<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Saringan — Hotfix/Diagnostik (PKB40)</title>

  <!-- Tetapan lalai (boleh ubah dalam UI) -->
  <meta name="gas-endpoint" content="https://broken-dew-0eb2.amiruladlije.workers.dev/exec">
  <meta name="google-signin-client_id" content="863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com">

  <!-- Google Identity -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{--bg:#0b1020;--ink:#e6f0ff;--muted:#91a1c1;--accent:#1f6fff;--ok:#26c281;--bad:#ff4d4f}
    *{box-sizing:border-box}
    body{margin:0;font:14px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,"Helvetica Neue",Arial,"Apple Color Emoji","Segoe UI Emoji";color:#0b1225;background:#f7f9fc}
    h1,h2{margin:.6rem 0 1rem}
    h1{font-size:28px}
    h2{font-size:20px}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e8eef8;border-radius:12px;box-shadow:0 2px 8px rgba(16,24,40,.04);padding:16px 16px}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    label{display:block;font-weight:600;color:#253155;margin:.25rem 0}
    input[type="text"],input[type="date"],textarea{width:100%;padding:10px 12px;border:1px solid #d6deee;border-radius:8px;font:inherit;background:#fbfdff}
    textarea{min-height:120px;resize:vertical}
    .btn{display:inline-flex;align-items:center;gap:8px;height:40px;padding:0 14px;border-radius:8px;border:1px solid #cbd6ee;background:#fff;cursor:pointer;user-select:none}
    .btn.primary{background:var(--accent);border-color:var(--accent);color:#fff}
    .btn.ghost{background:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}
    .stack{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:#66799e}
    .pill{padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid #d6deee;color:#3b4d74;background:#f3f7ff}
    .hr{height:1px;background:#eef2fa;margin:10px 0 14px}
    .hide{display:none !important}

    /* Log panel */
    .logpanel{position:fixed;right:14px;bottom:14px;width:420px;max-height:210px;background:#0c1327;border:1px solid #2c3963;border-radius:10px;overflow:auto;color:#cde2ff;font:12px/1.35 ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    .logpanel pre{margin:0;padding:8px 10px;white-space:pre-wrap;word-break:break-word}
    .logpanel pre:nth-child(odd){background:#0f1733}
    .ok{color:#9cffb1}
    .err{color:#ffc9c9}
    .tag{display:inline-block;margin-right:6px;padding:1px 6px;border-radius:6px;background:#172147;border:1px solid #2a3a76;color:#cde2ff}
    .flex{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .gsi{display:flex;align-items:center;gap:12px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Saringan — <b>Hotfix/Diagnostik</b></h1>
    <p class="muted">Tujuan: uji sambungan <b>Cloudflare Worker</b> → <b>Google Apps Script</b> + aliran log masuk Google yang sama seperti sistem sebenar. Jika respons bukan JSON (contoh: berisi <code>&lt;!DOCTYPE html&gt;</code>), panel log akan paparkan <span class="pill">UPSTREAM_NOT_JSON</span> bersama petikan HTML supaya punca boleh dikenalpasti.</p>

    <section class="card" id="sec-auth">
      <h2>1) Konfigurasi</h2>
      <div class="row">
        <div>
          <label>API BASE (Cloudflare Worker URL)</label>
          <input id="apiBase" type="text" placeholder="https://xxx.workers.dev/exec">
          <div class="muted" style="margin-top:6px">Contoh: <code>https://broken-dew-0eb2.amiruladlije.workers.dev/exec</code></div>
        </div>
        <div>
          <label>Google Client ID (GSI)</label>
          <input id="gsiClient" type="text" placeholder="xxxxxxxxx.apps.googleusercontent.com">
          <div class="muted" style="margin-top:6px">Biarkan jika tidak berubah.</div>
        </div>
      </div>
      <div class="hr"></div>
      <div class="flex">
        <div id="gsi-btn" class="gsi"></div>
        <button class="btn" id="btnLogout">Log keluar</button>
        <span class="muted" id="authInfo">Belum log masuk</span>
        <span class="pill" id="authEmail" style="display:none"></span>
        <div class="stack" style="margin-left:auto">
          <button class="btn ghost" id="btnWhoami">Uji WhoAmI</button>
          <button class="btn ghost" id="btnVoucher">Bina Voucher Set</button>
        </div>
      </div>
    </section>

    <section class="card" id="sec-history" style="margin-top:16px">
      <h2>2) Lihat Sejarah Saringan (AKTIVITI_PROGRAM)</h2>
      <div class="stack">
        <button class="btn primary" id="btnLoadActs">Muatkan Aktiviti</button>
        <span class="muted">Jika berjaya, senarai ringkas dipaparkan di bawah.</span>
      </div>
      <div class="hr"></div>
      <div id="actsOut" class="muted">Hasil Aktiviti</div>
    </section>

    <section class="card" id="sec-save" style="margin-top:16px">
      <h2>3) Simpan Jadual NADI (Demo Minimum)</h2>
      <div class="row">
        <div>
          <label>Tajuk Program</label>
          <input id="title" type="text" value="Program NADI Komuniti">
        </div>
        <div>
          <label>Tarikh Program (YYYY-MM-DD atau DD/MM/YYYY)</label>
          <input id="date" type="text" value="2025-09-12">
        </div>
      </div>
      <div style="margin-top:10px">
        <label>Items (JSON Array)</label>
        <textarea id="items">[{"nama":"Ali","noIC":"900101-10-1234","noTelefon":"0123456789","status":"LAYAK","appointmentType":"PKB40"}]</textarea>
      </div>
      <div class="hr"></div>
      <button class="btn primary" id="btnSave">Simpan</button>
    </section>
  </div>

  <div class="logpanel" id="log"><pre>Menunggu...</pre></div>

  <script>
  (function(){
    const $ = (sel)=>document.querySelector(sel);
    const $$ = (sel)=>Array.from(document.querySelectorAll(sel));
    const LS = {
      get: (k,d='')=>{ try{const v=localStorage.getItem(k); return v==null?d:v;}catch(e){return d}},
      set: (k,v)=>{ try{localStorage.setItem(k,v)}catch(e){} },
      del: (k)=>{ try{localStorage.removeItem(k)}catch(e){} }
    };
    const META = (name)=>{
      const el=document.querySelector(`meta[name="${name}"]`);
      return el?el.content.trim():'';
    };

    const logEl = document.getElementById('log');
    function log(msg, ok){
      const ts = new Date().toLocaleTimeString();
      const pre = document.createElement('pre');
      pre.innerHTML = `[${ts}] ${msg}`;
      pre.className = ok===true?'ok':(ok===false?'err':'');
      if (!logEl.firstChild) logEl.appendChild(pre); else logEl.append(pre);
      logEl.scrollTop = logEl.scrollHeight;
    }
    function j(obj){ try{return JSON.stringify(obj)}catch(e){return String(obj)} }

    // -------- Settings bootstrap
    const apiBaseInp = $('#apiBase');
    const gsiInp = $('#gsiClient');
    const defBase = META('gas-endpoint') || '';
    const defGSI  = META('google-signin-client_id') || '';
    apiBaseInp.value = LS.get('GAS_ENDPOINT', defBase);
    gsiInp.value     = LS.get('GSI_CLIENT_ID', defGSI);
    apiBaseInp.addEventListener('change', ()=>LS.set('GAS_ENDPOINT', apiBaseInp.value.trim()));
    gsiInp.addEventListener('change', ()=>LS.set('GSI_CLIENT_ID', gsiInp.value.trim()));

    // -------- Auth (GSI)
    const authInfo = $('#authInfo');
    const authEmail = $('#authEmail');
    const tokenKey = 'id_token';

    window.PKB40 = {
      get endpoint(){ return (apiBaseInp.value||'').trim().replace(/\/+$/,''); },
      get token(){ return LS.get(tokenKey,''); },
      set token(v){ v?LS.set(tokenKey, v):LS.del(tokenKey); },
      apiGet,
      apiPost
    };

    function ensureGSI(){
      if (!window.google || !google.accounts || !google.accounts.id){
        setTimeout(ensureGSI, 250);
        return;
      }
      const clientId = (gsiInp.value || defGSI || '').trim();
      if (!clientId){ log('Client ID kosong.', false); return; }
      google.accounts.id.initialize({
        client_id: clientId,
        auto_select: true,
        callback: (resp)=>{
          const token = resp && resp.credential;
          if (token){ PKB40.token = token; authInfo.textContent='Log masuk'; log('[auth] id_token disimpan', true); testWhoAmI(); ensureVoucherICs(); }
        }
      });
      google.accounts.id.renderButton($('#gsi-btn'), { theme:'outline', size:'medium', text: 'signin_with' });
      log('GSI sedia.', true);
    }
    window.addEventListener('load', ensureGSI);

    $('#btnLogout').addEventListener('click', ()=>{ PKB40.token=''; authInfo.textContent='Belum log masuk'; authEmail.style.display='none'; log('Token dibuang.', true); });

    // -------- API helpers (JSON-safe)
    async function _fetch(url, opts={}){
      const res = await fetch(url, opts);
      const ctype = (res.headers.get('content-type')||'').toLowerCase();
      if (ctype.includes('application/json')) return res.json();
      const body = await res.text();
      // Cloudflare/Apps Script error that returns HTML
      if (/^\s*</.test(body)){
        log('UPSTREAM_NOT_JSON → petikan: '+ body.slice(0,160).replace(/\n/g,' ') + ' ...', false);
        return { status:'error', code:'UPSTREAM_NOT_JSON', upstreamStatus: res.status, body };
      }
      try{ return JSON.parse(body); }catch(e){ return { status:'error', code:'NOT_JSON', body }; }
    }
    function qs(obj={}){
      const sp = new URLSearchParams();
      Object.entries(obj).forEach(([k,v])=>{ if (v!==undefined && v!==null) sp.set(k, String(v)); });
      return sp.toString();
    }
    function withToken(params={}){
      const p = Object.assign({}, params);
      if (!p.id_token) p.id_token = PKB40.token || '';
      return p;
    }
    function base(){ return PKB40.endpoint || ''; }

    function urlFor(action, params={}){
      const b = base(); if (!b) throw new Error('GAS_ENDPOINT kosong.');
      const u = b + (b.includes('?')?'&':'?') + qs(withToken(Object.assign({ action }, params)));
      return u;
    }

    async function apiGet(action, params={}){
      try{
        const u = urlFor(action, params);
        const out = await _fetch(u, { method:'GET', mode:'cors' });
        return out;
      }catch(err){ return { status:'error', message: String(err) }; }
    }

    async function apiPost(action, payload={}){
      try{
        const u = urlFor(action, {});
        const body = qs(withToken(Object.assign({ action }, payload)));
        const out = await _fetch(u, {
          method:'POST',
          mode:'cors',
          headers:{ 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
          body
        });
        return out;
      }catch(err){ return { status:'error', message: String(err) }; }
    }

    // -------- Tests
    async function testWhoAmI(){
      const r = await apiPost('whoami', {});
      if (r && r.status==='success'){
        authInfo.textContent = 'Log masuk sebagai';
        authEmail.textContent = r.email || '';
        authEmail.style.display='inline-block';
        log('WHOAMI → '+j(r), true);
      } else {
        authEmail.style.display='none';
        log('WHOAMI → '+j(r), false);
      }
    }
    $('#btnWhoami').addEventListener('click', testWhoAmI);

    // -------- Voucher IC Set (untuk preloading)
    async function ensureVoucherICs(){
      const r = await apiGet('getVoucherICSet', {});
      if (r && r.status==='success'){ window.__VOUCHER_ICS__ = (r.ics||[]); log('Voucher IC set → '+j(r), true); }
      else log('Voucher IC set → '+j(r), false);
    }
    $('#btnVoucher').addEventListener('click', ensureVoucherICs);

    // -------- Load activities (history)
    async function loadActivities(){
      const outEl = $('#actsOut');
      const r = await apiGet('getNadiActivities', {});
      if (r && r.status==='success' && Array.isArray(r.data)){
        const list = r.data;
        log('Aktiviti dimuat: '+ list.length, true);
        if (!list.length){ outEl.textContent='Tiada aktiviti.'; return; }
        const frag = document.createDocumentFragment();
        list.slice(0, 30).forEach((it, i)=>{
          const d = document.createElement('div');
          d.className='muted'; d.style.margin='6px 0';
          d.innerHTML = `<span class="tag">#${i+1}</span> <b>${escapeHtml(it.title||'')}</b> <span class="pill">${escapeHtml(it.programDate||'')}</span> <span class="muted">ID:</span> ${escapeHtml(it.activityId||'')}`;
          frag.appendChild(d);
        });
        outEl.innerHTML='';
        outEl.appendChild(frag);
        // expose untuk UI asal jika mahu consume
        window.__NADI_ACTIVITIES__ = list;
        document.dispatchEvent(new CustomEvent('nadi:activitiesLoaded', { detail:list }));
      } else {
        outEl.textContent='Gagal memuat aktiviti.';
        log('getNadiActivities → '+j(r), false);
      }
    }
    $('#btnLoadActs').addEventListener('click', loadActivities);

    // -------- Normalize & Save
    function normPhone(raw){
      let s = String(raw||'').replace(/\D/g,'');
      if (!s) return '';
      if (s.startsWith('00')) s=s.slice(2);
      if (s.startsWith('60')) return s;
      if (s.startsWith('0')) return '60'+s.slice(1);
      return '60'+s;
    }
    function normalizeItems(arr){
      const toBool = (v)=> v===true || String(v).toLowerCase()==='true' || String(v).toUpperCase()==='YA' || String(v)==='1';
      const normDXTType = (raw)=>{
        const s = String(raw||'').trim().toUpperCase();
        if (!s) return '';
        if (/(FAST|FBG|PUASA)/.test(s)) return 'FASTING';
        if (/(RAND|RBG|RANDOM)/.test(s)) return 'RANDOM';
        return s;
      };
      return (arr||[]).map((r)=>{
        const o = r||{};
        const nama      = o.nama || o.name || o.fullname || '';
        const noIC      = o.noIC || o.ic || o.no_kp || o.icNumber || o.nokp || o.NoIC || '';
        const umur      = o.umur || o.age || '';
        const noTelefon = normPhone(o.noTelefon || o.telefon || o.noTel || o.phone || o.msisdn || o.tel || '');
        const alamat    = o.alamat || o.address || o.addr || '';
        const bp        = o.bp || o.bloodPressure || '';
        const pr        = o.pr || o.nadi || o.pulse || '';
        const dxt       = o.dxt || o.gula || o.dxtValue || o.bs || o.sugar || '';
        const dxtType   = normDXTType(o.dxtType || o.dxt_type || o.dxttype);
        const tinggi    = o.tinggi || o.height || '';
        const berat     = o.berat || o.weight || '';
        const bmi       = o.bmi || o.BMI || '';
        let status      = String(o.status||'').toUpperCase();
        const layak     = toBool(o.layak);
        const takLayak  = toBool(o.takLayak) || /TAK\s*LAYAK|TIDAK\s*LAYAK/i.test(status);
        if (!status) status = layak ? 'LAYAK' : (takLayak ? 'TAK LAYAK' : '');

        let appointmentType = String(o.appointmentType || o.appointment_type || o.jenis || '').toUpperCase();
        const voucherFlag = toBool(o.voucher) || toBool(o.tcaVoucher);
        if (!appointmentType){
          if (status==='LAYAK') appointmentType='PKB40';
          else if (voucherFlag) appointmentType='VOUCHER';
          else appointmentType='NONE';
        }
        const tcaDate   = o.tcaDate || o.tca_date || o.tca || '';
        const tcaTime   = o.tcaTime || o.tca_time || o.masaTCA || '';
        const tcaStaff  = o.tcaStaff || o.tca_staff || o.staffTCA || '';
        const remark    = o.remark || o.catatan || o.notes || o.note || '';

        return { nama,noIC,umur,noTelefon,alamat,BP:bp,PR:pr,DXT:dxt,DXTType:dxtType,tinggi,berat,BMI:bmi,status,appointmentType,remark,tcaDate,tcaTime,tcaStaff };
      });
    }

    async function doSave(){
      let itemsRaw = $('#items').value.trim();
      let items = [];
      try{ items = JSON.parse(itemsRaw); }catch(e){ log('Items bukan JSON sah', false); return; }
      const payload = {
        title: $('#title').value.trim(),
        date: $('#date').value.trim(),
        items: JSON.stringify(normalizeItems(items))
      };
      const r = await apiPost('saveNadiProgramActivity', payload);
      log('Simpan OK → '+j(r), r && r.status==='success');
    }
    $('#btnSave').addEventListener('click', doSave);

    // Auto init (kalau token sudah ada dari sesi lepas)
    if (PKB40.token){ testWhoAmI(); ensureVoucherICs(); }
    // Option: auto-muat aktiviti selepas 1s
    setTimeout(()=>{ if (PKB40.token) loadActivities(); }, 1200);

    // Util
    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;" }[m])); }
  })();
  </script>
</body>
</html>
