<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Program PEKA B40 bersama NADI</title>

  <!-- Bootstrap 5 (ringan & moden) -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Ikon -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    :root{
      --brand:#106ebe;
      --brand-2:#0b5ed7;
      --soft:#f7f9fb;
      --line:#e9eef3;
    }
    body{background:#ffffff;color:#111}
    .app-bar{
      position:sticky; top:0; z-index:1000; background:#fff; border-bottom:1px solid var(--line);
    }
    .app-bar .left-actions .btn{margin-right:.5rem}
    .section-title{
      font-weight:700; font-size:1.1rem; margin:0;
    }
    .toolbar-note{font-size:.85rem;color:#6c757d}
    .table-wrap{
      background:#fff; border:1px solid var(--line); border-radius:.75rem; overflow:hidden;
    }
    .table thead th{
      position:sticky; top:58px; /* tinggi app-bar */
      background:#fff; z-index:5; border-bottom:1px solid var(--line);
      font-weight:600;
    }
    .table tbody tr{border-bottom:1px solid var(--line)}
    .table td, .table th{vertical-align:middle}
    .table input, .table select, .table textarea{
      width:100%; border:1px solid #dee2e6; border-radius:.375rem; padding:.375rem .5rem; font-size:.95rem;
    }
    .table textarea{height:38px; resize:vertical; min-height:38px}
    .row-actions .btn{padding:.3rem .5rem}
    .compact .table td{padding:.4rem .5rem}
    .sticky-footer{
      position:sticky; bottom:0; background:linear-gradient(180deg, rgba(255,255,255,0) 0%, #fff 35%);
      padding-top:.5rem;
    }
    .badge-dot{
      display:inline-flex; align-items:center; gap:.4rem; font-size:.8rem
    }
    .badge-dot i{font-size:.55rem}
    .form-chip{
      background:var(--soft); border:1px solid var(--line); border-radius:.5rem; padding:.35rem .5rem; font-size:.85rem
    }
    .search-area input{max-width:280px}
    .whatsapp-preview{
      background:#f8fff9; border:1px dashed #cfe9d9; border-radius:.5rem; padding:.75rem; font-family:ui-monospace, Menlo, Consolas;
      white-space:pre-wrap; max-height:240px; overflow:auto
    }
    /* Fokus jelas untuk kegunaan lama */
    :focus{outline:2px solid rgba(16,110,190,.35); outline-offset:2px}
  </style>
</head>
<body class="compact">

  <!-- App Bar / Toolbar Atas -->
  <div class="app-bar">
    <div class="container py-2">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
        <div class="left-actions d-flex align-items-center gap-2">
          <h1 class="section-title me-2">Program <span class="text-primary">PEKA B40</span> bersama NADI</h1>
          <span class="form-chip"><i class="fa-regular fa-clock me-1"></i>
            <span id="autosaveStatus">Autosave aktif</span>
          </span>
        </div>
        <div class="d-flex align-items-center gap-2 flex-wrap">
          <!-- Carian & Saring -->
          <div class="search-area d-flex align-items-center gap-2">
            <input id="searchInput" type="search" class="form-control" placeholder="Cari nama / IC / telefon...">
            <select id="filterCompany" class="form-select">
              <option value="">Semua Syarikat</option>
            </select>
            <input id="filterDate" type="date" class="form-control" />
          </div>
          <div class="toolbar-note d-none d-md-inline">
            <span class="badge-dot"><i class="fa-solid fa-circle"></i> Tekan <strong>Tab</strong> untuk berpindah sel</span>
          </div>
        </div>
      </div>

      <!-- Baris Aksi (Ikut versi 2.5.0: Tambah Baris di sebelah kiri, Export CSV di kanan) -->
      <div class="d-flex align-items-center justify-content-between mt-2">
        <div>
          <button id="addRowBtn" class="btn btn-success">
            <i class="fa-solid fa-plus"></i> Tambah Baris
          </button>
        </div>
        <div class="d-flex align-items-center gap-2">
          <button id="exportCsvBtn" class="btn btn-outline-primary">
            <i class="fa-solid fa-file-export"></i> Transfer fail kepada Excel (CSV)
          </button>
          <button id="whatsAppBtn" class="btn btn-success">
            <i class="fa-brands fa-whatsapp"></i> Hantar report (WhatsApp Web)
          </button>
          <button id="clearAllBtn" class="btn btn-outline-danger">
            <i class="fa-regular fa-trash-can"></i> Kosongkan (tempatan)
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Kandungan Utama -->
  <div class="container my-3">
    <div class="table-wrap p-2">
      <div class="table-responsive">
        <table id="dataTable" class="table align-middle mb-0">
          <thead>
            <tr>
              <th style="width:48px">#</th>
              <th style="min-width:120px">Tarikh</th>
              <th style="min-width:220px">Nama Peserta</th>
              <th style="min-width:170px">IC / Passport</th>
              <th style="min-width:160px">No. Telefon</th>
              <th style="min-width:200px">Syarikat</th>
              <th style="min-width:180px">Jenis Saringan</th>
              <th style="min-width:260px">Catatan</th>
              <th style="width:120px" class="text-center">Tindakan</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <!-- Baris akan dijana melalui JS -->
          </tbody>
        </table>
      </div>

      <div class="sticky-footer text-end mt-2">
        <small class="text-muted">
          Data disimpan automatik di pelayar (local). Sesuai untuk operasi seharian tanpa internet.
        </small>
      </div>
    </div>
  </div>

  <!-- Modal WhatsApp -->
  <div class="modal fade" id="waModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fa-brands fa-whatsapp me-2"></i>Hantar Laporan melalui WhatsApp Web</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Tutup"></button>
        </div>
        <div class="modal-body">
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">No. Telefon Penerima (pilihan)</label>
              <input id="waPhone" type="tel" class="form-control" placeholder="Contoh: 60123456789">
              <div class="form-text">Biarkan kosong jika mahu pilih kenalan dalam WhatsApp Web.</div>
            </div>
            <div class="col-md-8">
              <label class="form-label">Tajuk / Header mesej</label>
              <input id="waHeader" type="text" class="form-control" value="Laporan Ringkas Program PEKA B40 bersama NADI">
            </div>
            <div class="col-12">
              <label class="form-label">Pratonton mesej</label>
              <div id="waPreview" class="whatsapp-preview"></div>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button id="openWaBtn" class="btn btn-success">
            <i class="fa-brands fa-whatsapp"></i> Buka WhatsApp Web & Hantar
          </button>
          <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* =========================
       Util
       ========================= */
    const LS_KEY = "pekaB40_nadi_table_v250";
    const todayStr = () => new Date().toISOString().slice(0,10);
    const el = id => document.getElementById(id);

    // Data model asas
    function newRowData(){
      return {
        date: todayStr(),
        name: "",
        ic: "",
        phone: "",
        company: "",
        screening: "",
        notes: ""
      };
    }

    function sanitizePhone(p){
      return (p||"").replace(/\D/g,"");
    }

    // Auto-save status UI
    let saveTimer;
    function markSaved(){
      el('autosaveStatus').textContent = "Disimpan";
      setTimeout(()=>{ el('autosaveStatus').textContent = "Autosave aktif"; }, 2000);
    }
    function scheduleSave(){
      clearTimeout(saveTimer);
      el('autosaveStatus').textContent = "Menyimpan...";
      saveTimer = setTimeout(saveAll, 350);
    }

    /* =========================
       Muat / Simpan (localStorage)
       ========================= */
    function loadAll(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw) return [];
      try{
        const parsed = JSON.parse(raw);
        return Array.isArray(parsed) ? parsed : [];
      }catch(e){ return []; }
    }

    function saveAll(){
      const data = [];
      const rows = el('tableBody').querySelectorAll('tr[data-row]');
      rows.forEach(tr=>{
        const row = {
          date: tr.querySelector('[data-field="date"]').value.trim(),
          name: tr.querySelector('[data-field="name"]').value.trim(),
          ic: tr.querySelector('[data-field="ic"]').value.trim(),
          phone: tr.querySelector('[data-field="phone"]').value.trim(),
          company: tr.querySelector('[data-field="company"]').value.trim(),
          screening: tr.querySelector('[data-field="screening"]').value.trim(),
          notes: tr.querySelector('[data-field="notes"]').value.trim(),
        };
        data.push(row);
      });
      localStorage.setItem(LS_KEY, JSON.stringify(data));
      markSaved();
      refreshCompanyFilterOptions(data);
    }

    /* =========================
       Jadual: Render & Aksi
       ========================= */
    function renderRow(row, index){
      const tr = document.createElement('tr');
      tr.setAttribute('data-row', index);

      tr.innerHTML = `
        <td class="text-muted">${index+1}</td>
        <td><input type="date" class="form-control form-control-sm" data-field="date" value="${row.date||""}"></td>
        <td><input type="text" class="form-control form-control-sm" data-field="name" placeholder="Nama peserta" value="${row.name||""}"></td>
        <td><input type="text" class="form-control form-control-sm" data-field="ic" placeholder="IC / Passport" value="${row.ic||""}"></td>
        <td><input type="tel" class="form-control form-control-sm" data-field="phone" placeholder="Contoh: 0123456789" value="${row.phone||""}"></td>
        <td><input type="text" class="form-control form-control-sm" data-field="company" placeholder="Nama syarikat" value="${row.company||""}"></td>
        <td>
          <select class="form-select form-select-sm" data-field="screening">
            ${[
              "", "Tekanan darah", "Gula darah cap jari", "Kolesterol", "BMI", "Penglihatan", "Pendengaran", "Lain-lain"
            ].map(opt=>`<option ${row.screening===opt?'selected':''} value="${opt}">${opt||'Pilih jenis saringan'}</option>`).join("")}
          </select>
        </td>
        <td><textarea class="form-control form-control-sm" data-field="notes" placeholder="Catatan / rujukan / ubat">${row.notes||""}</textarea></td>
        <td class="text-center row-actions">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-secondary" data-action="duplicate" title="Gandakan baris"><i class="fa-regular fa-copy"></i></button>
            <button class="btn btn-outline-danger" data-action="delete" title="Padam baris"><i class="fa-regular fa-trash-can"></i></button>
          </div>
        </td>
      `;

      // Hook perubahan -> autosave
      tr.querySelectorAll('input, select, textarea').forEach(inp=>{
        inp.addEventListener('input', scheduleSave);
        // Enter: lompat ke sel seterusnya
        inp.addEventListener('keydown', (e)=>{
          if(e.key==='Enter' && !e.shiftKey){
            e.preventDefault();
            focusNextInput(inp);
          }
        });
      });

      // Aksi baris
      tr.querySelector('[data-action="delete"]').addEventListener('click', ()=>{
        tr.remove();
        renumberRows();
        scheduleSave();
      });
      tr.querySelector('[data-action="duplicate"]').addEventListener('click', ()=>{
        const rowData = {
          date: tr.querySelector('[data-field="date"]').value,
          name: tr.querySelector('[data-field="name"]').value,
          ic: tr.querySelector('[data-field="ic"]').value,
          phone: tr.querySelector('[data-field="phone"]').value,
          company: tr.querySelector('[data-field="company"]').value,
          screening: tr.querySelector('[data-field="screening"]').value,
          notes: tr.querySelector('[data-field="notes"]').value,
        };
        addRow(rowData, true);
      });

      return tr;
    }

    function focusNextInput(current){
      const inputs = Array.from(el('dataTable').querySelectorAll('input, select, textarea'));
      const idx = inputs.indexOf(current);
      if(idx>-1 && idx<inputs.length-1){
        inputs[idx+1].focus();
      }
    }

    function renumberRows(){
      el('tableBody').querySelectorAll('tr[data-row]').forEach((tr,i)=>{
        tr.setAttribute('data-row', i);
        tr.querySelector('td:first-child').textContent = i+1;
      });
    }

    function addRow(rowData = null, afterDuplicate = false){
      const data = rowData || newRowData();
      const tbody = el('tableBody');
      const tr = renderRow(data, tbody.children.length);
      tbody.appendChild(tr);
      renumberRows();
      if(!afterDuplicate){
        // Fokus ke nama peserta baris baru
        const lastNameInput = tr.querySelector('[data-field="name"]');
        if(lastNameInput) lastNameInput.focus();
      }
      scheduleSave();
    }

    function loadToTable(){
      const data = loadAll();
      const tbody = el('tableBody');
      tbody.innerHTML = "";
      (data.length? data : [newRowData()]).forEach((row,i)=>{
        tbody.appendChild(renderRow(row, i));
      });
      refreshCompanyFilterOptions(data);
    }

    /* =========================
       Carian & Saring
       ========================= */
    function refreshCompanyFilterOptions(allRows){
      const sel = el('filterCompany');
      const current = sel.value;
      const companies = Array.from(new Set(allRows.map(r => (r.company||"").trim()).filter(Boolean))).sort();
      sel.innerHTML = `<option value="">Semua Syarikat</option>` + companies.map(c=>`<option ${c===current?'selected':''}>${c}</option>`).join('');
    }

    function applyFilters(){
      const q = el('searchInput').value.toLowerCase().trim();
      const comp = (el('filterCompany').value||"").toLowerCase();
      const d = el('filterDate').value; // kosong = semua tarikh

      const rows = el('tableBody').querySelectorAll('tr[data-row]');
      rows.forEach(tr=>{
        const v = field => tr.querySelector(`[data-field="${field}"]`)?.value || "";
        const hit =
          (!q || [v('name'), v('ic'), v('phone'), v('company'), v('screening'), v('notes')].join(' ').toLowerCase().includes(q)) &&
          (!comp || v('company').toLowerCase()===comp) &&
          (!d || v('date')===d);
        tr.style.display = hit ? "" : "none";
      });
    }

    /* =========================
       CSV Export
       ========================= */
    function toCSV(){
      const headers = ["Tarikh","Nama Peserta","IC / Passport","No. Telefon","Syarikat","Jenis Saringan","Catatan"];
      const lines = [headers.join(",")];
      const rows = el('tableBody').querySelectorAll('tr[data-row]');
      rows.forEach(tr=>{
        if(tr.style.display==='none') return; // hormat saring
        const get = f => {
          let val = tr.querySelector(`[data-field="${f}"]`)?.value || "";
          // Lindungi koma dengan petikan
          if(/[" ,\n]/.test(val)) val = `"${val.replace(/"/g,'""')}"`;
          return val;
        };
        lines.push([
          get('date'),
          get('name'),
          get('ic'),
          get('phone'),
          get('company'),
          get('screening'),
          get('notes')
        ].join(","));
      });
      return lines.join("\n");
    }

    function downloadCSV(filename="PEKA_B40_NADI.csv"){
      const blob = new Blob([toCSV()], {type:"text/csv;charset=utf-8;"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    /* =========================
       WhatsApp Web
       ========================= */
    function buildWhatsAppMessage(){
      const header = el('waHeader').value || "Laporan Program";
      let lines = [];
      lines.push(`*${header}*`);
      lines.push(`Tarikh Laporan: ${todayStr()}`);
      lines.push("");

      const visibleRows = Array.from(el('tableBody').querySelectorAll('tr[data-row]')).filter(tr=>tr.style.display!=='none');
      if(!visibleRows.length){
        lines.push("_Tiada data untuk dihantar (mengikut saringan semasa)._");
      }else{
        visibleRows.forEach((tr,idx)=>{
          const get = f => tr.querySelector(`[data-field="${f}"]`)?.value || "";
          const parts = [];
          parts.push(`${idx+1}. ${get('name') || '(Tanpa Nama)'} (${get('ic')||'-'})`);
          if(get('phone')) parts.push(`☎ ${get('phone')}`);
          if(get('company')) parts.push(`🏢 ${get('company')}`);
          if(get('screening')) parts.push(`🩺 ${get('screening')}`);
          if(get('notes')) parts.push(`📝 ${get('notes')}`);
          lines.push(parts.join(" | "));
        });
      }
      return lines.join("\n");
    }

    function openWhatsAppWeb(){
      const phoneRaw = sanitizePhone(el('waPhone').value);
      const text = buildWhatsAppMessage();
      const urlText = encodeURIComponent(text);

      // Tanpa app desktop: buka WhatsApp Web
      const url = phoneRaw
        ? `https://web.whatsapp.com/send?phone=${phoneRaw}&text=${urlText}`
        : `https://web.whatsapp.com/send?text=${urlText}`;

      window.open(url, "_blank", "noopener,noreferrer");
    }

    /* =========================
       Event Binding
       ========================= */
    function bindEvents(){
      el('addRowBtn').addEventListener('click', ()=> addRow());
      el('exportCsvBtn').addEventListener('click', ()=> downloadCSV());

      el('clearAllBtn').addEventListener('click', ()=>{
        if(confirm("Padam semua data tempatan? Tindakan ini tidak boleh diundur.")){
          localStorage.removeItem(LS_KEY);
          loadToTable();
        }
      });

      ['searchInput','filterCompany','filterDate'].forEach(id=>{
        el(id).addEventListener('input', applyFilters);
        el(id).addEventListener('change', applyFilters);
      });

      // WhatsApp modal
      const waModal = new bootstrap.Modal(document.getElementById('waModal'));
      el('whatsAppBtn').addEventListener('click', ()=>{
        el('waPreview').textContent = buildWhatsAppMessage();
        waModal.show();
      });
      el('openWaBtn').addEventListener('click', openWhatsAppWeb);

      // Auto refresh preview ketika ubah header/phone
      el('waHeader').addEventListener('input', ()=>{
        el('waPreview').textContent = buildWhatsAppMessage();
      });
    }

    /* =========================
       Init
       ========================= */
    document.addEventListener('DOMContentLoaded', ()=>{
      // Baris permulaan
      loadToTable();

      // Jika kosong, tambah 5 baris awal untuk percepat input
      if(el('tableBody').children.length === 1){
        for(let i=0;i<4;i++) addRow();
      }

      bindEvents();
      applyFilters();

      // Simpan berkala (backup tambahan)
      setInterval(saveAll, 30000);
    });
  </script>
</body>
</html>
