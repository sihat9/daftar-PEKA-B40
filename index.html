<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saringan — Index 7 (Final)</title>

  <!--
    Fail ini fokus untuk memastikan HALAMAN "LIHAT SEJARAH" berfungsi tanpa ralat.
    Jika anda mempunyai layout asal, letakkan markup asal anda di dalam <body>
    dan kekalkan ID berikut supaya skrip ini boleh "bind":
      - #sejarahList       : bekas kad senarai program
      - #sejarahDetail     : bekas jadual butiran peserta
      - #btnReload         : (opsyen) butang muat semula
      - #authStatus        : (opsyen) label status login
      - #detailHeader      : (opsyen) label tajuk butiran
  -->

  <style>
    /* Fallback gaya minimum (tidak mengganggu design asal anda) */
    :root{ --muted:#f6f7f9; --text:#111; --sub:#667085; --card:#fff; --line:#e6e7eb; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial; margin:0; color:var(--text); background:#fff; }
    .wrap{ max-width:1100px; margin:24px auto; padding:0 16px; }
    .toolbar{ display:flex; gap:12px; align-items:center; justify-content:space-between; margin-bottom:16px; }
    .pill{ background:var(--muted); padding:6px 10px; border-radius:999px; font-size:13px; color:var(--sub); }
    .grid{ display:grid; grid-template-columns:repeat(auto-fill,minmax(260px,1fr)); gap:12px; }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:12px; padding:14px; }
    .card h4{ margin:0 0 6px; font-size:16px; }
    .meta{ font-size:12px; color:var(--sub); display:flex; gap:10px; flex-wrap:wrap; }
    .btn{ appearance:none; border:1px solid var(--line); background:#fff; padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px; }
    .btn:disabled{ opacity:.5; cursor:not-allowed; }
    table{ width:100%; border-collapse:collapse; margin-top:12px; font-size:13px; }
    th,td{ border:1px solid var(--line); padding:6px 8px; text-align:left; }
    th{ background:#fafafa; }
    .status{ font-size:12px; color:var(--sub); }
    .sep{ height:1px; background:var(--line); margin:12px 0; }
  </style>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <!-- Fallback markup; jika anda sudah ada markup sendiri dengan ID yang sama, ini tidak perlu ubah -->
  <div class="wrap">
    <div class="toolbar">
      <div class="pill">Lihat Sejarah</div>
      <div id="authStatus" class="status">Belum log masuk</div>
    </div>

    <div class="card">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
        <strong>Senarai Program</strong>
        <button id="btnReload" class="btn" disabled>Muat semula</button>
      </div>
      <div id="sejarahList" class="grid" style="margin-top:12px;"></div>
    </div>

    <div class="card" style="margin-top:12px;">
      <div style="display:flex; gap:8px; align-items:center; justify-content:space-between">
        <strong>Butiran Peserta</strong>
        <div id="detailHeader" class="status">Tiada pilihan</div>
      </div>
      <div id="sejarahDetail">
        <div class="status">Pilih salah satu program untuk melihat butiran…</div>
      </div>
    </div>
  </div>

  <script>
  "use strict";

  // =========================
  // KONFIGURASI (WAJIB GANTIKAN)
  // =========================
  const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbx6TKE0vDDPO3-36cY7xjacAbGL0HIRKCrORNm-sED9y5NpIeIUk9gyrpiWy-S7vbc/exec"; // contoh: https://script.google.com/macros/s/AKfycbx.../exec
  const GOOGLE_CLIENT_ID = "863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com";

  // =========================
  // STATE
  // =========================
  let ID_TOKEN = "";
  let IS_AUTH = false;

  // =========================
  // HELPER DOM
  // =========================
  const $ = (sel) => document.querySelector(sel);
  const elList = $("#sejarahList");
  const elDetail = $("#sejarahDetail");
  const elReload = $("#btnReload");
  const elAuth = $("#authStatus");
  const elDetailHeader = $("#detailHeader");

  const setAuthStatus = (t) => { if (elAuth) elAuth.textContent = String(t||""); };
  const setReloadEnabled = (on) => { if (elReload) elReload.disabled = !on; };

  // =========================
  // GOOGLE IDENTITY
  // =========================
  window.addEventListener("load", () => {
    if (!GOOGLE_CLIENT_ID || GOOGLE_CLIENT_ID.indexOf("PASTE_") === 0){
      setAuthStatus("Konfigurasi GOOGLE_CLIENT_ID belum ditetapkan.");
      return;
    }
    if (window.google && google.accounts && google.accounts.id){
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false
      });
      google.accounts.id.prompt(); // One Tap jika layak
    } else {
      setAuthStatus("GSI belum dimuatkan.");
    }
  });

  function parseJwt (token) {
    try{
      const base64Url = token.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      return JSON.parse(jsonPayload);
    }catch(e){ return {}; }
  }

  async function handleCredentialResponse(resp){
    try{
      ID_TOKEN = (resp && resp.credential) ? resp.credential : "";
      if (!ID_TOKEN){ setAuthStatus("Log masuk gagal (tiada id_token)."); return; }
      const info = parseJwt(ID_TOKEN);
      setAuthStatus("Log masuk sebagai: " + (info.email || "Pengguna"));
      IS_AUTH = true;
      setReloadEnabled(true);
      await bootstrap();
    }catch(err){
      console.error(err);
      setAuthStatus("Log masuk gagal.");
    }
  }

  // =========================
  // API WRAPPER
  // =========================
  async function apiGet(params){
    if (!SCRIPT_URL || SCRIPT_URL.indexOf("PASTE_") === 0) throw new Error("SCRIPT_URL belum disetkan.");
    if (!ID_TOKEN) throw new Error("Belum log masuk (tiada id_token).");
    const q = new URLSearchParams(Object.assign({}, params, { id_token: ID_TOKEN }));
    const url = SCRIPT_URL + "?" + q.toString();
    const res = await fetch(url, { method: "GET", credentials: "omit" });
    if (!res.ok){
      let msg = "";
      try{ msg = await res.text(); }catch(e){}
      throw new Error("HTTP " + res.status + " " + msg);
    }
    return res.json();
  }

  async function bootstrap(){
    try{
      const who = await apiGet({ action: "whoami" });
      if (!who || who.status !== "success"){
        setAuthStatus("Akses ditolak.");
        return;
      }
      setAuthStatus("Log masuk: " + (who.email || "Pengguna"));
      await loadSejarahList();
    }catch(e){
      console.error(e);
      setAuthStatus("Akses ditolak: " + (e && e.message ? e.message : e));
    }
  }

  // =========================
  // RENDER
  // =========================
  function escapeHtml(s){
    return String(s==null?"":s)
      .replace(/&/g,"&amp;").replace(/</g,"&lt;")
      .replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#39;");
  }
  const esc = (v) => escapeHtml(v);

  function renderKadProgram(list){
    if (!elList) return;
    if (!Array.isArray(list) || list.length === 0){
      elList.innerHTML = '<div class="status">Tiada rekod.</div>';
      return;
    }
    elList.innerHTML = list.map(item => {
      const id = item.activityId || "";
      const ttl = esc(item.title || "(Tanpa tajuk)");
      const dt  = esc(item.programDate || "");
      const lay = esc(item.layakCount || "0");
      const tlk = esc(item.takLayakCount || "0");
      const tot = esc(item.total || "0");
      const staff = esc(item.staff || "");
      return (
        '<div class="card">' +
          '<h4>'+ttl+'</h4>' +
          '<div class="meta">' +
            '<span>Tarikh: '+dt+'</span>' +
            '<span>Layak: '+lay+'</span>' +
            '<span>Tidak: '+tlk+'</span>' +
            '<span>Jumlah: '+tot+'</span>' +
          '</div>' +
          '<div class="sep"></div>' +
          '<div class="meta">Oleh: '+staff+'</div>' +
          '<div style="margin-top:10px; display:flex; gap:8px;">' +
            '<button class="btn" data-activity="'+esc(id)+'">Lihat butiran</button>' +
            '<span class="status">ID: '+esc(id)+'</span>' +
          '</div>' +
        '</div>'
      );
    }).join("");

    // Bind klik
    elList.querySelectorAll("button[data-activity]").forEach(btn => {
      btn.addEventListener("click", async (ev) => {
        const activityId = ev.currentTarget.getAttribute("data-activity");
        if (elDetailHeader) elDetailHeader.textContent = "Memuatkan butiran ("+activityId+")…";
        await loadSejarahDetail(activityId);
      });
    });
  }

  function renderButiranPeserta(rows){
    if (!elDetail) return;
    if (!Array.isArray(rows) || rows.length === 0){
      elDetail.innerHTML = '<div class="status">Tiada peserta untuk aktiviti ini.</div>';
      return;
    }
    const head = [
      "No","Nama","NoIC","Umur","NoTelefon","Alamat",
      "BP","PR","DXT","Tinggi","Berat","BMI","Status","Remark","TCADate","TCATime","TCAStaff"
    ];
    const body = rows.map(r => (
      "<tr>" +
        "<td>"+esc(r.no)+"</td>" +
        "<td>"+esc(r.nama)+"</td>" +
        "<td>"+esc(r.noIC)+"</td>" +
        "<td>"+esc(r.umur)+"</td>" +
        "<td>"+esc(r.noTelefon)+"</td>" +
        "<td>"+esc(r.alamat)+"</td>" +
        "<td>"+esc(r.bp)+"</td>" +
        "<td>"+esc(r.pr)+"</td>" +
        "<td>"+esc(r.dxt)+"</td>" +
        "<td>"+esc(r.tinggi)+"</td>" +
        "<td>"+esc(r.berat)+"</td>" +
        "<td>"+esc(r.bmi)+"</td>" +
        "<td>"+esc(r.status)+"</td>" +
        "<td>"+esc(r.remark)+"</td>" +
        "<td>"+esc(r.tcaDate)+"</td>" +
        "<td>"+esc(r.tcaTime)+"</td>" +
        "<td>"+esc(r.tcaStaff)+"</td>" +
      "</tr>"
    )).join("");

    elDetail.innerHTML = (
      '<div style="overflow:auto;">' +
        '<table>' +
          '<thead><tr>'+ head.map(h=>"<th>"+h+"</th>").join("") +'</tr></thead>' +
          '<tbody>'+ body +'</tbody>' +
        '</table>' +
      '</div>'
    );
  }

  // =========================
  // ACTIONS
  // =========================
  async function loadSejarahList(){
    try{
      if (elList) elList.innerHTML = '<div class="status">Memuatkan senarai…</div>';
      const resp = await apiGet({ action: "getNadiActivities" });
      if (!resp || resp.status !== "success") throw new Error("API gagal: getNadiActivities");
      renderKadProgram(resp.data || []);
    }catch(err){
      console.error(err);
      if (elList) elList.innerHTML = '<div class="status">Gagal memuatkan sejarah: '+(err && err.message ? err.message : err)+'</div>';
    }
  }

  async function loadSejarahDetail(activityId){
    if (!activityId){
      if (elDetail) elDetail.innerHTML = '<div class="status">Tiada activityId.</div>';
      return;
    }
    try{
      if (elDetail) elDetail.innerHTML = '<div class="status">Memuatkan butiran…</div>';
      const resp = await apiGet({ action: "getNadiActivityDetail", id: activityId });
      if (!resp || resp.status !== "success") throw new Error("API gagal: getNadiActivityDetail");
      if (elDetailHeader) elDetailHeader.textContent = "Butiran untuk ID: " + activityId;
      renderButiranPeserta(resp.data || []);
    }catch(err){
      console.error(err);
      if (elDetail) elDetail.innerHTML = '<div class="status">Gagal memuatkan butiran: '+(err && err.message ? err.message : err)+'</div>';
    }
  }

  if (elReload){
    elReload.addEventListener("click", () => {
      if (!IS_AUTH){ setAuthStatus("Sila log masuk dahulu."); return; }
      loadSejarahList();
    });
  }
  </script>
</body>
</html>
