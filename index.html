<!doctype html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Saringan — Hotfix/Diagnostik</title>
  <style>
    :root{--bg:#0b1220;--card:#121a2a;--muted:#9bb0d3;--text:#eaf2ff;--accent:#3b82f6;--ok:#10b981;--warn:#f59e0b;--err:#ef4444}
    html,body{background:#0b1220;color:#eaf2ff;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif}
    .wrap{max-width:980px;margin:36px auto;padding:0 16px}
    h1{font-size:28px;margin:0 0 10px}
    .sub{color:var(--muted);font-size:14px;margin-bottom:18px}
    .card{background:#121a2a;border:1px solid #1f2a44;border-radius:12px;padding:18px;margin:16px 0}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .col{flex:1;min-width:280px}
    label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
    input,textarea{width:100%;background:#0f172a;border:1px solid #1f2a44;color:#eaf2ff;padding:10px 12px;border-radius:10px;outline:none}
    textarea{min-height:110px;font-family:ui-monospace,Consolas,Menlo,monospace;font-size:13px}
    .btn{display:inline-flex;align-items:center;gap:8px;background:#1f2a44;color:#eaf2ff;border:1px solid #2b3a61;border-radius:10px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);border-color:var(--accent)}
    .btn.ok{background:var(--ok);border-color:var(--ok);color:#051b12}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .stack{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
    .badge{display:inline-block;border-radius:999px;padding:3px 9px;font-size:12px;margin-left:8px;background:#0f172a;border:1px solid #223159;color:#9bb0d3}
    #gbtn{min-height:40px}
    pre{background:#0f172a;border:1px solid #1f2a44;border-radius:10px;padding:12px;overflow:auto}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#1f2a44;margin:14px 0}
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <h1>Saringan — Hotfix/Diagnostik</h1>
    <div class="sub">
      Tujuan: uji sambungan <b>Cloudflare Worker</b> → <b>Google Apps Script</b> dengan selamat.
      Jika respons bukan JSON (contoh: berisi <code>&lt;!DOCTYPE html&gt;</code>), panel log akan memaparkan
      <span class="badge">UPSTREAM_NOT_JSON</span> bersama petikan HTML supaya mudah kesan punca.
    </div>

    <div class="card">
      <h3>1) Konfigurasi</h3>
      <div class="row">
        <div class="col">
          <label>API BASE (Cloudflare Worker URL)
            <span class="badge" id="baseState">-</span>
          </label>
          <input id="apiBase" placeholder="https://your-worker.workers.dev/exec" />
          <div class="muted" style="margin-top:6px">
            Contoh: <code>https://broken-dew-0eb2.amiruladlije.workers.dev/exec</code>
          </div>
        </div>
        <div class="col">
          <label>Google Client ID (GSI)</label>
          <input id="gClient" placeholder="xxxxxxxxxx-abcdef.apps.googleusercontent.com" />
          <div class="muted" style="margin-top:6px">Biarkan jika tidak berubah.</div>
        </div>
      </div>
      <div class="stack">
        <div id="gbtn"></div>
        <button class="btn" id="btnLogout">Log keluar</button>
        <span class="muted" id="authInfo">Belum log masuk</span>
      </div>
      <div class="stack">
        <button class="btn primary" id="btnWho">Uji WhoAmI</button>
        <button class="btn" id="btnBuild">Bina Voucher Set</button>
      </div>
    </div>

    <div class="card">
      <h3>2) Lihat Sejarah Saringan (AKTIVITI_PROGRAM)</h3>
      <div class="stack">
        <button class="btn primary" id="btnLoad">Muatkan Aktiviti</button>
      </div>
      <div id="activities" class="muted">Hasil Aktiviti</div>
    </div>

    <div class="card">
      <h3>3) Simpan Jadual NADI (Demo Minimum)</h3>
      <div class="row">
        <div class="col">
          <label>Tajuk Program</label>
          <input id="title" value="Program NADI Komuniti" />
        </div>
        <div class="col">
          <label>Tarikh Program (YYYY-MM-DD atau DD/MM/YYYY)</label>
          <input id="pdate" />
        </div>
      </div>
      <label>Items (JSON Array)</label>
      <textarea id="items">[{"nama":"Ali","noIC":"900101-10-1234","noTelefon":"0123456789","status":"LAYAK","appointmentType":"PKB40"}]</textarea>
      <div class="stack">
        <button class="btn ok" id="btnSave">Simpan</button>
      </div>
    </div>

    <div class="card">
      <h3>Log</h3>
      <pre id="log"></pre>
    </div>
  </div>

  <script>
    // ---------- State helpers ----------
    function $(id){ return document.getElementById(id); }
    function saveState(){
      localStorage.setItem("apiBase", $("apiBase").value);
      localStorage.setItem("gClient", $("gClient").value);
    }
    function loadState(){
      $("apiBase").value = localStorage.getItem("apiBase") || "";
      $("gClient").value = localStorage.getItem("gClient") || "";
      setBaseBadge();
      const token = localStorage.getItem("id_token") || "";
      setAuthInfo(token);
    }
    function setBaseBadge(){
      var txt = ($("apiBase").value || "").trim();
      var ok = /\/exec$/.test(txt);
      var el = $("baseState");
      el.textContent = ok ? "OK (/exec)" : "Perlu /exec";
      el.style.background = ok ? "#10331d" : "#3a1b1b";
      el.style.borderColor = ok ? "#1e7a46" : "#783232";
      el.style.color = ok ? "#b1ffcf" : "#ffd4d4";
    }
    function setAuthInfo(token){
      var lbl = $("authInfo");
      if(token){
        lbl.textContent = "[auth] token tersedia";
      }else{
        lbl.textContent = "Belum log masuk";
      }
    }
    function logLine(msg){
      var pre = $("log");
      var now = new Date().toLocaleTimeString();
      pre.textContent += "[" + now + "] " + msg + "\n";
      pre.scrollTop = pre.scrollHeight;
    }

    $("apiBase").addEventListener("input", function(){ saveState(); setBaseBadge(); });
    $("gClient").addEventListener("input", saveState);

    // ---------- Google Identity ----------
    var gsiReady = false;
    window.onload = function(){
      loadState();
      // Set default date today
      var d = new Date();
      var dd = ("0"+d.getDate()).slice(-2);
      var mm = ("0"+(d.getMonth()+1)).slice(-2);
      var yyyy = d.getFullYear();
      $("pdate").value = yyyy + "-" + mm + "-" + dd;
    };

    window.handleCredentialResponse = function(resp){
      try{
        var token = resp.credential || "";
        if(token){
          localStorage.setItem("id_token", token);
          setAuthInfo(token);
          logLine("[auth] id_token disimpan");
        }
      }catch(e){
        logLine("Auth callback error: " + e.message);
      }
    };

    function initGsi(){
      var cid = ($("gClient").value || "").trim();
      if(!cid){ logLine("Client ID kosong."); return; }
      try{
        google.accounts.id.initialize({ client_id: cid, callback: handleCredentialResponse });
        google.accounts.id.renderButton($("gbtn"), { theme: "outline", size: "medium" });
        gsiReady = true;
        logLine("GSI sedia.");
      }catch(e){
        logLine("GSI init gagal: " + e.message);
      }
    }
    // Wait a bit for gsi script to load
    var gsiTicker = setInterval(function(){
      if(window.google && google.accounts && google.accounts.id){
        clearInterval(gsiTicker);
        initGsi();
      }
    }, 400);

    $("btnLogout").onclick = function(){
      localStorage.removeItem("id_token");
      setAuthInfo("");
      logLine("Token dibuang.");
    };

    // ---------- API helpers ----------
    function base(){ return ($("apiBase").value || "").trim(); }
    function token(){ return localStorage.getItem("id_token") || ""; }

    async function callGet(action){
      var url = base();
      if(!url){ logLine("API base kosong."); return null; }
      var qs = "?action=" + encodeURIComponent(action) + "&id_token=" + encodeURIComponent(token());
      var res = await fetch(url + qs, { method:"GET", headers:{ "Accept":"application/json" } });
      try{
        var data = await res.json();
        return { ok:true, data:data, status:res.status };
      }catch(e){
        var text = await res.text();
        return { ok:false, status:res.status, error:"UPSTREAM_NOT_JSON", body:text.slice(0,400) };
      }
    }

    async function callPost(action, params){
      var url = base();
      if(!url){ logLine("API base kosong."); return null; }
      var form = new URLSearchParams();
      form.set("action", action);
      form.set("id_token", token());
      if(params){
        for(var k in params){
          if(Object.prototype.hasOwnProperty.call(params,k)){
            form.set(k, String(params[k]));
          }
        }
      }
      var res = await fetch(url, {
        method:"POST",
        headers:{ "Content-Type":"application/x-www-form-urlencoded" },
        body: form.toString()
      });
      try{
        var data = await res.json();
        return { ok:true, data:data, status:res.status };
      }catch(e){
        var text = await res.text();
        return { ok:false, status:res.status, error:"UPSTREAM_NOT_JSON", body:text.slice(0,400) };
      }
    }

    // ---------- Buttons ----------
    $("btnWho").onclick = async function(){
      var r = await callGet("whoami");
      if(!r){ return; }
      if(r.ok){
        logLine("WHOAMI → " + JSON.stringify(r.data));
      }else{
        logLine("WHOAMI ralat " + r.status + " : " + r.error + " :: " + r.body);
      }
    };

    $("btnBuild").onclick = async function(){
      var r = await callGet("getVoucherICSet");
      if(!r){ return; }
      if(r.ok){
        logLine("Voucher IC set → " + JSON.stringify(r.data));
      }else{
        logLine("Voucher IC set ralat " + r.status + " : " + r.error + " :: " + r.body);
      }
    };

    $("btnLoad").onclick = async function(){
      var r = await callGet("getNadiActivities");
      if(!r){ return; }
      if(r.ok){
        var out = (r.data && r.data.data) ? r.data.data.slice(0,20) : [];
        $("activities").textContent = JSON.stringify(out, null, 2);
        logLine("Aktiviti dimuat: " + out.length);
      }else{
        $("activities").textContent = "";
        logLine("Load aktivit ralat " + r.status + " : " + r.error + " :: " + r.body);
      }
    };

    $("btnSave").onclick = async function(){
      var title = $("title").value || "";
      var date = $("pdate").value || "";
      var itemsText = $("items").value || "[]";
      var items;
      try{
        items = JSON.parse(itemsText);
      }catch(e){
        logLine("JSON items tidak sah: " + e.message);
        return;
      }
      var r = await callPost("saveNadiProgramActivity", {
        staff: "",
        programTitle: title,
        programDate: date,
        items: JSON.stringify(items)
      });
      if(!r){ return; }
      if(r.ok){
        logLine("Simpan OK → " + JSON.stringify(r.data));
      }else{
        logLine("Simpan ralat " + r.status + " : " + r.error + " :: " + r.body);
      }
    };
  </script>
</body>
</html>
