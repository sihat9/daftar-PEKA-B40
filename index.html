<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem Tracker PEKA B40 — Live Sync</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Google Identity Services (Sign-In) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <style>
    :root{ --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12; --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6; }
    html{ font-size:15px; }
    body{ font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif; background:#f7f9fc; color:#222; }

    .navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
    .navbar-brand{font-weight:700;color:var(--primary);font-size:1.05rem;display:flex;align-items:center;gap:10px}

    .page-header{background:linear-gradient(135deg,#4e73df,#1cc88a);color:#fff;padding:14px 0;margin-bottom:12px;border-radius:0 0 12px 12px}

    .card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:16px;background:#ffffff}
    .card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;padding:12px 16px;border-radius:14px 14px 0 0!important}

    .nadi-scroll-container { overflow-x: auto; width: 100%; padding-bottom: 8px; }
    .nadi-table { width: 100%; min-width: 1200px; border-collapse: separate; border-spacing: 0; }
    .nadi-table th { background:#f8f9fa; padding:10px 8px; font-weight:600; text-align:center; position:sticky; top:0; z-index:10; border:1px solid #dee2e6; }
    .nadi-table td { padding:8px; vertical-align:middle; border:1px solid #dee2e6; }
    .nadi-input { width:100%; min-width:120px; }
    .nadi-actions-cell { min-width: 180px; }
    .small-muted{ font-size:.875rem; color:#6c757d; }
  </style>
</head>
<body>
  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-main sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#dashboard">
        <i class="fa-solid fa-heart-pulse text-primary"></i>
        <span>Klinik SihatSokmo</span>
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="#dashboard">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="#nadi">Program NADI (Live)</a></li>
        </ul>
        <div id="signinArea" class="d-flex"></div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <div class="container">
      <div class="row align-items-center">
        <div class="col-md-6">
          <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem Tracker PEKA B40</h1>
          <div class="small opacity-75">Mod tema cerah + Live Sync (NADI)</div>
        </div>
        <div class="col-md-6 text-md-end">
          <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
        </div>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- Dashboard (ringkas) -->
    <section id="dashboard" class="mb-4">
      <div class="card">
        <div class="card-header"><i class="fa-solid fa-gauge me-2"></i> Dashboard</div>
        <div class="card-body">
          <div class="row g-3">
            <div class="col-md-4">
              <div class="p-3 rounded border text-center">
                <div class="small-muted">Total Aktif</div>
                <div class="fs-4 fw-bold" id="totalDaftar">0</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 rounded border text-center">
                <div class="small-muted">Selesai</div>
                <div class="fs-4 fw-bold" id="totalSelesai">0</div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="p-3 rounded border text-center">
                <div class="small-muted">Lab Follow-up Due</div>
                <div class="fs-4 fw-bold" id="labFollowUpDue">0</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- NADI (Live) -->
    <section id="nadi" class="mb-4">
      <div class="d-flex justify-content-between align-items-end mb-2">
        <div class="me-3">
          <label class="form-label mb-1">Tajuk Program</label>
          <input id="nadiProgramTitle" class="form-control form-control-sm" placeholder="cth: Saringan Komuniti Tmn Mawar">
        </div>
        <div class="me-auto">
          <label class="form-label mb-1">Tarikh Program</label>
          <input id="nadiProgramDate" type="date" class="form-control form-control-sm">
        </div>
        <div class="d-flex gap-2">
          <button id="btnNadiAddRow" class="btn btn-sm btn-primary"><i class="bi bi-plus-circle me-1"></i>Tambah Pesakit</button>
          <button id="btnNadiSaveOfficial" class="btn btn-sm btn-success"><i class="bi bi-cloud-upload me-1"></i>Simpan Aktiviti (Rasmi)</button>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="nadi-scroll-container">
            <table class="nadi-table">
              <thead>
                <tr>
                  <th style="width:48px;">#</th>
                  <th>Nama</th>
                  <th>No IC</th>
                  <th>Umur</th>
                  <th>Telefon</th>
                  <th>Alamat</th>
                  <th>BP</th>
                  <th>PR</th>
                  <th>DXT</th>
                  <th>Tinggi</th>
                  <th>Berat</th>
                  <th>BMI</th>
                  <th>Layak</th>
                  <th>Tidak Layak</th>
                  <th>Remark</th>
                  <th>TCA Tarikh</th>
                  <th>TCA Masa</th>
                  <th>TCA Staff</th>
                  <th style="min-width:160px;">Tindakan</th>
                </tr>
              </thead>
              <tbody id="nadiContainer">
                <tr class="text-muted"><td colspan="19" class="text-center">Tiada data. Tambah baris pertama.</td></tr>
              </tbody>
            </table>
          </div>
          <div class="small text-muted mt-2">
            Live Sync aktif: perubahan di Laptop A akan muncul di Laptop B dalam ~3 saat. Selepas selesai, gunakan “Simpan Aktiviti (Rasmi)” untuk hantar ke sheet <code>AKTIVITI_PROGRAM</code>/<code>AKTIVITI_PROGRAM_DETAIL</code>.
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="footer mt-4 py-3 bg-light">
    <div class="container d-flex justify-content-between">
      <div>&copy; 2025 Klinik SihatSokmo</div>
      <div>Versi Live 1.0</div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
  /* =====================
     KONFIGURASI FRONTEND
     ===================== */
  const SCRIPT_URL = '<<TAMPAL_APPS_SCRIPT_URL_ANDA>>';   // e.g. https://script.google.com/macros/s/AKfycb.../exec
  const CLIENT_ID  = '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com'; // Google Identity (aud)
  let ID_TOKEN = '';   // diisi selepas sign-in

  // Auto tarikh semasa
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('ms-MY');

  /* =====================
     GOOGLE SIGN-IN (GIS)
     ===================== */
  window.onload = () => {
    if (window.google && google.accounts && google.accounts.id) {
      google.accounts.id.initialize({ client_id: CLIENT_ID, callback: onGoogleCredential });
      google.accounts.id.renderButton(document.getElementById('signinArea'), { theme:'outline', size:'large' });
      google.accounts.id.prompt();
    }
  };
  async function onGoogleCredential(resp){
    ID_TOKEN = resp.credential || '';
    // Uji whoami
    try{
      const r = await fetch(SCRIPT_URL + '?action=whoami&id_token=' + encodeURIComponent(ID_TOKEN));
      const js = await r.json();
      if (js && js.status === 'success') {
        document.getElementById('signinArea').innerHTML =
          '<span class="badge text-bg-secondary"><i class="bi bi-person-check me-1"></i>'+ (js.email || 'Signed') +'</span>';
      } else {
        document.getElementById('signinArea').innerHTML =
          '<span class="badge text-bg-danger">Akses ditolak</span>';
      }
    }catch(e){
      console.warn(e);
    }
  }

  /* =====================
     UTIL & HELPERS
     ===================== */
  const $ = (q) => document.querySelector(q);
  const $$ = (q) => Array.from(document.querySelectorAll(q));
  const sleep = (ms) => new Promise(r => setTimeout(r, ms));
  const slug = (s) => String(s||'').toLowerCase().trim().replace(/[^a-z0-9]+/g,'-').replace(/(^-|-$)/g,'');

  const toDisplayDate = (iso) => {
    if (!/^\d{4}-\d{2}-\d{2}$/.test(String(iso||''))) return String(iso||'');
    const [Y,M,D] = iso.split('-').map(Number);
    return ('0'+D).slice(-2)+'/'+('0'+M).slice(-2)+'/'+Y;
  };

  // Umur dari IC (YYMMDDxxxxxx)
  function umurDariIC(ic){
    const s = String(ic||'').replace(/\\D/g,'');
    if (s.length < 6) return '';
    const yy = +s.slice(0,2), mm = +s.slice(2,4), dd = +s.slice(4,6);
    if (!(mm>=1&&mm<=12) || !(dd>=1&&dd<=31)) return '';
    const now = new Date(), currentYY = now.getFullYear()%100;
    const year = (yy <= currentYY ? 2000 : 1900) + yy;
    let age = now.getFullYear() - year;
    const b = new Date(year, mm-1, dd);
    if (!(now.getMonth()>b.getMonth() || (now.getMonth()===b.getMonth() && now.getDate()>=b.getDate()))) age--;
    return String(age);
  }

  // Bina SessionId daripada Tajuk+Tarikh
  function currentSessionId(){
    const title = $('#nadiProgramTitle').value.trim();
    const dateIso = $('#nadiProgramDate').value.trim();
    if (!title || !dateIso) return '';
    return slug(title) + '_' + dateIso; // sama dengan backend _titleFromSessionId_
  }

  /* =====================
     RENDER NADI TABLE
     ===================== */
  const nadiBody = $('#nadiContainer');
  let ROW_SEQ = 1;

  function makeRowObj(seed={}){
    return Object.assign({
      id: 'row_'+Date.now()+'_'+Math.random().toString(36).slice(2,7),
      nama:'', ic:'', umur:'', tel:'', alamat:'',
      bp:'', pr:'', dxt:'', tinggi:'', berat:'', bmi:'',
      layak:false, takLayak:false, remark:'',
      tcaDate:'', tcaTime:'', tcaStaff:''
    }, seed);
  }

  function rowHtml(o, idx){
    return `
      <tr data-row-id="${o.id}">
        <td class="text-center">${idx}</td>
        <td><input class="form-control form-control-sm nadi-input n-nama" value="${o.nama||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-ic" value="${o.ic||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-umur" value="${o.umur||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-tel" value="${o.tel||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-alamat" value="${o.alamat||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-bp" value="${o.bp||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-pr" value="${o.pr||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-dxt" value="${o.dxt||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-tinggi" value="${o.tinggi||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-berat" value="${o.berat||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-bmi" value="${o.bmi||''}" /></td>
        <td class="text-center"><input class="form-check-input n-layak" type="checkbox" ${o.layak?'checked':''}></td>
        <td class="text-center"><input class="form-check-input n-tak" type="checkbox" ${o.takLayak?'checked':''}></td>
        <td><input class="form-control form-control-sm nadi-input n-remark" value="${o.remark||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-tcadate" type="date" value="${o.tcaDate||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-tcatime" type="time" value="${o.tcaTime||''}" /></td>
        <td><input class="form-control form-control-sm nadi-input n-tcastaff" value="${o.tcaStaff||''}" /></td>
        <td class="nadi-actions-cell">
          <div class="btn-group btn-group-sm">
            <button class="btn btn-outline-success btn-daftar"><i class="bi bi-person-plus"></i> Daftar</button>
            <button class="btn btn-outline-danger btn-buang"><i class="bi bi-trash"></i></button>
          </div>
        </td>
      </tr>
    `;
  }

  function ensureFirstRowMsg(){
    if (!nadiBody.children.length) {
      nadiBody.innerHTML = '<tr class="text-muted"><td colspan="19" class="text-center">Tiada data. Tambah baris pertama.</td></tr>';
    }
  }

  function addRow(seed={}){
    if (nadiBody.querySelector('.text-muted')) nadiBody.innerHTML='';
    const obj = makeRowObj(seed);
    nadiBody.insertAdjacentHTML('beforeend', rowHtml(obj, ROW_SEQ++));
    wireRow(nadiBody.lastElementChild);
    // auto isi umur dr IC
    const icInput = nadiBody.lastElementChild.querySelector('.n-ic');
    const umurInput = nadiBody.lastElementChild.querySelector('.n-umur');
    icInput.addEventListener('blur', ()=>{ umurInput.value = umurDariIC(icInput.value)||umurInput.value; saveRowDraft(nadiBody.lastElementChild); });
  }

  function wireRow(tr){
    tr.querySelectorAll('input').forEach(inp=>{
      inp.addEventListener('change', ()=> saveRowDraft(tr));
      inp.addEventListener('blur',   ()=> saveRowDraft(tr));
      inp.addEventListener('keyup',  (e)=> { if (['Enter','Tab'].includes(e.key)) saveRowDraft(tr); });
    });
    tr.querySelector('.btn-buang').addEventListener('click', ()=> { tr.remove(); ensureFirstRowMsg(); });
    tr.querySelector('.btn-daftar').addEventListener('click', ()=> { alert('Integrasi Daftar terus ke sheet boleh ditambah. (Frontend demo)'); });
  }

  $('#btnNadiAddRow').addEventListener('click', ()=> addRow());

  /* =====================
     LIVE SYNC (save + poll)
     ===================== */
  const POLL_LIVE_MS = 3000;
  let liveTimer = null;
  let lastSessionId = '';

  // Simpan satu baris (draft) ke Apps Script (NADI_LIVE) — append-only
  async function saveRowDraft(tr){
    const sessionId = currentSessionId();
    if (!sessionId) return; // skip jika belum set title/date
    if (!ID_TOKEN) return;

    const o = rowFromTr(tr);
    try{
      const form = new URLSearchParams();
      form.set('action','saveNadiLive');
      form.set('id_token', ID_TOKEN);
      form.set('sessionId', sessionId);
      form.set('items', JSON.stringify([o]));
      const res = await fetch(SCRIPT_URL, { method:'POST', body:form });
      const js = await res.json();
      // console.log('saveNadiLive', js);
    }catch(e){
      console.warn('saveNadiLive gagal', e);
    }
  }

  function rowFromTr(tr){
    return {
      id: tr.getAttribute('data-row-id'),
      nama: tr.querySelector('.n-nama')?.value || '',
      ic: tr.querySelector('.n-ic')?.value || '',
      umur: tr.querySelector('.n-umur')?.value || '',
      tel: tr.querySelector('.n-tel')?.value || '',
      alamat: tr.querySelector('.n-alamat')?.value || '',
      bp: tr.querySelector('.n-bp')?.value || '',
      pr: tr.querySelector('.n-pr')?.value || '',
      dxt: tr.querySelector('.n-dxt')?.value || '',
      tinggi: tr.querySelector('.n-tinggi')?.value || '',
      berat: tr.querySelector('.n-berat')?.value || '',
      bmi: tr.querySelector('.n-bmi')?.value || '',
      layak: tr.querySelector('.n-layak')?.checked || false,
      takLayak: tr.querySelector('.n-tak')?.checked || false,
      remark: tr.querySelector('.n-remark')?.value || '',
      tcaDate: tr.querySelector('.n-tcadate')?.value || '',
      tcaTime: tr.querySelector('.n-tcatime')?.value || '',
      tcaStaff: tr.querySelector('.n-tcastaff')?.value || ''
    };
  }

  // Merge item → baris sedia ada / tambah baru jika tiada
  function upsertLiveRow(item){
    let tr = nadiBody.querySelector('tr[data-row-id="'+ (item.id||'') +'"]');
    if (!tr){
      addRow({ id:item.id });
      tr = nadiBody.querySelector('tr[data-row-id="'+ (item.id||'') +'"]');
    }
    // Isi nilai
    tr.querySelector('.n-nama').value   = item.nama   || '';
    tr.querySelector('.n-ic').value     = item.ic     || '';
    tr.querySelector('.n-umur').value   = item.umur   || '';
    tr.querySelector('.n-tel').value    = item.tel    || '';
    tr.querySelector('.n-alamat').value = item.alamat || '';
    tr.querySelector('.n-bp').value     = item.bp     || '';
    tr.querySelector('.n-pr').value     = item.pr     || '';
    tr.querySelector('.n-dxt').value    = item.dxt    || '';
    tr.querySelector('.n-tinggi').value = item.tinggi || '';
    tr.querySelector('.n-berat').value  = item.berat  || '';
    tr.querySelector('.n-bmi').value    = item.bmi    || '';
    tr.querySelector('.n-layak').checked= !!item.layak;
    tr.querySelector('.n-tak').checked  = !!item.takLayak;
    tr.querySelector('.n-remark').value = item.remark || '';
    tr.querySelector('.n-tcadate').value= item.tcaDate|| '';
    tr.querySelector('.n-tcatime').value= item.tcaTime|| '';
    tr.querySelector('.n-tcastaff').value= item.tcaStaff|| '';
  }

  // Poll getNadiLive setiap 3s
  async function pollLive(){
    const sid = currentSessionId();
    if (!sid || !ID_TOKEN) return;

    // Reset jika tukar sesi
    if (sid !== lastSessionId){
      lastSessionId = sid;
      // kosongkan jadual (pilihan) — atau biarkan
      // nadiBody.innerHTML='';
      ensureFirstRowMsg();
    }

    try{
      const qs = new URLSearchParams({ action:'getNadiLive', sessionId: sid, id_token: ID_TOKEN });
      const r = await fetch(SCRIPT_URL + '?' + qs.toString());
      const js = await r.json();
      if (js && js.status === 'success' && Array.isArray(js.items)){
        js.items.forEach(upsertLiveRow);
      }
    }catch(e){
      console.warn('poll getNadiLive gagal', e);
    }
  }

  function startLive(){
    if (liveTimer) clearInterval(liveTimer);
    liveTimer = setInterval(pollLive, POLL_LIVE_MS);
  }

  // Mula polling bila user set Title & Date
  $('#nadiProgramTitle').addEventListener('change', startLive);
  $('#nadiProgramDate').addEventListener('change', startLive);

  // Default: set tarikh hari ini
  (function setToday(){
    const d=new Date(); const mm=('0'+(d.getMonth()+1)).slice(-2); const dd=('0'+d.getDate()).slice(-2);
    $('#nadiProgramDate').value = d.getFullYear()+'-'+mm+'-'+dd;
  })();

  // Button Simpan Rasmi → panggil saveNadiActivity (sama seperti fail anda)
  $('#btnNadiSaveOfficial').addEventListener('click', async ()=>{
    const title = $('#nadiProgramTitle').value.trim();
    const dateIso = $('#nadiProgramDate').value.trim();
    if (!title || !dateIso) { alert('Isi Tajuk & Tarikh Program'); return; }

    const items = Array.from(nadiBody.querySelectorAll('tr[data-row-id]')).map(rowFromTr);
    const form = new URLSearchParams();
    form.set('action','saveNadiActivity');
    form.set('id_token', ID_TOKEN);
    form.set('staff','SYSTEM');
    form.set('programTitle', title);
    form.set('programDate', dateIso);
    form.set('items', JSON.stringify(items));

    try{
      const res = await fetch(SCRIPT_URL, { method:'POST', body:form });
      const js = await res.json();
      if (js && js.status === 'success'){
        alert('Simpan Rasmi berjaya! ActivityId: ' + js.activityId);
      } else {
        alert('Gagal simpan rasmi: ' + (js && (js.message||js.code) || 'Unknown'));
      }
    }catch(e){
      alert('Ralat sambungan: ' + e);
    }
  });

  // Mula live polling awal (akan idle sehingga Title/Date diisi)
  startLive();
  </script>
</body>
</html>
