<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Sistem Tracker PEKA B40 - Klinik SihatSokmo</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- SheetJS (Excel) robust loader -->
  <script>
    (function () {
      if (window.XLSX) return;

      // Muat <script> sekali sahaja
      window.loadScriptOnce = window.loadScriptOnce || (function () {
        const loaded = new Set();
        return function loadScriptOnce(url) {
          return new Promise((resolve, reject) => {
            if (loaded.has(url)) return resolve();
            const s = document.createElement('script');
            s.src = url; s.async = true;
            s.onload = () => { loaded.add(url); resolve(); };
            s.onerror = () => reject(new Error('Gagal muat: ' + url));
            document.head.appendChild(s);
          });
        };
      })();

      // Pastikan XLSX wujud, cuba beberapa CDN
      window.ensureXLSXReady = async function ensureXLSXReady() {
        if (window.XLSX) return;
        const cdns = [
          'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
        ];
        let lastErr;
        for (const url of cdns) {
          try {
            await window.loadScriptOnce(url);
            if (window.XLSX) { console.log('[XLSX] Loaded from', url); return; }
          } catch (e) { lastErr = e; }
        }
        console.error('[XLSX] Gagal dimuat dari semua CDN.', lastErr || '');
        throw new Error('XLSX gagal dimuat.');
      };
    })();
  </script>

  <!-- Google Identity Services (Sign-In) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- html2canvas untuk tangkap preview → imej -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- AUTH & API HELPERS -->
  <script>
    function getIdToken() {
      return (
        window.ID_TOKEN ||
        localStorage.getItem('id_token') ||
        sessionStorage.getItem('id_token') ||
        ''
      );
    }
    async function apiGet(action, params = {}) {
      const id_token = getIdToken();
      const q = new URLSearchParams({ action, id_token, ...params });
      const url = location.pathname + '?' + q.toString();
      const res = await fetch(url, { method: 'GET' });
      try { return await res.json(); } catch { return { status:'error', message:'Respon bukan JSON' }; }
    }
    async function apiPost(action, body = {}) {
      const id_token = getIdToken();
      const form = new URLSearchParams({ action, id_token, ...body });
      const res = await fetch(location.pathname, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
        body: form.toString()
      });
      try { return await res.json(); } catch { return { status:'error', message:'Respon bukan JSON' }; }
    }
  </script>

  <style>
    :root{ --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12; --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6; }
    html{ font-size:15px; }
    @media (max-width:1200px){ html{ font-size:14px; } }
    @media (max-width:576px){ html{ font-size:13px; } }

    html,body{height:100%}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;color:#333}

    /* Navbar */
    .navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
    .navbar-brand{font-weight:700;color:var(--primary);font-size:1.05rem;display:flex;align-items:center;gap:10px}
    .nav-link{color:var(--dark);font-weight:500;margin:0 4px;padding:7px 10px!important;border-radius:8px;transition:.2s;position:relative}
    .nav-link:hover,.nav-link.active{background:rgba(52,152,219,.12);color:var(--secondary)}
    .nav-badge{ position:absolute; top:-4px; right:-2px; transform:translate(30%,-30%); background:#dc3545; color:#fff; border-radius:999px; font-size:.65rem; padding:2px 6px; display:none; }

    /* Header */
    .page-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:14px 0;margin-bottom:12px;border-radius:0 0 12px 12px}

    /* Cards & tables */
    .card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:16px}
    .card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;padding:12px 16px;border-radius:14px 14px 0 0!important}
    .stat-card{padding:14px;border-radius:14px;color:#fff;text-align:center;position:relative;overflow:hidden;cursor:pointer}
    .stat-card .number{font-size:1.45rem;font-weight:800}
    .table td,.table th{vertical-align:middle}
    .table{font-size:.95rem}
    .searchbar{max-width:340px}
    .mini-actions .btn{margin-right:6px;margin-bottom:6px}

    /* Global App Loader */
    #appLoader{ position:fixed; inset:0; z-index:2000; display:none; background: radial-gradient(1200px 600px at 10% -10%, rgba(52,152,219,.18), transparent), radial-gradient(1200px 600px at 110% 110%, rgba(46,204,113,.18), transparent), rgba(255,255,255,.35); backdrop-filter: blur(10px); }
    #appLoader .loader-card{ position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:rgba(255,255,255,.75); border:1px solid rgba(255,255,255,.6); box-shadow: 0 20px 40px rgba(0,0,0,.12); border-radius:18px; padding:16px 18px; min-width:220px; text-align:center; }
    .spinner-premium{ width:36px;height:36px;border-radius:50%; border:4px solid rgba(52,152,219,.25); border-top-color:#3498db; animation:spin .9s linear infinite; margin:6px auto 8px; }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Log Calls Drawer */
    #logDrawer{ position:fixed; top:0; right:-420px; width:400px; max-width:90vw; height:100%; background:#f8f9fb; box-shadow:-12px 0 35px rgba(0,0,0,.18); z-index:3000; transition:right .25s ease; border-left:1px solid rgba(0,0,0,.05); display:flex; flex-direction:column; }
    #logDrawer.open{ right:0; }
    .log-header{ padding:10px 12px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06); display:flex; gap:8px; align-items:center; }
    .log-header .title{font-weight:700; color:#222; flex:1}
    .log-search{ padding:8px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06); }
    .log-body{ padding:10px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; }
    .bubble{ max-width:80%; padding:8px 10px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.06); position:relative; font-size:.9rem; line-height:1.2rem; }
    .bubble.me{ margin-left:auto; background:#007aff; color:#fff; border-bottom-right-radius:6px; }
    .bubble.other{ margin-right:auto; background:#e9ecef; color:#222; border-bottom-left-radius:6px; }
    .bubble .meta{ font-size:.72rem; opacity:.8; margin-top:5px }
    .log-loading{ display:none; text-align:center; padding:8px }
    .log-loading.active{ display:block }

    /* FAB */
    #fabLog{ position:fixed; right:18px; bottom:18px; z-index:3500; width:56px; height:56px; border-radius:50%; display:flex; align-items:center; justify-content:center; box-shadow:0 10px 24px rgba(0,0,0,.18); }

    /* Toast Host */
    #toastHost{ position: fixed; top: 0; left: 0; right: 0; padding: 12px; z-index: 4000; pointer-events: none; display: flex; justify-content: flex-end; align-items: flex-start; box-sizing: border-box; }
    #toastContainer{ display: flex; flex-direction: column; gap: 8px; }
    #toastHost .toast{ pointer-events: auto; box-sizing: border-box; width: max-content; max-width: min(92vw, 420px); word-wrap: break-word; overflow-wrap: anywhere; }
    #logDrawer.open ~ #toastHost{ justify-content: flex-start; }
    @media (max-width: 576px){ #toastHost{ padding: 8px; } #toastHost .toast{ max-width: 96vw; } }

    /* NADI TABLE STYLES */
    .nadi-scroll-container { overflow-x: auto; width: 100%; padding-bottom: 8px; }
    .nadi-table { width: 100%; min-width: 1300px; border-collapse: separate; border-spacing: 0; }
    .nadi-table th { background: #f8f9fa; padding: 10px 8px; font-weight: 600; text-align: center; position: sticky; top: 0; z-index: 10; border: 1px solid #dee2e6; }
    .nadi-table td { padding: 8px; vertical-align: middle; border: 1px solid #dee2e6; }
    .nadi-input-cell { position: relative; }
    .nadi-input-cell .view-mode { width: 100%; padding: 6px 8px; cursor: pointer; border: 1px solid transparent; border-radius: 4px; min-height: 36px; display: flex; align-items: center; }
    .nadi-input-cell .view-mode:hover { background-color: #f8f9fa; border: 1px solid #dee2e6; }
    .nadi-input-cell input { width: 100%; min-width: 100px; border: 1px solid #ced4da; border-radius: 4px; padding: 6px 8px; transition: width 0.2s ease; }
    .nadi-input-cell input:focus { width: auto; min-width: 100px; }
    .nadi-checkbox-cell { text-align: center; }
    .nadi-actions-cell { min-width: 180px; }
    .nadi-counter { background: var(--primary); color: white; border-radius: 50%; width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.75rem; }

    /* Responsive */
    @media (max-width: 992px) { .stat-card .number{font-size:1.3rem} }

    /* Form sections */
    .form-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .form-section h5 { color: var(--primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .sticky-form-actions { position: sticky; bottom: 0; background: white; padding: 12px; border-top: 1px solid #eee; margin-top: 16px; }

    /* WhatsApp Report Image */
    .whatsapp-report { width: 100%; max-width: 500px; background: white; border-radius: 12px; padding: 20px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; }
    .whatsapp-report-header { display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee; }
    .whatsapp-report-logo { width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; border: 1px solid rgba(0,0,0,0.08); }
    .whatsapp-report-title { font-size: 18px; font-weight: 700; color: var(--primary); }
    .whatsapp-report-subtitle { font-size: 14px; color: var(--muted); }
    .whatsapp-report-body { margin-bottom: 15px; }
    .whatsapp-report-row { display: flex; margin-bottom: 8px; }
    .whatsapp-report-label { font-weight: 600; width: 120px; color: var(--dark); }
    .whatsapp-report-value { flex: 1; }
    .whatsapp-report-footer { text-align: center; font-size: 12px; color: var(--muted); margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }

    .monitor-card .stat { font-size: 28px; font-weight: 700; line-height: 1; }
    .monitor-card .label { font-size: 12px; text-transform: uppercase; letter-spacing: .06em; }

    /* NADI Summary Cards */
    .nadi-summary-container { display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap; }
    .nadi-summary-card { flex: 1; min-width: 200px; background: white; border-radius: 10px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); text-align: center; }
    .nadi-summary-card .title { font-size: 0.9rem; color: var(--muted); margin-bottom: 8px; }
    .nadi-summary-card .count { font-size: 1.5rem; font-weight: 700; }
    .nadi-summary-card.layak { border-top: 4px solid var(--success); }
    .nadi-summary-card.tak-layak { border-top: 4px solid var(--danger); }
  </style>
</head>
<body>
  <!-- Global Loader -->
  <div id="appLoader" aria-hidden="true">
    <div class="loader-card">
      <div class="spinner-premium"></div>
      <div class="fw-bold">Sila tunggu…</div>
      <div class="text-muted small" id="loaderMsg">Memproses permintaan anda</div>
    </div>
  </div>

  <!-- Log Calls Drawer -->
  <div id="logDrawer" aria-hidden="true">
    <div class="log-header">
      <button class="btn btn-sm btn-outline-secondary" id="btnCloseLog"><i class="bi bi-x-lg"></i></button>
      <div class="title"><i class="bi bi-chat-dots me-1"></i> Log Calls</div>
      <div id="logBadge" class="badge text-bg-primary">0</div>
    </div>
    <div class="log-search">
      <input id="logSearch" class="form-control form-control-sm" placeholder="Cari: nama / IC / telefon / staff…" />
    </div>
    <div id="logLoading" class="log-loading">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div class="small text-muted mt-1">Memuat Log Calls…</div>
    </div>
    <div id="logBody" class="log-body"></div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-main sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#dashboard">
        <img id="brandLogo" alt="Logo" style="width:32px;height:32px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,.08)">
        <span>Klinik SihatSokmo</span>
      </a>

      <!-- Google Sign-in button placeholder -->
      <div id="signinArea" class="d-lg-none me-2"></div>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item position-relative">
            <a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#nadi"><i class="bi bi-clipboard2-pulse"></i> Program PEKA B40 bersama NADI</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#daftar-peka"><i class="fas fa-user-plus"></i> Daftar Peka</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a>
            <span id="badgeTCA" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a>
            <span id="badgeFirst" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab Report</a>
            <span id="badgeLab" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a>
            <span id="badgeSecond" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a>
          </li>
        </ul>

        <div class="d-none d-lg-flex align-items-center gap-2">
          <div id="signinAreaDesktop"></div>
          <span id="staffBadge" class="badge bg-secondary d-none"><i class="bi bi-person-check me-1"></i><span id="staffEmail"></span></span>
          <!-- (Butang Log Calls terapung di bawah – tidak dalam navbar) -->
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <div class="container">
      <div class="row align-items-center g-2">
        <div class="col-md-6">
          <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
          <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
        </div>
        <div class="col-md-6 text-md-end">
          <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Dashboard -->
    <section id="dashboard" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-success" id="btnExportCSV"><i class="fa-solid fa-file-csv me-1"></i>Export (CSV)</button>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#tca-call" style="background:linear-gradient(135deg,var(--secondary),#2980b9)">
            <div class="number" id="totalDaftar">0</div><div class="small">Aktif</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#first-visit" style="background:linear-gradient(135deg,var(--warning),#e67e22)">
            <div class="number" id="totalFirstVisit">0</div><div class="small">First Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#second-visit" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">
            <div class="number" id="totalSecondVisit">0</div><div class="small">Second Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#selesai" style="background:linear-gradient(135deg,var(--success),#16a085)">
            <div class="number" id="totalSelesai">0</div><div class="small">Selesai</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#8e44ad,#6c5ce7)">
            <div class="number" id="labFollowUpDue">0</div><div class="small">Result > 3 Hari</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#d35400,#c0392b)">
            <div class="number" id="labFollowUpPending">0</div><div class="small">Perlu Follow-up</div>
          </div>
        </div>
      </div>

      <!-- Pesakit perlu dihubungi -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi Hari Ini</span>
          <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefon…" />
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
              <tbody id="tcaCallTable"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Statistik -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriod" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:320px;"><canvas id="stats3dChart"></canvas></div></div>
      </div>
    </section>

    <!-- Program NADI -->
    <section id="nadi" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="bi bi-clipboard2-pulse me-2"></i>Program PEKA B40 bersama NADI</h2>
        <div class="d-flex gap-2">
          <button id="btnNadiExportCsv" class="btn btn-sm btn-outline-success"><i class="bi bi-filetype-csv me-1"></i>Export to CSV</button>
          <button id="btnMonitorAll" class="btn btn-outline-primary">Monitor Semua (Live)</button>
        </div>
      </div>

      <!-- Summary Cards -->
      <div class="nadi-summary-container">
        <div class="nadi-summary-card layak">
          <div class="title">Layak PEKA B40</div>
          <div class="count" id="nadiLayakCount">0</div>
        </div>
        <div class="nadi-summary-card tak-layak">
          <div class="title">Tidak Layak</div>
          <div class="count" id="nadiTakLayakCount">0</div>
        </div>
      </div>

      <!-- BAR PROGRAM -->
      <div id="nadiProgramBar" class="d-flex flex-wrap gap-2 align-items-end mb-2">
        <div class="flex-grow-1">
          <label class="form-label mb-1">Tajuk Program</label>
          <input id="nadiProgramTitle" class="form-control form-control-sm" placeholder="cth: Saringan Komuniti Tmn Mawar">
        </div>
        <div>
          <label class="form-label mb-1">Tarikh Program</label>
          <input id="nadiProgramDate" type="date" class="form-control form-control-sm">
        </div>
        <div class="ms-auto d-flex gap-2">
          <button id="btnNadiSaveActivity" class="btn btn-sm btn-primary">
            <i class="bi bi-cloud-upload me-1"></i>Simpan Aktiviti (Semua)
          </button>
        </div>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="nadi-scroll-container">
            <table class="nadi-table">
              <thead>
                <tr>
                  <th style="width: 40px;">#</th>
                  <th style="min-width: 150px;">Nama Pesakit</th>
                  <th style="min-width: 120px;">No IC</th>
                  <th style="min-width: 80px;">Umur</th>
                  <th style="min-width: 120px;">Telefon</th>
                  <th style="min-width: 150px;">Alamat</th>
                  <th style="min-width: 80px;">BP</th>
                  <th style="min-width: 80px;">PR</th>
                  <th style="min-width: 120px;">DXT</th>
                  <th style="min-width: 80px;">Tinggi</th>
                  <th style="min-width: 80px;">Berat</th>
                  <th style="min-width: 80px;">BMI</th>
                  <th style="width: 80px;">Layak</th>
                  <th style="width: 100px;">Tidak Layak</th>
                  <th style="min-width: 160px;">Remark</th>
                  <th style="min-width: 200px;">TCA & Staff</th>
                  <th style="min-width: 180px;">Tindakan</th>
                </tr>
              </thead>
              <tbody id="nadiContainer">
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
          <div class="sticky-form-actions">
            <button class="btn btn-primary" onclick="addNadiRow()"><i class="bi bi-plus-circle me-1"></i>Tambah Pesakit</button>
          </div>
          <div class="text-muted small mt-2">Nota: Baris "Layak" boleh terus <b>Daftar</b> (simpan ke sheet). Baris "Tidak Layak" <u>tidak</u> disimpan ke sheet tetapi <b>tetap dieksport CSV</b> bersama-sama.</div>
        </div>
      </div>
    </section>

    <!-- Daftar Peka -->
    <section id="daftar-peka" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-user-plus me-2"></i>Daftar Peka</h2>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-circle me-2"></i>Maklumat Pesakit</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Penuh Pesakit</label>
            <input id="namaPesakit" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor IC</label>
            <input id="noIC" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor Telefon</label>
            <input id="noTelefon" class="form-control" type="tel" required placeholder="cth: 0123456789 atau 60123456789">
          </div>
          <div class="col-md-6">
            <label class="form-label">Alamat Pesakit</label>
            <textarea id="alamatPesakit" class="form-control" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-calendar-alt me-2"></i>Tarikh Temujanji</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Tarikh TCA</label>
            <input id="tarikhTCA" class="form-control" type="date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Masa TCA</label>
            <input id="masaTCA" class="form-control" type="time" required>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-tie me-2"></i>Maklumat Staff</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Staff</label>
            <input id="namaStaff" class="form-control" required>
          </div>
        </div>
      </div>

      <div class="sticky-form-actions">
        <button class="btn btn-primary" id="btnDaftarPesakit"><i class="fas fa-save me-1"></i>Daftar Pesakit</button>
      </div>
    </section>

    <!-- Kelayakan (Excel) -->
    <section id="kelayakan" class="mb-4 d-none">
      <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel)</h2>
      <div class="card"><div class="card-body">
        <div class="row g-2 align-items-center mb-3">
          <div class="col-md-6">
            <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls,.csv" />
            <div class="form-text">Fail perlu ada lajur: <b>Nama</b>, <b>IC</b>, <b>Telefon</b>, <b>Alamat</b>. (Sistem tapis umur ≥40 ikut IC)</div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th>
                <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
                <th style="width:360px">Jika Layak → TCA & Masa & Staff</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="kelayakanTable"><tr><td colspan="8" class="text-center text-muted">Muat naik Excel untuk mula.</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- TCA Call -->
    <section id="tca-call" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-phone me-2"></i>Senarai Rekod TCA Call</h2>
        <div class="d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="group" id="tcaFilter">
            <button class="btn btn-outline-primary active" data-filter="today">Hari ini</button>
            <button class="btn btn-outline-primary" data-filter="upcoming">Akan datang</button>
            <button class="btn btn-outline-primary" data-filter="past">Lepas</button>
            <button class="btn btn-outline-secondary" data-filter="all">Semua</button>
          </div>
          <input class="form-control form-control-sm searchbar" id="searchTCAPage" placeholder="Cari nama/IC/telefon…"/>
        </div>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
            <tbody id="tcaCallList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- First Visit -->
    <section id="first-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchFirst" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="firstVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Follow-up Lab Report -->
    <section id="lab-followup" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
        <input class="form-control form-control-sm searchbar" id="searchLab" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th><th>Tindakan</th></tr>
            </thead>
            <tbody id="labFollowupTable"><tr><td colspan="8" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Second Visit -->
    <section id="second-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchSecond" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="secondVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Selesai -->
    <section id="selesai" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
        <input class="form-control form-control-sm searchbar" id="searchCompleted" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card mb-3"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>PDPA</th>
                <th>Tarikh Daftar</th><th>First Visit</th><th>Lab Report Completed</th><th>Second Visit</th><th>Tarikh Selesai</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="completedTable"><tr><td colspan="11" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriodCompleted" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:300px;"><canvas id="completed3dChart"></canvas></div></div>
      </div>
    </section>

    <!-- Monitor Semua (Live) Page -->
    <section id="monitorAllSection" class="page" style="display:none;">
      <div class="d-flex align-items-center gap-2 mb-3">
        <h3 class="mb-0">Monitor Semua Program (Live)</h3>
        <input id="monitorDate" type="date" class="form-control" style="max-width:200px;">
        <button class="btn btn-primary" id="btnRefreshMonitor">Segar Semula</button>
      </div>

      <div id="monitorInfo" class="text-muted mb-2"></div>
      <div id="monitorCards" class="row g-3"></div>
    </section>

    <!-- Arkib -->
    <section id="arkib" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
        <input class="form-control form-control-sm searchbar" id="searchArchive" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th><th>Tindakan</th></tr></thead>
            <tbody id="archiveTable"><tr><td colspan="8" class="text-center text-muted">Tiada rekod arkib</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>
  </main>

  <!-- Modal Re-TCA -->
  <div class="modal fade" id="retcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Daftar TCA Semula</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="retcaIC">
        <div class="mb-3"><label class="form-label">Tarikh TCA Baharu</label><input type="date" id="retcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA Baharu</label><input type="time" id="retcaTime" class="form-control" required></div>
        <small class="text-muted">Status pesakit akan ditukar kepada <b>TCA CALL</b>.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitRetca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Set Second Visit TCA -->
  <div class="modal fade" id="secondTcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-check me-2"></i>Tetapkan TCA Second Visit</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="secondTcaIC">
        <div class="mb-2"><label class="form-label">Tarikh TCA Second Visit</label><input type="date" id="secondTcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA</label><input type="time" id="secondTcaTime" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Nama Staff (wajib isi)</label><input type="text" id="secondTcaStaff" class="form-control" required placeholder="cth: Dayah"></div>
        <small class="text-muted">Maklumat ini akan direkod ke Log Calls & ruangan "Lab Report Completed".</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitSecondTca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Upload PDPA -->
  <div class="modal fade" id="pdpaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i>Muat Naik Borang PDPA</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="pdpaIC">
        <input type="file" id="pdpaFile" class="form-control" accept="application/pdf,image/*" />
        <div class="form-text">Muat naik PDF / imej borang PDPA pesakit.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button class="btn btn-primary" id="btnUploadPDPA"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload</button>
      </div>
    </div></div>
  </div>

  <!-- Modal WhatsApp Report Preview -->
  <div class="modal fade" id="whatsappReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-brands fa-whatsapp me-2"></i>Pratonton Laporan WhatsApp</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="whatsappReportPreview"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button class="btn btn-outline-success" id="btnSendWhatsApp"><i class="fa-brands fa-whatsapp me-1"></i> Hantar WhatsApp (Teks)</button>
        <button class="btn btn-success" id="btnSendWhatsAppImage"><i class="fa-brands fa-whatsapp me-1"></i> Hantar Gambar ke WhatsApp</button>
      </div>
    </div></div>
  </div>

  <!-- Toast Host (kanan atas) -->
  <div id="toastHost"><div id="toastContainer" class="toast-container"></div></div>

  <!-- FAB Log Calls -->
  <button id="fabLog" class="btn btn-primary"><i class="bi bi-chat-dots fs-5"></i></button>

  <footer class="footer mt-4 py-3 bg-light">
    <div class="container"><div class="d-flex justify-content-between">
      <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
      <div>Versi 3.1 (Secure)</div>
    </div></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- =====================
       Skrip Bahagian A
       ===================== -->
  <script>
  // Util am (sekali sahaja)
  function escapeHtml(s){
    return String(s||'').replace(/[&<>"'`=\/]/g, function (c) {
      return {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'}[c];
    });
  }

  // ------------------------
  // KELAYAKAN: CSV-first, XLSX fallback (IIFE)
  // ------------------------
  (function () {
    const fileInput = document.getElementById('excelFile');
    const tableBody = document.getElementById('kelayakanTable');
    if (!fileInput || !tableBody) return;

    const norm = (v) => String(v ?? '').trim();

    function umurDariIC(ic) {
      const s = String(ic || '').replace(/\D/g, '');
      if (s.length < 6) return null;
      const yy = +s.slice(0,2), mm = +s.slice(2,4), dd = +s.slice(4,6);
      if (!(mm>=1 && mm<=12) || !(dd>=1 && dd<=31)) return null;
      const now = new Date();
      const currentYY = now.getFullYear() % 100;
      const year = (yy <= currentYY ? 2000 : 1900) + yy;
      let age = now.getFullYear() - year;
      const bday = new Date(year, mm - 1, dd);
      if (!(now.getMonth() > bday.getMonth() || (now.getMonth() === bday.getMonth() && now.getDate() >= bday.getDate()))) {
        age--;
      }
      return age;
    }

    // File readers
    const readAsArrayBuffer = (file) => new Promise((res, rej) => { const fr = new FileReader(); fr.onload = e => res(e.target.result); fr.onerror = rej; fr.readAsArrayBuffer(file); });
    const readAsText = (file) => new Promise((res, rej) => { const fr = new FileReader(); fr.onload = e => res(e.target.result); fr.onerror = rej; fr.readAsText(file, 'utf-8'); });

    // CSV helpers
    const stripBOM = (s) => s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;
    function detectDelimiter(s) {
      const sample = (s || '').slice(0, 3000);
      const cand = [',',';','\t','|'];
      const count = { ',':0, ';':0, '\t':0, '|':0 };
      let inQ = false;
      for (let i=0;i<sample.length;i++){
        const c = sample[i];
        if (c === '"') {
          if (inQ && sample[i+1] === '"') { i++; }
          else inQ = !inQ;
        } else if (!inQ && count.hasOwnProperty(c)) {
          count[c]++;
        }
      }
      return cand.sort((a,b)=>count[b]-count[a])[0] || ',';
    }
    function parseCSVToRows(text) {
      text = stripBOM(String(text||''));
      const delim = detectDelimiter(text);
      const rows = [];
      let row=[], field='', inQ=false;
      for (let i=0;i<text.length;i++){
        const c = text[i];
        if (inQ) {
          if (c === '"') {
            if (text[i+1] === '"') { field += '"'; i++; }
            else inQ = false;
          } else field += c;
        } else {
          if (c === '"') inQ = true;
          else if (c === delim) { row.push(field); field=''; }
          else if (c === '\n')  { row.push(field); rows.push(row); row=[]; field=''; }
          else if (c === '\r')  { /* skip */ }
          else field += c;
        }
      }
      row.push(field); rows.push(row);
      return rows;
    }

    // Header detection
    const keysets = {
      nama:    ['nama','nama penuh','name','nama pesakit'],
      ic:      ['ic','no ic','no. ic','nric','nokp','no kp','no. kp','kp','mykad','no mykad','no k/p','k/p','kad pengenalan','no kad pengenalan'],
      telefon: ['telefon','no telefon','no. telefon','no tel','no. tel','tel','mobile','hp','no hp','h/p','no h/p','whatsapp','no whatsapp','telefon (whatsapp)'],
      alamat:  ['alamat','address','addr','alamat rumah','alamat kediaman']
    };
    const canon = (s) => String(s||'').toLowerCase().replace(/[\s\.-_/()]+/g,'').trim();
    function scoreHeaderCell(cell) {
      const t = canon(cell);
      const hit = [];
      for (const [k, list] of Object.entries(keysets)) {
        if (list.some(p => t.includes(canon(p)))) hit.push(k);
      }
      return [...new Set(hit)];
    }
    function findHeaderRow(rows) {
      let best = { idx: 0, score: 0 };
      for (let r=0; r<Math.min(rows.length, 20); r++) {
        const hits = new Set();
        for (const c of rows[r]) scoreHeaderCell(c).forEach(k => hits.add(k));
        const sc = hits.size;
        if (sc > best.score) best = { idx: r, score: sc };
      }
      return (best.score >= 2) ? best.idx : 0;
    }
    function csvTextToObjects(text) {
      const rows = parseCSVToRows(text);
      if (!rows.length) return [];
      const headerRow = findHeaderRow(rows);
      const header = rows[headerRow].map(h => String(h||'').trim());
      const dataRows = rows.slice(headerRow+1);
      return dataRows
        .filter(r => r.some(v => String(v||'').trim() !== ''))
        .map(r => { const o = {}; for (let i=0;i<header.length;i++) o[header[i]] = r[i] ?? ''; return o; });
    }
    function mapRow(raw) {
      const entries = Object.entries(raw);
      const pick = (groups) => {
        for (const [k,v] of entries) { const t = canon(k); if (groups.some(word => t.includes(canon(word)))) return norm(v); }
        for (const [k,v] of entries) { const t = canon(k); if (groups.some(word => canon(word).includes(t))) return norm(v); }
        return '';
      };
      return { nama: pick(keysets.nama), ic: pick(keysets.ic), telefon: pick(keysets.telefon), alamat: pick(keysets.alamat) };
    }

    function renderRows(items) {
      if (!items.length) {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Tiada data ditemui (semak header CSV anda).</td></tr>';
        return;
      }
      tableBody.innerHTML = items.map((it, idx) => {
        const age = umurDariIC(it.ic);
        const eligible = (age !== null) ? age >= 40 : false;
        const reason = (age === null) ? 'IC tidak sah' : (eligible ? '-' : `Umur ${age} tahun (&lt; 40)`);
        return `
          <tr data-idx="${idx}">
            <td>${escapeHtml(it.nama) || '-'}</td>
            <td>${escapeHtml(it.ic) || '-'}</td>
            <td>${escapeHtml(it.telefon) || '-'}</td>
            <td>${escapeHtml(it.alamat) || '-'}</td>
            <td class="text-center">${eligible ? '<span class="badge text-bg-success">Layak</span>' : '<span class="badge text-bg-danger">Tidak Layak</span>'}</td>
            <td class="text-center">${escapeHtml(reason)}</td>
            <td>${eligible ? `
              <div class="row g-1">
                <div class="col"><input type="date" class="form-control form-control-sm tca-date"></div>
                <div class="col"><input type="time" class="form-control form-control-sm tca-time"></div>
                <div class="col"><input type="text" class="form-control form-control-sm tca-staff" placeholder="Staff"></div>
              </div>` : '<span class="text-muted">—</span>'}
            </td>
            <td>${eligible ? '<button class="btn btn-sm btn-primary daftar-row"><i class="fas fa-save me-1"></i>Daftar</button>' : '<span class="text-muted">—</span>'}</td>
          </tr>`;
      }).join('');
    }

    async function handleFile(file) {
      try {
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Memproses fail…</td></tr>';
        const ext = (file.name.split('.').pop() || '').toLowerCase();
        if (ext === 'csv') {
          const text = await readAsText(file);
          const raw  = csvTextToObjects(text);
          const items = raw.map(mapRow).filter(r => r.nama || r.ic || r.telefon || r.alamat);
          if (!items.length) {
            const rows = parseCSVToRows(text); const headerRow = findHeaderRow(rows);
            const hdrs = (rows[headerRow] || []).slice(0,8).map(h=>escapeHtml(h)).join(', ');
            tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">CSV dibaca tetapi tiada lajur sepadan.<br><small><b>Jumpa header:</b> ${hdrs || '(kosong)'}<br>Pastikan ada lajur seperti <i>Nama, IC/NRIC/KP, Telefon/HP/WhatsApp, Alamat</i>.</small></td></tr>`;
            return;
          }
          window.__KELAYAKAN_ITEMS__ = items; renderRows(items); return;
        }
        // XLSX/XLS
        if (typeof window.ensureXLSXReady === 'function') { try { await window.ensureXLSXReady(); } catch(e){} }
        if (!window.XLSX) {
          tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">SheetJS tidak tersedia. Sila simpan Excel sebagai <b>CSV</b> dan muat naik semula.</td></tr>';
          return;
        }
        const data = await readAsArrayBuffer(file);
        const wb   = XLSX.read(data, { type: 'array' });
        const ws   = wb.Sheets[wb.SheetNames[0]];
        const raw  = XLSX.utils.sheet_to_json(ws, { defval: '', raw: true });
        const items = raw.map(mapRow).filter(r => r.nama || r.ic || r.telefon || r.alamat);
        if (!items.length) {
          const hdrs = Object.keys(raw[0] || {}).slice(0,8).join(', ');
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">Excel dibaca tetapi tiada lajur sepadan.<br><small><b>Jumpa header:</b> ${escapeHtml(hdrs)}<br>Pastikan ada lajur seperti <i>Nama, IC/NRIC/KP, Telefon/HP/WhatsApp, Alamat</i>.</small></td></tr>`;
          return;
        }
        window.__KELAYAKAN_ITEMS__ = items; renderRows(items);
      } catch (err) {
        console.error(err);
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Ralat memproses fail. Pastikan fail CSV/Excel sah.</td></tr>';
      }
    }

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files && e.target.files[0];
      if (f) handleFile(f);
    });
  })();

  // ------------------------
  // Monitor Semua (Live)
  // ------------------------
  const POLL_MS = 7000; // refresh setiap 7s
  let monitorTimer = null; // pastikan tidak redeclare

  function showPage(id){
    document.querySelectorAll('.page').forEach(p=> p.style.display='none');
    const el = document.getElementById(id);
    if (el) el.style.display = '';
  }
  function todayIso(){
    const d=new Date();
    const mm=('0'+(d.getMonth()+1)).slice(-2);
    const dd=('0'+d.getDate()).slice(-2);
    return d.getFullYear()+'-'+mm+'-'+dd;
  }
  async function loadMonitor(force=false){
    try{
      const dateIso = document.getElementById('monitorDate')?.value || todayIso();
      const json = await apiGet('getNadiMonitor', { date: dateIso });
      if (json.status!=='success') throw new Error(json.message||'Gagal ambil monitor');
      document.getElementById('monitorInfo').textContent = `Tarikh: ${json.date} • Auto refresh setiap ${(POLL_MS/1000)}s`;
      renderMonitorCards(json.data||[]);
    }catch(err){
      console.error(err);
      document.getElementById('monitorInfo').textContent = 'Ralat memuat data monitor.';
      document.getElementById('monitorCards').innerHTML = '';
    }
  }
  function renderMonitorCards(list){
    const wrap = document.getElementById('monitorCards');
    if (!wrap) return;
    if (!list.length){ wrap.innerHTML = `<div class="col-12"><div class="alert alert-info">Tiada sesi pada tarikh ini.</div></div>`; return; }
    wrap.innerHTML = list.map(item=>{
      const c = item.counts||{layak:0,takLayak:0,total:0};
      return `
        <div class="col-12 col-md-6 col-lg-4">
          <div class="card shadow-sm monitor-card">
            <div class="card-body">
              <div class="d-flex justify-content-between align-items-start">
                <div>
                  <div class="fw-bold">${escapeHtml(item.title||'-')}</div>
                  <div class="text-muted small">${escapeHtml(item.programDate||'')}</div>
                  <div class="text-muted small">ID: ${escapeHtml(item.activityId||'')}</div>
                </div>
                <button class="btn btn-sm btn-outline-secondary" onclick="openSessionDetail('${item.activityId}')">Buka</button>
              </div>
              <hr>
              <div class="row text-center">
                <div class="col">
                  <div class="stat">${c.layak||0}</div><div class="label">Layak</div>
                </div>
                <div class="col">
                  <div class="stat">${c.takLayak||0}</div><div class="label">Tidak Layak</div>
                </div>
                <div class="col">
                  <div class="stat">${c.total||0}</div><div class="label">Jumlah</div>
                </div>
              </div>
            </div>
          </div>
        </div>`;
    }).join('');
  }
  function startMonitorPolling(){ stopMonitorPolling(); monitorTimer = setInterval(loadMonitor, POLL_MS); }
  function stopMonitorPolling(){ if (monitorTimer) { clearInterval(monitorTimer); monitorTimer=null; } }
  async function showMonitorAll(){
    showPage('monitorAllSection');
    const dateInput = document.getElementById('monitorDate');
    if (!dateInput.value) dateInput.value = todayIso();
    await loadMonitor();
    startMonitorPolling();
  }
  function openSessionDetail(activityId){
    location.hash = '#nadi?activityId='+encodeURIComponent(activityId);
  }
  document.getElementById('btnMonitorAll')?.addEventListener('click', showMonitorAll);
  document.getElementById('btnRefreshMonitor')?.addEventListener('click', loadMonitor);
  window.addEventListener('hashchange', ()=>{ const onMonitor = location.hash.includes('#monitor'); if (!onMonitor) stopMonitorPolling(); });

  // Tarikh semasa di header
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('ms-MY', { weekday:'long', day:'2-digit', month:'long', year:'numeric' })
 max-width: 500px; background: white; border-radius: 12px; padding: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto;
  }
  .whatsapp-report-header {
    display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;
  }
  .whatsapp-report-logo {
    width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; border: 1px solid rgba(0,0,0,0.08);
  }
  .whatsapp-report-title { font-size: 18px; font-weight: 700; color: var(--primary); }
  .whatsapp-report-subtitle { font-size: 14px; color: var(--muted); }
  .whatsapp-report-body { margin-bottom: 15px; }
  .whatsapp-report-row { display: flex; margin-bottom: 8px; }
  .whatsapp-report-label { font-weight: 600; width: 120px; color: var(--dark); }
  .whatsapp-report-value { flex: 1; }
  .whatsapp-report-footer { text-align: center; font-size: 12px; color: var(--muted); margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }


.monitor-card .stat {
  font-size: 28px; font-weight: 700; line-height: 1;
}
.monitor-card .label {
  font-size: 12px; text-transform: uppercase; letter-spacing: .06em;
}



  /* NADI Summary Cards */
  .nadi-summary-container {
    display: flex;
    gap: 12px;
    margin-bottom: 16px;
    flex-wrap: wrap;
  }
  .nadi-summary-card {
    flex: 1;
    min-width: 200px;
    background: white;
    border-radius: 10px;
    padding: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    text-align: center;
  }
  .nadi-summary-card .title {
    font-size: 0.9rem;
    color: var(--muted);
    margin-bottom: 8px;
  }
  .nadi-summary-card .count {
    font-size: 1.5rem;
    font-weight: 700;
  }
  .nadi-summary-card.layak { border-top: 4px solid var(--success); }
  .nadi-summary-card.tak-layak { border-top: 4px solid var(--danger); }
</style>
</head>
<body>
  <!-- Global Loader -->
  <div id="appLoader" aria-hidden="true">
    <div class="loader-card">
      <div class="spinner-premium"></div>
      <div class="fw-bold">Sila tunggu…</div>
      <div class="text-muted small" id="loaderMsg">Memproses permintaan anda</div>
    </div>
  </div>

  <!-- Log Calls Drawer -->
  <div id="logDrawer" aria-hidden="true">
    <div class="log-header">
      <button class="btn btn-sm btn-outline-secondary" id="btnCloseLog"><i class="bi bi-x-lg"></i></button>
      <div class="title"><i class="bi bi-chat-dots me-1"></i> Log Calls</div>
      <div id="logBadge" class="badge text-bg-primary">0</div>
    </div>
    <div class="log-search">
      <input id="logSearch" class="form-control form-control-sm" placeholder="Cari: nama / IC / telefon / staff…" />
    </div>
    <div id="logLoading" class="log-loading">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div class="small text-muted mt-1">Memuat Log Calls…</div>
    </div>
    <div id="logBody" class="log-body"></div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-main sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#dashboard">
        <img id="brandLogo" alt="Logo" style="width:32px;height:32px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,.08)">
        <span>Klinik SihatSokmo</span>
      </a>

      <!-- Google Sign-in button placeholder -->
      <div id="signinArea" class="d-lg-none me-2"></div>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item position-relative">
            <a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#nadi"><i class="bi bi-clipboard2-pulse"></i> Program PEKA B40 bersama NADI</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#daftar-peka"><i class="fas fa-user-plus"></i> Daftar Peka</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a>
            <span id="badgeTCA" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a>
            <span id="badgeFirst" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab Report</a>
            <span id="badgeLab" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a>
            <span id="badgeSecond" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a>
          </li>
        </ul>

        <div class="d-none d-lg-flex align-items-center gap-2">
          <div id="signinAreaDesktop"></div>
          <span id="staffBadge" class="badge bg-secondary d-none"><i class="bi bi-person-check me-1"></i><span id="staffEmail"></span></span>
          <!-- (Butang Log Calls terapung di bawah – tidak dalam navbar) -->
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <div class="container">
      <div class="row align-items-center g-2">
        <div class="col-md-6">
          <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
          <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
        </div>
        <div class="col-md-6 text-md-end">
          <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Dashboard -->
    <section id="dashboard" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-success" id="btnExportCSV"><i class="fa-solid fa-file-csv me-1"></i>Export (CSV)</button>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#tca-call" style="background:linear-gradient(135deg,var(--secondary),#2980b9)">
            <div class="number" id="totalDaftar">0</div><div class="small">Aktif</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#first-visit" style="background:linear-gradient(135deg,var(--warning),#e67e22)">
            <div class="number" id="totalFirstVisit">0</div><div class="small">First Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#second-visit" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">
            <div class="number" id="totalSecondVisit">0</div><div class="small">Second Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#selesai" style="background:linear-gradient(135deg,var(--success),#16a085)">
            <div class="number" id="totalSelesai">0</div><div class="small">Selesai</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#8e44ad,#6c5ce7)">
            <div class="number" id="labFollowUpDue">0</div><div class="small">Result > 3 Hari</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#d35400,#c0392b)">
            <div class="number" id="labFollowUpPending">0</div><div class="small">Perlu Follow-up</div>
          </div>
        </div>
      </div>

      <!-- Pesakit perlu dihubungi (ringkas hari ini mengikut backend lalai) -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi Hari Ini</span>
          <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefon…" />
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
              <tbody id="tcaCallTable"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Statistik -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriod" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:320px;"><canvas id="stats3dChart"></canvas></div></div>
      </div>
    </section>

    <!-- Program NADI -->
    <section id="nadi" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="bi bi-clipboard2-pulse me-2"></i>Program PEKA B40 bersama NADI</h2>
        <div class="d-flex gap-2">
          <button id="btnNadiExportCsv" class="btn btn-sm btn-outline-success"><i class="bi bi-filetype-csv me-1"></i>Export to CSV</button>
          <button id="btnMonitorAll" class="btn btn-outline-primary">Monitor Semua (Live)</button>
        </div>
      </div>
      
      <!-- Summary Cards -->
      <div class="nadi-summary-container">
        <div class="nadi-summary-card layak">
          <div class="title">Layak PEKA B40</div>
          <div class="count" id="nadiLayakCount">0</div>
        </div>
        <div class="nadi-summary-card tak-layak">
          <div class="title">Tidak Layak</div>
          <div class="count" id="nadiTakLayakCount">0</div>
        </div>
      </div>
      <!-- BAR PROGRAM (tajuk + tarikh + aksi) -->
<div id="nadiProgramBar" class="d-flex flex-wrap gap-2 align-items-end mb-2">
  <div class="flex-grow-1">
    <label class="form-label mb-1">Tajuk Program</label>
    <input id="nadiProgramTitle" class="form-control form-control-sm" placeholder="cth: Saringan Komuniti Tmn Mawar">
  </div>
  <div>
    <label class="form-label mb-1">Tarikh Program</label>
    <input id="nadiProgramDate" type="date" class="form-control form-control-sm">
  </div>
  <div class="ms-auto d-flex gap-2">
    <button id="btnNadiSaveActivity" class="btn btn-sm btn-primary">
      <i class="bi bi-cloud-upload me-1"></i>Simpan Aktiviti (Semua)
    </button>
  </div>
</div>
      <div class="card">
        <div class="card-body">
          <div class="nadi-scroll-container">
            <table class="nadi-table">
              <thead>
  <tr>
    <th style="width: 40px;">#</th>
    <th style="min-width: 150px;">Nama Pesakit</th>
    <th style="min-width: 120px;">No IC</th>
    <th style="min-width: 80px;">Umur</th>
    <th style="min-width: 120px;">Telefon</th>
    <th style="min-width: 150px;">Alamat</th>
    <th style="min-width: 80px;">BP</th>
    <th style="min-width: 80px;">PR</th>
    <th style="min-width: 120px;">DXT</th>
    <th style="min-width: 80px;">Tinggi</th>
    <th style="min-width: 80px;">Berat</th>
    <th style="min-width: 80px;">BMI</th>
    <th style="width: 80px;">Layak</th>
    <th style="width: 100px;">Tidak Layak</th>
    <!-- ⬇️ TAMBAH KOLUM BARU DI SINI -->
    <th style="min-width: 160px;">Remark</th>
    <!-- ⬆️ TAMBAH KOLUM BARU DI SINI -->
    <th style="min-width: 200px;">TCA & Staff</th>
    <th style="min-width: 180px;">Tindakan</th>
  </tr>
</thead>
              <tbody id="nadiContainer">
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
          <div class="sticky-form-actions">
            <button class="btn btn-primary" onclick="addNadiRow()"><i class="bi bi-plus-circle me-1"></i>Tambah Pesakit</button>
          </div>
          <div class="text-muted small mt-2">Nota: Baris "Layak" boleh terus <b>Daftar</b> (simpan ke sheet). Baris "Tidak Layak" <u>tidak</u> disimpan ke sheet tetapi <b>tetap dieksport CSV</b> bersama-sama.</div>
        </div>
      </div>
    </section>

    <!-- Daftar Peka -->
    <section id="daftar-peka" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-user-plus me-2"></i>Daftar Peka</h2>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-circle me-2"></i>Maklumat Pesakit</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Penuh Pesakit</label>
            <input id="namaPesakit" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor IC</label>
            <input id="noIC" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor Telefon</label>
            <input id="noTelefon" class="form-control" type="tel" required placeholder="cth: 0123456789 atau 60123456789">
          </div>
          <div class="col-md-6">
            <label class="form-label">Alamat Pesakit</label>
            <textarea id="alamatPesakit" class="form-control" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-calendar-alt me-2"></i>Tarikh Temujanji</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Tarikh TCA</label>
            <input id="tarikhTCA" class="form-control" type="date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Masa TCA</label>
            <input id="masaTCA" class="form-control" type="time" required>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-tie me-2"></i>Maklumat Staff</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Staff</label>
            <input id="namaStaff" class="form-control" required>
          </div>
        </div>
      </div>

      <div class="sticky-form-actions">
        <button class="btn btn-primary" id="btnDaftarPesakit"><i class="fas fa-save me-1"></i>Daftar Pesakit</button>
      </div>
    </section>

    <!-- Kelayakan (Excel) -->
    <section id="kelayakan" class="mb-4 d-none">
      <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel)</h2>
      <div class="card"><div class="card-body">
        <div class="row g-2 align-items-center mb-3">
          <div class="col-md-6">
            <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls,.csv" />
            <div class="form-text">Fail perlu ada lajur: <b>Nama</b>, <b>IC</b>, <b>Telefon</b>, <b>Alamat</b>. (Sistem tapis umur ≥40 ikut IC)</div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th>
                <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
                <th style="width:360px">Jika Layak → TCA & Masa & Staff</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="kelayakanTable"><tr><td colspan="8" class="text-center text-muted">Muat naik Excel untuk mula.</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- TCA Call (senarai rekod — tiada tanda selesai manual) -->
    <section id="tca-call" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-phone me-2"></i>Senarai Rekod TCA Call</h2>
        <div class="d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="group" id="tcaFilter">
            <button class="btn btn-outline-primary active" data-filter="today">Hari ini</button>
            <button class="btn btn-outline-primary" data-filter="upcoming">Akan datang</button>
            <button class="btn btn-outline-primary" data-filter="past">Lepas</button>
            <button class="btn btn-outline-secondary" data-filter="all">Semua</button>
          </div>
          <input class="form-control form-control-sm searchbar" id="searchTCAPage" placeholder="Cari nama/IC/telefon…"/>
        </div>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
            <tbody id="tcaCallList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- First Visit -->
    <section id="first-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchFirst" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="firstVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Follow-up Lab Report -->
    <section id="lab-followup" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
        <input class="form-control form-control-sm searchbar" id="searchLab" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th><th>Tindakan</th></tr>
            </thead>
            <tbody id="labFollowupTable"><tr><td colspan="8" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Second Visit -->
    <section id="second-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchSecond" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="secondVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Selesai -->
    <section id="selesai" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
        <input class="form-control form-control-sm searchbar" id="searchCompleted" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card mb-3"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>PDPA</th>
                <th>Tarikh Daftar</th><th>First Visit</th><th>Lab Report Completed</th><th>Second Visit</th><th>Tarikh Selesai</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="completedTable"><tr><td colspan="11" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriodCompleted" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:300px;"><canvas id="completed3dChart"></canvas></div></div>
      </div>
    </section>

    <section id="monitorAllSection" class="page" style="display:none;">
  <div class="d-flex align-items-center gap-2 mb-3">
    <h3 class="mb-0">Monitor Semua Program (Live)</h3>
    <input id="monitorDate" type="date" class="form-control" style="max-width:200px;">
    <button class="btn btn-primary" onclick="refreshMonitorNow()">Segar Semula</button>
  </div>

  <div id="monitorInfo" class="text-muted mb-2"></div>
  <div id="monitorCards" class="row g-3"></div>
</section>


    <!-- Arkib -->
    <section id="arkib" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
        <input class="form-control form-control-sm searchbar" id="searchArchive" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th><th>Tindakan</th></tr></thead>
            <tbody id="archiveTable"><tr><td colspan="8" class="text-center text-muted">Tiada rekod arkib</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>
  </main>

  <!-- Modal Re-TCA -->
  <div class="modal fade" id="retcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Daftar TCA Semula</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="retcaIC">
        <div class="mb-3"><label class="form-label">Tarikh TCA Baharu</label><input type="date" id="retcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA Baharu</label><input type="time" id="retcaTime" class="form-control" required></div>
        <small class="text-muted">Status pesakit akan ditukar kepada <b>TCA CALL</b>.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitRetca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Set Second Visit TCA (Lab Complete & Call) -->
  <div class="modal fade" id="secondTcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-check me-2"></i>Tetapkan TCA Second Visit</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="secondTcaIC">
        <div class="mb-2"><label class="form-label">Tarikh TCA Second Visit</label><input type="date" id="secondTcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA</label><input type="time" id="secondTcaTime" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Nama Staff (wajib isi)</label><input type="text" id="secondTcaStaff" class="form-control" required placeholder="cth: Dayah"></div>
        <small class="text-muted">Maklumat ini akan direkod ke Log Calls & ruangan "Lab Report Completed".</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitSecondTca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Upload PDPA -->
  <div class="modal fade" id="pdpaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i>Muat Naik Borang PDPA</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="pdpaIC">
        <input type="file" id="pdpaFile" class="form-control" accept="application/pdf,image/*" />
        <div class="form-text">Muat naik PDF / imej borang PDPA pesakit.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button class="btn btn-primary" id="btnUploadPDPA"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload</button>
      </div>
    </div></div>
  </div>

  <!-- Modal WhatsApp Report Preview -->
  <div class="modal fade" id="whatsappReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-brands fa-whatsapp me-2"></i>Pratonton Laporan WhatsApp</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="whatsappReportPreview"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <!-- Kekalkan butang lama (teks) -->
        <button class="btn btn-outline-success" id="btnSendWhatsApp">
          <i class="fa-brands fa-whatsapp me-1"></i> Hantar WhatsApp (Teks)
        </button>
        <!-- Butang baharu: hantar Gambar ke WhatsApp + auto-buka chat -->
        <button class="btn btn-success" id="btnSendWhatsAppImage">
          <i class="fa-brands fa-whatsapp me-1"></i> Hantar Gambar ke WhatsApp
        </button>
      </div>
    </div></div>
  </div>
  
  <!-- Toast Host (kanan atas) -->
  <div id="toastHost"><div id="toastContainer" class="toast-container"></div></div>

  <!-- FAB Log Calls -->
  <button id="fabLog" class="btn btn-primary">
    <i class="bi bi-chat-dots fs-5"></i>
  </button>

  <footer class="footer mt-4 py-3 bg-light">
    <div class="container"><div class="d-flex justify-content-between">
      <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
      <div>Versi 3.1 (Secure)</div>
    </div></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
/* =======================
   KONFIG (EDIT INI SAHAJA)
   ======================= */
/* =======================
   KELAYAKAN: CSV first, XLSX fallback
   - Auto detect header row & delimiter
   - Banyak sinonim lajur (IC/NRIC/KP/MyKad, No. H/P/WhatsApp)
   ======================= */
(function () {
  const fileInput = document.getElementById('excelFile');
  const tableBody = document.getElementById('kelayakanTable');
  if (!fileInput || !tableBody) return;

  // ---------- Util ----------
  const norm = (v) => String(v ?? '').trim();
  const escapeHtml = (s) => String(s || '').replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]
  ));

  function umurDariIC(ic) {
    const s = String(ic || '').replace(/\D/g, '');
    if (s.length < 6) return null;
    const yy = +s.slice(0,2), mm = +s.slice(2,4), dd = +s.slice(4,6);
    if (!(mm>=1 && mm<=12) || !(dd>=1 && dd<=31)) return null;
    const now = new Date();
    const currentYY = now.getFullYear() % 100;
    const year = (yy <= currentYY ? 2000 : 1900) + yy;
    let age = now.getFullYear() - year;
    const bday = new Date(year, mm - 1, dd);
    if (!(now.getMonth() > bday.getMonth() ||
          (now.getMonth() === bday.getMonth() && now.getDate() >= bday.getDate()))) {
      age--;
    }
    return age;
  }

  // ---------- File readers ----------
  const readAsArrayBuffer = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = e => res(e.target.result);
    fr.onerror = rej;
    fr.readAsArrayBuffer(file);
  });
  const readAsText = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = e => res(e.target.result);
    fr.onerror = rej;
    fr.readAsText(file, 'utf-8');
  });

  // ---------- CSV helpers ----------
  const stripBOM = (s) => s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;

  function detectDelimiter(s) {
    const sample = (s || '').slice(0, 3000);
    const cand = [',',';','\t','|'];
    const count = { ',':0, ';':0, '\t':0, '|':0 };
    let inQ = false;
    for (let i=0;i<sample.length;i++){
      const c = sample[i];
      if (c === '"') {
        if (inQ && sample[i+1] === '"') { i++; }
        else inQ = !inQ;
      } else if (!inQ && count.hasOwnProperty(c)) {
        count[c]++;
      }
    }
    return cand.sort((a,b)=>count[b]-count[a])[0] || ',';
  }

  function parseCSVToRows(text) {
    text = stripBOM(String(text||''));
    const delim = detectDelimiter(text);
    const rows = [];
    let row=[], field='', inQ=false;
    for (let i=0;i<text.length;i++){
      const c = text[i];
      if (inQ) {
        if (c === '"') {
          if (text[i+1] === '"') { field += '"'; i++; }
          else inQ = false;
        } else field += c;
      } else {
        if (c === '"') inQ = true;
        else if (c === delim) { row.push(field); field=''; }
        else if (c === '\n')  { row.push(field); rows.push(row); row=[]; field=''; }
        else if (c === '\r')  { /* skip */ }
        else field += c;
      }
    }
    row.push(field); rows.push(row);
    return rows;
  }

  // Cari baris header terbaik (ada ≥2 kata kunci)
  const keysets = {
    nama:    ['nama','nama penuh','name','nama pesakit'],
    ic:      ['ic','no ic','no. ic','nric','nokp','no kp','no. kp','kp','mykad','no mykad','no k/p','k/p','kad pengenalan','no kad pengenalan'],
    telefon: ['telefon','no telefon','no. telefon','no tel','no. tel','tel','mobile','hp','no hp','h/p','no h/p','whatsapp','no whatsapp','telefon (whatsapp)'],
    alamat:  ['alamat','address','addr','alamat rumah','alamat kediaman']
  };
  const canon = (s) => String(s||'')
      .toLowerCase()
      .replace(/[\s\.\-_/()]+/g,'')   // buang ruang, titik, slash dll
      .trim();

  function scoreHeaderCell(cell) {
    const t = canon(cell);
    const hit = [];
    for (const [k, list] of Object.entries(keysets)) {
      if (list.some(p => t.includes(canon(p)))) hit.push(k);
    }
    return [...new Set(hit)];
  }

  function findHeaderRow(rows) {
    let best = { idx: 0, score: 0 };
    for (let r=0; r<Math.min(rows.length, 20); r++) {
      const hits = new Set();
      for (const c of rows[r]) scoreHeaderCell(c).forEach(k => hits.add(k));
      const sc = hits.size;
      if (sc > best.score) best = { idx: r, score: sc };
    }
    return (best.score >= 2) ? best.idx : 0; // perlu ≥2 kolum relevan
  }

  function csvTextToObjects(text) {
    const rows = parseCSVToRows(text);
    if (!rows.length) return [];
    const headerRow = findHeaderRow(rows);
    const header = rows[headerRow].map(h => String(h||'').trim());
    const dataRows = rows.slice(headerRow+1);

    return dataRows
      .filter(r => r.some(v => String(v||'').trim() !== ''))
      .map(r => {
        const o = {};
        for (let i=0;i<header.length;i++) o[header[i]] = r[i] ?? '';
        return o;
      });
  }

  // Padanan objek → {nama, ic, telefon, alamat}
  function mapRow(raw) {
    const entries = Object.entries(raw);
    const pick = (groups) => {
      // cuba padanan tepat dulu
      for (const [k,v] of entries) {
        const t = canon(k);
        if (groups.some(word => t.includes(canon(word)))) return norm(v);
      }
      // fallback: cuba contains long->short
      for (const [k,v] of entries) {
        const t = canon(k);
        if (groups.some(word => canon(word).includes(t))) return norm(v);
      }
      return '';
    };
    return {
      nama:    pick(keysets.nama),
      ic:      pick(keysets.ic),
      telefon: pick(keysets.telefon),
      alamat:  pick(keysets.alamat)
    };

function showPage(id){
  // sembunyikan semua .page, tunjuk satu
  document.querySelectorAll('.page').forEach(p=> p.style.display='none');
  const el = document.getElementById(id);
  if (el) el.style.display = '';
}

function todayIso(){
  const d=new Date();
  const mm=('0'+(d.getMonth()+1)).slice(-2);
  const dd=('0'+d.getDate()).slice(-2);
  return d.getFullYear()+'-'+mm+'-'+dd;
}

// === MONITOR VIEW ===
async function showMonitorAll(){
  showPage('monitorAllSection');
  const dateInput = document.getElementById('monitorDate');
  if (!dateInput.value) dateInput.value = todayIso();
  await loadMonitor(); // first load
  startMonitorPolling();
}

function startMonitorPolling(){
  stopMonitorPolling();
  monitorTimer = setInterval(loadMonitor, POLL_MS);
}
function stopMonitorPolling(){
  if (monitorTimer) { clearInterval(monitorTimer); monitorTimer=null; }
}
async function refreshMonitorNow(){
  await loadMonitor(true);
}

async function loadMonitor(dateStr) {
  const container = document.getElementById('monitorAllContainer');
  if (!container) return;

  // Tarikh dari input jika tidak diberi
  const chosen = (dateStr || document.getElementById('monitorDate')?.value || '').trim();

  // Papar skeleton sementara
  container.innerHTML = `
    <div class="text-muted small mb-2">Memuat data monitor…</div>
    <div class="row g-2">
      <div class="col-12 col-md-4"><div class="card placeholder-wave"><div class="card-body">
        <div class="placeholder col-8 mb-2"></div>
        <div class="placeholder col-6"></div>
      </div></div></div>
      <div class="col-12 col-md-4"><div class="card placeholder-wave"><div class="card-body">
        <div class="placeholder col-8 mb-2"></div>
        <div class="placeholder col-6"></div>
      </div></div></div>
      <div class="col-12 col-md-4"><div class="card placeholder-wave"><div class="card-body">
        <div class="placeholder col-8 mb-2"></div>
        <div class="placeholder col-6"></div>
      </div></div></div>
    </div>`;

  // Util kecil: pembantu fetch + parse JSON dengan mesej ralat yang jelas
  async function fetchJSON(url) {
    const res = await fetch(url, { method: 'GET', credentials: 'omit' });
    const text = await res.text();
    let json;
    try {
      json = JSON.parse(text);
    } catch (e) {
      // Jika HTML (<!DOCTYPE …) -> biasanya URL silap / token tak dihantar
      throw new Error('Respons bukan JSON sah daripada pelayan (mungkinkah URL/token salah?).');
    }
    return json;
  }

  // Bina URL
  const qs = new URLSearchParams();
  qs.set('action', 'getNadiMonitor');
  if (chosen) qs.set('date', chosen); // sokong "yyyy-MM-dd" atau "dd/MM/yyyy"
  if (typeof ID_TOKEN === 'string' && ID_TOKEN) qs.set('id_token', ID_TOKEN);

  // Muat data
  let json;
  try {
    json = await fetchJSON(`${SCRIPT_URL}?${qs.toString()}`);
  } catch (err) {
    container.innerHTML = `
      <div class="alert alert-danger">
        <div class="fw-bold mb-1">Gagal memuat monitor</div>
        <div>${err.message || err}</div>
        <div class="small text-muted mt-1">Semak semula <code>SCRIPT_URL</code>, <code>ID_TOKEN</code>, dan capaian internet.</div>
      </div>`;
    if (typeof toast === 'function') toast('Ralat', 'Gagal memuat monitor', 'danger');
    return;
  }

  // Semak status
  if (!json || json.status !== 'success') {
    const msg = (json && (json.message || json.code)) || 'Action tidak sah / akses ditolak';
    container.innerHTML = `
      <div class="alert alert-warning">
        <div class="fw-bold mb-1">Tidak dapat memuat data monitor</div>
        <div>${msg}</div>
        <div class="small text-muted mt-1">Pastikan anda telah sign-in dan akaun berada dalam allowlist.</div>
      </div>`;
    if (typeof toast === 'function') toast('Makluman', String(msg), 'warning');
    return;
  }

  // Bentuk data: { status:'success', date:'dd/MM/yyyy', data:[{activityId,title,programDate,counts:{layak,takLayak,total}}] }
  const monitorDate = json.date || chosen || '';
  const items = Array.isArray(json.data) ? json.data : [];

  // Jika tiada sesi pada tarikh dipilih
  if (!items.length) {
    container.innerHTML = `
      <div class="text-center text-muted py-4">
        Tiada sesi ditemui untuk tarikh <span class="fw-semibold">${monitorDate || '(tidak ditentukan)'}</span>.
      </div>`;
    return;
  }

  // Render kad ringkasan setiap sesi
  const now = new Date();
  const rendered = items.map((s) => {
    const layak = Number(s?.counts?.layak || 0);
    const tak = Number(s?.counts?.takLayak || 0);
    const tot = Number(s?.counts?.total || (layak + tak));

    // Pilih warna ringkas ikut status (hanya kosmetik)
    const barLayak = Math.round(tot ? (layak / tot) * 100 : 0);
    const barTak = Math.max(0, 100 - barLayak);

    return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card h-100 shadow-sm">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <div>
                <div class="fw-bold">${s.title || 'Tanpa Tajuk'}</div>
                <div class="text-muted small">${s.programDate || monitorDate}</div>
              </div>
              <span class="badge bg-secondary">ID: ${s.activityId || '-'}</span>
            </div>

            <div class="mb-2">
              <div class="d-flex justify-content-between small text-muted">
                <span>Layak</span><span>${layak}</span>
              </div>
              <div class="progress" role="progressbar" aria-label="Layak vs Tidak Layak">
                <div class="progress-bar" style="width:${barLayak}%"></div>
                <div class="progress-bar bg-danger" style="width:${barTak}%"></div>
              </div>
            </div>

            <div class="d-flex gap-2 mt-3">
              <span class="badge bg-success">Layak: ${layak}</span>
              <span class="badge bg-danger">Tidak Layak: ${tak}</span>
              <span class="badge bg-primary">Jumlah: ${tot}</span>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');

  container.innerHTML = `
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="small text-muted">
        Tarikh dipantau: <span class="fw-semibold">${monitorDate || '(tidak ditentukan)'}</span>
      </div>
      <div class="small text-muted">Dikemas kini: ${now.toLocaleTimeString()}</div>
    </div>
    <div class="row g-2">${rendered}</div>
  `;
}

function openSessionDetail(activityId){
  location.hash = '#nadi?activityId='+encodeURIComponent(activityId);
}

// ❌ PADAMKAN fungsi duplikasi ini kalau ada:
// function escapeHtml(s){ ... }

// Henti polling bila keluar dari skrin monitor
window.addEventListener('hashchange', ()=>{
  const onMonitor = location.hash.includes('#monitor');
  if (!onMonitor) stopMonitorPolling();
});

// ✅ EXPOSE ke global (penting untuk onclick & button)
window.showMonitorAll = showMonitorAll;
window.refreshMonitorNow = refreshMonitorNow;
window.stopMonitorPolling = stopMonitorPolling;
// 1) Helper fetch dengan timeout (abort)
async function fetchWithTimeout(url, opt={}, ms=15000){
  const ctl = new AbortController();
  const id = setTimeout(()=>ctl.abort(new Error('timeout')), ms);
  try{
    const res = await fetch(url, { ...opt, signal: ctl.signal });
    return res;
  } finally {
    clearTimeout(id);
  }
}

// 2) Single-flight guard untuk monitor
let MONITOR_LOADING = false;

  // ---------- Pemproses utama ----------
  async function handleFile(file) {
    try {
      tableBody.innerHTML =
        '<tr><td colspan="8" class="text-center text-muted">Memproses fail…</td></tr>';

      const ext = (file.name.split('.').pop() || '').toLowerCase();

      // 1) CSV → terus baca (tak perlu internet/CDN)
      if (ext === 'csv') {
        const text = await readAsText(file);
        const raw  = csvTextToObjects(text);
        const items = raw.map(mapRow)
          .filter(r => r.nama || r.ic || r.telefon || r.alamat);

        if (!items.length) {
          // papar sedikit debug kepala lajur untuk bantu semak
          const rows = parseCSVToRows(text);
          const headerRow = findHeaderRow(rows);
          const hdrs = (rows[headerRow] || []).slice(0,8).map(h=>escapeHtml(h)).join(', ');
          tableBody.innerHTML =
            `<tr><td colspan="8" class="text-center text-danger">
              CSV dibaca tetapi tiada lajur sepadan.<br>
              <small><b>Jumpa header:</b> ${hdrs || '(kosong)'}<br>
              Pastikan ada lajur seperti <i>Nama, IC/NRIC/KP, Telefon/HP/WhatsApp, Alamat</i>.</small>
            </td></tr>`;
          return;
        }

        window.__KELAYAKAN_ITEMS__ = items;
        renderRows(items);
        return;
      }

      // 2) XLSX/XLS → cuba SheetJS; jika gagal, minta simpan CSV
      if (typeof window.ensureXLSXReady === 'function') {
        try { await window.ensureXLSXReady(); } catch(e) { /* ignore */ }
      }
      if (!window.XLSX) {
        tableBody.innerHTML =
          '<tr><td colspan="8" class="text-center text-danger">SheetJS tidak tersedia. Sila simpan Excel sebagai <b>CSV</b> dan muat naik semula.</td></tr>';
        return;
      }

      const data = await readAsArrayBuffer(file);
      const wb   = XLSX.read(data, { type: 'array' });
      const ws   = wb.Sheets[wb.SheetNames[0]];
      const raw  = XLSX.utils.sheet_to_json(ws, { defval: '', raw: true });

      const items = raw.map(mapRow)
        .filter(r => r.nama || r.ic || r.telefon || r.alamat);

      if (!items.length) {
        const hdrs = Object.keys(raw[0] || {}).slice(0,8).join(', ');
        tableBody.innerHTML =
          `<tr><td colspan="8" class="text-center text-danger">
            Excel dibaca tetapi tiada lajur sepadan.<br>
            <small><b>Jumpa header:</b> ${escapeHtml(hdrs)}<br>
            Pastikan ada lajur seperti <i>Nama, IC/NRIC/KP, Telefon/HP/WhatsApp, Alamat</i>.</small>
          </td></tr>`;
        return;
      }

      window.__KELAYAKAN_ITEMS__ = items;
      renderRows(items);

    } catch (err) {
      console.error(err);
      tableBody.innerHTML =
        '<tr><td colspan="8" class="text-center text-danger">Ralat memproses fail. Pastikan fail CSV/Excel sah.</td></tr>';
    }
  }
 // ---------- Events ----------
fileInput.addEventListener('change', e => {
  const f = e.target.files && e.target.files[0];
  if (f) handleFile(f);
});

tableBody.addEventListener('click', e => {
  const btn = e.target.closest('.daftar-row');
  if (!btn) return;
  const tr  = btn.closest('tr');
  const idx = Number(tr.dataset.idx);
  const item = (window.__KELAYAKAN_ITEMS__ || [])[idx];
  if (!item) return;

  const date  = tr.querySelector('.tca-date')?.value || '';
  const time  = tr.querySelector('.tca-time')?.value || '';
  const staff = tr.querySelector('.tca-staff')?.value || '';

  const fNama   = document.getElementById('namaPesakit');
  const fIC     = document.getElementById('noIC');
  const fTel    = document.getElementById('noTelefon');
  const fAlamat = document.getElementById('alamatPesakit');
  const fTCA    = document.getElementById('tarikhTCA');
  const fMasa   = document.getElementById('masaTCA');
  const fStaff  = document.getElementById('namaStaff');

  if (fNama)   fNama.value   = item.nama   || '';
  if (fIC)     fIC.value     = item.ic     || '';
  if (fTel)    fTel.value    = item.telefon|| '';
  if (fAlamat) fAlamat.value = item.alamat || '';
  if (fTCA && date)  fTCA.value  = date;
  if (fMasa && time) fMasa.value = time;
  if (fStaff && staff) fStaff.value = staff;

  location.hash = '#daftar-peka';
  btn.innerHTML = '<i class="fas fa-check me-1"></i>Diisi';
  btn.classList.remove('btn-primary');
  btn.classList.add('btn-success');
  btn.disabled = true;
});

// 1) Isi URL Web App Apps Script (deployment terkini)
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6TKE0vDDPO3-36cY7xjacAbGL0HIRKCrORNm-sED9y5NpIeIUk9gyrpiWy-S7vbc/exec';
// 2) Google OAuth Client ID (Google Cloud Console)
const GOOGLE_CLIENT_ID = '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com';
// 3) Logo (optional) - Ganti dengan URL logo klinik anda
const LOGO_URL = 'nanti saya letak';

/* =======================
   AUTH (Google Identity)
   ======================= */
let ID_TOKEN = '';      // diisi selepas login
let STAFF_EMAIL = '';   // email sebenar (server akan sahkan juga)

// Pastikan helper Bahagian A boleh capai token
function persistIdToken(token) {
  try {
    window.ID_TOKEN = token;
    localStorage.setItem('id_token', token);
  } catch (_) { /* ignore */ }
}

function initGoogleSignIn(){
  if (!window.google || !google.accounts || !google.accounts.id) return;
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false,
    cancel_on_tap_outside: true
  });
  const mobileSpot  = document.getElementById('signinArea');
  const desktopSpot = document.getElementById('signinAreaDesktop');
  if (mobileSpot)  google.accounts.id.renderButton(mobileSpot,  { theme: 'outline', size: 'medium', text:'signin_with' });
  if (desktopSpot) google.accounts.id.renderButton(desktopSpot, { theme: 'outline', size: 'medium', text:'signin_with' });
}

// Cuba auto-login jika token masih ada
(function tryRestoreToken(){
  const t = localStorage.getItem('id_token') || sessionStorage.getItem('id_token');
  if (t) {
    ID_TOKEN = t;
    window.ID_TOKEN = t;
  }
})();

async function handleCredentialResponse(resp){
  ID_TOKEN = resp?.credential || '';
  if (!ID_TOKEN) { toast('Ralat', 'Tiada credential diterima', 'danger'); return; }
  persistIdToken(ID_TOKEN);

  // Guna helper Bahagian A jika ada, sebaliknya POST terus ke SCRIPT_URL
  let j;
  try {
    if (typeof apiPost === 'function') {
      j = await apiPost('whoami', {});
    } else {
      const r = await fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ action:'whoami', id_token: ID_TOKEN })
      });
      j = await r.json();
    }
  } catch (e) {
    toast('Ralat', 'Gagal sahkan akaun. Semak rangkaian anda.', 'danger');
    ID_TOKEN = ''; STAFF_EMAIL = '';
    return;
  }

  if (j.status === 'success'){
    STAFF_EMAIL = j.email || '';
    document.getElementById('staffBadge')?.classList.remove('d-none');
    const staffEmailEl = document.getElementById('staffEmail');
    if (staffEmailEl) staffEmailEl.textContent = STAFF_EMAIL;
    const signinArea = document.getElementById('signinArea');
    const signinAreaDesktop = document.getElementById('signinAreaDesktop');
    if (signinArea) signinArea.innerHTML = '';
    if (signinAreaDesktop) signinAreaDesktop.innerHTML = '';

    bootstrapApp(); // muat data awal

    // Pastikan kita berada di Dashboard
    location.hash = '#dashboard';
    const dashLink = document.querySelector('.nav-link[href="#dashboard"]');
    if (dashLink) dashLink.click();

  } else {
    toast('Akses Ditolak', j.message || 'Sila hubungi admin untuk allowlist.', 'danger');
    ID_TOKEN = ''; STAFF_EMAIL = '';
    persistIdToken(''); // kosongkan
  }
}

// Inisialisasi GIS apabila DOM siap
document.addEventListener('DOMContentLoaded', () => {
  // Jika sudah ada token restore, boleh terus bootstrap (optional)
  if (ID_TOKEN) {
    // Cuba panggil whoami senyap untuk sahkan token masih sah
    (async () => {
      try {
        const res = await getJSON({ action:'whoami' }, { silent:true });
        if (res?.status === 'success') {
          STAFF_EMAIL = res.email || '';
          document.getElementById('staffBadge')?.classList.remove('d-none');
          const staffEmailEl = document.getElementById('staffEmail');
          if (staffEmailEl) staffEmailEl.textContent = STAFF_EMAIL;
          bootstrapApp();
          return;
        }
      } catch (_) {}
      // jika gagal, teruskan paparkan butang sign-in
      initGoogleSignIn();
    })();
  } else {
    // Tiada token → render butang sign-in
    // Tunggu script GIS siap (jaga-jaga race condition)
    if (window.google?.accounts?.id) initGoogleSignIn();
    else window.addEventListener('load', initGoogleSignIn, { once:true });
  }
});

/* =======================
   LOADER (maks 2s)
   ======================= */
let loaderTimer=null;
function showLoader(msg='Memproses…'){
  const el = document.getElementById('loaderMsg');
  if (el) el.textContent = msg;
  const root = document.getElementById('appLoader');
  if (root) root.style.display = 'block';
  clearTimeout(loaderTimer);
  loaderTimer = setTimeout(hideLoader, 2000);
}
function hideLoader(){
  const root = document.getElementById('appLoader');
  if (root) root.style.display = 'none';
}

/* =======================
   NETWORK HELPERS
   ======================= */
// Jika helper Bahagian A tersedia, gunakan itu; jika tidak, fallback ke SCRIPT_URL
async function getJSON(params={}, {silent=false, msg='Memuat data…'}={}){
  if (!(window.ID_TOKEN || ID_TOKEN)) throw new Error('Belum login');
  if (!silent) showLoader(msg);
  try{
    if (typeof apiGet === 'function') {
      return await apiGet(params.action || '', Object.fromEntries(Object.entries(params).filter(([k])=>k!=='action')));
    }
    // Fallback GET terus ke SCRIPT_URL
    const qs = new URLSearchParams({ ...params, id_token: window.ID_TOKEN || ID_TOKEN }).toString();
    const url = `${SCRIPT_URL}?${qs}`;
    const r = await Promise.race([
      fetch(url, { method:'GET' }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

async function postForm(params={}, {silent=false, msg='Menyimpan data…'}={}){
  if (!(window.ID_TOKEN || ID_TOKEN)) throw new Error('Belum login');
  if (!silent) showLoader(msg);
  try{
    if (typeof apiPost === 'function') {
      const { action, ...body } = params || {};
      return await apiPost(action || '', body);
    }
    // Fallback POST terus ke SCRIPT_URL
    const r = await Promise.race([
      fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ ...params, id_token: window.ID_TOKEN || ID_TOKEN })
      }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

/* =======================
   UTIL
   ======================= */
const normalizeMsisdnMY = (raw) => {
  if (!raw) return '';
  let s = String(raw).replace(/\D/g, '');
  if (s.startsWith('00')) s = s.slice(2);
  if (s.startsWith('60')) return s;
  if (s.startsWith('0')) return '60' + s.slice(1);
  return '60' + s;
};

const telHref = (msisdn) => `tel:+${msisdn}`;

const waHref  = (msisdn, txt='Assalamualaikum, saya dari Klinik SihatSokmo.') =>
  `https://wa.me/${msisdn}?text=${encodeURIComponent(txt)}`;

const parseDDMMYYYY = (s) => {
  if (!s) return null;
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { // "YYYY-MM-DD"
    const [Y, M, D] = s.split('-').map(Number);
    return new Date(Y, M - 1, D);
  }
  const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s); // "DD/MM/YYYY"
  if (!m) return null;
  const D = +m[1], M = +m[2], Y = +m[3];
  return new Date(Y, M - 1, D);
};

function isSameDay(a, b) {
  return a.getFullYear() === b.getFullYear()
      && a.getMonth() === b.getMonth()
      && a.getDate() === b.getDate();
}

/* Pastikan bekas notifikasi (#toastHost/#toastContainer) wujud. */
function ensureToastContainer() {
  let host = document.getElementById('toastHost');
  if (!host) {
    host = document.createElement('div');
    host.id = 'toastHost';
    document.body.appendChild(host);
  }
  let container = document.getElementById('toastContainer');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container';
    host.appendChild(container);
  }
  container.style.pointerEvents = 'auto';
  return container;
}

function clampToastIntoView(el){
  requestAnimationFrame(() => {
    const PAD = 12;
    el.style.maxWidth = Math.min(window.innerWidth - PAD*2, 420) + 'px';
    const r = el.getBoundingClientRect();
    let tx = 0, ty = 0;
    if (r.right > window.innerWidth - PAD) tx -= (r.right - (window.innerWidth - PAD));
    if (r.left  < PAD)                     tx += (PAD - r.left);
    if (r.top   < PAD)                     ty += (PAD - r.top);
    if (tx || ty){
      el.style.transform  = `translate(${tx}px, ${ty}px)`;
      el.style.willChange = 'transform';
    }
  });
}

/* Toast "kebal" */
function toast(title, message, variant = 'primary') {
  const container = ensureToastContainer();
  const id = 't' + Date.now() + Math.random().toString(36).slice(2, 7);

  const html = `
    <div class="toast align-items-center text-bg-${variant} border-0 mb-2" id="${id}"
         role="alert" aria-live="assertive" aria-atomic="true" style="min-width:260px">
      <div class="d-flex">
        <div class="toast-body"><strong>${title}:</strong> ${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`;
  container.insertAdjacentHTML('beforeend', html);
  const el = document.getElementById(id);

  clampToastIntoView(el);
  const onResize = () => clampToastIntoView(el);
  window.addEventListener('resize', onResize, { passive: true });

  const cleanup = () => {
    window.removeEventListener('resize', onResize);
    el.remove();
  };

  try {
    const BsToast = window.bootstrap?.Toast;
    if (BsToast) {
      const inst = BsToast.getOrCreateInstance(el, { delay: 3000, autohide: true });
      el.addEventListener('shown.bs.toast', () => clampToastIntoView(el));
      el.addEventListener('hidden.bs.toast', cleanup);
      inst.show();
    } else {
      el.classList.add('show');
      setTimeout(() => { el.classList.remove('show'); cleanup(); }, 3000);
    }
  } catch {
    el.classList.add('show');
    setTimeout(() => { el.classList.remove('show'); cleanup(); }, 3000);
  }
}

/* WhatsApp (TEKS) */
function composeNadiWhatsAppText(data){
  const lines = [
    'Assalamualaikum, saya dari Klinik SihatSokmo.',
    '',
    'Laporan Saringan Kesihatan:',
    `• Nama: ${data.nama || '-'}`,
    `• IC: ${data.ic || '-'}`,
    `• Alamat: ${data.alamat || '-'}`,
    `• BP: ${data.bp || '-'} mmHg`,
    `• PR: ${data.pr || '-'} bpm`,
    `• DXT (${data.dxtType || 'Fasting'}): ${data.dxt || '-'} mmol/L`,
    `• Tinggi: ${data.tinggi || '-'} cm`,
    `• Berat: ${data.berat || '-'} kg`,
    `• BMI: ${data.bmi || '-'}`,
    `• Status: ${data.layak ? 'Layak PEKA B40' : 'Tidak Layak PEKA B40'}`,
    '',
    'Jika ada soalan, balas mesej ini ya. Terima kasih.'
  ];
  return lines.join('\n');
}

function openWhatsAppTo(rawMsisdn, text){
  const msisdn = normalizeMsisdnMY(rawMsisdn);
  if (!/^\d{10,15}$/.test(msisdn)){
    toast('Ralat','Nombor telefon tidak sah','danger');
    return;
  }
  const encoded = encodeURIComponent(text || '');
  const scheme = `whatsapp://send?phone=${msisdn}&text=${encoded}`;
  const web    = `https://wa.me/${msisdn}?text=${encoded}`;
  const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
  const url = isMobile ? scheme : web;
  window.open(url, '_blank');
  toast('WhatsApp','Membuka WhatsApp dengan mesej siap-isi…','success');
}

/* =======================
   WHATSAPP IMAGE SEND HELPERS (BARU)
   ======================= */
let CURRENT_WA_MSISDN = ''; // diset ketika preview dibuka

async function captureReportAsBlob() {
  const card = document.querySelector('#whatsappReportPreview .whatsapp-report');
  if (!card) throw new Error('Gagal capai preview');
  const canvas = await html2canvas(card, {
    backgroundColor: '#ffffff',
    scale: Math.min(window.devicePixelRatio || 1.5, 2.5)
  });
  return await new Promise((resolve)=> canvas.toBlob(resolve, 'image/png', 0.95));
}

// Buka chat ikut peranti
function openWhatsAppDeepLink(msisdn, text='') {
  const encoded = encodeURIComponent(text || '');
  const scheme  = `whatsapp://send?phone=${msisdn}&text=${encoded}`;
  const web     = `https://wa.me/${msisdn}?text=${encoded}`;
  const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
  window.open(isMobile ? scheme : web, '_blank');
}

// Flow: buka chat → sediakan imej (share/clipboard/fallback muat turun)
async function sendWhatsAppReportImageFlow(msisdn) {
  const phone = normalizeMsisdnMY(msisdn||'');
  if (!/^\d{10,15}$/.test(phone)) {
    toast('Ralat','Nombor telefon tidak sah','danger');
    return;
  }

  openWhatsAppDeepLink(phone, '');

  showLoader('Menjana imej laporan…');
  let blob;
  try {
    blob = await captureReportAsBlob();
  } catch(e){
    hideLoader();
    toast('Ralat','Gagal jana imej laporan','danger');
    return;
  }
  hideLoader();

  const file = new File([blob], `laporan_nadi_${Date.now()}.png`, { type: 'image/png' });

  // MOBILE: Web Share API
  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({ files: [file], title: 'Laporan Saringan NADI', text: '' });
      toast('Berjaya', 'Imej dikongsi melalui aplikasi pilihan anda', 'success');
      return;
    } catch(e){ /* pengguna batal → teruskan */ }
  }

  // DESKTOP: Clipboard
  if (navigator.clipboard && window.ClipboardItem) {
    try {
      await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
      toast('Siap', 'Imej disalin ke clipboard. Tampal (Ctrl/Cmd+V) dalam chat WhatsApp.', 'success');
      return;
    } catch(e){ /* fallback */ }
  }

  // Fallback: Muat turun
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `laporan_nadi_${Date.now()}.png`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Makluman', 'Imej dimuat turun. Lampirkan imej itu dalam chat WhatsApp dan hantar.', 'warning');
}

/* =======================
   GLOBALS
   ======================= */
let stats3dChart, completed3dChart;
let retcaModal, secondTcaModal, pdpaModal, whatsappReportModal;
let currentWhatsAppData = null;
let NADI_LIVE_SESSION_ID = '';
let nadiLiveTimer = null;
let nadiLiveSaveQueue = new Map();  // rowId -> payload terkini
let nadiLiveSaving = false;

// Jana Session Id (berdasarkan tajuk + tarikh program)
function computeNadiSessionId(){
  const title = (document.getElementById('nadiProgramTitle')?.value || '').trim();
  const date  = (document.getElementById('nadiProgramDate')?.value || new Date().toISOString().slice(0,10)).trim();
  if (!title) return '';
  const slug = title.toLowerCase()
    .replace(/[^\p{L}\p{N}]+/gu,'-')
    .replace(/^-+|-+$/g,'')
    .slice(0,60);
  return `${slug}_${date}`;
}

/* =======================
   BOOTSTRAP APP
   ======================= */
function bootstrapApp(){
  const logoEl = document.getElementById('brandLogo');
  if (logoEl) {
    logoEl.src = LOGO_URL;
    logoEl.onerror = () => (logoEl.src='https://via.placeholder.com/64x64.png?text=KS');
  }

  const dateEl = document.getElementById('current-date');
  if (dateEl) {
    dateEl.textContent = new Date().toLocaleDateString('ms-MY', { weekday:'long', year:'numeric', month:'long', day:'numeric' });
  }

  setupNavigation();
  setupModals();
  setupSearchBars();
  setupExports();
  setupExcel();
  setupNADI();
  setupLogDrawer();
  setupFab();

  // Aktifkan seksyen berdasarkan hash semasa URL (jika ada)
  activateFromHash?.();

  loadDashboardData?.();
  loadStatistics?.('3months');
  loadCompletedStatistics?.('3months');
  loadTCACallData?.(); // widget dashboard (hari ini)
}

/* =======================
   NAV & UI
   ======================= */
function setupNavigation(){
  document.querySelectorAll('.nav-link').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault();
      document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
      const target = a.getAttribute('href');
      document.querySelector(target)?.classList.remove('d-none');
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
      a.classList.add('active');

      if (target==='#dashboard'){ loadDashboardData?.(); loadStatistics?.(document.getElementById('statPeriod')?.value); }
      else if (target==='#tca-call'){ loadTCACallPage?.(); }
      else if (target==='#first-visit'){ loadFirstVisitData?.(); }
      else if (target==='#lab-followup'){ loadLabFollowUp?.(); }
      else if (target==='#second-visit'){ loadSecondVisitData?.(); }
      else if (target==='#selesai'){ loadCompletedData?.(); loadCompletedStatistics?.(document.getElementById('statPeriodCompleted')?.value); }
      else if (target==='#arkib'){ loadArchivedData?.(); }
    });
  });

  // Stat cards → navigate
  document.querySelectorAll('.stat-card[data-goto]').forEach(card=>{
    card.addEventListener('click', ()=>{
      const href = card.getAttribute('data-goto');
      const link = document.querySelector(`.nav-link[href="${href}"]`);
      link?.click();
    });
  });

  document.getElementById('btnDaftarPesakit')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    await daftarPesakit?.();
  });

  document.getElementById('statPeriod')?.addEventListener('change', function(){ loadStatistics?.(this.value); });
  document.getElementById('statPeriodCompleted')?.addEventListener('change', function(){ loadCompletedStatistics?.(this.value); });
}

function setupModals(){
  if (document.getElementById('retcaModal')) {
    retcaModal = new bootstrap.Modal(document.getElementById('retcaModal'));
    document.getElementById('btnSubmitRetca')?.addEventListener('click', submitRetca);
  }

  if (document.getElementById('secondTcaModal')) {
    secondTcaModal = new bootstrap.Modal(document.getElementById('secondTcaModal'));
    document.getElementById('btnSubmitSecondTca')?.addEventListener('click', submitSecondTca);
  }

  if (document.getElementById('pdpaModal')) {
    pdpaModal = new bootstrap.Modal(document.getElementById('pdpaModal'));
    document.getElementById('btnUploadPDPA')?.addEventListener('click', uploadPDPA);
  }

  if (document.getElementById('whatsappReportModal')) {
    whatsappReportModal = new bootstrap.Modal(document.getElementById('whatsappReportModal'));
    document.getElementById('btnSendWhatsApp')?.addEventListener('click', sendWhatsAppReport);
    document.getElementById('btnSendWhatsAppImage')?.addEventListener('click', async ()=>{
      if (!CURRENT_WA_MSISDN){
        toast('Ralat','Nombor telefon tidak ditemui pada baris NADI','danger'); return;
      }
      await sendWhatsAppReportImageFlow(CURRENT_WA_MSISDN);
    });
  }
}

function setupFab(){
  const btn = document.getElementById('fabLog');
  const drawer  = document.getElementById('logDrawer');
  const btnClose= document.getElementById('btnCloseLog');
  if (!btn || !drawer || !btnClose) return;
  btn.addEventListener('click', ()=>{ drawer.classList.add('open'); refreshLogs(); autoRefreshLogs(); });
  btnClose.addEventListener('click', ()=>{ drawer.classList.remove('open'); stopAutoRefreshLogs(); });
}

function setupSearchBars(){
  const pairs = [
    ['searchTCA','tcaCallTable'], ['searchTCAPage','tcaCallList'],
    ['searchFirst','firstVisitList'], ['searchSecond','secondVisitList'],
    ['searchCompleted','completedTable'], ['searchLab','labFollowupTable'],
    ['searchArchive','archiveTable']
  ];
  pairs.forEach(([inpId,tbodyId])=>{
    const inp = document.getElementById(inpId);
    const tb = document.getElementById(tbodyId);
    if (!inp || !tb) return;
    inp.addEventListener('input', ()=>{
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const text = tr.innerText || '';
        tr.style.display = (text.toLowerCase().includes((inp.value||'').trim().toLowerCase())) ? '' : 'none';
      });
    });
  });
}

function setupExports(){
  document.getElementById('btnExportCSV')?.addEventListener('click', exportCompletedCSV);
}

/* =======================
   CHART HELPERS
   ======================= */
function buildBarChart(elId, dataArr, titleText){
  const el = document.getElementById(elId);
  if (!el) return null;
  const ctx = el.getContext('2d');
  const labels = dataArr.map(i=>i.label);
  const counts = dataArr.map(i=>i.count);
  const backgroundColors = counts.map((_,i)=>`hsla(${(i*30)%360},70%,50%,0.7)`);
  const config = {
    type:'bar',
    data:{ labels, datasets:[{ label:'Jumlah Pesakit Selesai', data:counts, backgroundColor:backgroundColors, borderColor:'rgba(0,0,0,.1)', borderWidth:1 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{ display:true, text:titleText, font:{ size:14 } }, legend:{ display:false }, datalabels:{ display:false } },
      scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Jumlah Pesakit'} }, x:{ title:{ display:true, text:'Bulan/Tahun'} } },
      animation:{ duration:500 }
    }
  };
  return new Chart(ctx, config);
}

/* =======================
   LOG CALLS DRAWER
   ======================= */
let logDrawerTimer=null, lastLogCount=0;
function setupLogDrawer(){
  document.getElementById('logSearch')?.addEventListener('input', ()=> refreshLogs());
}
function autoRefreshLogs(){ stopAutoRefreshLogs(); logDrawerTimer = setInterval(()=> refreshLogs({silent:true}), 10000); }
function stopAutoRefreshLogs(){ if (logDrawerTimer){ clearInterval(logDrawerTimer); logDrawerTimer=null; } }
async function refreshLogs(opts={}){
  const q = (document.getElementById('logSearch')?.value||'').trim();
  const loader = document.getElementById('logLoading');
  const body   = document.getElementById('logBody');
  if (!body) return;
  if (!opts.silent) loader?.classList.add('active');
  try{
    const res = await getJSON({ action:'getCallLogs', q }, { silent:true });
    if (res.status==='success'){
      const arr = res.data||[];
      lastLogCount = arr.length;
      const badge = document.getElementById('logBadge');
      if (badge) badge.textContent = arr.length;
      body.innerHTML = '';
      arr.forEach(item=>{
        const me = (item.staff||'').toLowerCase() === (STAFF_EMAIL||'').toLowerCase();
        const who = item.staff || 'STAFF';
        const text = `${item.event || 'CALL'} • ${item.nama||'-'} (${item.noIC||'-'}) • ${item.noTelefon||'-'}`;
        const when = item.time || '';
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (me?'me':'other');
        bubble.innerHTML = `<div><i class="fa-solid fa-phone-volume me-1"></i>${text}</div><div class="meta">${who} • ${when}</div>`;
        body.appendChild(bubble);
      });
      body.scrollTop = body.scrollHeight;
    }
  }catch(e){ /* senyap */ }
  finally{ if (!opts.silent) loader?.classList.remove('active'); }
}

/* =======================
   EXCEL (Kelayakan)
   ======================= */

// ===== CSV parser pintar (ganti fungsi asal; kekal nama) =====
function parseCSVText(text){
  function stripBOM(s){ return s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s; }
  function detectDelimiter(s){
    const sample = (s||'').slice(0, 3000);
    const cand = [',',';','\t','|'];
    const count = { ',':0, ';':0, '\t':0, '|':0 };
    let inQ = false;
    for (let i=0;i<sample.length;i++){
      const c = sample[i];
      if (c === '"'){
        if (inQ && sample[i+1] === '"'){ i++; }
        else inQ = !inQ;
      } else if (!inQ && count.hasOwnProperty(c)){
        count[c]++;
      }
    }
    return cand.sort((a,b)=>count[b]-count[a])[0] || ',';
  }

  const src = stripBOM(String(text||''));
  const delim = detectDelimiter(src);

  const rows = [];
  let row = [], field = '', inQuotes = false;

  for (let i = 0; i < src.length; i++){
    const ch = src[i];
    if (inQuotes){
      if (ch === '"'){
        if (src[i+1] === '"'){ field += '"'; i++; }
        else { inQuotes = false; }
      } else field += ch;
    } else {
      if (ch === '"') inQuotes = true;
      else if (ch === delim){ row.push(field); field = ''; }
      else if (ch === '\n'){ rows.push([...row, field]); row=[]; field=''; }
      else if (ch !== '\r'){ field += ch; }
    }
  }
  rows.push([...row, field]);
  return rows;
}

function setupExcel(){
  const input = document.getElementById('excelFile');
  const tbody = document.getElementById('kelayakanTable');

  input.addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;

    const name = (file.name || '').toLowerCase();
    const isCSV = name.endsWith('.csv');

    showLoader('Memproses fail…');
    try{
      if (isCSV){
        // ===== Fallback CSV (tanpa SheetJS) =====
        const text = await file.text();
        const rows = parseCSVText(text);
        tbody.innerHTML = '';
        if (!rows.length){
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada data.</td></tr>`;
          return;
        }

        // Header → indeks (case-insensitive)
        const header = rows[0].map(h => (h||'').trim().toLowerCase());
        const idx = {
          nama:    header.findIndex(h => ['nama','name'].includes(h)),
          ic:      header.findIndex(h => ['ic','no ic','kad pengenalan','nric'].includes(h)),
          telefon: header.findIndex(h => ['telefon','phone','no telefon','no tel'].includes(h)),
          alamat:  header.findIndex(h => ['alamat','address'].includes(h)),
        };

        let count = 0;
        for (let r = 1; r < rows.length; r++){
          const row = rows[r];
          if (!row || row.length === 0) continue;

          const nama   = idx.nama    >=0 ? row[idx.nama]    : '';
          const ic     = idx.ic      >=0 ? row[idx.ic]      : '';
          const telRaw = idx.telefon >=0 ? row[idx.telefon] : '';
          const alamat = idx.alamat  >=0 ? row[idx.alamat]  : '';

          if (!nama && !ic && !telRaw && !alamat) continue;

          const msisdn = normalizeMsisdnMY(telRaw);
          const id = 'x'+Date.now()+r;

          // Umur ≥40 ikut IC (YYMMDD……)
          const lahirYY = (ic||'').slice(0,2), lahirMM = (ic||'').slice(2,4), lahirDD = (ic||'').slice(4,6);
          let ageOk = false;
          if (/^\d{6}/.test(ic)){
            const y = Number(lahirYY); const fullY = (y<=29 ? 2000+y : 1900+y);
            const dob = new Date(fullY, Number(lahirMM)-1, Number(lahirDD));
            const now = new Date();
            let age = now.getFullYear() - dob.getFullYear();
            const m  = now.getMonth() - dob.getMonth();
            if (m<0 || (m===0 && now.getDate()<dob.getDate())) age--;
            ageOk = age >= 40;
          }

          const tr = `
            <tr id="${id}">
              <td>${nama||''}</td>
              <td>${ic||''}</td>
              <td>${msisdn||''}</td>
              <td>${alamat||''}</td>
              <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'checked':''} onchange="toggleLayak('${id}', true)"></td>
              <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'':'checked'} onchange="toggleLayak('${id}', false)"></td>
              <td>
                <div class="row g-1 align-items-center">
                  <div class="col"><input type="date" class="form-control form-control-sm tca-date" disabled></div>
                  <div class="col"><input type="time" class="form-control form-control-sm tca-time" disabled></div>
                  <div class="col"><input type="text" class="form-control form-control-sm tca-staff" placeholder="Nama staff" disabled></div>
                </div>
              </td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="daftarFromExcel('${id}', '${encodeURIComponent(nama||'')}', '${encodeURIComponent(ic||'')}', '${msisdn||''}', '${encodeURIComponent(alamat||'')}')" disabled>Daftar</button>
              </td>
            </tr>`;
          tbody.insertAdjacentHTML('beforeend', tr);
          count++;
        }

        if (!count){
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada data sah ditemui dalam CSV.</td></tr>`;
        } else {
          toast('Berjaya', `CSV dimuat: ${count} rekod`, 'success');
        }

      } else {
        // ===== Excel (XLSX/XLS) – guna SheetJS =====
        try { await ensureXLSXReady(); }
        catch(err){
          toast('Ralat', 'Gagal memuat SheetJS. Pastikan guna CSV jika perlu.', 'danger');
          return;
        }

        const data = await file.arrayBuffer();
        const wb = window.XLSX.read(data, { type:'array' });
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = window.XLSX.utils.sheet_to_json(ws, { defval:'' });

        tbody.innerHTML = '';
        if (!json.length){
          tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada data.</td></tr>`;
          return;
        }

        json.forEach((row, idx)=>{
          const nama   = row.Nama || row.NAMA || row.name || '';
          const ic     = row.IC || row.Ic || row.ic || '';
          const tel    = row.Telefon || row.TELEFON || row.Phone || row.phone || '';
          const alamat = row.Alamat || row.ALAMAT || row.alamat || row.address || '';
          const msisdn = normalizeMsisdnMY(tel);
          const id     = 'x'+Date.now()+idx;

          const lahirYY = ic.slice(0,2), lahirMM = ic.slice(2,4), lahirDD = ic.slice(4,6);
          let ageOk = false;
          if (/^\d{6}/.test(ic)){
            const y = Number(lahirYY); const fullY = (y<=29 ? 2000+y : 1900+y);
            const dob = new Date(fullY, Number(lahirMM)-1, Number(lahirDD));
            const now = new Date();
            let age = now.getFullYear()-dob.getFullYear();
            const m = now.getMonth()-dob.getMonth();
            if (m<0 || (m===0 && now.getDate()<dob.getDate())) age--;
            ageOk = age>=40;
          }

          const tr = `
            <tr id="${id}">
              <td>${nama}</td>
              <td>${ic}</td>
              <td>${msisdn}</td>
              <td>${alamat}</td>
              <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'checked':''} onchange="toggleLayak('${id}', true)"></td>
              <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'':'checked'} onchange="toggleLayak('${id}', false)"></td>
              <td>
                <div class="row g-1 align-items-center">
                  <div class="col"><input type="date" class="form-control form-control-sm tca-date" disabled></div>
                  <div class="col"><input type="time" class="form-control form-control-sm tca-time" disabled></div>
                  <div class="col"><input type="text" class="form-control form-control-sm tca-staff" placeholder="Nama staff" disabled></div>
                </div>
              </td>
              <td>
                <button class="btn btn-sm btn-primary" onclick="daftarFromExcel('${id}', '${encodeURIComponent(nama)}', '${encodeURIComponent(ic)}', '${msisdn}', '${encodeURIComponent(alamat)}')" disabled>Daftar</button>
              </td>
            </tr>`;
          tbody.insertAdjacentHTML('beforeend', tr);
        });

        toast('Berjaya', `Berjaya memuat naik ${json.length} rekod dari Excel`, 'success');
      }

    } catch(e){
      toast('Ralat', 'Gagal memproses fail: ' + e.message, 'danger');
    } finally {
      hideLoader();
    }
  });
}
function toggleLayak(rowId, isLayak){
  const tr = document.getElementById(rowId);
  if (!tr) return;
  const checks = tr.querySelectorAll('input[type=checkbox]');
  if (isLayak) { checks[1].checked = false; } else { checks[0].checked = false; }
  const date  = tr.querySelector('.tca-date');
  const time  = tr.querySelector('.tca-time');
  const staff = tr.querySelector('.tca-staff');
  const btn   = tr.querySelector('button');
  if (isLayak && checks[0].checked) {
    date.disabled = false; time.disabled = false; staff.disabled=false; btn.disabled = false;
  } else {
    date.disabled = true;  time.disabled = true; staff.disabled=true;  btn.disabled = true;
  }
}
async function daftarFromExcel(rowId, encNama, encIC, msisdn, encAlamat){
  const tr = document.getElementById(rowId);
  const nama = decodeURIComponent(encNama);
  const ic = decodeURIComponent(encIC);
  const alamat = decodeURIComponent(encAlamat);
  const date  = tr.querySelector('.tca-date').value;
  const time  = tr.querySelector('.tca-time').value;
  const staff = tr.querySelector('.tca-staff').value.trim();
  if (!date || !time || !staff) { toast('Ralat','Sila isi tarikh, masa & nama staff','danger'); return; }
  try{
    const res = await postForm({
      action:'daftarPesakit', namaPesakit:nama, noIC: ic, noTelefon: msisdn, alamat: alamat,
      namaStaff: staff, tarikhTCA: date, masaTCA: time
    }, { msg:'Mendaftar pesakit…' });
    if (res.status==='success'){
      toast('Berjaya',`Pesakit ${nama} didaftarkan ke TCA`, 'success');
      tr.remove();
      loadDashboardData(); loadTCACallData();
    } else throw new Error(res.message||'Gagal daftar');
  }catch(e){ toast('Ralat',e.message,'danger'); }
}

/* =======================
   NADI PAGE (tabular view)
   ======================= */
let nadiRowCounter = 0;
let nadiRows = []; // Array to store all NADI rows data

function setupNADI(){
  const container = document.getElementById('nadiContainer');
  container.innerHTML = '';
  addNadiRow();
  document.getElementById('btnNadiExportCsv').addEventListener('click', exportNadiCSV);

  // [TAMBAH] Set default tarikh program = hari ini
  const progDate = document.getElementById('nadiProgramDate');
  if (progDate && !progDate.value) progDate.value = new Date().toISOString().slice(0,10);

  // [TAMBAH] Simpan semua aktiviti (tajuk + semua baris)
  const btnSaveAll = document.getElementById('btnNadiSaveActivity');
  btnSaveAll?.addEventListener('click', saveNadiProgramActivity);

  // [TAMBAH] Export Excel format aktiviti
  const btnXlsx = document.getElementById('btnNadiExportXlsx');
  btnXlsx?.addEventListener('click', exportNadiExcel);
   NADI_LIVE_SESSION_ID = computeNadiSessionId();
  startNadiLiveSync();
}

function calculateAgeFromIC(ic) {
  if (!ic || ic.length < 6) return '';
  
  // Extract birth date from IC (YYMMDD)
  const birthYY = parseInt(ic.substring(0, 2));
  const birthMM = parseInt(ic.substring(2, 4)) - 1; // Months are 0-indexed
  const birthDD = parseInt(ic.substring(4, 6));
  
  // Determine full year (handle 2000s vs 1900s)
  const currentYear = new Date().getFullYear();
  const currentShortYear = currentYear % 100;
  const fullBirthYear = birthYY <= currentShortYear ? 2000 + birthYY : 1900 + birthYY;
  
  const birthDate = new Date(fullBirthYear, birthMM, birthDD);
  const today = new Date();
  
  // Calculate age in years
  let age = today.getFullYear() - birthDate.getFullYear();
  const m = today.getMonth() - birthDate.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
    age--;
  }
  
  // Calculate months and days since last birthday
  let months = today.getMonth() - birthDate.getMonth();
  let days = today.getDate() - birthDate.getDate();
  
  if (days < 0) {
    const lastMonth = new Date(today.getFullYear(), today.getMonth() - 1, birthDate.getDate());
    const daysInLastMonth = new Date(today.getFullYear(), today.getMonth(), 0).getDate();
    days = daysInLastMonth - birthDate.getDate() + today.getDate();
    months--;
  }
  
  if (months < 0) {
    months += 12;
  }
  
  return `${age}t ${months}b ${days}h`;
}

function updateNadiSummary() {
  let layakCount = 0;
  let takLayakCount = 0;
  
  document.querySelectorAll('.nadi-row').forEach(row => {
    if (row.querySelector('.nadi-layak').checked) {
      layakCount++;
    } else if (row.querySelector('.nadi-taklayak').checked) {
      takLayakCount++;
    }
  });
  
  document.getElementById('nadiLayakCount').textContent = layakCount;
  document.getElementById('nadiTakLayakCount').textContent = takLayakCount;
}

function addNadiRow(){
  const container = document.getElementById('nadiContainer');
  const id = 'n'+Date.now()+Math.random().toString(36).slice(2,6);
  const row = document.createElement('tr');
  row.className = 'nadi-row';
  row.id = id;

  nadiRowCounter++;

  row.innerHTML = `
    <td class="text-center">
      <div class="nadi-counter">${nadiRowCounter}</div>
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-nama" placeholder="Nama pesakit" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-ic" placeholder="IC" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode nadi-umur-view"></div>
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-tel" placeholder="Telefon" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-alamat" placeholder="Alamat" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-bp" placeholder="BP" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-pr" placeholder="PR" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td>
      <div class="input-group input-group-sm">
        <button class="btn btn-outline-secondary dropdown-toggle nadi-dxt-type-btn" data-bs-toggle="dropdown" type="button">Fasting</button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" data-value="Fasting">Fasting</a></li>
          <li><a class="dropdown-item" href="#" data-value="Random">Random</a></li>
        </ul>
        <input class="form-control nadi-dxt" placeholder="DXT" style="width:100%; min-width:80px" />
        <input type="hidden" class="nadi-dxt-type" value="Fasting" />
      </div>
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-tinggi" placeholder="Tinggi" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-berat" placeholder="Berat" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-bmi" placeholder="BMI" disabled style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="text-center">
      <input class="form-check-input nadi-layak" type="checkbox">
    </td>
    <td class="text-center">
      <input class="form-check-input nadi-taklayak" type="checkbox">
    </td>
    <!-- Kolum Remark baharu -->
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-remark" placeholder="Catatan / Remark" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td>
      <div class="d-flex gap-1">
        <input type="date" class="form-control form-control-sm nadi-tca-date" disabled style="min-width:100px">
        <input type="time" class="form-control form-control-sm nadi-tca-time" disabled style="min-width:80px">
        <input type="text" class="form-control form-control-sm nadi-staff" placeholder="Staff" disabled style="min-width:100px">
      </div>
    </td>
    <td>
      <div class="d-flex gap-1">
        <button class="btn btn-sm btn-outline-primary nadi-daftar" disabled>Daftar</button>
        <button class="btn btn-sm btn-outline-success nadi-wa">WA Report</button>
        <button class="btn btn-sm btn-outline-danger nadi-buang">Buang</button>
      </div>
    </td>
  `;

  container.appendChild(row);

  // Dropdown DXT type
  const dxtTypeBtn = row.querySelector('.nadi-dxt-type-btn');
  const dxtTypeMenu = row.querySelector('.dropdown-menu');
  const dxtTypeInput = row.querySelector('.nadi-dxt-type');
  dxtTypeMenu.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      dxtTypeBtn.textContent = this.textContent;
      dxtTypeInput.value = this.getAttribute('data-value');
    });
  });

  // BMI calc
  const tinggi = row.querySelector('.nadi-tinggi');
  const berat = row.querySelector('.nadi-berat');
  const bmi = row.querySelector('.nadi-bmi');
  const calculateBMI = () => {
    const height = parseFloat(tinggi.value) / 100;
    const weight = parseFloat(berat.value);
    if (height && weight) {
      bmi.value = (weight / (height * height)).toFixed(1);
      bmi.previousElementSibling.textContent = bmi.value;
    } else {
      bmi.value = '';
      bmi.previousElementSibling.textContent = '';
    }
  };
  tinggi.addEventListener('input', calculateBMI);
  berat.addEventListener('input', calculateBMI);

  // IC -> umur view
  const icInput = row.querySelector('.nadi-ic');
  icInput.addEventListener('input', function() {
    const umurView = row.querySelector('.nadi-umur-view');
    umurView.textContent = calculateAgeFromIC(this.value);
  });

  // Layak/Tak layak toggle
  const layak = row.querySelector('.nadi-layak');
  const takLayak = row.querySelector('.nadi-taklayak');
  const tcaDate = row.querySelector('.nadi-tca-date');
  const tcaTime = row.querySelector('.nadi-tca-time');
  const staff = row.querySelector('.nadi-staff');
  const btnDaftar = row.querySelector('.nadi-daftar');

  layak.addEventListener('change', () => {
    if (layak.checked) {
      takLayak.checked = false;
      tcaDate.disabled = false;
      tcaTime.disabled = false;
      staff.disabled = false;
      btnDaftar.disabled = false;
    } else {
      tcaDate.disabled = true;
      tcaTime.disabled = true;
      staff.disabled = true;
      btnDaftar.disabled = true;
    }
    updateNadiSummary();
  });

  takLayak.addEventListener('change', () => {
    if (takLayak.checked) {
      layak.checked = false;
      tcaDate.disabled = true;
      tcaTime.disabled = true;
      staff.disabled = true;
      btnDaftar.disabled = true;
    }
    updateNadiSummary();
  });

  // Daftar
  btnDaftar.addEventListener('click', async () => {
    const nama = row.querySelector('.nadi-nama').value.trim();
    const ic = row.querySelector('.nadi-ic').value.trim();
    const tel = row.querySelector('.nadi-tel').value.trim();
    const alamat = row.querySelector('.nadi-alamat').value.trim();
    const date = tcaDate.value;
    const time = tcaTime.value;
    const staffName = staff.value.trim();

    if (!nama || !ic || !tel || !date || !time || !staffName) {
      toast('Ralat', 'Sila isi semua maklumat', 'danger');
      return;
    }

    try {
      const res = await postForm({
        action: 'daftarPesakit',
        namaPesakit: nama,
        noIC: ic,
        noTelefon: tel,
        alamat: alamat,
        tarikhTCA: date,
        masaTCA: time,
        namaStaff: staffName
      }, { msg: 'Mendaftar pesakit...' });

      if (res.status === 'success') {
        toast('Berjaya', 'Pesakit berjaya didaftarkan', 'success');
        updateNadiRowData(row);
      } else {
        throw new Error(res.message || 'Gagal mendaftar pesakit');
      }
    } catch (e) {
      toast('Ralat', e.message, 'danger');
    }
  });

  // WA report (preview) — perhatikan: pembolehubah `data` DITAKRIF di dalam handler
  row.querySelector('.nadi-wa').addEventListener('click', async () => {
    try {
      const data = {
        nama: row.querySelector('.nadi-nama').value.trim(),
        ic: row.querySelector('.nadi-ic').value.trim(),
        tel: normalizeMsisdnMY(row.querySelector('.nadi-tel').value.trim()),
        alamat: row.querySelector('.nadi-alamat').value.trim(),
        bp: row.querySelector('.nadi-bp').value.trim(),
        pr: row.querySelector('.nadi-pr').value.trim(),
        dxtType: row.querySelector('.nadi-dxt-type').value,
        dxt: row.querySelector('.nadi-dxt').value.trim(),
        tinggi: row.querySelector('.nadi-tinggi').value.trim(),
        berat: row.querySelector('.nadi-berat').value.trim(),
        bmi: row.querySelector('.nadi-bmi').value.trim(),
        layak: row.querySelector('.nadi-layak').checked
      };
      generateWhatsAppReport(data);
    } catch (e) {
      toast('Ralat', 'Gagal buat laporan: ' + e.message, 'danger');
    }
  });

  // Buang
  row.querySelector('.nadi-buang').addEventListener('click', () => {
    if (confirm('Adakah anda pasti ingin membuang baris ini?')) {
      row.remove();
      updateNadiRowNumbers();
      updateNadiSummary();
    }
  });

  // simpan pointer baris
  nadiRows.push({ id, rowElement: row });
  // — AUTOSAVE bila input diubah —
const inputsToWatch = [
  '.nadi-nama','.nadi-ic','.nadi-tel','.nadi-alamat',
  '.nadi-bp','.nadi-pr','.nadi-dxt','.nadi-tinggi',
  '.nadi-berat','.nadi-bmi','.nadi-tca-date',
  '.nadi-tca-time','.nadi-staff','.nadi-dxt-type',
  '.nadi-remark'
];
inputsToWatch.forEach(sel=>{
  const el = row.querySelector(sel);
  if (el){
    el.addEventListener('input', ()=> queueSaveNadiLive(row));
    el.addEventListener('change', ()=> queueSaveNadiLive(row));
  }
});
layak.addEventListener('change', ()=> queueSaveNadiLive(row));
takLayak.addEventListener('change', ()=> queueSaveNadiLive(row));

// set rowId mantap (guna id baris)
row.dataset.rowId = row.id;
}

function updateNadiRowData(row) {
  const rowData = {
    nama: row.querySelector('.nadi-nama').value.trim(),
    ic: row.querySelector('.nadi-ic').value.trim(),
    tel: row.querySelector('.nadi-tel').value.trim(),
    alamat: row.querySelector('.nadi-alamat').value.trim(),
    bp: row.querySelector('.nadi-bp').value.trim(),
    pr: row.querySelector('.nadi-pr').value.trim(),
    dxtType: row.querySelector('.nadi-dxt-type').value,
    dxt: row.querySelector('.nadi-dxt').value.trim(),
    tinggi: row.querySelector('.nadi-tinggi').value.trim(),
    berat: row.querySelector('.nadi-berat').value.trim(),
    bmi: row.querySelector('.nadi-bmi').value.trim(),
    layak: row.querySelector('.nadi-layak').checked,
    takLayak: row.querySelector('.nadi-taklayak').checked,
    // ⬇️ medan baru
    remark: row.querySelector('.nadi-remark')?.value.trim() || '',
    // ⬆️ medan baru
    tcaDate: row.querySelector('.nadi-tca-date').value.trim(),
    tcaTime: row.querySelector('.nadi-tca-time').value.trim(),
    staff: row.querySelector('.nadi-staff').value.trim()
  };

  const rowId = row.id;
  const rowIndex = nadiRows.findIndex(r => r.id === rowId);
  if (rowIndex !== -1) {
    nadiRows[rowIndex].data = rowData;
  }
}


function editNadiCell(viewModeEl) {
  const input = viewModeEl.nextElementSibling;
  viewModeEl.style.display = 'none';
  input.style.display = 'block';
  input.value = viewModeEl.textContent || '';
  input.focus();
}

function saveNadiCell(inputEl) {
  const viewMode = inputEl.previousElementSibling;
  viewMode.textContent = inputEl.value || '';
  viewMode.style.display = 'block';
  inputEl.style.display = 'none';

  // If this is IC field, update age
  if (inputEl.classList.contains('nadi-ic')) {
    const row = inputEl.closest('tr');
    const umurView = row.querySelector('.nadi-umur-view');
    umurView.textContent = calculateAgeFromIC(inputEl.value);
  }

  // If this is height or weight, calculate BMI
  if (inputEl.classList.contains('nadi-tinggi') || inputEl.classList.contains('nadi-berat')) {
    const row = inputEl.closest('tr');
    const tinggi = row.querySelector('.nadi-tinggi').value;
    const berat = row.querySelector('.nadi-berat').value;
    const bmi = row.querySelector('.nadi-bmi');

    if (tinggi && berat) {
      const height = parseFloat(tinggi) / 100;
      const weight = parseFloat(berat);
      const bmiValue = (weight / (height * height)).toFixed(1);
      bmi.value = bmiValue;
      bmi.previousElementSibling.textContent = bmiValue;
    } else {
      bmi.value = '';
      bmi.previousElementSibling.textContent = '';
    }
  }
}

function updateNadiRowNumbers() {
  const rows = document.querySelectorAll('#nadiContainer tr');
  let counter = 0;
  rows.forEach(row => {
    counter++;
    const counterEl = row.querySelector('.nadi-counter');
    if (counterEl) { counterEl.textContent = counter; }
  });
  nadiRowCounter = counter;
}

function generateWhatsAppReport(data) {
  const reportContainer = document.getElementById('whatsappReportPreview');
  reportContainer.innerHTML = '';

  const reportHTML = `
    <div class="whatsapp-report">
      <div class="whatsapp-report-header">
        <img src="${LOGO_URL}" alt="Logo Klinik" class="whatsapp-report-logo" onerror="this.src='https://via.placeholder.com/50x50.png?text=KS'">
        <div>
          <div class="whatsapp-report-title">Laporan Saringan Kesihatan Bersama NADI</div>
          <div class="whatsapp-report-subtitle">Klinik SihatSokmo - Program PEKA B40</div>
        </div>
      </div>
      <div class="whatsapp-report-body">
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Nama Pesakit:</div>
          <div class="whatsapp-report-value">${data.nama || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">No. IC:</div>
          <div class="whatsapp-report-value">${data.ic || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Alamat:</div>
          <div class="whatsapp-report-value">${data.alamat || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">BP:</div>
          <div class="whatsapp-report-value">${data.bp || '-'} mmHg</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">PR:</div>
          <div class="whatsapp-report-value">${data.pr || '-'} bpm</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">DXT (${data.dxtType || 'Fasting'}):</div>
          <div class="whatsapp-report-value">${data.dxt || '-'} mmol/L</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Tinggi:</div>
          <div class="whatsapp-report-value">${data.tinggi || '-'} cm</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Berat:</div>
          <div class="whatsapp-report-value">${data.berat || '-'} kg</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">BMI:</div>
          <div class="whatsapp-report-value">${data.bmi || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Status:</div>
          <div class="whatsapp-report-value">${data.layak ? 'Layak PEKA B40' : 'Tidak Layak PEKA B40'}</div>
        </div>
      </div>
      <div class="whatsapp-report-footer">
        Sila hubungi klinik untuk maklumat lanjut. Terima kasih.
      </div>
    </div>
  `;

  reportContainer.innerHTML = reportHTML;
  currentWhatsAppData = data;
  CURRENT_WA_MSISDN = data.tel || '';  // SIMPAN no. telefon untuk hantar gambar
  whatsappReportModal.show();
}

function sendWhatsAppReport() {
  if (!currentWhatsAppData) return;

  // Validasi: pastikan status kelayakan dipilih (layak atau tidak)
  if (typeof currentWhatsAppData.layak !== 'boolean') {
    toast('Ralat', 'Sila pilih status Layak / Tidak Layak sebelum hantar laporan.', 'danger');
    return;
  }

  const nama = currentWhatsAppData.nama || '';
  const ic = currentWhatsAppData.ic || '';
  const bp = currentWhatsAppData.bp || '';
  const pr = currentWhatsAppData.pr || '';
  const dxtType = currentWhatsAppData.dxtType || 'Fasting';
  const dxt = currentWhatsAppData.dxt || '';
  const tinggi = currentWhatsAppData.tinggi || '';
  const berat = currentWhatsAppData.berat || '';
  const bmi = currentWhatsAppData.bmi || '';
  const layak = currentWhatsAppData.layak ? 'Layak PEKA B40' : 'Tidak Layak PEKA B40';

  const message = `Laporan Saringan Kesihatan Bersama NADI
Nama: ${nama}
IC: ${ic}
BP: ${bp} mmHg
PR: ${pr} bpm
DXT (${dxtType}): ${dxt} mmol/L
Tinggi: ${tinggi} cm
Berat: ${berat} kg
BMI: ${bmi}
Status: ${layak}

Sila hubungi klinik untuk maklumat lanjut. Terima kasih.`;

  if (currentWhatsAppData.tel) {
    window.open(waHref(currentWhatsAppData.tel, message), '_blank');
    whatsappReportModal.hide();
    toast('Berjaya', 'Laporan (teks) dihantar melalui WhatsApp', 'success');
  } else {
    toast('Ralat', 'Nombor telefon tidak sah', 'danger');
  }
}

// GANTIKAN fungsi ini
/* ===== Export Aktiviti NADI → Excel (XLSX) dahulu, jatuh ke CSV ===== */
// GANTIKAN fungsi exportNadiCSV() sedia ada dengan yang ini
async function exportNadiCSV() {
  const rows = Array.from(document.querySelectorAll('#nadiContainer .nadi-row'));
  if (!rows.length) {
    toast('Makluman','Tiada data untuk diexport','warning');
    return;
  }

  // Ambil tajuk & tarikh program (guna input jika ada; jika tiada, guna default)
  const programTitle = (document.getElementById('nadiProgramTitle')?.value || 'Tajuk Program').trim();
  const programDate  = (document.getElementById('nadiProgramDate')?.value || new Date().toISOString().slice(0,10)).trim();

  // Header mengikut susunan yang diminta
  const HEADER = ['TARIKH','NAMA','NO IC','NO TEL','ALAMAT','WT','HT','BP','HR','UMUR','BMI','DXT TYPE','DXT','KELAYAKAN PEKA B40'];

  // Row tajuk: letak tajuk pada kolum TENGAH (supaya nampak benar² di tengah jadual dalam .xlsx dan .csv)
  const midCol = Math.floor(HEADER.length / 2);     // 14 -> 7 (0-based) -> lajur ke-8 (H)
  const titleRow = Array(HEADER.length).fill('');
  titleRow[midCol] = programTitle;

  // Kumpul data baris mengikut header
  const dataRows = rows.map(r => {
    const nama    = r.querySelector('.nadi-nama')?.value.trim() || '';
    const ic      = r.querySelector('.nadi-ic')?.value.trim() || '';
    const tel     = r.querySelector('.nadi-tel')?.value.trim() || '';
    const alamat  = r.querySelector('.nadi-alamat')?.value.trim() || '';
    const wt      = r.querySelector('.nadi-berat')?.value.trim() || '';     // kg
    const ht      = r.querySelector('.nadi-tinggi')?.value.trim() || '';    // cm
    const bp      = r.querySelector('.nadi-bp')?.value.trim() || '';
    const hr      = r.querySelector('.nadi-pr')?.value.trim() || '';
    const umurTxt = r.querySelector('.nadi-umur-view')?.textContent.trim() || ''; // cth "52t 3b 2h"
    const umur    = (umurTxt.match(/^(\d+)/)?.[1]) || umurTxt || '';        // ambil tahun sahaja jika ada
    const bmi     = r.querySelector('.nadi-bmi')?.value.trim() || '';
    const dxtType = r.querySelector('.nadi-dxt-type')?.value || '';
    const dxt     = r.querySelector('.nadi-dxt')?.value.trim() || '';
    const kelayak = r.querySelector('.nadi-layak')?.checked ? 'Layak' : 'Tidak Layak';

    return [programDate, nama, ic, tel, alamat, wt, ht, bp, hr, umur, bmi, dxtType, dxt, kelayak];
  });

  // Cuba hasilkan Excel (.xlsx) dahulu
  try {
    if (typeof ensureXLSXReady === 'function') {
      await ensureXLSXReady(); // dari kod anda: akan load xlsx.full.min.js jika belum ada
    }
    if (window.XLSX) {
      const wb  = XLSX.utils.book_new();
      const aoa = [titleRow, HEADER, ...dataRows];
      const ws  = XLSX.utils.aoa_to_sheet(aoa);

      // Lebar kolum asas yang kemas
      ws['!cols'] = [
        { wch: 12 }, // TARIKH
        { wch: 22 }, // NAMA
        { wch: 18 }, // NO IC
        { wch: 16 }, // NO TEL
        { wch: 36 }, // ALAMAT
        { wch: 8  }, // WT
        { wch: 8  }, // HT
        { wch: 12 }, // BP
        { wch: 8  }, // HR
        { wch: 8  }, // UMUR
        { wch: 8  }, // BMI
        { wch: 12 }, // DXT TYPE
        { wch: 10 }, // DXT
        { wch: 12 }  // KELAYAKAN
      ];

      // Nota: SheetJS komuniti tidak menulis gaya (bold/center) ke fail.
      // Trik "tajuk di kolum tengah" memastikan ia sentiasa nampak centred merentasi jadual.

      XLSX.utils.book_append_sheet(wb, ws, 'Aktiviti Program');

      // Nama fail kemas (slug tajuk)
      const safeTitle = programTitle
        .replace(/[^\p{L}\p{N}\-_. ]/gu,'') // buang aksara pelik
        .trim().replace(/\s+/g,'_').slice(0,60);
      const fname = `aktiviti_program_${programDate}${safeTitle ? '_' + safeTitle : ''}.xlsx`;

      XLSX.writeFile(wb, fname);
      toast('Export','Fail Excel dimuat turun','success');
      return;
    }
  } catch (e) {
    // Teruskan ke CSV fallback
  }

  // Fallback: CSV (tajuk berada di kolum tengah juga)
  const BOM = '\uFEFF'; // elak isu aksara di Excel
  const toCsvRow = arr => arr.map(v => `"${String(v ?? '').replace(/"/g,'""')}"`).join(',');
  const csv = [titleRow, HEADER, ...dataRows].map(toCsvRow).join('\r\n');

  const blob = new Blob([BOM + csv], { type:'text/csv;charset=utf-8;' });
  const url  = URL.createObjectURL(blob);
  const a    = Object.assign(document.createElement('a'), {
    href: url,
    download: `aktiviti_program_${programDate}.csv`
  });
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Export','Fail CSV dimuat turun','success');
}

function collectNadiRowsForActivity(){
  const rows  = Array.from(document.querySelectorAll('#nadiContainer .nadi-row'));
  const title = (document.getElementById('nadiProgramTitle')?.value || '').trim();
  const d     = (document.getElementById('nadiProgramDate')?.value || '').trim();
  const tarikh= d || new Date().toISOString().slice(0,10);

  const items = [];

  rows.forEach(r => {
    const val  = (sel) => (r.querySelector(sel)?.value ?? '').trim();
    const text = (sel) => (r.querySelector(sel)?.textContent ?? '').trim();

    const nama    = val('.nadi-nama');
    const ic      = val('.nadi-ic');
    const tel     = val('.nadi-tel');
    const alamat  = val('.nadi-alamat');
    const wt      = val('.nadi-berat');   // kg
    const ht      = val('.nadi-tinggi');  // cm
    const bp      = val('.nadi-bp');
    const hr      = val('.nadi-pr');
    const umurTxt = text('.nadi-umur-view');
    const bmi     = val('.nadi-bmi');
    const dxtType = val('.nadi-dxt-type');   // hidden input yang pegang Fasting/Random
    const dxt     = val('.nadi-dxt');
    const layakCB = r.querySelector('.nadi-layak')?.checked || false;
    const kelayak = layakCB ? 'Layak' : 'Tidak Layak';
    const remark  = val('.nadi-remark');     // jika anda sudah tambah kolum Remark

    // Anggap "ada isi" jika sekurang-kurangnya satu medan utama terisi
    const adaIsi = [nama, ic, tel, alamat, bp, hr, dxt, ht, wt, bmi].some(Boolean);

    if (adaIsi){
      items.push({
        tarikh, nama, ic, tel, alamat,
        wt, ht, bp, hr, umur: umurTxt, bmi,
        dxtType, dxt, kelayak, remark
      });
    }
  });

  return { title, tarikh, items };
}
/* =======================
   NADI LIVE SYNC (baru)
   ======================= */

// Kumpul payload 1 baris (digunakan utk autosave)
function extractRowPayload(row){
  const id      = row.dataset.rowId || row.id;
  const nama    = row.querySelector('.nadi-nama')?.value.trim() || '';
  const ic      = row.querySelector('.nadi-ic')?.value.trim() || '';
  const tel     = row.querySelector('.nadi-tel')?.value.trim() || '';
  const alamat  = row.querySelector('.nadi-alamat')?.value.trim() || '';
  const bp      = row.querySelector('.nadi-bp')?.value.trim() || '';
  const pr      = row.querySelector('.nadi-pr')?.value.trim() || '';
  const dxtType = row.querySelector('.nadi-dxt-type')?.value || '';
  const dxt     = row.querySelector('.nadi-dxt')?.value.trim() || '';
  const tinggi  = row.querySelector('.nadi-tinggi')?.value.trim() || '';
  const berat   = row.querySelector('.nadi-berat')?.value.trim() || '';
  const bmi     = row.querySelector('.nadi-bmi')?.value.trim() || '';
  const layak   = !!row.querySelector('.nadi-layak')?.checked;
  const takLayak= !!row.querySelector('.nadi-taklayak')?.checked;
  const tcaDate = row.querySelector('.nadi-tca-date')?.value || '';
  const tcaTime = row.querySelector('.nadi-tca-time')?.value || '';
  const tcaStaff= row.querySelector('.nadi-staff')?.value.trim() || '';
  const remark  = row.querySelector('.nadi-remark')?.value.trim() || '';

  return {
    id, nama, ic, tel, alamat,
    bp, pr, dxtType, dxt, tinggi, berat, bmi,
    layak, takLayak, tcaDate, tcaTime, tcaStaff,
    remark
  };
}

// Queue save (debounce per baris)
function queueSaveNadiLive(row){
  if (!NADI_LIVE_SESSION_ID) return;           // tiada sesi (tajuk kosong)
  const payload = extractRowPayload(row);
  nadiLiveSaveQueue.set(payload.id, payload);
  // Debounce global
  if (!nadiLiveSaving){
    nadiLiveSaving = true;
    setTimeout(async ()=>{
      try{
        const items = Array.from(nadiLiveSaveQueue.values());
        nadiLiveSaveQueue.clear();
        await postForm({
          action: 'saveNadiLive',
          sessionId: NADI_LIVE_SESSION_ID,
          items: JSON.stringify(items)
        }, { silent:true });
      }catch(e){ /* senyap */ }
      finally{ nadiLiveSaving = false; }
    }, 400);
  }
}

// Mula tarik data berkala
function startNadiLiveSync(){
  stopNadiLiveSync();
  if (!NADI_LIVE_SESSION_ID) return; // tajuk belum diisi
  // Tarik sekali segera
  pullNadiLiveOnce();
  // Kemudian setiap 6s
  nadiLiveTimer = setInterval(pullNadiLiveOnce, 6000);
}
function stopNadiLiveSync(){
  if (nadiLiveTimer){ clearInterval(nadiLiveTimer); nadiLiveTimer = null; }
}

// Tarik sekali & gabung ke UI
async function pullNadiLiveOnce(){
  try{
    const res = await getJSON({
      action: 'getNadiLive',
      sessionId: NADI_LIVE_SESSION_ID
    }, { silent:true });
    if (res.status==='success' && Array.isArray(res.items)){
      mergeLiveRowsIntoUI(res.items);
    }
  }catch(e){ /* senyap */ }
}

// Gabung rekod masuk ke UI (tanpa kacau input sedang fokus)
function mergeLiveRowsIntoUI(items){
  const byId = (id)=> document.querySelector(`#nadiContainer .nadi-row[data-row-id="${id}"]`)
             || document.getElementById(id);

  items.forEach(it=>{
    let row = byId(it.id);
    if (!row){
      // jika baris belum wujud, tambah baris baharu dulu
      addNadiRow();
      row = byId(it.id) || document.querySelector('#nadiContainer .nadi-row:last-child');
      if (row) row.dataset.rowId = it.id;
    }
    if (!row) return;

    // Jangan override jika user sedang menaip pada medan itu
    const safeSet = (sel, val) => {
      const el = row.querySelector(sel);
      if (!el) return;
      if (document.activeElement === el) return; // biar user habis menaip
      if (el.tagName==='INPUT' || el.tagName==='TEXTAREA'){
        if (el.type==='checkbox'){
          el.checked = !!val;
        } else {
          el.value = val || '';
          // jika ada view-mode (inline edit), pantulkan
          if (el.previousElementSibling && el.previousElementSibling.classList.contains('view-mode')){
            el.previousElementSibling.textContent = el.value || '';
          }
        }
      }
    };

    safeSet('.nadi-nama', it.nama);
    safeSet('.nadi-ic', it.ic);
    safeSet('.nadi-tel', it.tel);
    safeSet('.nadi-alamat', it.alamat);
    safeSet('.nadi-bp', it.bp);
    safeSet('.nadi-pr', it.pr);
    // dxt type (butang dropdown – hanya tukar hidden value & label jika tak fokus)
    const dxtTypeInput = row.querySelector('.nadi-dxt-type');
    const dxtTypeBtn   = row.querySelector('.nadi-dxt-type-btn');
    if (dxtTypeInput && document.activeElement !== dxtTypeInput){
      dxtTypeInput.value = it.dxtType || dxtTypeInput.value;
      if (dxtTypeBtn && !dxtTypeBtn.matches(':focus')) dxtTypeBtn.textContent = dxtTypeInput.value || 'Fasting';
    }
    safeSet('.nadi-dxt', it.dxt);
    safeSet('.nadi-tinggi', it.tinggi);
    safeSet('.nadi-berat', it.berat);
    safeSet('.nadi-bmi', it.bmi);
    safeSet('.nadi-tca-date', it.tcaDate);
    safeSet('.nadi-tca-time', it.tcaTime);
    safeSet('.nadi-staff', it.tcaStaff);
    safeSet('.nadi-remark', it.remark);

    // checkbox layak/tak layak – hormati mutual exclusive (guna helper asal)
    const layak   = row.querySelector('.nadi-layak');
    const takLayak= row.querySelector('.nadi-taklayak');
    if (layak && document.activeElement !== layak) layak.checked = !!it.layak;
    if (takLayak && document.activeElement !== takLayak) takLayak.checked = !!it.takLayak;

    // Pantulkan status enable/disable input TCA ikut logik asal
    const tcaDate = row.querySelector('.nadi-tca-date');
    const tcaTime = row.querySelector('.nadi-tca-time');
    const staff   = row.querySelector('.nadi-staff');
    const btnDaftar = row.querySelector('.nadi-daftar');
    if (layak && takLayak && tcaDate && tcaTime && staff && btnDaftar){
      if (layak.checked){
        takLayak.checked = false;
        tcaDate.disabled = false; tcaTime.disabled = false; staff.disabled = false; btnDaftar.disabled = false;
      } else if (takLayak.checked){
        layak.checked = false;
        tcaDate.disabled = true;  tcaTime.disabled = true;  staff.disabled = true;  btnDaftar.disabled = true;
      } else {
        // tiada pilihan → disable TCA
        tcaDate.disabled = true;  tcaTime.disabled = true;  staff.disabled = true;  btnDaftar.disabled = true;
      }
    }
  });

  // kemas kini ringkasan
  updateNadiSummary?.();
}

function collectNadiItems(){
  // Ambil payload sedia ada
  const payload = collectNadiRowsForActivity() || {};
  const rows = Array.isArray(payload.items) ? payload.items : [];

  // Peta nama medan:
  // tel     -> telefon
  // wt/ht   -> berat/tinggi
  // hr      -> pr
  // kelayak -> layak/takLayak + status
  return rows.map(r => {
    const kel = String(r.kelayak || '').trim().toLowerCase(); // "Layak" / "Tidak Layak"
    const isLayak = kel === 'layak';
    const isTak   = kel === 'tidak layak' || kel === 'tak layak';

    return {
      nama    : r.nama    || '',
      ic      : r.ic      || '',
      umur    : r.umur    || '',                 // jika kosong pun ok
      telefon : normalizeMsisdnMY(r.tel || ''),  // norm msisdn
      alamat  : r.alamat  || '',
      bp      : r.bp      || '',
      pr      : r.hr      || '',
      dxt     : r.dxt     || '',
      tinggi  : r.ht      || '',
      berat   : r.wt      || '',
      bmi     : r.bmi     || '',
      layak   : !!isLayak,
      takLayak: !!isTak,
      status  : isLayak ? 'LAYAK' : (isTak ? 'TAK LAYAK' : ''),
      // TCA di jadual NADI memang ada input, tapi jika collectNadiRowsForActivity
      // anda tidak mengembalikannya, biarkan kosong (code.gs tidak wajibkan).
      tcaDate : '',
      tcaTime : '',
      tcaStaff: '',
      // Simpan juga dxtType jika ada (tidak mandatory di code.gs)
      dxtType : r.dxtType || ''
    };
  });
}
async function saveNadiProgramActivity(){
  const { title, tarikh, items } = collectNadiRowsForActivity();

  // Auto-fallback tajuk jika kosong
  const finalTitle = (title && title.trim())
    ? title.trim()
    : `Program PEKA B40 bersama NADI (${tarikh})`;

  if (!items || !items.length){
    toast('Ralat','Tiada baris peserta untuk disimpan','danger');
    return;
  }

  try{
    const res = await postForm({
      action: 'saveNadiActivity',       // selari dengan code.gs
      programTitle: finalTitle,
      programDate: tarikh,
      items: JSON.stringify(items)
    }, { msg: 'Menyimpan aktiviti…' });

    if (res.status === 'success'){
  toast('Berjaya', 'Aktiviti program disimpan ke sheet aktiviti', 'success');

  // [PILIHAN] — kosongkan live cache
  if (NADI_LIVE_SESSION_ID){
    try{ await postForm({ action:'clearNadiLive', sessionId: NADI_LIVE_SESSION_ID }, { silent:true }); }catch(e){}
  }
} else {
  throw new Error(res.message || 'Gagal simpan aktiviti');
}

  } catch(e){
    toast('Ralat', e.message, 'danger');
  }
}



// Pastikan butang di-wire sekali sahaja
(function wireNadiSaveButtonOnce(){
  const btn = document.getElementById('btnNadiSaveActivity');
  if (!btn || btn._wiredSaveNadi) return;
  btn.addEventListener('click', saveNadiProgramActivity);
  btn._wiredSaveNadi = true;
})();
/* =======================
   DATA LOADERS
   ======================= */
async function loadDashboardData(){
  try{
    const data = await getJSON({ action:'getDashboardData' }, { msg:'Memuat Dashboard…' });
    if (data.status==='success'){
      const d = data.data || {};
      totalDaftar.textContent = d.totalDaftar || 0;
      totalFirstVisit.textContent = d.totalFirstVisit || 0;
      totalSecondVisit.textContent = d.totalSecondVisit || 0;
      totalSelesai.textContent = d.totalSelesai || 0;
      labFollowUpDue.textContent = d.labFollowUpDue || 0;
      labFollowUpPending.textContent = d.labFollowUpPending || 0;

      // Badges navbar (tunjuk hanya jika >0)
      setBadge('badgeTCA', d.totalDaftar);
      setBadge('badgeFirst', d.totalFirstVisit);
      setBadge('badgeSecond', d.totalSecondVisit);
      setBadge('badgeLab', d.labFollowUpDue + d.labFollowUpPending);
    }
  }catch(e){ toast('Ralat','Gagal memuat data dashboard','danger'); }
}
function setBadge(id,val){
  const el = document.getElementById(id);
  if (!el) return;
  if (val>0){ el.textContent = val; el.style.display='inline-block'; }
  else { el.style.display='none'; }
}

async function loadStatistics(period){
  try{
    const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…' });
    if (data.status==='success'){
      if (stats3dChart) stats3dChart.destroy();
      stats3dChart = buildBarChart('stats3dChart', data.data, `Statistik Pesakit Selesai (${getPeriodLabel(period)})`);
    }
  }catch(e){}
}
async function loadCompletedStatistics(period){
  try{
    const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…' });
    if (data.status==='success'){
      if (completed3dChart) completed3dChart.destroy();
      completed3dChart = buildBarChart('completed3dChart', data.data, `Statistik Pesakit Selesai (${getPeriodLabel(period)})`);
    }
  }catch(e){}
}
function getPeriodLabel(p){ if(p==='3months')return'3 Bulan Terakhir'; if(p==='6months')return'6 Bulan Terakhir'; if(p==='12months')return'12 Bulan Terakhir'; return p; }

async function loadTCACallData(){
  try{
    const data = await getJSON({ action:'getTCACall' }, { msg:'Memuat TCA Hari Ini…' });
    const tb1 = document.getElementById('tcaCallTable');
    if (tb1) tb1.innerHTML = '';

    const renderRow = (p) => {
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      return `
      <tr data-ic="${p.noIC}">
        <td>${p.nama}</td>
        <td>${p.noIC}</td>
        <td class="mini-actions">
          <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          <div class="small text-muted mt-1">${msisdn}</div>
        </td>
        <td>${p.alamat || '-'}</td>
        <td>${p.tarikhTCA}</td>
        <td><span class="badge ${p.status==='CALLED'?'bg-success':'bg-warning'}">${p.status || 'PENDING'}</span></td>
      </tr>`;
    };

    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{ if (tb1) tb1.insertAdjacentHTML('beforeend', renderRow(p)); });
    } else {
      if (tb1) tb1.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada pesakit perlu dihubungi hari ini</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

/* === TCA PAGE (rekod; tiada tanda selesai manual) === */
let TCA_ALL = [];
async function loadTCACallPage(){
  try{
    const res = await getJSON({ action:'getTCACall', all:1 }, { msg:'Memuat rekod TCA…' });
    TCA_ALL = (res.status==='success') ? (res.data||[]) : [];
    renderTcaList('today');
  }catch(e){ renderTcaList('all'); }
  document.querySelectorAll('#tcaFilter [data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#tcaFilter [data-filter]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderTcaList(btn.getAttribute('data-filter'));
    });
  });
}
function renderTcaList(mode){
  const tbody = document.getElementById('tcaCallList');
  if (!tbody) return;

  tbody.innerHTML = '';
  const today = new Date(); today.setHours(0,0,0,0);

  const filtered = (TCA_ALL || []).filter(p => {
    const d = parseDDMMYYYY(p.tarikhTCA);
    if (!d) return mode === 'all';
    d.setHours(0,0,0,0);

    if (mode === 'today')    return isSameDay(d, today);
    if (mode === 'upcoming') return d > today;
    if (mode === 'past')     return d < today;
    return true; // 'all'
  });

  if (!filtered.length){
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada rekod untuk paparan ini</td></tr>`;
    return;
  }

  filtered.forEach(p => {
    const msisdn = normalizeMsisdnMY(p.noTelefon || '');
    const statusClass = (p.status === 'CALLED') ? 'bg-success' : 'bg-warning';
    const rowHtml = `
      <tr data-ic="${p.noIC}">
        <td>${p.nama || '-'}</td>
        <td>${p.noIC || '-'}</td>
        <td class="mini-actions">
          <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          <div class="small text-muted mt-1">${msisdn || '-'}</div>
        </td>
        <td>${p.alamat || '-'}</td>
        <td>${p.tarikhTCA || '-'}</td>
        <td><span class="badge ${statusClass}">${p.status || 'PENDING'}</span></td>
      </tr>`;
    tbody.insertAdjacentHTML('beforeend', rowHtml);
  });
}
async function loadFirstVisitData(){
  try{
    const data = await getJSON({ action:'getFirstVisit' }, { msg:'Memuat First Visit…' });
    const tbody = document.getElementById('firstVisitList');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const hadir = p.status==='HADIR';
        const within = isWithin24hOfDate(p.tarikhTCA);
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');

        let pdpaHTML = '';
        if (p.pdpaFileId){
          pdpaHTML = `
            <div class="d-flex flex-wrap gap-1">
              <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deletePDPA('${p.noIC}')"><i class="fa-solid fa-trash"></i> Padam</button>
            </div>`;
        } else {
          pdpaHTML = hadir ? `<button class="btn btn-sm btn-outline-primary" onclick="openPDPA('${p.noIC}')"><i class="fa-solid fa-file-arrow-up"></i> Upload</button>`
                           : `<span class="text-muted">-</span>`;
        }

        const row = `
        <tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td>${p.alamat || '-'}</td>
          <td>${p.tarikhTCA||'-'}</td>
          <td>${pdpaHTML}</td>
          <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
          <td class="mini-actions">
            ${within && !hadir ? `<button class="btn btn-sm btn-success" onclick="markFirstVisit('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
            ${!hadir ? `<button class="btn btn-sm btn-primary" onclick="openRetcaModal('${p.noIC}')"><i class="fa-solid fa-calendar-plus"></i> Re-TCA</button>` : ''}
            ${msisdn ? `
              <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
              <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
          </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data First Visit</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

function isWithin24hOfDate(dateStr){
  const d = parseDDMMYYYY(dateStr);
  if (!d) return false;
  const start = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
  const end = new Date(start.getTime() + 24*60*60*1000);
  const now = new Date();
  return now >= start && now < end;
}

async function loadLabFollowUp(){
  try{
    const data = await getJSON({ action:'getLabFollowUp' }, { msg:'Memuat Follow-up Lab…' });
    const tbody = document.getElementById('labFollowupTable');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        const badge = p.labStatus==='DONE' ? 'bg-success' : (p.labStatus==='REPEAT' ? 'bg-danger' : (p.labStatus==='IN_PROCESS' ? 'bg-warning' : 'bg-secondary'));
        const label = p.labStatus || 'PENDING';
        const row = `
        <tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td class="mini-actions">
            <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
            <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn,'Keputusan makmal anda telah siap.')}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
            <div class="small text-muted mt-1">${msisdn}</div>
          </td>
          <td>${p.alamat || '-'}</td>
          <td>${p.firstVisitDate}</td>
          <td>${p.daysSince}</td>
          <td><span class="badge ${badge}">${label}</span></td>
          <td class="mini-actions">
            <button class="btn btn-sm btn-success" onclick="openSecondTca('${p.noIC}')"><i class="fa-solid fa-square-check"></i> Result complete & berjaya call</button>
            <button class="btn btn-sm btn-warning" onclick="markLabStatus('${p.noIC}','IN_PROCESS')"><i class="fa-solid fa-hourglass-half"></i> In process</button>
            <button class="btn btn-sm btn-danger" onclick="markLabStatus('${p.noIC}','REPEAT')"><i class="fa-solid fa-rotate-left"></i> Repeat sample</button>
          </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada pesakit untuk follow-up.</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

async function loadSecondVisitData(){
  try{
    const data = await getJSON({ action:'getSecondVisit' }, { msg:'Memuat Second Visit…' });
    const tbody = document.getElementById('secondVisitList');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const hadir = p.status==='HADIR';
        const within = isWithin24hOfDate(p.tarikhTCA);
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');

        let pdpaHTML = p.pdpaFileId
          ? `<div class="d-flex flex-wrap gap-1">
              <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
            </div>`
          : `<span class="text-danger">PDPA tiada</span>`;

        const row = `
        <tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td>${p.alamat || '-'}</td>
          <td>${p.tarikhTCA||'-'}</td>
          <td>${pdpaHTML}</td>
          <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
          <td class="mini-actions">
            ${within && !hadir ? `<button class="btn btn-sm btn-success" onclick="markSecondVisitHadir('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
            ${msisdn ? `
              <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
              <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
          </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data Second Visit</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

async function loadCompletedData(){
  try{
    const data = await getJSON({ action:'getCompleted' }, { msg:'Memuat Selesai…' });
    const tbody = document.getElementById('completedTable');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        const pdpaHTML = p.pdpaFileId
          ? `<div class="d-flex flex-wrap gap-1">
              <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
            </div>`
          : `<span class="text-muted">-</span>`;

        const labCompleted = p.labCompletedAt ? `${p.labCompletedAt}` : '-';
        const row = `<tr data-ic="${p.noIC}">
          <td>${p.nama}</td><td>${p.noIC}</td><td>${msisdn}</td><td>${p.alamat || '-'}</td><td>${pdpaHTML}</td>
          <td>${p.tarikhDaftar||'-'}</td>
          <td>${p.firstVisitDate||'-'}</td>
          <td>${labCompleted}</td>
          <td>${p.secondVisitDate||'-'}</td>
          <td>${p.tarikhSelesai||'-'}</td>
          <td><button class="btn btn-sm btn-outline-secondary" onclick="archivePatient('${p.noIC}')"><i class="fa-solid fa-box-archive"></i> Arkib</button></td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted">Tiada data pesakit selesai</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

async function loadArchivedData(){
  try{
    const data = await getJSON({ action:'getArchived' }, { msg:'Memuat Arkib…' });
    const tbody = document.getElementById('archiveTable');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        const row = `<tr data-ic="${p.noIC}">
          <td>${p.nama}</td><td>${p.noIC}</td><td>${msisdn}</td><td>${p.alamat || '-'}</td><td>${p.tarikhDaftar}</td><td>${p.tarikhSelesai}</td><td>${p.archivedAt||'-'}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="restorePatient('${p.noIC}')"><i class="fa-solid fa-rotate-left"></i> Pulihkan</button></td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada rekod arkib</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

/* =======================
   ACTIONS
   ======================= */
async function markFirstVisit(noIC){
  try{
    const res = await postForm({ action:'updateStatus', op:'firstVisit', noIC, staff: STAFF_EMAIL }, { msg:'Merekod Hadir (First Visit)…' });
    if (res.status==='success'){
      toast('Berjaya','Hadir (First Visit) direkodkan. Sila muat naik PDPA.', 'success');
      openPDPA(noIC);
      loadFirstVisitData(); loadLabFollowUp(); loadSecondVisitData(); loadDashboardData();
    } else throw new Error(res.message||'Gagal rekod hadir');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
async function markSecondVisitHadir(noIC){
  try{
    const res = await postForm({ action:'updateStatus', op:'secondVisitHadir', noIC, staff: STAFF_EMAIL }, { msg:'Menandakan Hadir (Second Visit)…' });
    if (res.status==='success'){
      toast('Berjaya','Second Visit selesai → Selesai','success');
      loadSecondVisitData(); loadCompletedData(); loadDashboardData();
    } else throw new Error(res.message||'Gagal menandakan hadir');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

function openRetcaModal(noIC){
  document.getElementById('retcaIC').value = noIC;
  document.getElementById('retcaDate').value = '';
  document.getElementById('retcaTime').value = '';
  retcaModal.show();
}
async function submitRetca(){
  const noIC = document.getElementById('retcaIC').value;
  const tarikhTCA = document.getElementById('retcaDate').value;
  const masaTCA = document.getElementById('retcaTime').value;
  if (!noIC || !tarikhTCA || !masaTCA) return toast('Ralat','Sila lengkapkan tarikh & masa','danger');
  try{
    const res = await postForm({ action:'updateStatus', op:'retca', noIC, tarikhTCA, masaTCA, staff: STAFF_EMAIL }, { msg:'Mendaftar TCA semula…' });
    if (res.status==='success'){
      retcaModal.hide();
      toast('Berjaya','TCA baharu disimpan','success');
      loadTCACallData(); loadFirstVisitData(); loadSecondVisitData(); loadDashboardData();
    } else throw new Error(res.message||'Gagal kemaskini TCA');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

/* Lab complete → set second TCA + log caller + set Lab DONE */
function openSecondTca(noIC){
  document.getElementById('secondTcaIC').value = noIC;
  document.getElementById('secondTcaDate').value = '';
  document.getElementById('secondTcaTime').value = '';
  document.getElementById('secondTcaStaff').value = '';
  secondTcaModal.show();
}
async function submitSecondTca(){
  const noIC = document.getElementById('secondTcaIC').value;
  const date = document.getElementById('secondTcaDate').value;
  const time = document.getElementById('secondTcaTime').value;
  const staff= document.getElementById('secondTcaStaff').value.trim();
  if (!date || !time || !staff) { toast('Ralat','Sila isi tarikh, masa & nama staff','danger'); return; }
  try{
    const a = await postForm({ action:'updatePatient', noIC, tarikhTCA:date, masaTCA:time, staff }, { msg:'Menetapkan TCA Second Visit…' });
    if (a.status!=='success') throw new Error(a.message||'Gagal tetapkan TCA');

    const b = await postForm({ action:'logCall', noIC, staff, event:'LAB_COMPLETE_CALL' }, { msg:'Merekod log panggilan…' });
    if (b.status!=='success') throw new Error(b.message||'Gagal rekod log');

    const c = await postForm({ action:'updateLabStatus', noIC, status:'DONE', staff }, { msg:'Mengemas kini status follow-up…' });
    if (c.status!=='success') throw new Error(c.message||'Gagal set follow-up DONE');

    secondTcaModal.hide();
    toast('Berjaya','TCA Second Visit ditetapkan, log disimpan & lab ditanda Selesai','success');

    loadLabFollowUp(); loadSecondVisitData(); loadCompletedData(); loadDashboardData();
    refreshLogs({silent:true});
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

function openPDPA(noIC){
  document.getElementById('pdpaIC').value = noIC;
  document.getElementById('pdpaFile').value = '';
  pdpaModal.show();
}
async function uploadPDPA(){
  const noIC = document.getElementById('pdpaIC').value;
  const file = document.getElementById('pdpaFile').files[0];
  if (!file) { toast('Ralat','Sila pilih fail PDPA','danger'); return; }

  showLoader('Memuat naik PDPA…');
  try{
    const base64 = await fileToBase64(file); const pure64 = base64.split(',').pop();
    const res = await fetch(SCRIPT_URL, {
      method: 'POST',
      headers: { 'Content-Type':'application/x-www-form-urlencoded' },
      body: new URLSearchParams({
        action: 'uploadPDPA', id_token: ID_TOKEN, noIC, staff: STAFF_EMAIL,
        fileBase64: pure64, fileName: file.name, fileType: file.type || 'application/octet-stream'
      })
    });
    const json = await res.json();
    if (json.status === 'success'){
      pdpaModal.hide();
      toast('Berjaya','PDPA dimuat naik','success');
      loadFirstVisitData(); loadSecondVisitData(); loadCompletedData();
    } else { throw new Error(json.message || 'Gagal muat naik PDPA'); }
  } catch(e){
    toast('Ralat', e.message, 'danger');
  } finally { hideLoader(); }
}
function fileToBase64(file){
  return new Promise((resolve, reject)=>{
    const fr = new FileReader();
    fr.onload = () => resolve(fr.result);
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

async function deletePDPA(noIC){
  if (!confirm('Padam PDPA untuk pesakit ini?')) return;
  try{
    const res = await postForm({ action:'deletePDPA', noIC, staff: STAFF_EMAIL }, { msg:'Memadam PDPA…' });
    if (res.status==='success'){
      toast('Berjaya','PDPA dipadam.','success');
      loadFirstVisitData(); loadSecondVisitData(); loadCompletedData();
    } else throw new Error(res.message||'Gagal padam PDPA');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

async function archivePatient(noIC){
  if (!confirm('Arkibkan rekod pesakit ini?')) return;
  try{
    const res = await postForm({ action:'archivePatient', noIC, staff: STAFF_EMAIL }, { msg:'Mengarkib rekod…' });
    if (res.status==='success'){
      toast('Arkib','Rekod telah diarkibkan','success');
      loadCompletedData();
    } else throw new Error(res.message||'Gagal arkib');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
async function restorePatient(noIC){
  if (!confirm('Pulihkan rekod ini ke senarai utama?')) return;
  try{
    const res = await postForm({ action:'restorePatient', noIC, staff: STAFF_EMAIL }, { msg:'Memulihkan rekod…' });
    if (res.status==='success'){
      toast('Pulih','Rekod telah dipulihkan','success');
      loadArchivedData(); loadCompletedData(); loadDashboardData();
    } else throw new Error(res.message||'Gagal pulih');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

/* =======================
   PENDAFTARAN & EXPORT
   ======================= */
async function daftarPesakit(){
  const formData = {
    action:'daftarPesakit',
    namaPesakit: document.getElementById('namaPesakit').value.trim(),
    noIC:        document.getElementById('noIC').value.trim(),
    noTelefon:   normalizeMsisdnMY(document.getElementById('noTelefon').value.trim()),
    alamat:      document.getElementById('alamatPesakit').value.trim(),
    namaStaff:   document.getElementById('namaStaff').value.trim() || STAFF_EMAIL || 'SYSTEM',
    tarikhTCA:   document.getElementById('tarikhTCA').value,
    masaTCA:     document.getElementById('masaTCA').value
  };
  if (!formData.namaPesakit || !formData.noIC || !formData.noTelefon || !formData.namaStaff || !formData.tarikhTCA || !formData.masaTCA){
    toast('Ralat','Sila isi semua maklumat','danger'); return;
  }
  try{
    const result = await postForm(formData, { msg:'Mendaftar pesakit…' });
    if (result.status==='success'){
      toast('Berjaya','Pendaftaran berjaya (IC sebagai kunci, tiada duplikasi)','success');
      document.getElementById('namaPesakit').value = '';
      document.getElementById('noIC').value = '';
      document.getElementById('noTelefon').value = '';
      document.getElementById('alamatPesakit').value = '';
      loadDashboardData(); loadTCACallData();
    } else throw new Error(result.message||'Gagal mendaftar');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

  async function exportCompletedCSV(){
    try{
      // Ambil semua rekod selesai
      const res = await getJSON({ action:'getCompleted', all: 1 }, { msg:'Menjana CSV…' });
      const arr = (res.status === 'success' && Array.isArray(res.data)) ? res.data : [];
      if (!arr.length){
        toast('Makluman', 'Tiada rekod selesai untuk dieksport', 'warning');
        return;
      }

      // Tajuk & data CSV (ringkas dan berguna)
      const header = [
        'Nama Pesakit','No IC','No Telefon','Alamat',
        'Tarikh Daftar','First Visit','Lab Report Completed','Second Visit','Tarikh Selesai'
      ];
      const rows = arr.map(p => [
        p.nama || '',
        p.noIC || '',
        normalizeMsisdnMY(p.noTelefon || ''),
        p.alamat || '',
        p.tarikhDaftar || '',
        p.firstVisitDate || '',
        p.labCompletedAt || '',
        p.secondVisitDate || '',
        p.tarikhSelesai || ''
      ]);

      const csv = [header, ...rows]
        .map(r => r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(','))
        .join('\r\n');

      const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `pesakit_selesai_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      toast('Export', 'CSV selesai dimuat turun', 'success');
    }catch(e){
      toast('Ralat', 'Gagal eksport CSV: ' + e.message, 'danger');
    }
  }

  // ====== UTIL ACTION untuk Follow-up Lab (digunakan pada butang IN_PROCESS/REPEAT) ======
  async function markLabStatus(noIC, status){
    try{
      const res = await postForm(
        { action:'updateLabStatus', noIC, status, staff: STAFF_EMAIL },
        { msg:'Mengemas kini status lab…' }
      );
      if (res.status === 'success'){
        toast('Berjaya', 'Status lab dikemas kini', 'success');
        loadLabFollowUp();   // segar semula jadual lab
        loadDashboardData(); // kemas kini indikator pada dashboard/badge
      }else{
        throw new Error(res.message || 'Gagal kemas kini status lab');
      }
    }catch(e){
      toast('Ralat', e.message, 'danger');
    }
  }

  // Pastikan butang Sign-In Google muncul selepas load
  window.addEventListener('load', () => {
    try { initGoogleSignIn(); } catch(e) { console.error(e); }
  });

/* =======================
   HASH ROUTING (BARU)
   ======================= */
// Aktifkan seksyen ikut hash URL
function activateFromHash(){
  const hash = location.hash || '#dashboard';
  const link = document.querySelector(`.nav-link[href="${hash}"]`);
  if (link){ link.click(); }
}
window.addEventListener('hashchange', activateFromHash);
// ===================== Monitor Semua (Live) =====================

// Tetapan poll (fallback 7s jika tiada tetapan global)
const MONITOR_POLL_MS = (window.MONITOR_POLL_MS || 7000);

// Pemasa untuk auto-refresh
let monitorTimer = null;

/**
 * Tunjukkan skrin Monitor Semua & mulakan auto-refresh
 */
async function showMonitorAll(){
  // Jika app anda ada helper showPage(id), guna itu; jika tiada, sekurang-kurangnya papar seksyen monitor
  if (typeof showPage === 'function') {
    showPage('monitorAllSection');
  } else {
    const sec = document.getElementById('monitorAllSection');
    if (sec) sec.style.display = '';
  }

  // Tetapkan tarikh default (hari ini) jika kosong
  const dateInput = document.getElementById('monitorDate');
  if (dateInput && !dateInput.value) dateInput.value = todayIsoSafe();

  // Muat pertama kali & mula polling
  await loadMonitor(true);
  startMonitorPolling();
}

/** Muat semula sekali (guna pada butang "Segar Semula") */
async function refreshMonitorNow(){
  await loadMonitor(true);
}

function startMonitorPolling(dateIso){
  stopMonitorPolling();
  // Panggil sekali dulu
  loadMonitor(dateIso);
  // Kemudian berkala
  monitorTimer = setInterval(()=> loadMonitor(dateIso), 15000); // 15s
}
function stopMonitorPolling(){
  if (monitorTimer){ clearInterval(monitorTimer); monitorTimer=null; }
}


/** Util: tarikh hari ini (YYYY-MM-DD) — versi selamat */
function todayIsoSafe(){
  const d = new Date();
  const mm = ('0'+(d.getMonth()+1)).slice(-2);
  const dd = ('0'+d.getDate()).slice(-2);
  return `${d.getFullYear()}-${mm}-${dd}`;
}

/**
 * Teras pemuatan data monitor
 * - Cuba guna getJSON + id_token jika tersedia
 * - Jika tidak, jatuh kepada fetch(SCRIPT_URL) / fetch relatif
 */
async function loadMonitor(force=false){
  const infoEl  = document.getElementById('monitorInfo');
  const cardsEl = document.getElementById('monitorCards');

  try{
    const dateIso = document.getElementById('monitorDate')?.value || todayIsoSafe();

    // Papar status kecil (optional)
    if (infoEl && force){
      infoEl.textContent = 'Memuat data monitor…';
    }

    // Keutamaan: getJSON (jika disediakan oleh app anda dan sudah login)
    let json;
    if (typeof getJSON === 'function' && window.ID_TOKEN) {
      json = await getJSON(
        { action:'getNadiMonitor', date: dateIso },
        { silent:true }
      );
    } else {
      // Fallback: try direct fetch → SCRIPT_URL jika ada, jika tidak fetch relatif
      const base = (typeof SCRIPT_URL === 'string' && SCRIPT_URL) ? SCRIPT_URL : '';
      const qs   = new URLSearchParams({ action:'getNadiMonitor', date: dateIso }).toString();
      const url  = base ? `${base}?${qs}` : `?${qs}`;
      const r    = await fetch(url, { method:'GET', credentials:'include' });
      json       = await r.json();
    }

    if (json.status !== 'success') throw new Error(json.message || 'Gagal ambil data monitor');

    // Info bar
    if (infoEl){
      infoEl.textContent = `Tarikh: ${json.date || dateIso} • Auto refresh setiap ${(MONITOR_POLL_MS/1000)}s`;
    }

    renderMonitorCards(Array.isArray(json.data) ? json.data : []);

  } catch(err){
    console.error(err);
    if (infoEl) infoEl.textContent = 'Ralat memuat data monitor.';
    if (cardsEl) {
      cardsEl.innerHTML = `<div class="col-12"><div class="alert alert-danger">Tidak dapat memuat data buat masa ini.</div></div>`;
    }
  }
}

/**
 * Lukis kad-kad ringkasan untuk semua program pada tarikh dipilih
 * @param {Array} list - senarai { activityId, title, programDate, counts:{layak,takLayak,total} }
 */
function renderMonitorCards(list){
  const wrap = document.getElementById('monitorCards');
  if (!wrap) return;

  if (!list.length){
    wrap.innerHTML = `<div class="col-12"><div class="alert alert-info">Tiada sesi pada tarikh ini.</div></div>`;
    return;
  }

  wrap.innerHTML = list.map(item=>{
    const c = item.counts || { layak:0, takLayak:0, total:0 };
    return `
      <div class="col-12 col-md-6 col-lg-4">
        <div class="card shadow-sm monitor-card">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
              <div>
                <div class="fw-bold">${escapeHtmlSafe(item.title||'-')}</div>
                <div class="text-muted small">${escapeHtmlSafe(item.programDate||'')}</div>
                <div class="text-muted small">ID: ${escapeHtmlSafe(item.activityId||'')}</div>
              </div>
              <button class="btn btn-sm btn-outline-secondary"
                      onclick="openSessionDetail('${String(item.activityId||'').replace(/["'<>]/g,'')}')">
                Buka
              </button>
            </div>
            <hr>
            <div class="row text-center">
              <div class="col">
                <div class="stat">${Number(c.layak||0)}</div>
                <div class="label">Layak</div>
              </div>
              <div class="col">
                <div class="stat">${Number(c.takLayak||0)}</div>
                <div class="label">Tidak Layak</div>
              </div>
              <div class="col">
                <div class="stat">${Number(c.total||0)}</div>
                <div class="label">Jumlah</div>
              </div>
            </div>
          </div>
        </div>
      </div>`;
  }).join('');
}

/** Apabila klik “Buka” pada kad — navigate ke tab NADI dengan activityId (jika anda sediakan) */
function openSessionDetail(activityId){
  // Masukkan activityId ke hash supaya tab NADI boleh membacanya
  location.hash = '#nadi?activityId=' + encodeURIComponent(activityId || '');
  // Jika app anda perlu buka seksyen NADI secara manual:
  // const link = document.querySelector('.nav-link[href="#nadi"]'); link?.click();
}

/** Helper ringkas anti-XSS untuk teks */
function escapeHtmlSafe(s){
  return String(s||'').replace(/[&<>"'`=\/]/g, c => ({
    '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;','/':'&#x2F;','`':'&#x60;','=':'&#x3D;'
  }[c]));
}

// -- Expose ke global supaya dipanggil oleh event listener luar / butang HTML --
window.showMonitorAll     = showMonitorAll;
window.refreshMonitorNow  = refreshMonitorNow;
window.stopMonitorPolling = stopMonitorPolling;

// (Pilihan) Hentikan polling bila bertukar hash dan bukan monitor
window.addEventListener('hashchange', () => {
  if (!location.hash.includes('#monitor')) {
    try { stopMonitorPolling(); } catch(e){}
  }
});
/* =======================
   ENSURE XLSX (SATU-SATUNYA; CDN)
   ======================= */
(function () {
  'use strict';

  // Helper: muatkan skrip satu kali sahaja
  window.loadScriptOnce = window.loadScriptOnce || function loadScriptOnce(src){
    return new Promise((resolve, reject) => {
      if (document.querySelector('script[data-dynamic-src="'+src+'"]')) return resolve();
      const s = document.createElement('script');
      s.src = src;
      s.async = true;
      s.setAttribute('data-dynamic-src', src);
      s.onload = () => resolve();
      s.onerror = () => reject(new Error('Gagal memuat: '+src));
      document.head.appendChild(s);
    });
  };

  // OVERRIDE: hanya cuba CDN (tiada lagi 'vendor/...')
  window.ensureXLSXReady = async function ensureXLSXReady() {
    if (window.XLSX) return;
    const cdns = [
      'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
      'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
      'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
    ];
    let lastErr;
    for (const url of cdns) {
      try {
        await window.loadScriptOnce(url);
        if (window.XLSX) {
          console.log('[XLSX] Loaded from', url);
          return;
        }
      } catch (e) { lastErr = e; }
    }
    console.error('[XLSX] Gagal dimuat dari semua CDN.', lastErr);
    throw new Error('Tidak dapat memuatkan SheetJS (XLSX).');
  };

  // Event listener untuk butang "Monitor Semua"
document.addEventListener('DOMContentLoaded', function(){
  const btnMonitor = document.getElementById('btnMonitorAll');
  if (btnMonitor) {
    btnMonitor.addEventListener('click', () => {
      try { showMonitorAll(); } catch (e) { console.error(e); }
    });
  }
});


  // Henti polling bila keluar dari paparan monitor
  window.addEventListener('hashchange', () => {
    if (!location.hash.includes('#monitor')) {
      try { window.stopMonitorPolling && window.stopMonitorPolling(); } catch(e){}
    }
  });

})(); // tutup IIFE
</script>
</body>
</html>
