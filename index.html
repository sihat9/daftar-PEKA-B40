<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Program PEKA B40 bersama NADI</title>
  <style>
    :root{
      --bg:#f7f9fc;
      --card:#ffffff;
      --text:#1c2434;
      --muted:#9096a2;
      --primary:#2c7be5;
      --primary-600:#2266c7;
      --success:#00b884;
      --warning:#f6a609;
      --danger:#e44d4d;
      --border:#e6e9ef;
      --row:#fbfcfe;
      --row-alt:#f0f4fa;
      --focus:#b7d2ff;
      --shadow:0 6px 16px rgba(28,36,52,.08);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji";
      background:var(--bg);
      color:var(--text);
      line-height:1.45;
    }

    .container{
      max-width:1200px;
      margin:0 auto;
      padding:16px;
    }

    header{
      position:sticky; top:0; z-index:50;
      background:linear-gradient(180deg, #ffffff 0%, #ffffffee 60%, #ffffffcc 100%);
      border-bottom:1px solid var(--border);
      backdrop-filter:saturate(180%) blur(8px);
    }
    .header-inner{
      max-width:1200px; margin:0 auto; padding:14px 16px; display:flex; align-items:center; gap:14px;
    }
    .brand{
      font-weight:700; letter-spacing:.3px; font-size:18px; color:var(--primary);
    }
    .subtitle{color:var(--muted); font-size:13px}

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }

    .toolbar{
      position:sticky; top:66px; z-index:40;
      display:flex; align-items:center; gap:8px; flex-wrap:wrap;
      padding:12px; background:#fff; border-bottom:1px solid var(--border);
    }

    .toolbar .spacer{flex:1}
    .btn{
      display:inline-flex; align-items:center; gap:8px;
      height:38px; padding:0 14px; border-radius:10px;
      border:1px solid var(--border); background:#fff; color:var(--text);
      cursor:pointer; transition:.15s ease; user-select:none; font-size:14px;
    }
    .btn:focus{outline:3px solid var(--focus); outline-offset:1px}
    .btn:hover{transform:translateY(-1px); box-shadow:0 3px 10px rgba(0,0,0,.05)}
    .btn-primary{background:var(--primary); border-color:var(--primary); color:#fff}
    .btn-primary:hover{background:var(--primary-600)}
    .btn-success{background:var(--success); border-color:var(--success); color:#fff}
    .btn-warning{background:var(--warning); border-color:var(--warning); color:#1a1a1a}
    .btn-danger{background:var(--danger); border-color:var(--danger); color:#fff}
    .btn-ghost{background:#fff; color:var(--text)}

    .hint{color:var(--muted); font-size:12px; margin-left:6px}

    .content{padding:12px}

    .table-wrap{
      overflow:auto; border-top:1px solid var(--border);
    }

    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{
      position:sticky; top:0; z-index:10;
      background:#fff; color:#334155; font-weight:600; font-size:13px;
      text-align:left; padding:10px 8px; border-bottom:1px solid var(--border);
      white-space:nowrap;
    }
    tbody td{
      padding:6px 8px; border-bottom:1px solid var(--border);
      background:var(--row);
    }
    tbody tr:nth-child(even) td{background:var(--row-alt)}
    tfoot td{padding:10px 8px; color:var(--muted); font-size:12px}

    .cell{
      display:flex; align-items:center;
      background:#fff; border:1px solid var(--border);
      border-radius:8px; padding:4px 8px;
    }
    .cell:focus-within{border-color:var(--primary); box-shadow:0 0 0 3px #2c7be52a}
    .cell input,.cell select,.cell textarea{
      width:100%; border:0; outline:0; background:transparent; font:inherit; color:inherit;
    }
    .cell input[type="date"]{text-align:center}
    .cell textarea{resize:vertical; min-height:36px; max-height:120px}
    .num, .center{text-align:center}
    .col-bil{width:54px}
    .col-nama{min-width:220px}
    .col-ic{min-width:170px}
    .col-phone{min-width:150px}
    .col-syarikat{min-width:200px}
    .col-tarikh{min-width:150px}
    .col-ujian{min-width:180px}
    .col-keputusan{min-width:140px}
    .col-catatan{min-width:220px}
    .col-aksi{width:80px}

    .badge{
      display:inline-flex; align-items:center; gap:6px;
      height:24px; padding:0 10px; border-radius:999px; font-size:12px;
      background:#eef2ff; color:#3949ab; border:1px solid #e0e7ff;
    }

    .footer-note{color:var(--muted); font-size:12px; padding:12px}
    .sticky-footer{
      position:sticky; bottom:0; background:#fff; border-top:1px solid var(--border);
      display:flex; align-items:center; justify-content:space-between; gap:10px; padding:10px 12px;
    }

    @media (max-width: 720px){
      .toolbar{top:60px}
      .btn{height:36px; padding:0 12px; font-size:13px}
      .col-syarikat{min-width:160px}
      .col-catatan{min-width:180px}
    }
  </style>
</head>
<body>
  <header>
    <div class="header-inner">
      <div class="brand">Program PEKA B40 bersama NADI</div>
      <div class="subtitle">Reka bentuk padat, pantas diisi & sesuai untuk penggunaan lama seharian</div>
    </div>
  </header>

  <main class="container">
    <section class="card" id="page-peka-b40">
      <!-- Toolbar: ‚ÄúTambah Baris‚Äù di SEBELAH KIRI ‚ÄúTransfer fail kepada excell (CSV)‚Äù -->
      <div class="toolbar" role="toolbar" aria-label="Kawalan Jadual">
        <button id="btnAddRow" class="btn btn-primary" title="Tambah satu baris kosong (Enter di sel terakhir juga akan tambah baris)">
          ‚ûï Tambah Baris
        </button>

        <button id="btnExportCsv" class="btn btn-success" title="Muat turun data jadual dalam format CSV untuk Excel">
          ‚¨áÔ∏è Transfer fail kepada excell (CSV)
        </button>

        <button id="btnWhatsapp" class="btn btn-warning" title="Buka WhatsApp Web dengan mesej ringkasan yang telah diprafill">
          üü¢ Hantar laporan melalui WhatsApp Web
        </button>

        <div class="spacer"></div>

        <button id="btnClear" class="btn btn-danger" title="Kosongkan semua baris (data juga dibersihkan daripada simpanan automatik)">
          üóëÔ∏è Kosongkan Jadual
        </button>
        <span class="hint">Auto-simpan diaktifkan ‚Ä¢ Tekan <b>Tab</b> untuk bergerak lajur, <b>Enter</b> di sel terakhir untuk tambah baris</span>
      </div>

      <div class="content">
        <div class="table-wrap">
          <table id="tblPekaB40">
            <thead>
              <tr>
                <th class="col-bil center">Bil</th>
                <th class="col-nama">Nama Peserta</th>
                <th class="col-ic">IC / Passport</th>
                <th class="col-phone">No. Telefon</th>
                <th class="col-syarikat">Syarikat / Lokasi</th>
                <th class="col-tarikh center">Tarikh</th>
                <th class="col-ujian">Pemeriksaan</th>
                <th class="col-keputusan center">Keputusan</th>
                <th class="col-catatan">Catatan</th>
                <th class="col-aksi center">Aksi</th>
              </tr>
            </thead>
            <tbody id="tblBody">
              <!-- baris dinamik -->
            </tbody>
            <tfoot>
              <tr><td colspan="10">
                <span class="badge" id="badgeCount">0 rekod</span>
                <span class="hint">‚Äî Reka letak kolum dioptimumkan untuk input pantas & bacaan jelas sepanjang hari.</span>
              </td></tr>
            </tfoot>
          </table>
        </div>

        <div class="sticky-footer">
          <div class="hint">Nota: Fail CSV sesuai dibuka dengan Microsoft Excel / Google Sheets.</div>
          <div>
            <button id="btnAddRowFooter" class="btn btn-primary">‚ûï Tambah Baris</button>
            <button id="btnExportCsvFooter" class="btn btn-success">‚¨áÔ∏è Transfer fail kepada excell (CSV)</button>
          </div>
        </div>
      </div>
    </section>

    <p class="footer-note">
      Tip: Untuk mesej WhatsApp Web, sistem akan cipta ringkasan (jumlah & senarai peserta). Fail CSV perlu dilampirkan secara manual selepas WhatsApp Web dibuka (had keselamatan pelayar tidak benarkan lampiran automatik).
    </p>
  </main>

  <script>
    // ========= Util asas =========
    const $ = (q, el=document) => el.querySelector(q);
    const $$ = (q, el=document) => Array.from(el.querySelectorAll(q));

    const STORAGE_KEY = 'pekaB40Rows.v2_5_0';
    const TODAY = (() => {
      const d = new Date();
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,'0');
      const dd = String(d.getDate()).padStart(2,'0');
      return `${yyyy}-${mm}-${dd}`; // untuk input type="date"
    })();

    const HEADERS = [
      'Bil',
      'Nama Peserta',
      'IC / Passport',
      'No. Telefon',
      'Syarikat / Lokasi',
      'Tarikh',
      'Pemeriksaan',
      'Keputusan',
      'Catatan'
    ];

    // ========= Jadual & baris =========
    const tbody = $('#tblBody');
    const badgeCount = $('#badgeCount');

    function renumber(){
      $$('#tblBody tr').forEach((tr,idx)=>{
        const bilCell = tr.querySelector('.bil');
        if (bilCell) bilCell.textContent = idx+1;
      });
      updateCountBadge();
    }

    function updateCountBadge(){
      const data = getTableData();
      badgeCount.textContent = `${data.length} rekod`;
    }

    function cellInput(value='', opts={}){
      const wrap = document.createElement('div');
      wrap.className = 'cell';
      const input = document.createElement('input');
      input.type = opts.type || 'text';
      if (opts.placeholder) input.placeholder = opts.placeholder;
      if (opts.pattern) input.pattern = opts.pattern;
      if (opts.inputmode) input.inputMode = opts.inputmode;
      if (opts.maxlength) input.maxLength = opts.maxlength;
      input.value = value ?? '';
      wrap.appendChild(input);
      input.addEventListener('change', saveState);
      input.addEventListener('input', handleInlineEnter);
      return wrap;
    }

    function cellSelect(value='', options=[], center=false){
      const wrap = document.createElement('div');
      wrap.className = 'cell' + (center ? ' center':'');
      const sel = document.createElement('select');
      options.forEach(opt=>{
        const o = document.createElement('option');
        o.value = o.textContent = opt;
        sel.appendChild(o);
      });
      sel.value = value || options[0] || '';
      wrap.appendChild(sel);
      sel.addEventListener('change', saveState);
      sel.addEventListener('keydown', handleEnterAtLastCell);
      return wrap;
    }

    function cellTextarea(value=''){
      const wrap = document.createElement('div');
      wrap.className = 'cell';
      const ta = document.createElement('textarea');
      ta.value = value ?? '';
      wrap.appendChild(ta);
      ta.addEventListener('change', saveState);
      ta.addEventListener('keydown', handleEnterAtLastCell);
      return wrap;
    }

    function addRow(prefill={}){
      const tr = document.createElement('tr');

      // Bil
      const tdBil = document.createElement('td');
      tdBil.className = 'col-bil center';
      const bilSpan = document.createElement('span');
      bilSpan.className = 'bil';
      bilSpan.textContent = '‚Äî';
      tdBil.appendChild(bilSpan);
      tr.appendChild(tdBil);

      // Nama
      const tdNama = document.createElement('td'); tdNama.className='col-nama';
      tdNama.appendChild(cellInput(prefill.nama, {placeholder:'Nama penuh'}));
      tr.appendChild(tdNama);

      // IC
      const tdIC = document.createElement('td'); tdIC.className='col-ic';
      tdIC.appendChild(cellInput(prefill.ic, {placeholder:'Contoh: 800101-11-1234', maxlength:20}));
      tr.appendChild(tdIC);

      // Telefon
      const tdTel = document.createElement('td'); tdTel.className='col-phone';
      tdTel.appendChild(cellInput(prefill.phone, {placeholder:'01X-XXXX XXXX', inputmode:'tel'}));
      tr.appendChild(tdTel);

      // Syarikat / Lokasi
      const tdSyarikat = document.createElement('td'); tdSyarikat.className='col-syarikat';
      tdSyarikat.appendChild(cellInput(prefill.syarikat, {placeholder:'Nama syarikat / lokasi program'}));
      tr.appendChild(tdSyarikat);

      // Tarikh
      const tdTarikh = document.createElement('td'); tdTarikh.className='col-tarikh center';
      tdTarikh.appendChild(cellInput(prefill.tarikh || TODAY, {type:'date'}));
      tr.appendChild(tdTarikh);

      // Pemeriksaan
      const tdUjian = document.createElement('td'); tdUjian.className='col-ujian';
      tdUjian.appendChild(cellSelect(prefill.ujian, [
        '‚Äî Pilih ‚Äî',
        'Tekanan Darah',
        'Gula (RBS)',
        'BMI',
        'Ujian Mata / Refraction',
        'Pemeriksaan Umum'
      ]));
      tr.appendChild(tdUjian);

      // Keputusan
      const tdKeputusan = document.createElement('td'); tdKeputusan.className='col-keputusan center';
      tdKeputusan.appendChild(cellSelect(prefill.keputusan, ['‚Äî','Normal','Perlu Rujukan','Susulan Diperlukan'], true));
      tr.appendChild(tdKeputusan);

      // Catatan
      const tdCatatan = document.createElement('td'); tdCatatan.className='col-catatan';
      tdCatatan.appendChild(cellTextarea(prefill.catatan));
      tr.appendChild(tdCatatan);

      // Aksi
      const tdAksi = document.createElement('td'); tdAksi.className='col-aksi center';
      const btnDel = document.createElement('button');
      btnDel.className = 'btn btn-ghost';
      btnDel.type = 'button';
      btnDel.textContent = 'Padam';
      btnDel.title = 'Padam baris ini';
      btnDel.addEventListener('click', ()=>{
        tr.remove(); renumber(); saveState();
      });
      tdAksi.appendChild(btnDel);
      tr.appendChild(tdAksi);

      tbody.appendChild(tr);
      renumber();
      saveState();

      // Fokus ke nama jika baris baru
      const firstInput = tr.querySelector('input,select,textarea');
      if (firstInput) firstInput.focus();

      // Bila tekan Enter di sel terakhir, tambah baris baru
      tr.addEventListener('keydown', handleEnterAtLastCell);
    }

    function handleInlineEnter(e){
      // Benarkan Enter untuk lompat ke sel seterusnya (tanpa newline)
      if(e.key === 'Enter'){
        e.preventDefault();
        focusNextCell(e.target);
      }
    }

    function handleEnterAtLastCell(e){
      if(e.key === 'Enter'){
        const lastEditable = getLastEditable();
        if (e.target === lastEditable){
          e.preventDefault();
          addRow();
        }
      }
    }

    function getLastEditable(){
      const inputs = $$('input,select,textarea', tbody);
      return inputs[inputs.length-1] || null;
    }

    function focusNextCell(current){
      const inputs = $$('input,select,textarea', tbody);
      const idx = inputs.indexOf(current);
      if (idx >= 0 && idx < inputs.length-1){
        inputs[idx+1].focus();
      } else {
        addRow();
      }
    }

    // ========= Data & CSV =========
    function getTableData(){
      const rows = [];
      $$('#tblBody tr').forEach((tr)=>{
        const tds = tr.querySelectorAll('td');
        const nama = tds[1]?.querySelector('input')?.value?.trim() || '';
        const ic   = tds[2]?.querySelector('input')?.value?.trim() || '';
        const tel  = tds[3]?.querySelector('input')?.value?.trim() || '';
        const sykt = tds[4]?.querySelector('input')?.value?.trim() || '';
        const tarikh = tds[5]?.querySelector('input')?.value || '';
        const ujian = tds[6]?.querySelector('select')?.value || '';
        const keputusan = tds[7]?.querySelector('select')?.value || '';
        const catatan = tds[8]?.querySelector('textarea')?.value?.trim() || '';

        // Skip baris betul-betul kosong
        if ([nama,ic,tel,sykt,tarikh,ujian,keputusan,catatan].join('').length === 0) return;

        rows.push({nama,ic,tel,sykt,tarikh,ujian,keputusan,catatan});
      });
      return rows;
    }

    function toCsv(){
      const rows = getTableData();
      const csv = [];
      csv.push(HEADERS.join(','));
      rows.forEach((r,i)=>{
        const arr = [
          (i+1),
          r.nama, r.ic, r.tel, r.sykt, r.tarikh, r.ujian, r.keputusan, r.catatan
        ].map(csvEscape);
        csv.push(arr.join(','));
      });
      return '\uFEFF' + csv.join('\r\n'); // BOM untuk Excel (UTF-8)
    }

    function csvEscape(v){
      const s = (v ?? '').toString();
      if (/[",\r\n]/.test(s)){
        return '"' + s.replace(/"/g,'""') + '"';
      }
      return s;
    }

    function downloadCsv(){
      const data = getTableData();
      if (!data.length){
        alert('Tiada data untuk dieksport.');
        return;
      }
      const blob = new Blob([toCsv()], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      const stamp = new Date().toISOString().slice(0,10);
      a.href = url;
      a.download = `PEKA_B40_NADI_${stamp}.csv`;
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    }

    // ========= WhatsApp Web =========
    function composeWhatsappText(){
      const rows = getTableData();
      const today = new Date();
      const dd = String(today.getDate()).padStart(2,'0');
      const mm = String(today.getMonth()+1).padStart(2,'0');
      const yyyy = today.getFullYear();
      let txt = `Ringkasan Program PEKA B40 bersama NADI%0A`;
      txt += `Tarikh: ${dd}/${mm}/${yyyy}%0A`;
      txt += `Jumlah rekod: ${rows.length}%0A%0A`;
      if (rows.length){
        txt += `Butiran:%0A`;
        rows.forEach((r,i)=>{
          const line = `${i+1}) ${safe(r.nama)} ‚Äî ${safe(r.ic)} ‚Äî ${safe(r.tel)} ‚Äî ${safe(r.ujian)} [${safe(r.keputusan)}] ‚Äî ${safe(r.tarikh)} ‚Äî ${safe(r.sykt)}${r.catatan?` ‚Äî Catatan: ${safe(r.catatan)}`:''}`;
          txt += line.replace(/%/g, '%25') + '%0A';
        });
        txt += `%0A*Nota:* Fail CSV akan dilampirkan secara berasingan.`;
      }
      return txt;
    }

    function safe(s){ return (s ?? '').toString().trim(); }

    function openWhatsappWeb(){
      const rows = getTableData();
      if (!rows.length){
        alert('Tiada data untuk dihantar.');
        return;
      }
      // Guna wa.me supaya automatik buka WhatsApp Web pada desktop
      const text = composeWhatsappText(); // sudah termasuk %0A
      const url = `https://wa.me/?text=${text}`;
      window.open(url, '_blank', 'noopener');
    }

    // ========= Simpan automatik (localStorage) =========
    function saveState(){
      const rows = getTableData();
      localStorage.setItem(STORAGE_KEY, JSON.stringify(rows));
      updateCountBadge();
    }

    function restoreState(){
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw){
        addRow(); // sekurang-kurangnya satu baris kosong
        return;
      }
      try{
        const rows = JSON.parse(raw);
        if (Array.isArray(rows) && rows.length){
          tbody.innerHTML = '';
          rows.forEach(r=>addRow(r));
        } else {
          addRow();
        }
      }catch(e){
        console.warn('Gagal baca simpanan, mula baru.', e);
        addRow();
      }
    }

    function clearAll(){
      if (!confirm('Kosongkan semua baris dan buang simpanan automatik?')){
        return;
      }
      tbody.innerHTML = '';
      localStorage.removeItem(STORAGE_KEY);
      addRow();
      updateCountBadge();
    }

    // ========= Ikatan event =========
    function bindToolbar(){
      $('#btnAddRow')?.addEventListener('click', ()=>addRow());
      $('#btnAddRowFooter')?.addEventListener('click', ()=>addRow());

      const exportClick = ()=>downloadCsv();
      $('#btnExportCsv')?.addEventListener('click', exportClick);
      $('#btnExportCsvFooter')?.addEventListener('click', exportClick);

      $('#btnWhatsapp')?.addEventListener('click', openWhatsappWeb);
      $('#btnClear')?.addEventListener('click', clearAll);
    }

    document.addEventListener('DOMContentLoaded', ()=>{
      bindToolbar();
      restoreState();
    });
  </script>
</body>
</html>
