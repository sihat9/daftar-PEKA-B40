<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Optional: pre-fill your Worker URL here. It will be overridden by the input box if changed. -->
  <meta name="gas-endpoint" content="https://broken-dew-0eb2.amiruladlije.workers.dev/exec" />
  <title>Saringan — Hotfix/Diagnostik</title>
  <style>
    :root { --bg:#0f172a; --fg:#111827; --muted:#6b7280; --blue:#2563eb; --green:#059669; --red:#dc2626; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji"; margin:0; background:#f8fafc; color:#111827; }
    header { padding:22px 20px 10px; border-bottom:1px solid #e5e7eb; background:white; position:sticky; top:0; z-index:5; }
    h1 { margin:0 0 4px; font-size:28px;}
    small.muted { color:#6b7280; }
    .container { max-width:1100px; margin:0 auto; padding:18px 16px 80px;}
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; margin:14px 0; }
    .row { display:grid; grid-template-columns: 1fr 1fr; gap:12px; }
    .row-3 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px; }
    .row-2-3 { display:grid; grid-template-columns: 2fr 3fr; gap:12px; }
    label { display:block; font-size:13px; color:#374151; margin:6px 0; }
    input[type=text], input[type=date], textarea, select {
      width:100%; border:1px solid #d1d5db; border-radius:10px; padding:10px 12px;
      outline:none; font:inherit; background:white;
    }
    textarea { min-height:120px; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; }
    .btn { display:inline-flex; align-items:center; gap:8px; border:1px solid #d1d5db; background:white; color:#111827; padding:9px 14px; border-radius:10px; cursor:pointer; }
    .btn.primary { background:#111827; border-color:#111827; color:#fff; }
    .btn.blue { background:#2563eb; border-color:#2563eb; color:#fff; }
    .btn.green { background:#059669; border-color:#059669; color:#fff; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }
    .toolbar { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .muted { color:#6b7280; }
    .list { border:1px solid #e5e7eb; border-radius:10px; padding:6px; background:#fff; max-height:360px; overflow:auto; }
    .list-item { padding:10px 10px; border-radius:8px; border:1px solid transparent; }
    .list-item:hover { background:#f1f5f9; border-color:#e5e7eb;}
    table { width:100%; border-collapse:collapse; }
    thead th { position:sticky; top:0; background:#f8fafc; }
    th, td { border-bottom:1px solid #edf2f7; padding:8px 10px; font-size:14px; text-align:left; }
    .right { text-align:right; }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace; font-size: 13px; }
    .log { background:#0b1220; color:#c7d2fe; padding:10px; border-radius:10px; height:150px; overflow:auto; white-space:pre-wrap; }
    .flex { display:flex; gap:10px; align-items:center; }
    .grow { flex: 1 1 auto; }
    .pill { font-size:12px; padding:2px 8px; border-radius:999px; background:#eef2ff; color:#3730a3; border:1px solid #c7d2fe; }
    .help { font-size:12px; color:#6b7280; }
    .hr { height:1px; background:#e5e7eb; margin:10px 0; }
    .gsi-wrap { display:flex; align-items:center; gap:10px; }
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header>
    <h1>Saringan — <strong>Hotfix/Diagnostik</strong></h1>
    <small class="muted">Tujuan: uji sambungan Cloudflare Worker → Google Apps Script dengan selamat. Jika respons bukan JSON (contoh: berisi <code>&lt;!DOCTYPE html&gt;</code>), panel log akan memaparkan <code>UPSTREAM_NOT_JSON</code> beserta petikan HTML supaya kita boleh kenal pasti punca.</small>
  </header>

  <div class="container">
    <section class="card">
      <h2>1) Konfigurasi</h2>
      <div class="row">
        <div>
          <label>API BASE (Cloudflare Worker URL)</label>
          <input id="apiBase" type="text" placeholder="https://your-worker.workers.dev/exec" />
          <div class="help">Contoh: <span class="mono">https://broken-dew-0eb2.amiruladlije.workers.dev/exec</span></div>
        </div>
        <div>
          <label>Google Client ID (GSI)</label>
          <input id="clientId" type="text" placeholder="xxxx.apps.googleusercontent.com" />
          <div class="help">Biarkan nilai ini jika sama seperti sebelum ini.</div>
        </div>
      </div>
      <div style="height:10px"></div>
      <div class="toolbar">
        <div class="gsi-wrap">
          <div id="gsi_btn"></div>
          <button class="btn" id="btnOut">Log keluar</button>
        </div>
        <button class="btn" id="btnWhoAmI">Uji WhoAmI</button>
        <button class="btn" id="btnVoucher">Bina Voucher Set</button>
      </div>
      <div id="loginState" class="help" style="margin-top:8px;">Belum log masuk</div>
    </section>

    <section class="card">
      <h2>2) Lihat Sejarah Saringan (<span class="mono">AKTIVITI_PROGRAM</span>)</h2>
      <div class="toolbar">
        <button class="btn primary" id="btnLoadAktiviti">Muatkan Aktiviti</button>
        <span class="help">Jika berjaya, senarai ringkas dipaparkan di bawah.</span>
      </div>

      <div class="row-2-3" style="margin-top:12px">
        <div>
          <div class="pill">Senarai Program</div>
          <div id="aktiviti-list" class="list" aria-live="polite"></div>
        </div>
        <div>
          <div class="pill">Maklumat Program</div>
          <div class="list" style="padding:0; max-height:360px; overflow:auto;">
            <table id="jadual-aktiviti-detail">
              <thead>
                <tr>
                  <th>#</th><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th>
                  <th>BP</th><th>PR</th><th>DXT</th><th>BMI</th><th>Status</th><th>T. Apoint</th><th>Remark</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <section class="card">
      <h2>3) Simpan Jadual NADI (Demo Minimum)</h2>
      <div class="row-3">
        <div>
          <label>Tajuk Program</label>
          <input id="progTitle" type="text" value="Program NADI Komuniti" />
        </div>
        <div>
          <label>Tarikh Program (YYYY-MM-DD atau DD/MM/YYYY)</label>
          <input id="progDate" type="text" value="" />
        </div>
        <div>
          <label>&nbsp;</label>
          <button class="btn blue" id="btnSimpan">Simpan</button>
        </div>
      </div>
      <label>Items (JSON Array)</label>
      <textarea id="itemsJson">[{"nama":"Ali","noIC":"900101-10-1234","noTelefon":"0123456789","status":"LAYAK","appointmentType":"PKB40"}]</textarea>
    </section>

    <section class="card">
      <h2>Log</h2>
      <div id="log" class="log" aria-live="polite"></div>
    </section>
  </div>

  <script>
    // -------------------------- Utiliti UI ---------------------------
    const logEl = document.getElementById('log');
    function log(msg, obj) {
      const ts = new Date().toLocaleTimeString();
      if (obj !== undefined) {
        try { msg += ' → ' + JSON.stringify(obj); } catch(_) {}
      }
      logEl.textContent += '[' + ts + '] ' + msg + '\\n';
      logEl.scrollTop = logEl.scrollHeight;
      console.log('[LOG]', msg, obj);
    }
    function esc(s){return String(s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));}

    // --------------------- Muat naik/persist config ------------------
    const apiBaseInput = document.getElementById('apiBase');
    const clientIdInput = document.getElementById('clientId');
    const META = document.querySelector('meta[name="gas-endpoint"]');

    function normalizeExec(u){
      if (!u) return '';
      u = String(u).trim();
      if (!u) return '';
      return /\/exec(?:\\?|$)/.test(u) ? u : (u.replace(/\\/+$/, '') + '/exec');
    }

    function loadConfig() {
      const defBase = META && META.content ? META.content : '';
      apiBaseInput.value = localStorage.getItem('PEKA_API_BASE') || defBase;
      clientIdInput.value = localStorage.getItem('PEKA_GSI_CLIENT_ID') || '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com';
      const today = new Date(); document.getElementById('progDate').value = today.toISOString().slice(0,10);
    }
    function saveConfig() {
      localStorage.setItem('PEKA_API_BASE', normalizeExec(apiBaseInput.value));
      localStorage.setItem('PEKA_GSI_CLIENT_ID', clientIdInput.value.trim());
    }
    apiBaseInput.addEventListener('change', saveConfig);
    clientIdInput.addEventListener('change', () => { saveConfig(); setupGSI(); });

    // -------------------- Google Identity Services -------------------
    const TOKEN_KEY='PEKA_ID_TOKEN';
    const getToken=()=> localStorage.getItem(TOKEN_KEY)||'';
    const setToken=t=> { localStorage.setItem(TOKEN_KEY, t||''); refreshLoginState(); };

    const loginStateEl = document.getElementById('loginState');
    function refreshLoginState() {
      const t = getToken();
      if (t) loginStateEl.textContent = '[auth] id_token disimpan';
      else   loginStateEl.textContent = 'Belum log masuk';
    }

    function setupGSI() {
      const clientId = localStorage.getItem('PEKA_GSI_CLIENT_ID') || clientIdInput.value.trim();
      const gsiDiv = document.getElementById('gsi_btn');
      gsiDiv.innerHTML = '';
      if (!clientId) {
        log('Client ID kosong.');
        return;
      }
      // Init
      google.accounts.id.initialize({
        client_id: clientId,
        callback: (resp)=>{
          if (resp && resp.credential) {
            setToken(resp.credential);
          }
        }
      });
      google.accounts.id.renderButton(gsiDiv, {
        theme: 'outline', size: 'medium', text: 'signin_with', shape:'rectangular'
      });
      log('GSI sedia.');
    }

    document.getElementById('btnOut').addEventListener('click', ()=>{
      localStorage.removeItem(TOKEN_KEY);
      try { google.accounts.id.disableAutoSelect(); } catch(e){}
      log('Token dibuang.');
      refreshLoginState();
    });

    // --------------------- API wrapper tahan HTML --------------------
    function apiBase(){ return normalizeExec(localStorage.getItem('PEKA_API_BASE') || apiBaseInput.value); }
    async function parseJsonOrThrow(res){
      const txt = await res.text();
      try { return JSON.parse(txt); }
      catch(e){
        console.error('UPSTREAM_NOT_JSON', {status: res.status, preview: txt.slice(0,250)});
        log('UPSTREAM_NOT_JSON — lihat console untuk previu HTML');
        throw new Error('UPSTREAM_NOT_JSON');
      }
    }
    async function apiGet(action, params={}){
      const base = apiBase();
      if (!base) throw new Error('API_BASE kosong');
      const url = new URL(base);
      url.searchParams.set('action', action);
      url.searchParams.set('id_token', getToken());
      Object.entries(params).forEach(([k,v]) => url.searchParams.set(k, v==null?'':String(v)));
      const res = await fetch(url.toString(), { headers:{ 'Accept':'application/json' } });
      return parseJsonOrThrow(res);
    }
    async function apiPost(action, payload={}){
      const base = apiBase();
      if (!base) throw new Error('API_BASE kosong');
      const url = base + '?action=' + encodeURIComponent(action);
      const body = Object.assign({ id_token: getToken() }, payload||{});
      const res = await fetch(url, {
        method:'POST', headers:{ 'Content-Type':'application/json','Accept':'application/json' },
        body: JSON.stringify(body)
      });
      return parseJsonOrThrow(res);
    }

    // ------------------------ Voucher set ----------------------------
    window.ensureVoucherICs = async function ensureVoucherICs() {
      try {
        const j = await apiGet('getVoucherICSet');
        if (j.status !== 'success') throw new Error(j.message||'getVoucherICSet gagal');
        window.__voucherICSet = new Set(j.ics || []);
        log('Voucher IC set → ' + JSON.stringify(j));
      } catch (err) {
        console.error('Build voucher set failed', err);
        log('Build voucher set failed: ' + (err.message||err));
      }
    };

    // ------------------- Lihat sejarah (UI) -------------------------
    const listHost = document.getElementById('aktiviti-list');
    const tbody = document.querySelector('#jadual-aktiviti-detail tbody');
    function renderActivityList(items){
      if (!listHost) return;
      if (!Array.isArray(items) || !items.length){
        listHost.innerHTML = '<div class="muted" style="padding:8px">Tiada aktiviti.</div>';
        return;
      }
      listHost.innerHTML = items.map(x => `
        <div class="list-item" data-id="${esc(x.activityId)}" title="Klik untuk lihat butiran">
          <div><strong>${esc(x.programDate)}</strong> — ${esc(x.title)}</div>
          <div class="muted">Layak: ${esc(x.layakCount||'0')} • Tak Layak: ${esc(x.takLayakCount||'0')} • Jumlah: ${esc(x.total||'')}</div>
        </div>
      `).join('');
      listHost.querySelectorAll('.list-item').forEach(el=>{
        el.addEventListener('click', () => loadActivityDetail(el.dataset.id));
      });
    }
    function renderActivityDetail(rows){
      if (!tbody) return;
      if (!Array.isArray(rows) || !rows.length){
        tbody.innerHTML = '<tr><td colspan="12" class="muted">Tiada data.</td></tr>';
        return;
      }
      tbody.innerHTML = rows.map((r,i)=>`
        <tr>
          <td>${i+1}</td>
          <td>${esc(r.nama)}</td>
          <td>${esc(r.noIC)}</td>
          <td>${esc(r.noTelefon)}</td>
          <td>${esc(r.alamat)}</td>
          <td>${esc(r.bp)}</td>
          <td>${esc(r.pr)}</td>
          <td>${esc(r.dxt)}</td>
          <td>${esc(r.bmi)}</td>
          <td>${esc(r.status)}</td>
          <td>${esc(r.appointmentType||'')}</td>
          <td>${esc(r.remark||'')}</td>
        </tr>
      `).join('');
    }

    window.loadActivities = async function loadActivities(){
      try {
        const list = await apiGet('getNadiActivities');
        const items = (list && list.data) || [];
        renderActivityList(items);
        log('Aktiviti dimuat: ' + items.length);
        if (items.length) {
          await loadActivityDetail(items[0].activityId);
        }
      } catch (e) {
        console.error(e);
        log('Gagal muat aktiviti: ' + (e.message||e));
        renderActivityList([]);
      }
    };
    async function loadActivityDetail(id){
      try {
        const det = await apiGet('getNadiActivityDetail', { id });
        renderActivityDetail((det && det.data) || []);
      } catch (e) {
        console.error(e);
        log('Gagal muat butiran aktiviti: ' + (e.message||e));
        renderActivityDetail([]);
      }
    }

    // ------------------ Simpan Jadual NADI Demo ---------------------
    const btnSimpan = document.getElementById('btnSimpan');
    btnSimpan.addEventListener('click', async ()=>{
      try{
        const title = document.getElementById('progTitle').value.trim();
        const date  = document.getElementById('progDate').value.trim();
        let items;
        try { items = JSON.parse(document.getElementById('itemsJson').value); }
        catch(e){ alert('Items bukan JSON sah'); return; }
        if (!Array.isArray(items) || !items.length){ alert('Items kosong'); return; }
        const resp = await apiPost('saveNadiActivity', { programTitle:title, programDate:date, items });
        log('Simpan OK → ' + JSON.stringify(resp));
      }catch(e){
        log('Simpan gagal: ' + (e.message||e));
      }
    });

    // ------------------------- Hook butang --------------------------
    document.getElementById('btnWhoAmI').addEventListener('click', async ()=>{
      try {
        const j = await apiGet('whoami');
        log('WHOAMI → ' + JSON.stringify(j));
      } catch(e){ log('WHOAMI gagal: ' + (e.message||e)); }
    });
    document.getElementById('btnVoucher').addEventListener('click', ()=> ensureVoucherICs());
    document.getElementById('btnLoadAktiviti').addEventListener('click', ()=> loadActivities());

    // ------------------------- Bootstrap ----------------------------
    loadConfig();
    saveConfig(); // normalise /exec
    refreshLoginState();
    window.addEventListener('load', ()=> {
      if (window.google && google.accounts && google.accounts.id) setupGSI();
      else {
        let tries = 0;
        const t = setInterval(()=>{
          tries++;
          if (window.google && google.accounts && google.accounts.id) {
            clearInterval(t); setupGSI();
          } else if (tries>50) clearInterval(t);
        }, 100);
      }
    });
  </script>
</body>
</html>
