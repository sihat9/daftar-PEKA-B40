<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <title>Sistem Tracker PEKA B40 - Klinik SihatSokmo</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- SheetJS (Excel) via CDN -->
  <!-- XLSX robust loader + override (SIAP TAMPAL DI <head>) -->
  <script>
    (function () {
      // Jika dah ada, tak perlu apa-apa
      if (window.XLSX) return;

      // Helper umum: muat <script> sekali
      window.loadScriptOnce = window.loadScriptOnce || (function () {
        const loaded = new Set();
        return function loadScriptOnce(url) {
          return new Promise((resolve, reject) => {
            if (loaded.has(url)) return resolve();
            const s = document.createElement('script');
            s.src = url;
            s.async = true;
            s.onload = () => { loaded.add(url); resolve(); };
            s.onerror = () => reject(new Error('Gagal muat: ' + url));
            document.head.appendChild(s);
          });
        };
      })();

      // Override/definisi semula: pastikan XLSX wujud, cuba 3 CDN
      window.ensureXLSXReady = async function ensureXLSXReady() {
        if (window.XLSX) return;
        const cdns = [
          'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
        ];
        let lastErr;
        for (const url of cdns) {
          try {
            await window.loadScriptOnce(url);
            if (window.XLSX) {
              console.log('[XLSX] Loaded from', url);
              return;
            }
          } catch (e) {
            lastErr = e;
          }
        }
        console.error('[XLSX] Gagal dimuat dari semua CDN.', lastErr || '');
        throw new Error('XLSX gagal dimuat.');
      };
    })();
  </script>

  <!-- Google Identity Services (Sign-In) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- html2canvas untuk tangkap preview â†’ imej (BARU) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{ --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12; --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6; }
    html{ font-size:15px; }
    @media (max-width:1200px){ html{ font-size:14px; } }
    @media (max-width:576px){ html{ font-size:13px; } }

    html,body{height:100%}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;color:#333}

    /* Navbar */
    .navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
    .navbar-brand{font-weight:700;color:var(--primary);font-size:1.05rem;display:flex;align-items:center;gap:10px}
    .nav-link{color:var(--dark);font-weight:500;margin:0 4px;padding:7px 10px!important;border-radius:8px;transition:.2s;position:relative}
    .nav-link:hover,.nav-link.active{background:rgba(52,152,219,.12);color:var(--secondary)}
    .nav-badge{
      position:absolute; top:-4px; right:-2px; transform:translate(30%,-30%);
      background:#dc3545; color:#fff; border-radius:999px; font-size:.65rem; padding:2px 6px; display:none;
    }

    /* Header */
    .page-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:14px 0;margin-bottom:12px;border-radius:0 0 12px 12px}

    /* Cards & tables */
    .card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:16px}
    .card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;padding:12px 16px;border-radius:14px 14px 0 0!important}
    .stat-card{padding:14px;border-radius:14px;color:#fff;text-align:center;position:relative;overflow:hidden;cursor:pointer}
    .stat-card .number{font-size:1.45rem;font-weight:800}
    .table td,.table th{vertical-align:middle}
    .table{font-size:.95rem}
    .searchbar{max-width:340px}
    .mini-actions .btn{margin-right:6px;margin-bottom:6px}

    /* Global App Loader (maks 2s) */
    #appLoader{
      position:fixed; inset:0; z-index:2000; display:none;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(52,152,219,.18), transparent),
                  radial-gradient(1200px 600px at 110% 110%, rgba(46,204,113,.18), transparent),
                  rgba(255,255,255,.35);
      backdrop-filter: blur(10px);
    }
    #appLoader .loader-card{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background:rgba(255,255,255,.75); border:1px solid rgba(255,255,255,.6);
      box-shadow: 0 20px 40px rgba(0,0,0,.12);
      border-radius:18px; padding:16px 18px; min-width:220px; text-align:center;
    }
    .spinner-premium{
      width:36px;height:36px;border-radius:50%;
      border:4px solid rgba(52,152,219,.25);
      border-top-color:#3498db; animation:spin .9s linear infinite; margin:6px auto 8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Log Calls Drawer (gaya iPhone) */
    #logDrawer{
      position:fixed; top:0; right:-420px; width:400px; max-width:90vw; height:100%;
      background:#f8f9fb; box-shadow:-12px 0 35px rgba(0,0,0,.18); z-index:3000;
      transition:right .25s ease; border-left:1px solid rgba(0,0,0,.05);
      display:flex; flex-direction:column;
    }
    #logDrawer.open{ right:0; }
    .log-header{
      padding:10px 12px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06);
      display:flex; gap:8px; align-items:center;
    }
    .log-header .title{font-weight:700; color:#222; flex:1}
    .log-search{ padding:8px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06); }
    .log-body{ padding:10px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; }
    .bubble{
      max-width:80%; padding:8px 10px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      position:relative; font-size:.9rem; line-height:1.2rem;
    }
    .bubble.me{ margin-left:auto; background:#007aff; color:#fff; border-bottom-right-radius:6px; }
    .bubble.other{ margin-right:auto; background:#e9ecef; color:#222; border-bottom-left-radius:6px; }
    .bubble .meta{ font-size:.72rem; opacity:.8; margin-top:5px }
    .log-loading{ display:none; text-align:center; padding:8px }
    .log-loading.active{ display:block }

    /* FAB (tombol terapung) untuk Log Calls */
    #fabLog{
      position:fixed; right:18px; bottom:18px; z-index:3500;
      width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }

    /* ===== Toast: kebal overflow & tidak tenggelam di kanan ===== */
    #toastHost{
      position: fixed;
      top: 0; left: 0; right: 0;
      padding: 12px;
      z-index: 4000;
      pointer-events: none;
      display: flex;
      justify-content: flex-end;
      align-items: flex-start;
      box-sizing: border-box;
    }
    #toastContainer{
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    #toastHost .toast{
      pointer-events: auto;
      box-sizing: border-box;
      width: max-content;
      max-width: min(92vw, 420px);
      word-wrap: break-word;
      overflow-wrap: anywhere;
    }
    #logDrawer.open ~ #toastHost{ justify-content: flex-start; }
    @media (max-width: 576px){
      #toastHost{ padding: 8px; }
      #toastHost .toast{ max-width: 96vw; }
    }

    /* NADI TABLE STYLES */
    .nadi-scroll-container { overflow-x: auto; width: 100%; padding-bottom: 8px; }
    .nadi-table { width: 100%; min-width: 1300px; border-collapse: separate; border-spacing: 0; }
    .nadi-table th {
      background: #f8f9fa; padding: 10px 8px; font-weight: 600; text-align: center;
      position: sticky; top: 0; z-index: 10; border: 1px solid #dee2e6;
    }
    .nadi-table td { padding: 8px; vertical-align: middle; border: 1px solid #dee2e6; }
    .nadi-input-cell { position: relative; }
    .nadi-input-cell .view-mode {
      width: 100%; padding: 6px 8px; cursor: pointer; border: 1px solid transparent;
      border-radius: 4px; min-height: 36px; display: flex; align-items: center;
    }
    .nadi-input-cell .view-mode:hover { background-color: #f8f9fa; border: 1px solid #dee2e6; }
    .nadi-input-cell input {
      width: 100%; min-width: 100px; border: 1px solid #ced4da; border-radius: 4px; padding: 6px 8px; transition: width 0.2s ease;
    }
    .nadi-input-cell input:focus { width: auto; min-width: 100px; }
    .nadi-checkbox-cell { text-align: center; }
    .nadi-actions-cell { min-width: 180px; }
    .nadi-counter {
      background: var(--primary); color: white; border-radius: 50%;
      width: 24px; height: 24px; display: inline-flex; align-items: center; justify-content: center; font-size: 0.75rem;
    }

    /* Responsive */
    @media (max-width: 992px) { .stat-card .number{font-size:1.3rem} }

    /* Form sections */
    .form-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .form-section h5 { color: var(--primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .sticky-form-actions { position: sticky; bottom: 0; background: white; padding: 12px; border-top: 1px solid #eee; margin-top: 16px; }

    /* WhatsApp Report Image */
    .whatsapp-report {
      width: 100%; max-width: 500px; background: white; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto;
    }
    .whatsapp-report-header {
      display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;
    }
    .whatsapp-report-logo {
      width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; border: 1px solid rgba(0,0,0,0.08);
    }
    .whatsapp-report-title { font-size: 18px; font-weight: 700; color: var(--primary); }
    .whatsapp-report-subtitle { font-size: 14px; color: var(--muted); }
    .whatsapp-report-body { margin-bottom: 15px; }
    .whatsapp-report-row { display: flex; margin-bottom: 8px; }
    .whatsapp-report-label { font-weight: 600; width: 120px; color: var(--dark); }
    .whatsapp-report-value { flex: 1; }
    .whatsapp-report-footer { text-align: center; font-size: 12px; color: var(--muted); margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }

    /* NADI Summary Cards */
    .nadi-summary-container {
      display: flex;
      gap: 12px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }
    .nadi-summary-card {
      flex: 1;
      min-width: 200px;
      background: white;
      border-radius: 10px;
      padding: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      text-align: center;
    }
    .nadi-summary-card .title {
      font-size: 0.9rem;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .nadi-summary-card .count {
      font-size: 1.5rem;
      font-weight: 700;
    }
    .nadi-summary-card.layak { border-top: 4px solid var(--success); }
    .nadi-summary-card.tak-layak { border-top: 4px solid var(--danger); }
  </style>
</head>
<body>
  <!-- Global Loader -->
  <div id="appLoader" aria-hidden="true">
    <div class="loader-card">
      <div class="spinner-premium"></div>
      <div class="fw-bold">Sila tungguâ€¦</div>
      <div class="text-muted small" id="loaderMsg">Memproses permintaan anda</div>
    </div>
  </div>

  <!-- Log Calls Drawer -->
  <div id="logDrawer" aria-hidden="true">
    <div class="log-header">
      <button class="btn btn-sm btn-outline-secondary" id="btnCloseLog"><i class="bi bi-x-lg"></i></button>
      <div class="title"><i class="bi bi-chat-dots me-1"></i> Log Calls</div>
      <div id="logBadge" class="badge text-bg-primary">0</div>
    </div>
    <div class="log-search">
      <input id="logSearch" class="form-control form-control-sm" placeholder="Cari: nama / IC / telefon / staffâ€¦" />
    </div>
    <div id="logLoading" class="log-loading">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div class="small text-muted mt-1">Memuat Log Callsâ€¦</div>
    </div>
    <div id="logBody" class="log-body"></div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-main sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#dashboard">
        <img id="brandLogo" alt="Logo" style="width:32px;height:32px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,.08)">
        <span>Klinik SihatSokmo</span>
      </a>

      <!-- Google Sign-in button placeholder -->
      <div id="signinArea" class="d-lg-none me-2"></div>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item position-relative">
            <a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#nadi"><i class="bi bi-clipboard2-pulse"></i> Program PEKA B40 bersama NADI</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#daftar-peka"><i class="fas fa-user-plus"></i> Daftar Peka</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a>
            <span id="badgeTCA" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a>
            <span id="badgeFirst" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab Report</a>
            <span id="badgeLab" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a>
            <span id="badgeSecond" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a>
          </li>
        </ul>

        <div class="d-none d-lg-flex align-items-center gap-2">
          <div id="signinAreaDesktop"></div>
          <span id="staffBadge" class="badge bg-secondary d-none"><i class="bi bi-person-check me-1"></i><span id="staffEmail"></span></span>
          <!-- (Butang Log Calls terapung di bawah â€“ tidak dalam navbar) -->
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <div class="container">
      <div class="row align-items-center g-2">
        <div class="col-md-6">
          <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
          <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
        </div>
        <div class="col-md-6 text-md-end">
          <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Dashboard -->
    <section id="dashboard" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-success" id="btnExportCSV"><i class="fa-solid fa-file-csv me-1"></i>Export (CSV)</button>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#tca-call" style="background:linear-gradient(135deg,var(--secondary),#2980b9)">
            <div class="number" id="totalDaftar">0</div><div class="small">Aktif</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#first-visit" style="background:linear-gradient(135deg,var(--warning),#e67e22)">
            <div class="number" id="totalFirstVisit">0</div><div class="small">First Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#second-visit" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">
            <div class="number" id="totalSecondVisit">0</div><div class="small">Second Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#selesai" style="background:linear-gradient(135deg,var(--success),#16a085)">
            <div class="number" id="totalSelesai">0</div><div class="small">Selesai</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#8e44ad,#6c5ce7)">
            <div class="number" id="labFollowUpDue">0</div><div class="small">Result > 3 Hari</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#d35400,#c0392b)">
            <div class="number" id="labFollowUpPending">0</div><div class="small">Perlu Follow-up</div>
          </div>
        </div>
      </div>

      <!-- Pesakit perlu dihubungi (ringkas hari ini mengikut backend lalai) -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi Hari Ini</span>
          <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefonâ€¦" />
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
              <tbody id="tcaCallTable"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Statistik -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriod" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:320px;"><canvas id="stats3dChart"></canvas></div></div>
      </div>
    </section>

    <!-- Program NADI -->
    <section id="nadi" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="bi bi-clipboard2-pulse me-2"></i>Program PEKA B40 bersama NADI</h2>
        <div class="d-flex gap-2">
          <button id="btnNadiExportCsv" class="btn btn-sm btn-outline-success"><i class="bi bi-filetype-csv me-1"></i>Export to CSV</button>
        </div>
      </div>
      
      <!-- Summary Cards -->
      <div class="nadi-summary-container">
        <div class="nadi-summary-card layak">
          <div class="title">Layak PEKA B40</div>
          <div class="count" id="nadiLayakCount">0</div>
        </div>
        <div class="nadi-summary-card tak-layak">
          <div class="title">Tidak Layak</div>
          <div class="count" id="nadiTakLayakCount">0</div>
        </div>
      </div>
      
      <div class="card">
        <div class="card-body">
          <div class="nadi-scroll-container">
            <table class="nadi-table">
              <thead>
                <tr>
                  <th style="width: 40px;">#</th>
                  <th style="min-width: 150px;">Nama Pesakit</th>
                  <th style="min-width: 120px;">No IC</th>
                  <th style="min-width: 80px;">Umur</th>
                  <th style="min-width: 120px;">Telefon</th>
                  <th style="min-width: 150px;">Alamat</th>
                  <th style="min-width: 80px;">BP</th>
                  <th style="min-width: 80px;">PR</th>
                  <th style="min-width: 120px;">DXT</th>
                  <th style="min-width: 80px;">Tinggi</th>
                  <th style="min-width: 80px;">Berat</th>
                  <th style="min-width: 80px;">BMI</th>
                  <th style="width: 80px;">Layak</th>
                  <th style="width: 100px;">Tidak Layak</th>
                  <th style="min-width: 200px;">TCA & Staff</th>
                  <th style="min-width: 180px;">Tindakan</th>
                </tr>
              </thead>
              <tbody id="nadiContainer">
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
          <div class="sticky-form-actions">
            <button class="btn btn-primary" onclick="addNadiRow()"><i class="bi bi-plus-circle me-1"></i>Tambah Pesakit</button>
          </div>
          <div class="text-muted small mt-2">Nota: Baris "Layak" boleh terus <b>Daftar</b> (simpan ke sheet). Baris "Tidak Layak" <u>tidak</u> disimpan ke sheet tetapi <b>tetap dieksport CSV</b> bersama-sama.</div>
        </div>
      </div>
    </section>

    <!-- Daftar Peka -->
    <section id="daftar-peka" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-user-plus me-2"></i>Daftar Peka</h2>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-circle me-2"></i>Maklumat Pesakit</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Penuh Pesakit</label>
            <input id="namaPesakit" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor IC</label>
            <input id="noIC" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor Telefon</label>
            <input id="noTelefon" class="form-control" type="tel" required placeholder="cth: 0123456789 atau 60123456789">
          </div>
          <div class="col-md-6">
            <label class="form-label">Alamat Pesakit</label>
            <textarea id="alamatPesakit" class="form-control" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-calendar-alt me-2"></i>Tarikh Temujanji</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Tarikh TCA</label>
            <input id="tarikhTCA" class="form-control" type="date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Masa TCA</label>
            <input id="masaTCA" class="form-control" type="time" required>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-tie me-2"></i>Maklumat Staff</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Staff</label>
            <input id="namaStaff" class="form-control" required>
          </div>
        </div>
      </div>

      <div class="sticky-form-actions">
        <button class="btn btn-primary" id="btnDaftarPesakit"><i class="fas fa-save me-1"></i>Daftar Pesakit</button>
      </div>
    </section>

    <!-- Kelayakan (Excel) -->
    <section id="kelayakan" class="mb-4 d-none">
      <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel)</h2>
      <div class="card"><div class="card-body">
        <div class="row g-2 align-items-center mb-3">
          <div class="col-md-6">
            <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls,.csv" />
            <div class="form-text">Fail perlu ada lajur: <b>Nama</b>, <b>IC</b>, <b>Telefon</b>, <b>Alamat</b>. (Sistem tapis umur â‰¥40 ikut IC)</div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th>
                <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
                <th style="width:360px">Jika Layak â†’ TCA & Masa & Staff</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="kelayakanTable"><tr><td colspan="8" class="text-center text-muted">Muat naik Excel untuk mula.</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- TCA Call (senarai rekod â€” tiada tanda selesai manual) -->
    <section id="tca-call" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-phone me-2"></i>Senarai Rekod TCA Call</h2>
        <div class="d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="group" id="tcaFilter">
            <button class="btn btn-outline-primary active" data-filter="today">Hari ini</button>
            <button class="btn btn-outline-primary" data-filter="upcoming">Akan datang</button>
            <button class="btn btn-outline-primary" data-filter="past">Lepas</button>
            <button class="btn btn-outline-secondary" data-filter="all">Semua</button>
          </div>
          <input class="form-control form-control-sm searchbar" id="searchTCAPage" placeholder="Cari nama/IC/telefonâ€¦"/>
        </div>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="tcaCallList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- First Visit -->
    <section id="first-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchFirst" placeholder="Cari nama/IC/telefonâ€¦"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="firstVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Follow-up Lab Report -->
    <section id="lab-followup" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
        <input class="form-control form-control-sm searchbar" id="searchLab" placeholder="Cari nama/IC/telefonâ€¦"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th><th>Tindakan</th></tr>
            </thead>
            <tbody id="labFollowupTable"><tr><td colspan="8" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Second Visit -->
    <section id="second-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchSecond" placeholder="Cari nama/IC/telefonâ€¦"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="secondVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Selesai -->
    <section id="selesai" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
        <input class="form-control form-control-sm searchbar" id="searchCompleted" placeholder="Cari nama/IC/telefonâ€¦"/>
      </div>
      <div class="card mb-3"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>PDPA</th>
                <th>Tarikh Daftar</th><th>First Visit</th><th>Lab Report Completed</th><th>Second Visit</th><th>Tarikh Selesai</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="completedTable"><tr><td colspan="11" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriodCompleted" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:300px;"><canvas id="completed3dChart"></canvas></div></div>
      </div>
    </section>

    <!-- Arkib -->
    <section id="arkib" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
        <input class="form-control form-control-sm searchbar" id="searchArchive" placeholder="Cari nama/IC/telefonâ€¦"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th><th>Tindakan</th></tr></thead>
            <tbody id="archiveTable"><tr><td colspan="8" class="text-center text-muted">Tiada rekod arkib</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>
  </main>

  <!-- Modal Re-TCA -->
  <div class="modal fade" id="retcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Daftar TCA Semula</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="retcaIC">
        <div class="mb-3"><label class="form-label">Tarikh TCA Baharu</label><input type="date" id="retcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA Baharu</label><input type="time" id="retcaTime" class="form-control" required></div>
        <small class="text-muted">Status pesakit akan ditukar kepada <b>TCA CALL</b>.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitRetca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Set Second Visit TCA (Lab Complete & Call) -->
  <div class="modal fade" id="secondTcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-check me-2"></i>Tetapkan TCA Second Visit</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="secondTcaIC">
        <div class="mb-2"><label class="form-label">Tarikh TCA Second Visit</label><input type="date" id="secondTcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA</label><input type="time" id="secondTcaTime" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Nama Staff (wajib isi)</label><input type="text" id="secondTcaStaff" class="form-control" required placeholder="cth: Dayah"></div>
        <small class="text-muted">Maklumat ini akan direkod ke Log Calls & ruangan "Lab Report Completed".</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitSecondTca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Upload PDPA -->
  <div class="modal fade" id="pdpaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i>Muat Naik Borang PDPA</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="pdpaIC">
        <input type="file" id="pdpaFile" class="form-control" accept="application/pdf,image/*" />
        <div class="form-text">Muat naik PDF / imej borang PDPA pesakit.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button class="btn btn-primary" id="btnUploadPDPA"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload</button>
      </div>
    </div></div>
  </div>

  <!-- Modal WhatsApp Report Preview -->
  <div class="modal fade" id="whatsappReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-brands fa-whatsapp me-2"></i>Pratonton Laporan WhatsApp</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="whatsappReportPreview"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <!-- Kekalkan butang lama (teks) -->
        <button class="btn btn-outline-success" id="btnSendWhatsApp">
          <i class="fa-brands fa-whatsapp me-1"></i> Hantar WhatsApp (Teks)
        </button>
        <!-- Butang baharu: hantar Gambar ke WhatsApp + auto-buka chat -->
        <button class="btn btn-success" id="btnSendWhatsAppImage">
          <i class="fa-brands fa-whatsapp me-1"></i> Hantar Gambar ke WhatsApp
        </button>
      </div>
    </div></div>
  </div>

  <!-- Toast Host (kanan atas) -->
  <div id="toastHost"><div id="toastContainer" class="toast-container"></div></div>

  <!-- FAB Log Calls -->
  <button id="fabLog" class="btn btn-primary">
    <i class="bi bi-chat-dots fs-5"></i>
  </button>

  <footer class="footer mt-4 py-3 bg-light">
    <div class="container"><div class="d-flex justify-content-between">
      <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
      <div>Versi 3.1 (Secure)</div>
    </div></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
/* =======================
   KONFIG (EDIT INI SAHAJA)
   ======================= */

/* =======================
   KELAYAKAN: CSV first, XLSX fallback
   - Auto detect header row & delimiter
   - Banyak sinonim lajur (IC/NRIC/KP/MyKad, No. H/P/WhatsApp)
   ======================= */
(function () {
  const fileInput = document.getElementById('excelFile');
  const tableBody = document.getElementById('kelayakanTable');
  if (!fileInput || !tableBody) return;

  // ---------- Util ----------
  const norm = (v) => String(v ?? '').trim();
  const escapeHtml = (s) => String(s || '').replace(/[&<>"']/g, m => (
    {'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'}[m]
  ));

  function umurDariIC(ic) {
    const s = String(ic || '').replace(/\D/g, '');
    if (s.length < 6) return null;
    const yy = +s.slice(0,2), mm = +s.slice(2,4), dd = +s.slice(4,6);
    if (!(mm>=1 && mm<=12) || !(dd>=1 && dd<=31)) return null;
    const now = new Date();
    const currentYY = now.getFullYear() % 100;
    const year = (yy <= currentYY ? 2000 : 1900) + yy;
    let age = now.getFullYear() - year;
    const bday = new Date(year, mm - 1, dd);
    if (!(now.getMonth() > bday.getMonth() ||
          (now.getMonth() === bday.getMonth() && now.getDate() >= bday.getDate()))) {
      age--;
    }
    return age;
  }

  // ---------- File readers ----------
  const readAsArrayBuffer = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = e => res(e.target.result);
    fr.onerror = rej;
    fr.readAsArrayBuffer(file);
  });
  const readAsText = (file) => new Promise((res, rej) => {
    const fr = new FileReader();
    fr.onload = e => res(e.target.result);
    fr.onerror = rej;
    fr.readAsText(file, 'utf-8');
  });

  // ---------- CSV helpers ----------
  const stripBOM = (s) => s && s.charCodeAt(0) === 0xFEFF ? s.slice(1) : s;

  function detectDelimiter(s) {
    const sample = (s || '').slice(0, 3000);
    const cand = [',',';','\t','|'];
    const count = { ',':0, ';':0, '\t':0, '|':0 };
    let inQ = false;
    for (let i=0;i<sample.length;i++){
      const c = sample[i];
      if (c === '"') {
        if (inQ && sample[i+1] === '"') { i++; }
        else inQ = !inQ;
      } else if (!inQ && count.hasOwnProperty(c)) {
        count[c]++;
      }
    }
    return cand.sort((a,b)=>count[b]-count[a])[0] || ',';
  }

  function parseCSVToRows(text) {
    text = stripBOM(String(text||''));
    const delim = detectDelimiter(text);
    const rows = [];
    let row=[], field='', inQ=false;
    for (let i=0;i<text.length;i++){
      const c = text[i];
      if (inQ) {
        if (c === '"') {
          if (text[i+1] === '"') { field += '"'; i++; }
          else inQ = false;
        } else field += c;
      } else {
        if (c === '"') inQ = true;
        else if (c === delim) { row.push(field); field=''; }
        else if (c === '\n')  { row.push(field); rows.push(row); row=[]; field=''; }
        else if (c === '\r')  { /* skip */ }
        else field += c;
      }
    }
    row.push(field); rows.push(row);
    return rows;
  }

  // Cari baris header terbaik (ada â‰¥2 kata kunci)
  const keysets = {
    nama:    ['nama','nama penuh','name','nama pesakit'],
    ic:      ['ic','no ic','no. ic','nric','nokp','no kp','no. kp','kp','mykad','no mykad','no k/p','k/p','kad pengenalan','no kad pengenalan'],
    telefon: ['telefon','no telefon','no. telefon','no tel','no. tel','tel','mobile','hp','no hp','h/p','no h/p','whatsapp','no whatsapp','telefon (whatsapp)'],
    alamat:  ['alamat','address','addr','alamat rumah','alamat kediaman']
  };
  const canon = (s) => String(s||'')
      .toLowerCase()
      .replace(/[\s\.\-_/()]+/g,'')
      .trim();

  function scoreHeaderCell(cell) {
    const t = canon(cell);
    const hit = [];
    for (const [k, list] of Object.entries(keysets)) {
      if (list.some(p => t.includes(canon(p)))) hit.push(k);
    }
    return [...new Set(hit)];
  }

  function findHeaderRow(rows) {
    let best = { idx: 0, score: 0 };
    for (let r=0; r<Math.min(rows.length, 20); r++) {
      const hits = new Set();
      for (const c of rows[r]) scoreHeaderCell(c).forEach(k => hits.add(k));
      const sc = hits.size;
      if (sc > best.score) best = { idx: r, score: sc };
    }
    return (best.score >= 2) ? best.idx : 0;
  }

  function csvTextToObjects(text) {
    const rows = parseCSVToRows(text);
    if (!rows.length) return [];
    const headerRow = findHeaderRow(rows);
    const header = rows[headerRow].map(h => String(h||'').trim());
    const dataRows = rows.slice(headerRow+1);

    return dataRows
      .filter(r => r.some(v => String(v||'').trim() !== ''))
      .map(r => {
        const o = {};
        for (let i=0;i<header.length;i++) o[header[i]] = r[i] ?? '';
        return o;
      });
  }

  // Padanan objek â†’ {nama, ic, telefon, alamat}
  function mapRow(raw) {
    const entries = Object.entries(raw);
    const pick = (groups) => {
      for (const [k,v] of entries) {
        const t = canon(k);
        if (groups.some(word => t.includes(canon(word)))) return norm(v);
      }
      for (const [k,v] of entries) {
        const t = canon(k);
        if (groups.some(word => canon(word).includes(t))) return norm(v);
      }
      return '';
    };
    return {
      nama:    pick(keysets.nama),
      ic:      pick(keysets.ic),
      telefon: pick(keysets.telefon),
      alamat:  pick(keysets.alamat)
    };
  }

  // ---------- Render ----------
  function renderRows(items) {
    if (!items.length) {
      tableBody.innerHTML =
        '<tr><td colspan="8" class="text-center text-muted">Tiada data ditemui (semak header CSV anda).</td></tr>';
      return;
    }
    tableBody.innerHTML = items.map((it, idx) => {
      const age = umurDariIC(it.ic);
      const eligible = (age !== null) ? age >= 40 : false;
      const reason = (age === null) ? 'IC tidak sah' : (eligible ? '-' : `Umur ${age} tahun (&lt; 40)`);

      return `
        <tr data-idx="${idx}">
          <td>${escapeHtml(it.nama) || '-'}</td>
          <td>${escapeHtml(it.ic) || '-'}</td>
          <td>${escapeHtml(it.telefon) || '-'}</td>
          <td>${escapeHtml(it.alamat) || '-'}</td>
          <td class="text-center">
            ${eligible ? '<span class="badge text-bg-success">Layak</span>' :
                         '<span class="badge text-bg-danger">Tidak Layak</span>'}
          </td>
          <td class="text-center">${escapeHtml(reason)}</td>
          <td>
            ${eligible ? `
              <div class="row g-1">
                <div class="col"><input type="date" class="form-control form-control-sm tca-date"></div>
                <div class="col"><input type="time" class="form-control form-control-sm tca-time"></div>
                <div class="col"><input type="text"  class="form-control form-control-sm tca-staff" placeholder="Staff"></div>
              </div>
            ` : '<span class="text-muted">â€”</span>'}
          </td>
          <td>
            ${eligible
              ? '<button class="btn btn-sm btn-primary daftar-row"><i class="fas fa-save me-1"></i>Daftar</button>'
              : '<span class="text-muted">â€”</span>'}
          </td>
        </tr>`;
    }).join('');
  }

  // ---------- Pemproses utama ----------
  async function handleFile(file) {
    try {
      tableBody.innerHTML =
        '<tr><td colspan="8" class="text-center text-muted">Memproses failâ€¦</td></tr>';

      const ext = (file.name.split('.').pop() || '').toLowerCase();

      // 1) CSV â†’ terus baca (tak perlu internet/CDN)
      if (ext === 'csv') {
        const text = await readAsText(file);
        const raw  = csvTextToObjects(text);
        const items = raw.map(mapRow)
          .filter(r => r.nama || r.ic || r.telefon || r.alamat);

        if (!items.length) {
          const rows = parseCSVToRows(text);
          const headerRow = findHeaderRow(rows);
          const hdrs = (rows[headerRow] || []).slice(0,8).map(h=>escapeHtml(h)).join(', ');
          tableBody.innerHTML =
            `<tr><td colspan="8" class="text-center text-danger">
              CSV dibaca tetapi tiada lajur sepadan.<br>
              <small><b>Jumpa header:</b> ${hdrs || '(kosong)'}<br>
              Pastikan ada lajur seperti <i>Nama, IC/NRIC/KP, Telefon/HP/WhatsApp, Alamat</i>.</small>
            </td></tr>`;
          return;
        }

        window.__KELAYAKAN_ITEMS__ = items;
        renderRows(items);
        return;
      }

      // 2) XLSX/XLS â†’ cuba SheetJS; jika gagal, minta simpan CSV
      if (typeof window.ensureXLSXReady === 'function') {
        try { await window.ensureXLSXReady(); } catch(e) { /* ignore */ }
      }
      if (!window.XLSX) {
        tableBody.innerHTML =
          '<tr><td colspan="8" class="text-center text-danger">SheetJS tidak tersedia. Sila simpan Excel sebagai <b>CSV</b> dan muat naik semula.</td></tr>';
        return;
      }

      const data = await readAsArrayBuffer(file);
      const wb   = XLSX.read(data, { type: 'array' });
      const ws   = wb.Sheets[wb.SheetNames[0]];
      const raw  = XLSX.utils.sheet_to_json(ws, { defval: '', raw: true });

      const items = raw.map(mapRow)
        .filter(r => r.nama || r.ic || r.telefon || r.alamat);

      if (!items.length) {
        const hdrs = Object.keys(raw[0] || {}).slice(0,8).join(', ');
        tableBody.innerHTML =
          `<tr><td colspan="8" class="text-center text-danger">
            Excel dibaca tetapi tiada lajur sepadan.<br>
            <small><b>Jumpa header:</b> ${escapeHtml(hdrs)}<br>
            Pastikan ada lajur seperti <i>Nama, IC/NRIC/KP, Telefon/HP/WhatsApp, Alamat</i>.</small>
          </td></tr>`;
        return;
      }

      window.__KELAYAKAN_ITEMS__ = items;
      renderRows(items);

    } catch (err) {
      console.error(err);
      tableBody.innerHTML =
        '<tr><td colspan="8" class="text-center text-danger">Ralat memproses fail. Pastikan fail CSV/Excel sah.</td></tr>';
    }
  }

  // ---------- Events ----------
  fileInput.addEventListener('change', e => {
    const f = e.target.files && e.target.files[0];
    if (f) handleFile(f);
  });

  tableBody.addEventListener('click', e => {
    const btn = e.target.closest('.daftar-row');
    if (!btn) return;
    const tr  = btn.closest('tr');
    const idx = Number(tr.dataset.idx);
    const item = (window.__KELAYAKAN_ITEMS__ || [])[idx];
    if (!item) return;

    const date  = tr.querySelector('.tca-date')?.value || '';
    const time  = tr.querySelector('.tca-time')?.value || '';
    const staff = tr.querySelector('.tca-staff')?.value || '';

    const fNama   = document.getElementById('namaPesakit');
    const fIC     = document.getElementById('noIC');
    const fTel    = document.getElementById('noTelefon');
    const fAlamat = document.getElementById('alamatPesakit');
    const fTCA    = document.getElementById('tarikhTCA');
    const fMasa   = document.getElementById('masaTCA');
    const fStaff  = document.getElementById('namaStaff');

    if (fNama)   fNama.value   = item.nama   || '';
    if (fIC)     fIC.value     = item.ic     || '';
    if (fTel)    fTel.value    = item.telefon|| '';
    if (fAlamat) fAlamat.value = item.alamat || '';
    if (fTCA && date)  fTCA.value  = date;
    if (fMasa && time) fMasa.value = time;
    if (fStaff && staff) fStaff.value = staff;

    location.hash = '#daftar-peka';
    btn.innerHTML = '<i class="fas fa-check me-1"></i>Diisi';
    btn.classList.remove('btn-primary');
    btn.classList.add('btn-success');
    btn.disabled = true;
  });
})();

// 1) Isi URL Web App Apps Script (deployment terkini)
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6TKE0vDDPO3-36cY7xjacAbGL0HIRKCrORNm-sED9y5NpIeIUk9gyrpiWy-S7vbc/exec';
// 2) Google OAuth Client ID (Google Cloud Console)
const GOOGLE_CLIENT_ID = '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com';
// 3) Logo (optional) - Ganti dengan URL logo klinik anda
const LOGO_URL = 'saya masukkan nanti';
    
/* =======================
   AUTH (Google Identity)
   ======================= */
let ID_TOKEN = '';      // diisi selepas login
let STAFF_EMAIL = '';   // email sebenar (server akan sahkan juga)

function initGoogleSignIn(){
  if (!window.google || !google.accounts || !google.accounts.id) {
    // cuba lagi sekejap jika skrip belum siap
    setTimeout(initGoogleSignIn, 300);
    return;
  }
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false,
    cancel_on_tap_outside: true
  });
  google.accounts.id.renderButton(
    document.getElementById('signinArea'),
    { theme: 'outline', size: 'medium', text:'signin_with' }
  );
  google.accounts.id.renderButton(
    document.getElementById('signinAreaDesktop'),
    { theme: 'outline', size: 'medium', text:'signin_with' }
  );
}

async function handleCredentialResponse(resp){
  ID_TOKEN = resp.credential;
  // Semak whoami di backend
  const r = await fetch(SCRIPT_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ action:'whoami', id_token: ID_TOKEN })
  });
  const j = await r.json();
  if (j.status === 'success'){
    STAFF_EMAIL = j.email || '';
    document.getElementById('staffBadge').classList.remove('d-none');
    document.getElementById('staffEmail').textContent = STAFF_EMAIL;
    document.getElementById('signinArea').innerHTML = '';
    document.getElementById('signinAreaDesktop').innerHTML = '';
    bootstrapApp(); // muat data
  } else {
    toast('Akses Ditolak', j.message || 'Sila hubungi admin untuk allowlist.', 'danger');
    ID_TOKEN = ''; STAFF_EMAIL = '';
  }
}

/* =======================
   LOADER (maks 2s)
   ======================= */
let loaderTimer=null;
function showLoader(msg='Memprosesâ€¦'){
  document.getElementById('loaderMsg').textContent = msg;
  document.getElementById('appLoader').style.display = 'block';
  clearTimeout(loaderTimer);
  loaderTimer = setTimeout(hideLoader, 2000);
}
function hideLoader(){ document.getElementById('appLoader').style.display = 'none'; }

/* =======================
   NETWORK HELPERS
   ======================= */
async function getJSON(params={}, {silent=false, msg='Memuat dataâ€¦'}={}){
  if (!ID_TOKEN) throw new Error('Belum login');
  const qs = new URLSearchParams({ ...params, id_token: ID_TOKEN }).toString();
  const url = `${SCRIPT_URL}?${qs}`;
  if (!silent) showLoader(msg);
  try{
    const r = await Promise.race([
      fetch(url, { method:'GET' }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

async function postForm(params={}, {silent=false, msg='Menyimpan dataâ€¦'}={}){
  if (!ID_TOKEN) throw new Error('Belum login');
  if (!silent) showLoader(msg);
  try{
    const r = await Promise.race([
      fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ ...params, id_token: ID_TOKEN })
      }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

/* =======================
   UTIL
   ======================= */
const normalizeMsisdnMY = (raw) => {
  if (!raw) return '';
  let s = String(raw).replace(/\D/g, '');
  if (s.startsWith('00')) s = s.slice(2);
  if (s.startsWith('60')) return s;
  if (s.startsWith('0')) return '60' + s.slice(1);
  return '60' + s;
};

const telHref = (msisdn) => `tel:+${msisdn}`;

const waHref  = (msisdn, txt='Assalamualaikum, saya dari Klinik SihatSokmo.') =>
  `https://wa.me/${msisdn}?text=${encodeURIComponent(txt)}`;

const parseDDMMYYYY = (s) => {
  if (!s) return null;
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { // "YYYY-MM-DD"
    const [Y, M, D] = s.split('-').map(Number);
    return new Date(Y, M - 1, D);
  }
  const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s); // "DD/MM/YYYY"
  if (!m) return null;
  const D = +m[1], M = +m[2], Y = +m[3];
  return new Date(Y, M - 1, D);
};

function isSameDay(a, b) {
  return a.getFullYear() === b.getFullYear()
      && a.getMonth() === b.getMonth()
      && a.getDate() === b.getDate();
}

/* Pastikan bekas notifikasi (#toastHost/#toastContainer) wujud. */
function ensureToastContainer() {
  let host = document.getElementById('toastHost');
  if (!host) {
    host = document.createElement('div');
    host.id = 'toastHost';
    document.body.appendChild(host);
  }
  let container = document.getElementById('toastContainer');
  if (!container) {
    container = document.createElement('div');
    container.id = 'toastContainer';
    container.className = 'toast-container';
    host.appendChild(container);
  }
  container.style.pointerEvents = 'auto';
  return container;
}

/* Kekalkan toast sentiasa kelihatan */
function clampToastIntoView(el){
  requestAnimationFrame(() => {
    const PAD = 12;
    el.style.maxWidth = Math.min(window.innerWidth - PAD*2, 420) + 'px';
    const r = el.getBoundingClientRect();
    let tx = 0, ty = 0;
    if (r.right > window.innerWidth - PAD) tx -= (r.right - (window.innerWidth - PAD));
    if (r.left  < PAD)                     tx += (PAD - r.left);
    if (r.top   < PAD)                     ty += (PAD - r.top);
    if (tx || ty){
      el.style.transform  = `translate(${tx}px, ${ty}px)`;
      el.style.willChange = 'transform';
    }
  });
}

function toast(title, message, variant = 'primary') {
  const container = ensureToastContainer();
  const id = 't' + Date.now() + Math.random().toString(36).slice(2, 7);
  const html = `
    <div class="toast align-items-center text-bg-${variant} border-0 mb-2" id="${id}"
         role="alert" aria-live="assertive" aria-atomic="true" style="min-width:260px">
      <div class="d-flex">
        <div class="toast-body"><strong>${title}:</strong> ${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`;
  container.insertAdjacentHTML('beforeend', html);
  const el = document.getElementById(id);
  clampToastIntoView(el);
  const onResize = () => clampToastIntoView(el);
  window.addEventListener('resize', onResize, { passive: true });
  const cleanup = () => { window.removeEventListener('resize', onResize); el.remove(); };

  try {
    const BsToast = window.bootstrap?.Toast;
    if (BsToast) {
      const inst = BsToast.getOrCreateInstance(el, { delay: 3000, autohide: true });
      el.addEventListener('shown.bs.toast', () => clampToastIntoView(el));
      el.addEventListener('hidden.bs.toast', cleanup);
      inst.show();
    } else {
      el.classList.add('show');
      setTimeout(() => { el.classList.remove('show'); cleanup(); }, 3000);
    }
  } catch {
    el.classList.add('show');
    setTimeout(() => { el.classList.remove('show'); cleanup(); }, 3000);
  }
}

/* WhatsApp (TEKS) */
function composeNadiWhatsAppText(data){
  const lines = [
    'Assalamualaikum, saya dari Klinik SihatSokmo.',
    '',
    'Laporan Saringan Kesihatan:',
    `â€¢ Nama: ${data.nama || '-'}`,
    `â€¢ IC: ${data.ic || '-'}`,
    `â€¢ Alamat: ${data.alamat || '-'}`,
    `â€¢ BP: ${data.bp || '-'} mmHg`,
    `â€¢ PR: ${data.pr || '-'} bpm`,
    `â€¢ DXT (${data.dxtType || 'Fasting'}): ${data.dxt || '-'} mmol/L`,
    `â€¢ Tinggi: ${data.tinggi || '-'} cm`,
    `â€¢ Berat: ${data.berat || '-'} kg`,
    `â€¢ BMI: ${data.bmi || '-'}`,
    `â€¢ Status: ${data.layak ? 'Layak PEKA B40' : 'Tidak Layak PEKA B40'}`,
    '',
    'Jika ada soalan, balas mesej ini ya. Terima kasih.'
  ];
  return lines.join('\n');
}

function openWhatsAppTo(rawMsisdn, text){
  const msisdn = normalizeMsisdnMY(rawMsisdn);
  if (!/^\d{10,15}$/.test(msisdn)){
    toast('Ralat','Nombor telefon tidak sah','danger');
    return;
  }
  const encoded = encodeURIComponent(text || '');
  const scheme = `whatsapp://send?phone=${msisdn}&text=${encoded}`;
  const web    = `https://wa.me/${msisdn}?text=${encoded}`;
  const isMobile = /Android|iPhone|iPad|iPod|Windows Phone/i.test(navigator.userAgent);
  const url = isMobile ? scheme : web;
  window.open(url, '_blank');
  toast('WhatsApp','Membuka WhatsApp dengan mesej siap-isiâ€¦','success');
}

/* =======================
   WHATSAPP IMAGE SEND HELPERS (BARU)
   ======================= */
let CURRENT_WA_MSISDN = ''; // diset ketika preview dibuka

async function captureReportAsBlob() {
  const card = document.querySelector('#whatsappReportPreview .whatsapp-report');
  if (!card) throw new Error('Gagal capai preview');
  const canvas = await html2canvas(card, {
    backgroundColor: '#ffffff',
    scale: Math.min(window.devicePixelRatio || 1.5, 2.5)
  });
  return await new Promise((resolve)=> canvas.toBlob(resolve, 'image/png', 0.95));
}

function openWhatsAppDeepLink(msisdn, text='') {
  const encoded = encodeURIComponent(text || '');
  const scheme = `whatsapp://send?phone=${msisdn}&text=${encoded}`;
  const web    = `https://wa.me/${msisdn}?text=${encoded}`;
  window.open(scheme, '_blank');
  setTimeout(()=>window.open(web,'_blank'), 600);
}

async function sendWhatsAppReportImageFlow(msisdn) {
  const phone = normalizeMsisdnMY(msisdn||'');
  if (!/^\d{10,15}$/.test(phone)) {
    toast('Ralat','Nombor telefon tidak sah','danger');
    return;
  }
  openWhatsAppDeepLink(phone, '');
  showLoader('Menjana imej laporanâ€¦');
  let blob;
  try {
    blob = await captureReportAsBlob();
  } catch(e){
    hideLoader();
    toast('Ralat','Gagal jana imej laporan','danger');
    return;
  }
  hideLoader();

  const file = new File([blob], `laporan_nadi_${Date.now()}.png`, { type: 'image/png' });

  if (navigator.canShare && navigator.canShare({ files: [file] })) {
    try {
      await navigator.share({ files: [file], title: 'Laporan Saringan NADI', text: '' });
      toast('Berjaya', 'Imej dikongsi melalui aplikasi pilihan anda', 'success');
      return;
    } catch(e){
      // pengguna batal â†’ teruskan fallback
    }
  }

  if (navigator.clipboard && window.ClipboardItem) {
    try {
      await navigator.clipboard.write([ new ClipboardItem({ 'image/png': blob }) ]);
      toast('Siap', 'Imej disalin ke clipboard. Tampal (Ctrl/Cmd+V) dalam chat WhatsApp.', 'success');
      return;
    } catch(e){
      // fallback terakhir
    }
  }

  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `laporan_nadi_${Date.now()}.png`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Makluman', 'Imej dimuat turun. Lampirkan imej itu dalam chat WhatsApp dan hantar.', 'warning');
}

/* =======================
   GLOBALS
   ======================= */
let stats3dChart, completed3dChart;
let retcaModal, secondTcaModal, pdpaModal, whatsappReportModal;
let currentWhatsAppData = null;

/* =======================
   BOOTSTRAP APP
   ======================= */
function bootstrapApp(){
  const logoEl = document.getElementById('brandLogo');
  logoEl.src = LOGO_URL;
  logoEl.onerror = () => (logoEl.src='https://via.placeholder.com/64x64.png?text=KS');

  document.getElementById('current
