<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- COOP/COEP supaya Google Sign-In tidak trigger amaran postMessage -->
  <meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
  <meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">

  <title>Sistem Tracker PEKA B40 - Klinik SihatSokmo</title>

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Chart.js + Datalabels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- SheetJS (Excel) -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>

  <!-- Google Identity Services (Sign-In) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- html2canvas (capture preview → image) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <style>
    :root{
      --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12;
      --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6;
    }
    html{ font-size:15px; }
    @media (max-width:1200px){ html{ font-size:14px; } }
    @media (max-width:576px){ html{ font-size:13px; } }

    html,body{height:100%}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;color:#333}

    /* Navbar */
    .navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
    .navbar-brand{font-weight:700;color:var(--primary);font-size:1.05rem;display:flex;align-items:center;gap:10px}
    .nav-link{color:var(--dark);font-weight:500;margin:0 4px;padding:7px 10px!important;border-radius:8px;transition:.2s;position:relative}
    .nav-link:hover,.nav-link.active{background:rgba(52,152,219,.12);color:var(--secondary)}
    .nav-badge{
      position:absolute; top:-4px; right:-2px; transform:translate(30%,-30%);
      background:#dc3545; color:#fff; border-radius:999px; font-size:.65rem; padding:2px 6px; display:none;
    }

    /* Header */
    .page-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:14px 0;margin-bottom:12px;border-radius:0 0 12px 12px}

    /* Cards */
    .card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:16px}
    .card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;padding:12px 16px;border-radius:14px 14px 0 0!important}
    .stat-card{padding:14px;border-radius:14px;color:#fff;text-align:center;position:relative;overflow:hidden;cursor:pointer}
    .stat-card .number{font-size:1.45rem;font-weight:800}
    .table td,.table th{vertical-align:middle}
    .table{font-size:.95rem}
    .searchbar{max-width:340px}
    .mini-actions .btn{margin-right:6px;margin-bottom:6px}

    /* Global App Loader (maks 2s) */
    #appLoader{
      position:fixed; inset:0; z-index:2000; display:none;
      background: radial-gradient(1200px 600px at 10% -10%, rgba(52,152,219,.18), transparent),
                  radial-gradient(1200px 600px at 110% 110%, rgba(46,204,113,.18), transparent),
                  rgba(255,255,255,.35);
      backdrop-filter: blur(10px);
    }
    #appLoader .loader-card{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      background:rgba(255,255,255,.75); border:1px solid rgba(255,255,255,.6);
      box-shadow: 0 20px 40px rgba(0,0,0,.12);
      border-radius:18px; padding:16px 18px; min-width:220px; text-align:center;
    }
    .spinner-premium{
      width:36px;height:36px;border-radius:50%;
      border:4px solid rgba(52,152,219,.25);
      border-top-color:#3498db; animation:spin .9s linear infinite; margin:6px auto 8px;
    }
    @keyframes spin{to{transform:rotate(360deg)}}

    /* Log Calls Drawer (gaya iPhone) */
    #logDrawer{
      position:fixed; top:0; right:-420px; width:400px; max-width:90vw; height:100%;
      background:#f8f9fb; box-shadow:-12px 0 35px rgba(0,0,0,.18); z-index:3000;
      transition:right .25s ease; border-left:1px solid rgba(0,0,0,.05);
      display:flex; flex-direction:column;
    }
    #logDrawer.open{ right:0; }
    .log-header{
      padding:10px 12px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06);
      display:flex; gap:8px; align-items:center;
    }
    .log-header .title{font-weight:700; color:#222; flex:1}
    .log-search{ padding:8px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06); }
    .log-body{ padding:10px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; }
    .bubble{
      max-width:80%; padding:8px 10px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
      position:relative; font-size:.9rem; line-height:1.2rem;
    }
    .bubble.me{ margin-left:auto; background:#007aff; color:#fff; border-bottom-right-radius:6px; }
    .bubble.other{ margin-right:auto; background:#e9ecef; color:#222; border-bottom-left-radius:6px; }
    .bubble .meta{ font-size:.72rem; opacity:.8; margin-top:5px }
    .log-loading{ display:none; text-align:center; padding:8px }
    .log-loading.active{ display:block }

    /* FAB (tombol terapung) untuk Log Calls */
    #fabLog{
      position:fixed; right:18px; bottom:18px; z-index:3500;
      width:56px; height:56px; border-radius:50%;
      display:flex; align-items:center; justify-content:center;
      box-shadow:0 10px 24px rgba(0,0,0,.18);
    }

    /* NOTIFIKASI (kanan atas) */
    #toastHost{
      position:fixed; top:12px; right:12px; z-index:4000; /* tertinggi */
      pointer-events:none;
    }
    #toastHost .toast{ pointer-events:auto; }

    /* NADI TABLE STYLES */
    .nadi-scroll-container { overflow-x: auto; width: 100%; padding-bottom: 8px; }
    .nadi-table { width: 100%; min-width: 1300px; border-collapse: separate; border-spacing: 0; }
    .nadi-table th {
      background: #f8f9fa; padding: 10px 8px; font-weight: 600; text-align: center;
      position: sticky; top: 0; z-index: 10; border: 1px solid #dee2e6;
    }
    .nadi-table td { padding: 8px; vertical-align: middle; border: 1px solid #dee2e6; }
    .nadi-input-cell { position: relative; }
    .nadi-input-cell .view-mode {
      width: 100%; padding: 6px 8px; cursor: pointer; border: 1px solid transparent;
      border-radius: 4px; min-height: 36px; display: flex; align-items: center;
    }
    .nadi-input-cell .view-mode:hover { background-color: #f8f9fa; border: 1px solid #dee2e6; }
    .nadi-input-cell input {
      width: 100%; min-width: 100px; border: 1px solid #ced4da; border-radius: 4px; padding: 6px 8px; transition: width 0.2s ease;
    }
    .nadi-input-cell input:focus { width: auto; min-width: 100px; }
    .nadi-checkbox-cell { text-align: center; }
    .nadi-actions-cell { min-width: 180px; }
    .nadi-counter {
      background: var(--primary); color: white; border-radius: 50%; width: 24px; height: 24px;
      display: inline-flex; align-items: center; justify-content: center; font-size: 0.75rem;
    }

    /* Responsive */
    @media (max-width: 992px) { .stat-card .number{font-size:1.3rem} }

    /* Form sections */
    .form-section { background: white; border-radius: 12px; padding: 16px; margin-bottom: 16px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .form-section h5 { color: var(--primary); margin-bottom: 16px; padding-bottom: 8px; border-bottom: 1px solid #eee; }
    .sticky-form-actions { position: sticky; bottom: 0; background: white; padding: 12px; border-top: 1px solid #eee; margin-top: 16px; }

    /* WhatsApp Report Image (Preview) */
    .whatsapp-report {
      width: 100%; max-width: 500px; background: white; border-radius: 12px; padding: 20px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; border: 1px solid #eee;
    }
    .whatsapp-report-header {
      display: flex; align-items: center; margin-bottom: 15px; padding-bottom: 15px; border-bottom: 1px solid #eee;
    }
    .whatsapp-report-logo { width: 50px; height: 50px; border-radius: 8px; margin-right: 15px; object-fit: cover; border: 1px solid rgba(0,0,0,0.08); }
    .whatsapp-report-title { font-size: 18px; font-weight: 700; color: var(--primary); }
    .whatsapp-report-subtitle { font-size: 14px; color: var(--muted); }
    .whatsapp-report-body { margin-bottom: 15px; }
    .whatsapp-report-row { display: flex; margin-bottom: 8px; }
    .whatsapp-report-label { font-weight: 600; width: 120px; color: var(--dark); }
    .whatsapp-report-value { flex: 1; }
    .whatsapp-report-footer { text-align: center; font-size: 12px; color: var(--muted); margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; }
  </style>
</head>
<body>
  <!-- Global Loader -->
  <div id="appLoader" aria-hidden="true">
    <div class="loader-card">
      <div class="spinner-premium"></div>
      <div class="fw-bold">Sila tunggu…</div>
      <div class="text-muted small" id="loaderMsg">Memproses permintaan anda</div>
    </div>
  </div>

  <!-- Log Calls Drawer -->
  <div id="logDrawer" aria-hidden="true">
    <div class="log-header">
      <button class="btn btn-sm btn-outline-secondary" id="btnCloseLog"><i class="bi bi-x-lg"></i></button>
      <div class="title"><i class="bi bi-chat-dots me-1"></i> Log Calls</div>
      <div id="logBadge" class="badge text-bg-primary">0</div>
    </div>
    <div class="log-search">
      <input id="logSearch" class="form-control form-control-sm" placeholder="Cari: nama / IC / telefon / staff…" />
    </div>
    <div id="logLoading" class="log-loading">
      <div class="spinner-border spinner-border-sm" role="status"></div>
      <div class="small text-muted mt-1">Memuat Log Calls…</div>
    </div>
    <div id="logBody" class="log-body"></div>
  </div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-main sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#dashboard">
        <img id="brandLogo" alt="Logo" style="width:32px;height:32px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,.08)">
        <span>Klinik SihatSokmo</span>
      </a>

      <!-- Google Sign-in button placeholder -->
      <div id="signinArea" class="d-lg-none me-2"></div>

      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item position-relative">
            <a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#nadi"><i class="bi bi-clipboard2-pulse"></i> Program PEKA B40 bersama NADI</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#daftar-peka"><i class="fas fa-user-plus"></i> Daftar Peka</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a>
            <span id="badgeTCA" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a>
            <span id="badgeFirst" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab Report</a>
            <span id="badgeLab" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a>
            <span id="badgeSecond" class="nav-badge">0</span>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a>
          </li>
          <li class="nav-item position-relative">
            <a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a>
          </li>
        </ul>

        <div class="d-none d-lg-flex align-items-center gap-2">
          <div id="signinAreaDesktop"></div>
          <span id="staffBadge" class="badge bg-secondary d-none"><i class="bi bi-person-check me-1"></i><span id="staffEmail"></span></span>
          <!-- (Butang Log Calls terapung di bawah – tidak dalam navbar) -->
        </div>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <div class="container">
      <div class="row align-items-center g-2">
        <div class="col-md-6">
          <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
          <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
        </div>
        <div class="col-md-6 text-md-end">
          <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
        </div>
      </div>
    </div>
  </header>

  <main class="container">

    <!-- Dashboard -->
    <section id="dashboard" class="mb-4">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
        <div class="d-flex gap-2">
          <button class="btn btn-sm btn-outline-success" id="btnExportCSV"><i class="fa-solid fa-file-csv me-1"></i>Export (CSV)</button>
        </div>
      </div>

      <div class="row g-3 mb-3">
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#tca-call" style="background:linear-gradient(135deg,var(--secondary),#2980b9)">
            <div class="number" id="totalDaftar">0</div><div class="small">Aktif</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#first-visit" style="background:linear-gradient(135deg,var(--warning),#e67e22)">
            <div class="number" id="totalFirstVisit">0</div><div class="small">First Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#second-visit" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">
            <div class="number" id="totalSecondVisit">0</div><div class="small">Second Visit (Pending)</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#selesai" style="background:linear-gradient(135deg,var(--success),#16a085)">
            <div class="number" id="totalSelesai">0</div><div class="small">Selesai</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#8e44ad,#6c5ce7)">
            <div class="number" id="labFollowUpDue">0</div><div class="small">Result > 3 Hari</div>
          </div>
        </div>
        <div class="col-6 col-md-2">
          <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#d35400,#c0392b)">
            <div class="number" id="labFollowUpPending">0</div><div class="small">Perlu Follow-up</div>
          </div>
        </div>
      </div>

      <!-- Pesakit perlu dihubungi (ringkas hari ini mengikut backend lalai) -->
      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi Hari Ini</span>
          <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefon…" />
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
              <tbody id="tcaCallTable"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Statistik -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriod" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:320px;"><canvas id="stats3dChart"></canvas></div></div>
      </div>
    </section>

    <!-- Program NADI -->
    <section id="nadi" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="bi bi-clipboard2-pulse me-2"></i>Program PEKA B40 bersama NADI</h2>
        <div class="d-flex gap-2">
          <button id="btnNadiExportCsv" class="btn btn-sm btn-outline-success"><i class="bi bi-filetype-csv me-1"></i>Export to CSV</button>
        </div>
      </div>
      <div class="card">
        <div class="card-body">
          <div class="nadi-scroll-container">
            <table class="nadi-table">
              <thead>
                <tr>
                  <th style="width: 40px;">#</th>
                  <th style="min-width: 150px;">Nama Pesakit</th>
                  <th style="min-width: 120px;">No IC</th>
                  <th style="min-width: 120px;">Telefon</th>
                  <th style="min-width: 150px;">Alamat</th>
                  <th style="min-width: 80px;">BP</th>
                  <th style="min-width: 80px;">PR</th>
                  <th style="min-width: 120px;">DXT</th>
                  <th style="min-width: 80px;">Tinggi</th>
                  <th style="min-width: 80px;">Berat</th>
                  <th style="min-width: 80px;">BMI</th>
                  <th style="width: 80px;">Layak</th>
                  <th style="width: 100px;">Tidak Layak</th>
                  <th style="min-width: 200px;">TCA & Staff</th>
                  <th style="min-width: 180px;">Tindakan</th>
                </tr>
              </thead>
              <tbody id="nadiContainer">
                <!-- Rows will be added dynamically -->
              </tbody>
            </table>
          </div>
          <div class="sticky-form-actions">
            <button class="btn btn-primary" onclick="addNadiRow()"><i class="bi bi-plus-circle me-1"></i>Tambah Pesakit</button>
          </div>
          <div class="text-muted small mt-2">Nota: Baris "Layak" boleh terus <b>Daftar</b> (simpan ke sheet). Baris "Tidak Layak" <u>tidak</u> disimpan ke sheet tetapi <b>tetap dieksport CSV</b> bersama-sama.</div>
        </div>
      </div>
    </section>

    <!-- Daftar Peka -->
    <section id="daftar-peka" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h2 class="h6 m-0"><i class="fas fa-user-plus me-2"></i>Daftar Peka</h2>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-circle me-2"></i>Maklumat Pesakit</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Penuh Pesakit</label>
            <input id="namaPesakit" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor IC</label>
            <input id="noIC" class="form-control" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nombor Telefon</label>
            <input id="noTelefon" class="form-control" type="tel" required placeholder="cth: 0123456789 atau 60123456789">
          </div>
          <div class="col-md-6">
            <label class="form-label">Alamat Pesakit</label>
            <textarea id="alamatPesakit" class="form-control" rows="2"></textarea>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-calendar-alt me-2"></i>Tarikh Temujanji</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Tarikh TCA</label>
            <input id="tarikhTCA" class="form-control" type="date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">Masa TCA</label>
            <input id="masaTCA" class="form-control" type="time" required>
          </div>
        </div>
      </div>

      <div class="form-section">
        <h5><i class="fas fa-user-tie me-2"></i>Maklumat Staff</h5>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Staff</label>
            <input id="namaStaff" class="form-control" required>
          </div>
        </div>
      </div>

      <div class="sticky-form-actions">
        <button class="btn btn-primary" id="btnDaftarPesakit"><i class="fas fa-save me-1"></i>Daftar Pesakit</button>
      </div>
    </section>

    <!-- Kelayakan (Excel) -->
    <section id="kelayakan" class="mb-4 d-none">
      <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel)</h2>
      <div class="card"><div class="card-body">
        <div class="row g-2 align-items-center mb-3">
          <div class="col-md-6">
            <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls" />
            <div class="form-text">Fail perlu ada lajur: <b>Nama</b>, <b>IC</b>, <b>Telefon</b>, <b>Alamat</b>. (Sistem tapis umur ≥40 ikut IC)</div>
          </div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th>
                <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
                <th style="width:360px">Jika Layak → TCA & Masa & Staff</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="kelayakanTable"><tr><td colspan="8" class="text-center text-muted">Muat naik Excel untuk mula.</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- TCA Call -->
    <section id="tca-call" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-phone me-2"></i>Senarai Rekod TCA Call</h2>
        <div class="d-flex align-items-center gap-2">
          <div class="btn-group btn-group-sm" role="group" id="tcaFilter">
            <button class="btn btn-outline-primary active" data-filter="today">Hari ini</button>
            <button class="btn btn-outline-primary" data-filter="upcoming">Akan datang</button>
            <button class="btn btn-outline-primary" data-filter="past">Lepas</button>
            <button class="btn btn-outline-secondary" data-filter="all">Semua</button>
          </div>
          <input class="form-control form-control-sm searchbar" id="searchTCAPage" placeholder="Cari nama/IC/telefon…"/>
        </div>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
            <tbody id="tcaCallList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- First Visit -->
    <section id="first-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchFirst" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="firstVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Follow-up Lab Report -->
    <section id="lab-followup" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
        <input class="form-control form-control-sm searchbar" id="searchLab" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th><th>Tindakan</th></tr>
            </thead>
            <tbody id="labFollowupTable"><tr><td colspan="8" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Second Visit -->
    <section id="second-visit" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
        <input class="form-control form-control-sm searchbar" id="searchSecond" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
            <tbody id="secondVisitList"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Selesai -->
    <section id="selesai" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
        <input class="form-control form-control-sm searchbar" id="searchCompleted" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card mb-3"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>PDPA</th>
                <th>Tarikh Daftar</th><th>First Visit</th><th>Lab Report Completed</th><th>Second Visit</th><th>Tarikh Selesai</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="completedTable"><tr><td colspan="11" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>

      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
          <select id="statPeriodCompleted" class="form-select form-select-sm" style="max-width:200px">
            <option value="3months">3 Bulan Terakhir</option>
            <option value="6months">6 Bulan Terakhir</option>
            <option value="12months">12 Bulan Terakhir</option>
          </select>
        </div>
        <div class="card-body"><div style="height:300px;"><canvas id="completed3dChart"></canvas></div></div>
      </div>
    </section>

    <!-- Arkib -->
    <section id="arkib" class="mb-4 d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
        <input class="form-control form-control-sm searchbar" id="searchArchive" placeholder="Cari nama/IC/telefon…"/>
      </div>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th><th>Tindakan</th></tr></thead>
            <tbody id="archiveTable"><tr><td colspan="8" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>
  </main>

  <!-- Modal Re-TCA -->
  <div class="modal fade" id="retcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Daftar TCA Semula</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="retcaIC">
        <div class="mb-3"><label class="form-label">Tarikh TCA Baharu</label><input type="date" id="retcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA Baharu</label><input type="time" id="retcaTime" class="form-control" required></div>
        <small class="text-muted">Status pesakit akan ditukar kepada <b>TCA CALL</b>.</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitRetca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Set Second Visit TCA -->
  <div class="modal fade" id="secondTcaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-calendar-check me-2"></i>Tetapkan TCA Second Visit</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="secondTcaIC">
        <div class="mb-2"><label class="form-label">Tarikh TCA Second Visit</label><input type="date" id="secondTcaDate" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Masa TCA</label><input type="time" id="secondTcaTime" class="form-control" required></div>
        <div class="mb-2"><label class="form-label">Nama Staff (wajib isi)</label><input type="text" id="secondTcaStaff" class="form-control" required placeholder="cth: Dayah"></div>
        <small class="text-muted">Maklumat ini akan direkod ke Log Calls & ruangan "Lab Report Completed".</small>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
        <button class="btn btn-primary" id="btnSubmitSecondTca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
      </div>
    </div></div>
  </div>

  <!-- Modal Upload PDPA -->
  <div class="modal fade" id="pdpaModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i>Muat Naik Borang PDPA</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="pdpaIC">
        <input type="file" id="pdpaFile" class="form-control" accept="application/pdf,image/*" />
        <div class="form-text">Muat naik PDF / imej borang PDPA pesakit.</div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button class="btn btn-primary" id="btnUploadPDPA"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload</button>
      </div>
    </div></div>
  </div>

  <!-- Modal WhatsApp Report Preview -->
  <div class="modal fade" id="whatsappReportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered"><div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title"><i class="fa-brands fa-whatsapp me-2"></i>Pratonton Laporan WhatsApp</h5>
        <button class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="whatsappReportPreview"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
        <button class="btn btn-success" id="btnSendWhatsApp"><i class="fa-brands fa-whatsapp me-1"></i>Hantar WhatsApp</button>
      </div>
    </div></div>
  </div>

  <!-- Toast Host -->
  <div id="toastHost"><div id="toastContainer" class="toast-container"></div></div>

  <!-- FAB Log Calls -->
  <button id="fabLog" class="btn btn-primary">
    <i class="bi bi-chat-dots fs-5"></i>
  </button>

  <footer class="footer mt-4 py-3 bg-light">
    <div class="container"><div class="d-flex justify-content-between">
      <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
      <div>Versi 3.1 (Secure)</div>
    </div></div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script>
/* =======================
   KONFIG (EDIT INI SAHAJA)
   ======================= */
// 1) Isi URL Web App Apps Script (deployment terkini)
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6TKE0vDDPO3-36cY7xjacAbGL0HIRKCrORNm-sED9y5NpIeIUk9gyrpiWy-S7vbc/exec';
// 2) Google OAuth Client ID (Google Cloud Console)
const GOOGLE_CLIENT_ID = '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com';
// 3) Logo (optional) — disyorkan guna URL yang benarkan CORS
const LOGO_URL = 'https://raw.githubusercontent.com/sihat9/mari-jalan-dengan-doktor/main/img/logo-kss.png';

/* =======================
   AUTH (Google Identity)
   ======================= */
let ID_TOKEN = '';      // diisi selepas login
let STAFF_EMAIL = '';   // email sebenar (server akan sahkan juga)

function initGoogleSignIn(){
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false,
    cancel_on_tap_outside: true
  });
  google.accounts.id.renderButton(
    document.getElementById('signinArea'),
    { theme: 'outline', size: 'medium', text:'signin_with' }
  );
  google.accounts.id.renderButton(
    document.getElementById('signinAreaDesktop'),
    { theme: 'outline', size: 'medium', text:'signin_with' }
  );
}

async function handleCredentialResponse(resp){
  ID_TOKEN = resp.credential;
  // Semak whoami di backend
  const r = await fetch(SCRIPT_URL, {
    method:'POST',
    headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ action:'whoami', id_token: ID_TOKEN })
  });
  const j = await r.json();
  if (j.status === 'success'){
    STAFF_EMAIL = j.email || '';
    document.getElementById('staffBadge').classList.remove('d-none');
    document.getElementById('staffEmail').textContent = STAFF_EMAIL;
    document.getElementById('signinArea').innerHTML = '';
    document.getElementById('signinAreaDesktop').innerHTML = '';
    bootstrapApp(); // muat data
  } else {
    toast('Akses Ditolak', j.message || 'Sila hubungi admin untuk allowlist.', 'danger');
    ID_TOKEN = ''; STAFF_EMAIL = '';
  }
}

/* =======================
   LOADER (maks 2s)
   ======================= */
let loaderTimer=null;
function showLoader(msg='Memproses…'){
  document.getElementById('loaderMsg').textContent = msg;
  document.getElementById('appLoader').style.display = 'block';
  clearTimeout(loaderTimer);
  loaderTimer = setTimeout(hideLoader, 2000);
}
function hideLoader(){ document.getElementById('appLoader').style.display = 'none'; }

/* =======================
   NETWORK HELPERS
   ======================= */
async function getJSON(params={}, {silent=false, msg='Memuat data…'}={}){
  if (!ID_TOKEN) throw new Error('Belum login');
  const qs = new URLSearchParams({ ...params, id_token: ID_TOKEN }).toString();
  const url = `${SCRIPT_URL}?${qs}`;
  if (!silent) showLoader(msg);
  try{
    const r = await Promise.race([
      fetch(url, { method:'GET' }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

async function postForm(params={}, {silent=false, msg='Menyimpan data…'}={}){
  if (!ID_TOKEN) throw new Error('Belum login');
  if (!silent) showLoader(msg);
  try{
    const r = await Promise.race([
      fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ ...params, id_token: ID_TOKEN })
      }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

/* =======================
   UTIL
   ======================= */
const normalizeMsisdnMY = (raw) => {
  if (!raw) return '';
  let s = String(raw).replace(/\D/g,'');
  if (s.startsWith('00')) s = s.slice(2);
  if (s.startsWith('60')) return s;
  if (s.startsWith('0')) return '60' + s.slice(1);
  return '60' + s;
};
const telHref = (msisdn) => `tel:+${msisdn}`;
const waHref  = (msisdn, txt='') => `whatsapp://send?phone=${msisdn}${txt?('&text='+encodeURIComponent(txt)):''}`; // guna app WhatsApp kalau ada
const waWebHref = (msisdn, txt='') => `https://wa.me/${msisdn}${txt?('?text='+encodeURIComponent(txt)):''}`;

const parseDDMMYYYY = (s) => {
  if (!s) return null;
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D); }
  const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
  if (!m) return null; const D=+m[1], M=+m[2], Y=+m[3]; return new Date(Y,M-1,D);
};
function isSameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }

function toast(title, message, variant='primary'){
  const container = document.getElementById('toastContainer');
  const id = 't'+Date.now();
  const html = `
    <div class="toast align-items-center text-bg-${variant} border-0 mb-2" id="${id}" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"><strong>${title}:</strong> ${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`;
  container.insertAdjacentHTML('beforeend', html);
  const el = document.getElementById(id);
  const t = new bootstrap.Toast(el, { delay: 3000 });
  t.show();
  el.addEventListener('hidden.bs.toast', ()=>el.remove());
}

/* =======================
   GLOBALS
   ======================= */
let stats3dChart, completed3dChart;
let retcaModal, secondTcaModal, pdpaModal, whatsappReportModal;
let currentWhatsAppData = null;

/* === LOGO cache as Data URL (untuk pastikan muncul dalam imej) === */
let LOGO_DATA_URL = '';
async function cacheLogoAsDataURL(){
  try{
    const res = await fetch(LOGO_URL, { mode:'cors', cache:'force-cache' });
    const blob = await res.blob();
    const reader = new FileReader();
    LOGO_DATA_URL = await new Promise((resolve)=>{ reader.onload=()=>resolve(reader.result); reader.readAsDataURL(blob); });
  }catch(e){
    LOGO_DATA_URL = ''; // fallback — html2canvas masih cuba guna src asal
  }
}

/* =======================
   BOOTSTRAP APP
   ======================= */
function bootstrapApp(){
  const logoEl = document.getElementById('brandLogo');
  logoEl.src = LOGO_URL;
  logoEl.onerror = () => (logoEl.src='https://via.placeholder.com/64x64.png?text=KS');

  document.getElementById('current-date').textContent =
    new Date().toLocaleDateString('ms-MY', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  setupNavigation();
  setupModals();
  setupSearchBars();
  setupExports();
  setupExcel();
  setupNADI();
  setupLogDrawer();
  setupFab();

  // Cache logo → data URL untuk rendering dalam imej
  cacheLogoAsDataURL();

  loadDashboardData();
  loadStatistics('3months');
  loadCompletedStatistics('3months');
  loadTCACallData(); // widget dashboard (hari ini)
}

/* =======================
   NAV & UI
   ======================= */
function setupNavigation(){
  document.querySelectorAll('.nav-link').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault();
      document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
      const target = a.getAttribute('href');
      document.querySelector(target).classList.remove('d-none');
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
      a.classList.add('active');

      if (target==='#dashboard'){ loadDashboardData(); loadStatistics(document.getElementById('statPeriod').value); }
      else if (target==='#nadi'){ /* no-op */ }
      else if (target==='#daftar-peka'){ /* no-op */ }
      else if (target==='#kelayakan'){ /* no-op */ }
      else if (target==='#tca-call'){ loadTCACallPage(); }
      else if (target==='#first-visit'){ loadFirstVisitData(); }
      else if (target==='#lab-followup'){ loadLabFollowUp(); }
      else if (target==='#second-visit'){ loadSecondVisitData(); }
      else if (target==='#selesai'){ loadCompletedData(); loadCompletedStatistics(document.getElementById('statPeriodCompleted').value); }
      else if (target==='#arkib'){ loadArchivedData(); }
    });
  });

  // Stat cards → navigate
  document.querySelectorAll('.stat-card[data-goto]').forEach(card=>{
    card.addEventListener('click', ()=>{
      const href = card.getAttribute('data-goto');
      const link = document.querySelector(`.nav-link[href="${href}"]`);
      if (link){ link.click(); }
    });
  });

  document.getElementById('btnDaftarPesakit').addEventListener('click', async (e)=>{
    e.preventDefault();
    await daftarPesakit();
  });

  document.getElementById('statPeriod').addEventListener('change', function(){ loadStatistics(this.value); });
  document.getElementById('statPeriodCompleted').addEventListener('change', function(){ loadCompletedStatistics(this.value); });
}

function setupModals(){
  retcaModal = new bootstrap.Modal(document.getElementById('retcaModal'));
  document.getElementById('btnSubmitRetca').addEventListener('click', submitRetca);

  secondTcaModal = new bootstrap.Modal(document.getElementById('secondTcaModal'));
  document.getElementById('btnSubmitSecondTca').addEventListener('click', submitSecondTca);

  pdpaModal = new bootstrap.Modal(document.getElementById('pdpaModal'));
  document.getElementById('btnUploadPDPA').addEventListener('click', uploadPDPA);

  whatsappReportModal = new bootstrap.Modal(document.getElementById('whatsappReportModal'));
  document.getElementById('btnSendWhatsApp').addEventListener('click', sendWhatsAppReport);
}

function setupFab(){
  const btn = document.getElementById('fabLog');
  const drawer  = document.getElementById('logDrawer');
  const btnClose= document.getElementById('btnCloseLog');
  btn.addEventListener('click', ()=>{ drawer.classList.add('open'); refreshLogs(); autoRefreshLogs(); });
  btnClose.addEventListener('click', ()=>{ drawer.classList.remove('open'); stopAutoRefreshLogs(); });
}

function setupSearchBars(){
  const pairs = [
    ['searchTCA','tcaCallTable'], ['searchTCAPage','tcaCallList'],
    ['searchFirst','firstVisitList'], ['searchSecond','secondVisitList'],
    ['searchCompleted','completedTable'], ['searchLab','labFollowupTable'],
    ['searchArchive','archiveTable']
  ];
  pairs.forEach(([inpId,tbodyId])=>{
    const inp = document.getElementById(inpId);
    const tb = document.getElementById(tbodyId);
    if (!inp || !tb) return;
    inp.addEventListener('input', ()=>{
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const text = tr.innerText || '';
        tr.style.display = (text.toLowerCase().includes((inp.value||'').trim().toLowerCase())) ? '' : 'none';
      });
    });
  });
}

function setupExports(){
  document.getElementById('btnExportCSV').addEventListener('click', exportCompletedCSV);
}

/* =======================
   CHART HELPERS
   ======================= */
function buildBarChart(elId, dataArr, titleText){
  const ctx = document.getElementById(elId).getContext('2d');
  const labels = dataArr.map(i=>i.label);
  const counts = dataArr.map(i=>i.count);
  const backgroundColors = counts.map((_,i)=>`hsla(${(i*30)%360},70%,50%,0.7)`);
  const config = {
    type:'bar',
    data:{ labels, datasets:[{ label:'Jumlah Pesakit Selesai', data:counts, backgroundColor:backgroundColors, borderColor:'rgba(0,0,0,.1)', borderWidth:1 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{ display:true, text:titleText, font:{ size:14 } }, legend:{ display:false }, datalabels:{ display:false } },
      scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Jumlah Pesakit'} }, x:{ title:{ display:true, text:'Bulan/Tahun'} } },
      animation:{ duration:500 }
    }
  };
  return new Chart(ctx, config);
}

/* =======================
   LOG CALLS DRAWER
   ======================= */
let logDrawerTimer=null, lastLogCount=0;
function setupLogDrawer(){
  document.getElementById('logSearch').addEventListener('input', ()=> refreshLogs());
}
function autoRefreshLogs(){ stopAutoRefreshLogs(); logDrawerTimer = setInterval(()=> refreshLogs({silent:true}), 10000); }
function stopAutoRefreshLogs(){ if (logDrawerTimer){ clearInterval(logDrawerTimer); logDrawerTimer=null; } }
async function refreshLogs(opts={}){
  const q = (document.getElementById('logSearch').value||'').trim();
  const loader = document.getElementById('logLoading');
  const body   = document.getElementById('logBody');
  if (!opts.silent) loader.classList.add('active');
  try{
    const res = await getJSON({ action:'getCallLogs', q }, { silent:true });
    if (res.status==='success'){
      const arr = res.data||[];
      lastLogCount = arr.length;
      document.getElementById('logBadge').textContent = arr.length;
      body.innerHTML = '';
      arr.forEach(item=>{
        const me = (item.staff||'').toLowerCase() === (STAFF_EMAIL||'').toLowerCase();
        const who = item.staff || 'STAFF';
        const text = `${item.event || 'CALL'} • ${item.nama||'-'} (${item.noIC||'-'}) • ${item.noTelefon||'-'}`;
        const when = item.time || '';
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (me?'me':'other');
        bubble.innerHTML = `<div><i class="fa-solid fa-phone-volume me-1"></i>${text}</div><div class="meta">${who} • ${when}</div>`;
        body.appendChild(bubble);
      });
      body.scrollTop = body.scrollHeight;
    }
  }catch(e){ /* senyap */ }
  finally{ if (!opts.silent) loader.classList.remove('active'); }
}

/* =======================
   EXCEL (Kelayakan)
   ======================= */
function setupExcel(){
  const input = document.getElementById('excelFile');
  const tbody = document.getElementById('kelayakanTable');
  input.addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    showLoader('Memproses Excel…');
    try{
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
      tbody.innerHTML = '';
      if (!json.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada data.</td></tr>`;
        return;
      }
      json.forEach((row, idx)=>{
        const nama = row.Nama || row.NAMA || row.name || '';
        const ic = row.IC || row.Ic || row.ic || '';
        const tel = row.Telefon || row.TELEFON || row.Phone || row.phone || '';
        const alamat = row.Alamat || row.ALAMAT || row.alamat || row.address || '';
        const msisdn = normalizeMsisdnMY(tel);
        const id = 'x'+Date.now()+idx;

        // Kelayakan lalai ikut umur >=40 dari IC (format: YYMMDD-..)
        const lahirYY = ic.slice(0,2), lahirMM = ic.slice(2,4), lahirDD = ic.slice(4,6);
        let ageOk = false;
        if (/^\d{6}/.test(ic)){
          const y = Number(lahirYY); const fullY = (y>=0 && y<=29) ? (2000+y) : (1900+y);
          const dob = new Date(fullY, Number(lahirMM)-1, Number(lahirDD));
          const now = new Date();
          let age = now.getFullYear()-dob.getFullYear();
          const m = now.getMonth()-dob.getMonth();
          if (m<0 || (m===0 && now.getDate()<dob.getDate())) age--;
          ageOk = age>=40;
        }

        const tr = `
          <tr id="\${id}">
            <td>\${nama}</td>
            <td>\${ic}</td>
            <td>\${msisdn}</td>
            <td>\${alamat}</td>
            <td class="text-center"><input type="checkbox" class="form-check-input" \${ageOk?'checked':''} onchange="toggleLayak('\${id}', true)"></td>
            <td class="text-center"><input type="checkbox" class="form-check-input" \${ageOk?'':'checked'} onchange="toggleLayak('\${id}', false)"></td>
            <td>
              <div class="row g-1 align-items-center">
                <div class="col"><input type="date" class="form-control form-control-sm tca-date" disabled></div>
                <div class="col"><input type="time" class="form-control form-control-sm tca-time" disabled></div>
                <div class="col"><input type="text" class="form-control form-control-sm tca-staff" placeholder="Nama staff" disabled></div>
              </div>
            </td>
            <td>
              <button class="btn btn-sm btn-primary" onclick="daftarFromExcel('\${id}', '\${encodeURIComponent(nama)}', '\${encodeURIComponent(ic)}', '\${msisdn}', '\${encodeURIComponent(alamat)}')" disabled>Daftar</button>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', tr);
      });
    } finally { hideLoader(); }
  });
}
function toggleLayak(rowId, isLayak){
  const tr = document.getElementById(rowId);
  if (!tr) return;
  const checks = tr.querySelectorAll('input[type=checkbox]');
  if (isLayak) { checks[1].checked = false; } else { checks[0].checked = false; }
  const date  = tr.querySelector('.tca-date');
  const time  = tr.querySelector('.tca-time');
  const staff = tr.querySelector('.tca-staff');
  const btn   = tr.querySelector('button');
  if (isLayak && checks[0].checked) {
    date.disabled = false; time.disabled = false; staff.disabled=false; btn.disabled = false;
  } else {
    date.disabled = true;  time.disabled = true; staff.disabled=true;  btn.disabled = true;
  }
}
async function daftarFromExcel(rowId, encNama, encIC, msisdn, encAlamat){
  const tr = document.getElementById(rowId);
  const nama = decodeURIComponent(encNama);
  const ic = decodeURIComponent(encIC);
  const alamat = decodeURIComponent(encAlamat);
  const date  = tr.querySelector('.tca-date').value;
  const time  = tr.querySelector('.tca-time').value;
  const staff = tr.querySelector('.tca-staff').value.trim();
  if (!date || !time || !staff) { toast('Ralat','Sila isi tarikh, masa & nama staff','danger'); return; }
  try{
    const res = await postForm({
      action:'daftarPesakit', namaPesakit:nama, noIC: ic, noTelefon: msisdn, alamat: alamat,
      namaStaff: staff, tarikhTCA: date, masaTCA: time
    }, { msg:'Mendaftar pesakit…' });
    if (res.status==='success'){
      toast('Berjaya',`Pesakit ${nama} didaftarkan ke TCA`, 'success');
      tr.remove();
      loadDashboardData(); loadTCACallData();
    } else throw new Error(res.message||'Gagal daftar');
  }catch(e){ toast('Ralat',e.message,'danger'); }
}

/* =======================
   NADI PAGE (tabular view)
   ======================= */
let nadiRowCounter = 0;
let nadiRows = []; // Array to store all NADI rows data

function setupNADI(){
  const container = document.getElementById('nadiContainer');
  container.innerHTML = '';
  addNadiRow(); // Start with 1 row
  document.getElementById('btnNadiExportCsv').addEventListener('click', exportNadiCSV);
}

function addNadiRow(){
  const container = document.getElementById('nadiContainer');
  const id = 'n'+Date.now()+Math.random().toString(36).slice(2,6);
  const row = document.createElement('tr');
  row.className = 'nadi-row';
  row.id = id;

  nadiRowCounter++;

  row.innerHTML = `
    <td class="text-center">
      <div class="nadi-counter">${nadiRowCounter}</div>
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-nama" placeholder="Nama pesakit" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-ic" placeholder="IC" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-tel" placeholder="Telefon" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-alamat" placeholder="Alamat" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-bp" placeholder="BP" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-pr" placeholder="PR" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td>
      <div class="input-group input-group-sm">
        <button class="btn btn-outline-secondary dropdown-toggle nadi-dxt-type-btn" data-bs-toggle="dropdown" type="button">Fasting</button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" data-value="Fasting">Fasting</a></li>
          <li><a class="dropdown-item" href="#" data-value="Random">Random</a></li>
        </ul>
        <input class="form-control nadi-dxt" placeholder="DXT" style="width:100%; min-width:80px" />
        <input type="hidden" class="nadi-dxt-type" value="Fasting" />
      </div>
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-tinggi" placeholder="Tinggi" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-berat" placeholder="Berat" style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="nadi-input-cell">
      <div class="view-mode" onclick="editNadiCell(this)"></div>
      <input class="form-control form-control-sm nadi-bmi" placeholder="BMI" disabled style="display:none" onblur="saveNadiCell(this)" />
    </td>
    <td class="text-center">
      <input class="form-check-input nadi-layak" type="checkbox">
    </td>
    <td class="text-center">
      <input class="form-check-input nadi-taklayak" type="checkbox">
    </td>
    <td>
      <div class="d-flex gap-1">
        <input type="date" class="form-control form-control-sm nadi-tca-date" disabled style="min-width:100px">
        <input type="time" class="form-control form-control-sm nadi-tca-time" disabled style="min-width:80px">
        <input type="text" class="form-control form-control-sm nadi-staff" placeholder="Staff" disabled style="min-width:100px">
      </div>
    </td>
    <td>
      <div class="d-flex gap-1">
        <button class="btn btn-sm btn-outline-primary nadi-daftar" disabled>Daftar</button>
        <button class="btn btn-sm btn-outline-success nadi-wa">WA Report</button>
        <button class="btn btn-sm btn-outline-danger nadi-buang">Buang</button>
      </div>
    </td>
  `;

  container.appendChild(row);

  // Initialize dropdown for DXT type
  const dxtTypeBtn = row.querySelector('.nadi-dxt-type-btn');
  const dxtTypeMenu = row.querySelector('.dropdown-menu');
  const dxtTypeInput = row.querySelector('.nadi-dxt-type');

  dxtTypeMenu.querySelectorAll('.dropdown-item').forEach(item => {
    item.addEventListener('click', function(e) {
      e.preventDefault();
      dxtTypeBtn.textContent = this.textContent;
      dxtTypeInput.value = this.getAttribute('data-value');
    });
  });

  // BMI calculation
  const tinggi = row.querySelector('.nadi-tinggi');
  const berat = row.querySelector('.nadi-berat');
  const bmi = row.querySelector('.nadi-bmi');

  const calculateBMI = () => {
    const height = parseFloat(tinggi.value) / 100;
    const weight = parseFloat(berat.value);
    if (height && weight) {
      bmi.value = (weight / (height * height)).toFixed(1);
      bmi.previousElementSibling.textContent = bmi.value;
    } else {
      bmi.value = '';
      bmi.previousElementSibling.textContent = '';
    }
  };

  tinggi.addEventListener('input', calculateBMI);
  berat.addEventListener('input', calculateBMI);

  // Layak/Tidak Layak toggle
  const layak = row.querySelector('.nadi-layak');
  const takLayak = row.querySelector('.nadi-taklayak');
  const tcaDate = row.querySelector('.nadi-tca-date');
  const tcaTime = row.querySelector('.nadi-tca-time');
  const staff = row.querySelector('.nadi-staff');
  const btnDaftar = row.querySelector('.nadi-daftar');

  layak.addEventListener('change', () => {
    if (layak.checked) {
      takLayak.checked = false;
      tcaDate.disabled = false;
      tcaTime.disabled = false;
      staff.disabled = false;
      btnDaftar.disabled = false;
    } else {
      tcaDate.disabled = true;
      tcaTime.disabled = true;
      staff.disabled = true;
      btnDaftar.disabled = true;
    }
  });

  takLayak.addEventListener('change', () => {
    if (takLayak.checked) {
      layak.checked = false;
      tcaDate.disabled = true;
      tcaTime.disabled = true;
      staff.disabled = true;
      btnDaftar.disabled = true;
    }
  });

  // Daftar button action
  btnDaftar.addEventListener('click', async () => {
    const nama = row.querySelector('.nadi-nama').value.trim();
    const ic = row.querySelector('.nadi-ic').value.trim();
    const tel = row.querySelector('.nadi-tel').value.trim();
    const alamat = row.querySelector('.nadi-alamat').value.trim();
    const date = tcaDate.value;
    const time = tcaTime.value;
    const staffName = staff.value.trim();

    if (!nama || !ic || !tel || !date || !time || !staffName) {
      toast('Ralat', 'Sila isi semua maklumat', 'danger');
      return;
    }

    try {
      const res = await postForm({
        action: 'daftarPesakit',
        namaPesakit: nama,
        noIC: ic,
        noTelefon: tel,
        alamat: alamat,
        tarikhTCA: date,
        masaTCA: time,
        namaStaff: staffName
      }, { msg: 'Mendaftar pesakit...' });

      if (res.status === 'success') {
        toast('Berjaya', 'Pesakit berjaya didaftarkan', 'success');
        updateNadiRowData(row);
      } else {
        throw new Error(res.message || 'Gagal mendaftar pesakit');
      }
    } catch (e) {
      toast('Ralat', e.message, 'danger');
    }
  });

  // WhatsApp Report button
  row.querySelector('.nadi-wa').addEventListener('click', async () => {
    try {
      const data = {
        nama: row.querySelector('.nadi-nama').value.trim(),
        ic: row.querySelector('.nadi-ic').value.trim(),
        tel: normalizeMsisdnMY(row.querySelector('.nadi-tel').value.trim()),
        alamat: row.querySelector('.nadi-alamat').value.trim(),
        bp: row.querySelector('.nadi-bp').value.trim(),
        pr: row.querySelector('.nadi-pr').value.trim(),
        dxtType: row.querySelector('.nadi-dxt-type').value,
        dxt: row.querySelector('.nadi-dxt').value.trim(),
        tinggi: row.querySelector('.nadi-tinggi').value.trim(),
        berat: row.querySelector('.nadi-berat').value.trim(),
        bmi: row.querySelector('.nadi-bmi').value.trim(),
        layak: row.querySelector('.nadi-layak').checked
      };

      // Generate WhatsApp report preview (dengan logo)
      generateWhatsAppReport(data);

    } catch (e) {
      toast('Ralat', 'Gagal buat laporan: ' + e.message, 'danger');
    }
  });

  // Buang button
  row.querySelector('.nadi-buang').addEventListener('click', () => {
    if (confirm('Adakah anda pasti ingin membuang baris ini?')) {
      row.remove();
      updateNadiRowNumbers();
    }
  });

  // Add row data to nadiRows array
  nadiRows.push({
    id: id,
    rowElement: row
  });
}

function updateNadiRowData(row) {
  const rowData = {
    nama: row.querySelector('.nadi-nama').value.trim(),
    ic: row.querySelector('.nadi-ic').value.trim(),
    tel: row.querySelector('.nadi-tel').value.trim(),
    alamat: row.querySelector('.nadi-alamat').value.trim(),
    bp: row.querySelector('.nadi-bp').value.trim(),
    pr: row.querySelector('.nadi-pr').value.trim(),
    dxtType: row.querySelector('.nadi-dxt-type').value,
    dxt: row.querySelector('.nadi-dxt').value.trim(),
    tinggi: row.querySelector('.nadi-tinggi').value.trim(),
    berat: row.querySelector('.nadi-berat').value.trim(),
    bmi: row.querySelector('.nadi-bmi').value.trim(),
    layak: row.querySelector('.nadi-layak').checked,
    takLayak: row.querySelector('.nadi-taklayak').checked,
    tcaDate: row.querySelector('.nadi-tca-date').value.trim(),
    tcaTime: row.querySelector('.nadi-tca-time').value.trim(),
    staff: row.querySelector('.nadi-staff').value.trim()
  };

  // Update the row data in nadiRows array
  const rowId = row.id;
  const rowIndex = nadiRows.findIndex(r => r.id === rowId);
  if (rowIndex !== -1) {
    nadiRows[rowIndex].data = rowData;
  }
}

function editNadiCell(viewModeEl) {
  const input = viewModeEl.nextElementSibling;
  viewModeEl.style.display = 'none';
  input.style.display = 'block';
  input.value = viewModeEl.textContent || '';
  input.focus();
}

function saveNadiCell(inputEl) {
  const viewMode = inputEl.previousElementSibling;
  viewMode.textContent = inputEl.value || '';
  viewMode.style.display = 'block';
  inputEl.style.display = 'none';

  // If this is height or weight, calculate BMI
  if (inputEl.classList.contains('nadi-tinggi') || inputEl.classList.contains('nadi-berat')) {
    const row = inputEl.closest('tr');
    const tinggi = row.querySelector('.nadi-tinggi').value;
    const berat = row.querySelector('.nadi-berat').value;
    const bmi = row.querySelector('.nadi-bmi');

    if (tinggi && berat) {
      const height = parseFloat(tinggi) / 100;
      const weight = parseFloat(berat);
      const bmiValue = (weight / (height * height)).toFixed(1);
      bmi.value = bmiValue;
      bmi.previousElementSibling.textContent = bmiValue;
    } else {
      bmi.value = '';
      bmi.previousElementSibling.textContent = '';
    }
  }
}

function updateNadiRowNumbers() {
  const rows = document.querySelectorAll('#nadiContainer tr');
  let counter = 0;
  rows.forEach(row => {
    counter++;
    const counterEl = row.querySelector('.nadi-counter');
    if (counterEl) {
      counterEl.textContent = counter;
    }
  });
  nadiRowCounter = counter;
}

/* ====== WhatsApp Report (Preview + Hantar Imej) ====== */
function generateWhatsAppReport(data) {
  const reportContainer = document.getElementById('whatsappReportPreview');
  reportContainer.innerHTML = '';

  const logoSrc = LOGO_DATA_URL || LOGO_URL; // cuba data URL dahulu

  const reportHTML = `
    <div class="whatsapp-report" id="whatsappReportCard" style="background:#ffffff;">
      <div class="whatsapp-report-header">
        <img id="reportLogoImg" src="${logoSrc}" alt="Logo Klinik" class="whatsapp-report-logo" crossOrigin="anonymous"
             onerror="this.src='https://via.placeholder.com/50x50.png?text=KS'">
        <div>
          <div class="whatsapp-report-title">Laporan Saringan NADI</div>
          <div class="whatsapp-report-subtitle">Klinik SihatSokmo - Program PEKA B40</div>
        </div>
      </div>
      <div class="whatsapp-report-body">
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Nama Pesakit:</div>
          <div class="whatsapp-report-value">${data.nama || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">No. IC:</div>
          <div class="whatsapp-report-value">${data.ic || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Alamat:</div>
          <div class="whatsapp-report-value">${data.alamat || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">BP:</div>
          <div class="whatsapp-report-value">${data.bp || '-'} mmHg</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">PR:</div>
          <div class="whatsapp-report-value">${data.pr || '-'} bpm</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">DXT (${data.dxtType || 'Fasting'}):</div>
          <div class="whatsapp-report-value">${data.dxt || '-'} mmol/L</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Tinggi:</div>
          <div class="whatsapp-report-value">${data.tinggi || '-'} cm</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Berat:</div>
          <div class="whatsapp-report-value">${data.berat || '-'} kg</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">BMI:</div>
          <div class="whatsapp-report-value">${data.bmi || '-'}</div>
        </div>
        <div class="whatsapp-report-row">
          <div class="whatsapp-report-label">Status:</div>
          <div class="whatsapp-report-value">${data.layak ? 'Layak PEKA B40' : 'Tidak Layak PEKA B40'}</div>
        </div>
      </div>
      <div class="whatsapp-report-footer">
        Sila hubungi klinik untuk maklumat lanjut. Terima kasih.
      </div>
    </div>
  `;

  reportContainer.innerHTML = reportHTML;
  currentWhatsAppData = data;
  whatsappReportModal.show();
}

/* Tangkap preview → Blob PNG resolusi tinggi */
async function captureReportBlob(){
  const el = document.getElementById('whatsappReportCard');
  if (!el) throw new Error('Tiada komponen laporan untuk ditangkap');

  // Pastikan logo pakai data URL jika ada
  const img = document.getElementById('reportLogoImg');
  if (img && LOGO_DATA_URL) img.src = LOGO_DATA_URL;

  // Tunggu seketika supaya imej termuat
  await new Promise(r=>setTimeout(r, 120));

  const canvas = await html2canvas(el, {
    useCORS: true,
    backgroundColor: '#ffffff',
    scale: Math.min(2, window.devicePixelRatio || 2)
  });
  return await new Promise((resolve)=> canvas.toBlob(resolve, 'image/png', 0.95));
}

/* Cuba share imej (mobile) / muat turun + buka WhatsApp (desktop) */
async function sendWhatsAppReport(){
  if (!currentWhatsAppData) return;

  try{
    showLoader('Menjana imej laporan…');
    const blob = await captureReportBlob();
    if (!blob) throw new Error('Gagal menjana imej');

    const msisdn = currentWhatsAppData.tel || '';
    const fileName = `laporan_nadi_${(currentWhatsAppData.ic||'').replace(/\W+/g,'')||'pesakit'}.png`;
    const file = new File([blob], fileName, { type: 'image/png' });

    // 1) Cuba Web Share API dengan fail (Android/iOS)
    if (navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({
        files: [file],
        title: 'Laporan Saringan NADI',
        text: '' // kosong – fokus hantar imej
      });
      // Selepas share, cuba buka chat nombor spesifik (jika WhatsApp sokong deep link)
      if (msisdn){
        // Cuba app WhatsApp:
        const opened = window.open(waHref(msisdn), '_blank');
        // Fallback ke web:
        setTimeout(()=>{ if (!opened) window.open(waWebHref(msisdn), '_blank'); }, 600);
      }
      whatsappReportModal.hide();
      toast('Berjaya', 'Imej laporan dihantar melalui WhatsApp', 'success');
      return;
    }

    // 2) Desktop/fallback: muat turun imej + buka chat nombor
    // Muat turun automatik
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = fileName;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);

    // Buka app WhatsApp (jika ada) ke chat nombor spesifik
    if (msisdn){
      const opened = window.open(waHref(msisdn), '_blank');
      setTimeout(()=>{ if (!opened) window.open(waWebHref(msisdn), '_blank'); }, 600);
    }else{
      toast('Makluman','Nombor telefon tidak sah – hanya muat turun imej dibuat','warning');
    }

    whatsappReportModal.hide();
    toast('Berjaya', 'Imej laporan dimuat turun & WhatsApp dibuka ke chat pesakit', 'success');

  }catch(e){
    toast('Ralat', e.message || 'Gagal menghantar laporan', 'danger');
  }finally{
    hideLoader();
  }
}

/* Export NADI CSV */
function exportNadiCSV() {
  const container = document.getElementById('nadiContainer');
  const rows = Array.from(container.querySelectorAll('.nadi-row'));
  if (!rows.length){ toast('Makluman','Tiada data untuk diexport','warning'); return; }

  const header = ['Nama','IC','Telefon','Alamat','BP','PR','DXT_Tipe','DXT','Tinggi(cm)','Berat(kg)','BMI','Layak','TarikhTCA','MasaTCA','Staff'];

  const data = rows.map(row => {
    return {
      nama: row.querySelector('.nadi-nama').value.trim(),
      ic: row.querySelector('.nadi-ic').value.trim(),
      tel: row.querySelector('.nadi-tel').value.trim(),
      alamat: row.querySelector('.nadi-alamat').value.trim(),
      bp: row.querySelector('.nadi-bp').value.trim(),
      pr: row.querySelector('.nadi-pr').value.trim(),
      dxtType: row.querySelector('.nadi-dxt-type').value,
      dxt: row.querySelector('.nadi-dxt').value.trim(),
      tinggi: row.querySelector('.nadi-tinggi').value.trim(),
      berat: row.querySelector('.nadi-berat').value.trim(),
      bmi: row.querySelector('.nadi-bmi').value.trim(),
      layak: row.querySelector('.nadi-layak').checked ? 'Ya' : 'Tidak',
      tcaDate: row.querySelector('.nadi-tca-date').value.trim(),
      tcaTime: row.querySelector('.nadi-tca-time').value.trim(),
      staff: row.querySelector('.nadi-staff').value.trim()
    };
  });

  const csvRows = data.map(row => [
    row.nama, row.ic, row.tel, row.alamat, row.bp, row.pr, row.dxtType, row.dxt,
    row.tinggi, row.berat, row.bmi, row.layak, row.tcaDate, row.tcaTime, row.staff
  ]);

  const csv = [header, ...csvRows].map(r => r.map(v => `"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `program_nadi_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  toast('Export','Fail CSV telah dimuat turun','success');
}

/* =======================
   DATA LOADERS
   ======================= */
async function loadDashboardData(){
  try{
    const data = await getJSON({ action:'getDashboardData' }, { msg:'Memuat Dashboard…' });
    if (data.status==='success'){
      const d = data.data || {};
      totalDaftar.textContent = d.totalDaftar || 0;
      totalFirstVisit.textContent = d.totalFirstVisit || 0;
      totalSecondVisit.textContent = d.totalSecondVisit || 0;
      totalSelesai.textContent = d.totalSelesai || 0;
      labFollowUpDue.textContent = d.labFollowUpDue || 0;
      labFollowUpPending.textContent = d.labFollowUpPending || 0;

      // Badges navbar (tunjuk hanya jika >0)
      setBadge('badgeTCA', d.totalDaftar);
      setBadge('badgeFirst', d.totalFirstVisit);
      setBadge('badgeSecond', d.totalSecondVisit);
      setBadge('badgeLab', d.labFollowUpDue + d.labFollowUpPending);
    }
  }catch(e){ toast('Ralat','Gagal memuat data dashboard','danger'); }
}
function setBadge(id,val){
  const el = document.getElementById(id);
  if (!el) return;
  if (val>0){ el.textContent = val; el.style.display='inline-block'; }
  else { el.style.display='none'; }
}

async function loadStatistics(period){
  try{
    const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…' });
    if (data.status==='success'){
      if (stats3dChart) stats3dChart         if (data.status==='success'){
          // data.data dijangka [{label:"Jan 2025", count:12}, ...]
          if (stats3dChart) stats3dChart.destroy();
          stats3dChart = buildBarChart('stats3dChart', data.data || [], 'Pesakit Selesai mengikut bulan');
        } else {
          toast('Ralat', data.message || 'Gagal memuat statistik', 'danger');
        }
      }catch(e){
        toast('Ralat', e.message || 'Gagal memuat statistik', 'danger');
      }
    }

async function loadCompletedStatistics(period){
  try{
    const data = await getJSON({ action:'getCompletedStatistics', period }, { msg:'Memuat statistik selesai…' });
    if (data.status==='success'){
      if (completed3dChart) completed3dChart.destroy();
      completed3dChart = buildBarChart('completed3dChart', data.data || [], 'Selesai mengikut bulan');
    } else {
      toast('Ralat', data.message || 'Gagal memuat statistik selesai', 'danger');
    }
  }catch(e){
    toast('Ralat', e.message || 'Gagal memuat statistik selesai', 'danger');
  }
}

/* =======================
   DAFTAR PEKA (borang)
   ======================= */
async function daftarPesakit(){
  const nama   = (document.getElementById('namaPesakit').value||'').trim();
  const ic     = (document.getElementById('noIC').value||'').trim();
  const tel    = normalizeMsisdnMY((document.getElementById('noTelefon').value||'').trim());
  const alamat = (document.getElementById('alamatPesakit').value||'').trim();
  const tca    = document.getElementById('tarikhTCA').value;
  const masa   = document.getElementById('masaTCA').value;
  const staff  = (document.getElementById('namaStaff').value||'').trim();

  if (!nama || !ic || !tel || !tca || !masa || !staff){
    toast('Ralat','Sila lengkapkan semua medan wajib.','danger');
    return;
  }

  try{
    const res = await postForm({
      action:'daftarPesakit',
      namaPesakit:nama, noIC:ic, noTelefon:tel, alamat,
      tarikhTCA:tca, masaTCA:masa, namaStaff:staff
    }, { msg:'Mendaftar pesakit…' });

    if (res.status==='success'){
      toast('Berjaya', `Pesakit ${nama} didaftarkan.`, 'success');
      // reset borang ringkas
      ['namaPesakit','noIC','noTelefon','alamatPesakit','tarikhTCA','masaTCA','namaStaff']
        .forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
      loadDashboardData();
      loadTCACallData();
    }else{
      throw new Error(res.message||'Gagal daftar');
    }
  }catch(e){
    toast('Ralat', e.message, 'danger');
  }
}

/* =======================
   TCA CALL (dashboard + page)
   ======================= */
async function loadTCACallData(){ // untuk widget Dashboard (hari ini)
  try{
    const data = await getJSON({ action:'getTcaList', filter:'today' }, { msg:'Memuat senarai TCA…' });
    const tbody = document.getElementById('tcaCallTable');
    tbody.innerHTML = '';
    const arr = (data.status==='success' ? (data.data||[]) : []);
    if (!arr.length){
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada pesakit untuk dihubungi hari ini.</td></tr>`;
      return;
    }
    arr.forEach(item=>{
      const tr = document.createElement('tr');
      const msisdn = normalizeMsisdnMY(item.noTelefon||'');
      tr.innerHTML = `
        <td>${item.nama||'-'}</td>
        <td>${item.noIC||'-'}</td>
        <td><a href="${telHref(msisdn)}">+${msisdn||'-'}</a></td>
        <td>${item.alamat||'-'}</td>
        <td>${item.tarikhTCA||'-'}</td>
        <td><span class="badge text-bg-warning">TCA CALL</span></td>`;
      tbody.appendChild(tr);
    });
  }catch(e){
    document.getElementById('tcaCallTable').innerHTML =
      `<tr><td colspan="6" class="text-center text-danger">Gagal memuat data.</td></tr>`;
  }
}

let _tcaFilterBound = false;
async function loadTCACallPage(){
  const group = document.getElementById('tcaFilter');
  if (group && !_tcaFilterBound){
    group.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-filter]');
      if (!btn) return;
      group.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      loadTCACallList(btn.dataset.filter);
    });
    _tcaFilterBound = true;
  }
  // lalai: butang aktif
  const active = group?.querySelector('button.active')?.dataset.filter || 'today';
  loadTCACallList(active);
}

async function loadTCACallList(filter){
  try{
    const q = (document.getElementById('searchTCAPage').value||'').trim();
    const data = await getJSON({ action:'getTcaList', filter, q }, { msg:'Memuat TCA Call…' });
    const tbody = document.getElementById('tcaCallList');
    tbody.innerHTML = '';
    const arr = (data.status==='success' ? (data.data||[]) : []);
    if (!arr.length){
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada data.</td></tr>`;
      return;
    }
    arr.forEach(item=>{
      const msisdn = normalizeMsisdnMY(item.noTelefon||'');
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nama||'-'}</td>
        <td>${item.noIC||'-'}</td>
        <td><a href="${telHref(msisdn)}">+${msisdn||'-'}</a></td>
        <td>${item.alamat||'-'}</td>
        <td>${item.tarikhTCA||'-'}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary" data-act="retca" data-ic="${item.noIC||''}">Re-TCA</button>
            <button class="btn btn-sm btn-outline-success" data-act="pdpa" data-ic="${item.noIC||''}">Upload PDPA</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    // delegasi tindakan
    tbody.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const ic = btn.getAttribute('data-ic')||'';
        if (btn.dataset.act==='retca'){
          document.getElementById('retcaIC').value = ic;
          retcaModal.show();
        } else if (btn.dataset.act==='pdpa'){
          document.getElementById('pdpaIC').value = ic;
          pdpaModal.show();
        }
      });
    });

  }catch(e){
    document.getElementById('tcaCallList').innerHTML =
      `<tr><td colspan="6" class="text-center text-danger">Gagal memuat data.</td></tr>`;
  }
}

/* =======================
   FIRST / SECOND / LAB / SELESAI / ARKIB
   ======================= */
async function loadFirstVisitData(){
  try{
    const q = (document.getElementById('searchFirst').value||'').trim();
    const data = await getJSON({ action:'getFirstVisitList', q }, { msg:'Memuat First Visit…' });
    const tbody = document.getElementById('firstVisitList');
    tbody.innerHTML = '';
    const arr = (data.status==='success' ? (data.data||[]) : []);
    if (!arr.length){ tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data.</td></tr>`; return; }

    arr.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nama||'-'}</td>
        <td>${item.noIC||'-'}</td>
        <td>${item.alamat||'-'}</td>
        <td>${item.tarikhTCA||'-'}</td>
        <td>${item.pdpa ? '<span class="badge text-bg-success">Ada</span>' : '<span class="badge text-bg-secondary">Tiada</span>'}</td>
        <td><span class="badge text-bg-info">FIRST VISIT</span></td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-success" data-act="second" data-ic="${item.noIC||''}">Tetap Second Visit</button>
            <button class="btn btn-sm btn-outline-success nadi-wa-mini" data-act="wa" data-nama="${encodeURIComponent(item.nama||'')}" data-ic="${encodeURIComponent(item.noIC||'')}" data-tel="${encodeURIComponent(item.noTelefon||'')}" data-alamat="${encodeURIComponent(item.alamat||'')}">WA Report</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    // delegasi
    tbody.querySelectorAll('button[data-act="second"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.getElementById('secondTcaIC').value = btn.getAttribute('data-ic')||'';
        secondTcaModal.show();
      });
    });
    tbody.querySelectorAll('button[data-act="wa"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        const data = {
          nama: decodeURIComponent(btn.dataset.nama||''),
          ic: decodeURIComponent(btn.dataset.ic||''),
          tel: normalizeMsisdnMY(decodeURIComponent(btn.dataset.tel||'')),
          alamat: decodeURIComponent(btn.dataset.alamat||''),
          bp:'', pr:'', dxtType:'', dxt:'', tinggi:'', berat:'', bmi:'', layak:true
        };
        generateWhatsAppReport(data);
      });
    });

  }catch(e){
    document.getElementById('firstVisitList').innerHTML =
      `<tr><td colspan="7" class="text-center text-danger">Gagal memuat data.</td></tr>`;
  }
}

async function loadSecondVisitData(){
  try{
    const q = (document.getElementById('searchSecond').value||'').trim();
    const data = await getJSON({ action:'getSecondVisitList', q }, { msg:'Memuat Second Visit…' });
    const tbody = document.getElementById('secondVisitList');
    tbody.innerHTML = '';
    const arr = (data.status==='success' ? (data.data||[]) : []);
    if (!arr.length){ tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data.</td></tr>`; return; }

    arr.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nama||'-'}</td>
        <td>${item.noIC||'-'}</td>
        <td>${item.alamat||'-'}</td>
        <td>${item.tarikhTCA||'-'}</td>
        <td>${item.pdpa ? '<span class="badge text-bg-success">Ada</span>' : '<span class="badge text-bg-secondary">Tiada</span>'}</td>
        <td><span class="badge text-bg-warning">SECOND VISIT</span></td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary" data-act="retca" data-ic="${item.noIC||''}">Re-TCA</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    // delegasi
    tbody.querySelectorAll('button[data-act="retca"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.getElementById('retcaIC').value = btn.getAttribute('data-ic')||'';
        retcaModal.show();
      });
    });

  }catch(e){
    document.getElementById('secondVisitList').innerHTML =
      `<tr><td colspan="7" class="text-center text-danger">Gagal memuat data.</td></tr>`;
  }
}

async function loadLabFollowUp(){
  try{
    const q = (document.getElementById('searchLab').value||'').trim();
    const data = await getJSON({ action:'getLabFollowUp', q }, { msg:'Memuat Follow-up Lab…' });
    const tbody = document.getElementById('labFollowupTable');
    tbody.innerHTML = '';
    const arr = (data.status==='success' ? (data.data||[]) : []);
    if (!arr.length){ tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada data.</td></tr>`; return; }

    arr.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nama||'-'}</td>
        <td>${item.noIC||'-'}</td>
        <td>${item.noTelefon||'-'}</td>
        <td>${item.alamat||'-'}</td>
        <td>${item.tarikhFirstVisit||'-'}</td>
        <td>${item.hariKe||'-'}</td>
        <td>${item.status||'-'}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-primary" data-act="retca" data-ic="${item.noIC||''}">Re-TCA</button>
            <button class="btn btn-sm btn-outline-success" data-act="second" data-ic="${item.noIC||''}">Tetap Second Visit</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="retca"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.getElementById('retcaIC').value = btn.getAttribute('data-ic')||'';
        retcaModal.show();
      });
    });
    tbody.querySelectorAll('button[data-act="second"]').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.getElementById('secondTcaIC').value = btn.getAttribute('data-ic')||'';
        secondTcaModal.show();
      });
    });

  }catch(e){
    document.getElementById('labFollowupTable').innerHTML =
      `<tr><td colspan="8" class="text-center text-danger">Gagal memuat data.</td></tr>`;
  }
}

async function loadCompletedData(){
  try{
    const q = (document.getElementById('searchCompleted').value||'').trim();
    const data = await getJSON({ action:'getCompletedList', q }, { msg:'Memuat Selesai…' });
    const tbody = document.getElementById('completedTable');
    tbody.innerHTML = '';
    const arr = (data.status==='success' ? (data.data||[]) : []);
    if (!arr.length){ tbody.innerHTML = `<tr><td colspan="11" class="text-center text-muted">Tiada data.</td></tr>`; return; }

    arr.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nama||'-'}</td>
        <td>${item.noIC||'-'}</td>
        <td>${item.noTelefon||'-'}</td>
        <td>${item.alamat||'-'}</td>
        <td>${item.pdpa ? '<span class="badge text-bg-success">Ada</span>' : '<span class="badge text-bg-secondary">Tiada</span>'}</td>
        <td>${item.tarikhDaftar||'-'}</td>
        <td>${item.firstVisit||'-'}</td>
        <td>${item.labCompleted||'-'}</td>
        <td>${item.secondVisit||'-'}</td>
        <td>${item.tarikhSelesai||'-'}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-secondary" data-act="arkib" data-ic="${item.noIC||''}">Arkib</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="arkib"]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        if (!confirm('Pindahkan rekod ke Arkib?')) return;
        try{
          const ic = btn.getAttribute('data-ic')||'';
          const res = await postForm({ action:'archiveRecord', noIC:ic }, { msg:'Mengarkibkan…' });
          if (res.status==='success'){ toast('Selesai','Rekod diarkibkan.','success'); loadCompletedData(); }
          else throw new Error(res.message||'Gagal arkib');
        }catch(e){ toast('Ralat', e.message, 'danger'); }
      });
    });

  }catch(e){
    document.getElementById('completedTable').innerHTML =
      `<tr><td colspan="11" class="text-center text-danger">Gagal memuat data.</td></tr>`;
  }
}

async function loadArchivedData(){
  try{
    const q = (document.getElementById('searchArchive').value||'').trim();
    const data = await getJSON({ action:'getArchivedList', q }, { msg:'Memuat Arkib…' });
    const tbody = document.getElementById('archiveTable');
    tbody.innerHTML = '';
    const arr = (data.status==='success' ? (data.data||[]) : []);
    if (!arr.length){ tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted">Tiada data.</td></tr>`; return; }

    arr.forEach(item=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.nama||'-'}</td>
        <td>${item.noIC||'-'}</td>
        <td>${item.noTelefon||'-'}</td>
        <td>${item.alamat||'-'}</td>
        <td>${item.tarikhDaftar||'-'}</td>
        <td>${item.tarikhSelesai||'-'}</td>
        <td>${item.diarkib||'-'}</td>
        <td>
          <div class="d-flex gap-1">
            <button class="btn btn-sm btn-outline-secondary" data-act="pulih" data-ic="${item.noIC||''}">Pulihkan</button>
          </div>
        </td>`;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act="pulih"]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        try{
          const ic = btn.getAttribute('data-ic')||'';
          const res = await postForm({ action:'restoreRecord', noIC:ic }, { msg:'Memulihkan…' });
          if (res.status==='success'){ toast('Selesai','Rekod dipulihkan.','success'); loadArchivedData(); }
          else throw new Error(res.message||'Gagal pulih');
        }catch(e){ toast('Ralat', e.message, 'danger'); }
      });
    });

  }catch(e){
    document.getElementById('archiveTable').innerHTML =
      `<tr><td colspan="8" class="text-center text-danger">Gagal memuat data.</td></tr>`;
  }
}

/* =======================
   MODAL HANDLERS
   ======================= */
async function submitRetca(){
  const ic   = (document.getElementById('retcaIC').value||'').trim();
  const date = document.getElementById('retcaDate').value;
  const time = document.getElementById('retcaTime').value;
  if (!ic || !date || !time){ toast('Ralat','Sila isi tarikh & masa.','danger'); return; }
  try{
    const res = await postForm({ action:'retca', noIC:ic, tarikhTCA:date, masaTCA:time }, { msg:'Menyimpan Re-TCA…' });
    if (res.status==='success'){ toast('Berjaya','TCA Semula disimpan.','success'); retcaModal.hide(); loadTCACallPage(); loadDashboardData(); }
    else throw new Error(res.message||'Gagal simpan');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

async function submitSecondTca(){
  const ic   = (document.getElementById('secondTcaIC').value||'').trim();
  const date = document.getElementById('secondTcaDate').value;
  const time = document.getElementById('secondTcaTime').value;
  const staff= (document.getElementById('secondTcaStaff').value||'').trim();
  if (!ic || !date || !time || !staff){ toast('Ralat','Sila lengkapkan semua medan.','danger'); return; }
  try{
    const res = await postForm({ action:'setSecondVisitTca', noIC:ic, tarikhTCA:date, masaTCA:time, namaStaff:staff }, { msg:'Menyimpan Second Visit…' });
    if (res.status==='success'){ toast('Berjaya','Second Visit ditetapkan.','success'); secondTcaModal.hide(); loadSecondVisitData(); loadDashboardData(); }
    else throw new Error(res.message||'Gagal simpan');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

async function uploadPDPA(){
  const ic = (document.getElementById('pdpaIC').value||'').trim();
  const f  = document.getElementById('pdpaFile').files[0];
  if (!ic || !f){ toast('Ralat','Sila pilih fail PDPA.','danger'); return; }
  try{
    const base64 = await new Promise((resolve, reject)=>{
      const fr = new FileReader();
      fr.onload = ()=> resolve(String(fr.result).split(',')[1]||'');
      fr.onerror= ()=> reject(new Error('Gagal baca fail'));
      fr.readAsDataURL(f);
    });
    const res = await postForm({
      action:'uploadPdpa', noIC:ic,
      fileName: f.name, mimeType: f.type||'application/octet-stream', data: base64
    }, { msg:'Memuat naik PDPA…' });

    if (res.status==='success'){
      toast('Berjaya','Borang PDPA dimuat naik.','success');
      pdpaModal.hide();
      loadFirstVisitData();
      loadSecondVisitData();
    } else {
      throw new Error(res.message||'Gagal muat naik');
    }
  }catch(e){
    toast('Ralat', e.message, 'danger');
  }
}

/* =======================
   EXPORT CSV (Selesai)
   ======================= */
function exportCompletedCSV(){
  const tbody = document.getElementById('completedTable');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  if (!rows.length || rows[0].children.length<2){
    toast('Makluman','Tiada data untuk dieksport.','warning');
    return;
  }
  const header = ['Nama Pesakit','No IC','No Telefon','Alamat','PDPA','Tarikh Daftar','First Visit','Lab Report Completed','Second Visit','Tarikh Selesai'];
  const csvRows = [header];

  rows.forEach(tr=>{
    const tds = tr.querySelectorAll('td');
    if (tds.length<11) return; // skip baris info
    csvRows.push([
      tds[0].innerText, tds[1].innerText, tds[2].innerText, tds[3].innerText,
      tds[4].innerText.replace(/\s+/g,' ').trim(),
      tds[5].innerText, tds[6].innerText, tds[7].innerText, tds[8].innerText, tds[9].innerText
    ]);
  });

  const csv = csvRows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `pesakit_selesai_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  toast('Export','CSV selesai dimuat turun.','success');
}

/* =======================
   BOOT
   ======================= */
window.addEventListener('load', initGoogleSignIn);
  </script>
</body>
</html>

