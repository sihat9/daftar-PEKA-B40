<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Sistem TRacKer PEKA B40 - Klinik SihatSokmo</title>

  <!-- (Opsyen) Cloudflare Worker proxy untuk GAS -->
  <meta name="gas-endpoint" content="">

  <!-- Bootstrap & Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Chart.js (untuk graf ringkas) -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Google Identity Services (Sign-In) -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>

  <!-- (Opsyen) html2canvas untuk pratonton WhatsApp (biarkan) -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

  <!-- SheetJS (Excel) – auto-loader ringan -->
  <script>
    (function () {
      if (window.XLSX) return;
      window.loadScriptOnce = window.loadScriptOnce || (function () {
        const loaded = new Set();
        return function (url) {
          return new Promise((resolve, reject) => {
            if (loaded.has(url)) return resolve();
            const s = document.createElement('script');
            s.src = url; s.async = true;
            s.onload = () => { loaded.add(url); resolve(); };
            s.onerror = () => reject(new Error('Gagal muat: ' + url));
            document.head.appendChild(s);
          });
        };
      })();
      window.ensureXLSXReady = async function () {
        if (window.XLSX) return;
        const cdns = [
          'https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://unpkg.com/xlsx@0.19.3/dist/xlsx.full.min.js',
          'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.19.3/xlsx.full.min.js'
        ];
        for (const url of cdns) {
          try { await window.loadScriptOnce(url); if (window.XLSX) return; } catch(e){}
        }
        throw new Error('XLSX gagal dimuat.');
      };
    })();
  </script>

  <style>
    :root{ --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12; --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6; }
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f7f9fc;color:#222}
    .navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
    .nav-link{color:#333;font-weight:500;margin:0 4px;padding:7px 10px!important;border-radius:8px}
    .page-header{background:linear-gradient(135deg,#4e73df,#1cc88a);color:#fff;padding:14px 0;margin-bottom:12px;border-radius:0 0 12px 12px}
    .card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:16px}
    .card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600}
    .stat-card{padding:14px;border-radius:12px;color:#fff;text-align:center}
    .stat-card .number{font-size:1.45rem;font-weight:800}
    .table td,.table th{vertical-align:middle}
    .searchbar{max-width:340px}
    .nadi-scroll-container { overflow-x:auto; width:100%; padding-bottom:8px; }
    .nadi-table { width:100%; min-width:1300px; border-collapse:separate; border-spacing:0; }
    .nadi-table th { background:#f8f9fa; padding:10px 8px; font-weight:600; text-align:center; position:sticky; top:0; z-index:1; border:1px solid #dee2e6; }
    .nadi-table td { padding:8px; border:1px solid #dee2e6; }
    .sejarah-table-wrap thead th{ position:sticky; top:0; background:#f8f9fa; z-index:1; }
    .d-none{display:none !important}
    /* Toast */
    #toastHost{ position:fixed; inset:0 0 auto auto; padding:12px; z-index:4000; pointer-events:none; }
    #toastHost .toast{ pointer-events:auto; margin-bottom:8px; }
  </style>
</head>
<body>
  <!-- Loader -->
  <div id="appLoader" style="display:none; position:fixed; inset:0; background:rgba(255,255,255,.6); z-index:3000;">
    <div style="position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border:1px solid #eee;border-radius:12px;padding:16px 18px;box-shadow:0 20px 40px rgba(0,0,0,.12);min-width:220px;text-align:center">
      <div class="spinner-border text-primary" role="status"></div>
      <div class="fw-bold mt-2">Sila tunggu…</div>
      <div class="text-muted small" id="loaderMsg">Memproses permintaan anda</div>
    </div>
  </div>

  <!-- Toast Host -->
  <div id="toastHost"><div class="toast-container"></div></div>

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-main sticky-top">
    <div class="container">
      <a class="navbar-brand" href="#dashboard"><i class="fas fa-heartbeat me-2 text-primary"></i>Klinik SihatSokmo</a>
      <div id="signinArea" class="d-lg-none"></div>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain"><span class="navbar-toggler-icon"></span></button>
      <div class="collapse navbar-collapse" id="navbarMain">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <li class="nav-item"><a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="#nadi"><i class="bi bi-clipboard2-pulse"></i> Program PEKA B40 bersama NADI</a></li>
          <li class="nav-item"><a class="nav-link" href="#sejarah"><i class="bi bi-clock-history"></i> Lihat Sejarah Saringan</a></li>
          <li class="nav-item"><a class="nav-link" href="#daftar-peka"><i class="fas fa-user-plus"></i> Daftar Peka</a></li>
          <li class="nav-item"><a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a></li>
          <li class="nav-item"><a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a></li>
          <li class="nav-item"><a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a></li>
          <li class="nav-item"><a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab</a></li>
          <li class="nav-item"><a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a></li>
          <li class="nav-item"><a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a></li>
          <li class="nav-item"><a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a></li>
        </ul>
        <div id="signinAreaDesktop" class="d-none d-lg-block"></div>
        <span id="staffBadge" class="badge bg-secondary d-none ms-2"><i class="bi bi-person-check me-1"></i><span id="staffEmail"></span></span>
      </div>
    </div>
  </nav>

  <!-- Header -->
  <header class="page-header">
    <div class="container d-flex justify-content-between align-items-center">
      <div>
        <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
        <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
      </div>
      <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
    </div>
  </header>

  <main class="container">

    <!-- Dashboard -->
    <section id="dashboard">
      <div class="row g-3 mb-3">
        <div class="col-6 col-md-2"><div class="stat-card" style="background:linear-gradient(135deg,var(--secondary),#2980b9)"><div class="number" id="totalDaftar">0</div><div class="small">Aktif</div></div></div>
        <div class="col-6 col-md-2"><div class="stat-card" style="background:linear-gradient(135deg,var(--warning),#e67e22)"><div class="number" id="totalFirstVisit">0</div><div class="small">First Visit</div></div></div>
        <div class="col-6 col-md-2"><div class="stat-card" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)"><div class="number" id="totalSecondVisit">0</div><div class="small">Second Visit</div></div></div>
        <div class="col-6 col-md-2"><div class="stat-card" style="background:linear-gradient(135deg,var(--success),#16a085)"><div class="number" id="totalSelesai">0</div><div class="small">Selesai</div></div></div>
        <div class="col-6 col-md-2"><div class="stat-card" style="background:linear-gradient(135deg,#8e44ad,#6c5ce7)"><div class="number" id="labFollowUpDue">0</div><div class="small">Result > 3 Hari</div></div></div>
        <div class="col-6 col-md-2"><div class="stat-card" style="background:linear-gradient(135deg,#d35400,#c0392b)"><div class="number" id="labFollowUpPending">0</div><div class="small">Perlu Follow-up</div></div></div>
      </div>

      <div class="card mb-3">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi</span>
          <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefon…"/>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead class="table-light"><tr><th>Nama</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
              <tbody id="tcaCallTable"><tr><td colspan="6" class="text-center text-muted">Memuat data…</td></tr></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <!-- Program NADI -->
    <section id="nadi" class="d-none">
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h2 class="h6 m-0"><i class="bi bi-clipboard2-pulse me-2"></i>Program PEKA B40 bersama NADI</h2>
        <button id="btnNadiSaveActivity" class="btn btn-sm btn-primary"><i class="bi bi-cloud-upload me-1"></i>Simpan Aktiviti (Semua)</button>
      </div>

      <div class="card">
        <div class="card-body">
          <div class="row g-2 mb-2">
            <div class="col-md-7">
              <label class="form-label mb-1">Tajuk Program</label>
              <input id="nadiProgramTitle" class="form-control form-control-sm" placeholder="cth: Saringan Komuniti Tmn Mawar">
            </div>
            <div class="col-md-3">
              <label class="form-label mb-1">Tarikh Program</label>
              <input id="nadiProgramDate" type="date" class="form-control form-control-sm">
            </div>
            <div class="col-md-2 d-grid">
              <label class="form-label mb-1">&nbsp;</label>
              <button class="btn btn-sm btn-outline-secondary" id="btnNadiAddRow"><i class="bi bi-plus-circle me-1"></i>Tambah Pesakit</button>
            </div>
          </div>

          <div class="nadi-scroll-container">
            <table class="nadi-table">
              <thead>
                <tr>
                  <th style="width:40px">#</th>
                  <th>Nama Pesakit</th>
                  <th>No IC</th>
                  <th>Umur</th>
                  <th>Telefon</th>
                  <th>Alamat</th>
                  <th>BP</th>
                  <th>PR</th>
                  <th>DXT</th>
                  <th>Tinggi</th>
                  <th>Berat</th>
                  <th>BMI</th>
                  <th>Layak</th>
                  <th>Tidak Layak</th>
                  <th>TCA voucher</th>
                  <th>Tarikh TCA (Voucher)</th>
                  <th>Remark</th>
                  <th>TCA & Staff (Jika Layak)</th>
                  <th>Tindakan</th>
                </tr>
              </thead>
              <tbody id="nadiContainer">
                <tr><td colspan="19" class="text-center text-muted">Tiada baris. Klik “Tambah Pesakit”.</td></tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </section>

    <!-- Daftar Peka -->
    <section id="daftar-peka" class="d-none">
      <h2 class="h6 mb-3"><i class="fas fa-user-plus me-2"></i>Daftar Peka</h2>
      <div class="card"><div class="card-body">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Nama Penuh Pesakit</label><input id="namaPesakit" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nombor IC</label><input id="noIC" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nombor Telefon</label><input id="noTelefon" class="form-control" type="tel" required></div>
          <div class="col-md-6"><label class="form-label">Alamat Pesakit</label><textarea id="alamatPesakit" class="form-control" rows="2"></textarea></div>
          <div class="col-md-6"><label class="form-label">Tarikh TCA</label><input id="tarikhTCA" type="date" class="form-control" required></div>
          <div class="col-md-3"><label class="form-label">Masa TCA</label><input id="masaTCA" type="time" class="form-control" required></div>
          <div class="col-md-3"><label class="form-label">Nama Staff</label><input id="namaStaff" class="form-control" required></div>
        </div>
        <div class="text-end mt-3"><button class="btn btn-primary" id="btnDaftarPesakit"><i class="fas fa-save me-1"></i>Daftar Pesakit</button></div>
      </div></div>
    </section>

    <!-- Kelayakan (Excel) -->
    <section id="kelayakan" class="d-none">
      <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel/CSV)</h2>
      <div class="card"><div class="card-body">
        <div class="row g-2 align-items-center mb-3">
          <div class="col-md-6"><input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls,.csv"/></div>
        </div>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr>
                <th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th>
                <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
                <th style="width:360px">Jika Layak → TCA & Masa & Staff</th><th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="kelayakanTable"><tr><td colspan="8" class="text-center text-muted">Muat naik Excel/CSV untuk mula.</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- TCA Call -->
    <section id="tca-call" class="d-none">
      <h2 class="h6 mb-3"><i class="fas fa-phone me-2"></i>Senarai Rekod TCA Call</h2>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
            <tbody id="tcaCallList"><tr><td colspan="6" class="text-center text-muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- First Visit -->
    <section id="first-visit" class="d-none">
      <h2 class="h6 mb-3"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th></tr></thead>
            <tbody id="firstVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Lab Follow-up -->
    <section id="lab-followup" class="d-none">
      <h2 class="h6 mb-3"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th></tr></thead>
            <tbody id="labFollowupTable"><tr><td colspan="7" class="text-center text-muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Second Visit -->
    <section id="second-visit" class="d-none">
      <h2 class="h6 mb-3"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama</th><th>No IC</th><th>Alamat</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th></tr></thead>
            <tbody id="secondVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Selesai -->
    <section id="selesai" class="d-none">
      <h2 class="h6 mb-3"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>Nama</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>PDPA</th><th>Tarikh Daftar</th><th>First Visit</th><th>Lab Completed</th><th>Second Visit</th><th>Tarikh Selesai</th></tr>
            </thead>
            <tbody id="completedTable"><tr><td colspan="10" class="text-center text-muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Arkib -->
    <section id="arkib" class="d-none">
      <h2 class="h6 mb-3"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
      <div class="card"><div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama</th><th>No IC</th><th>No Telefon</th><th>Alamat</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th></tr></thead>
            <tbody id="archiveTable"><tr><td colspan="7" class="text-center text-muted">Memuat…</td></tr></tbody>
          </table>
        </div>
      </div></div>
    </section>

    <!-- Sejarah Saringan -->
    <section id="sejarah" class="d-none">
      <div class="d-flex align-items-center justify-content-between flex-wrap gap-2 mb-3">
        <h2 class="h6 m-0"><i class="bi bi-clock-history me-2"></i> Lihat Sejarah Saringan</h2>
        <div class="input-group input-group-sm" style="min-width:260px">
          <span class="input-group-text"><i class="bi bi-search"></i></span>
          <input id="sejarahSearch" class="form-control" placeholder="Cari peserta (nama/IC/telefon/alamat/status)">
        </div>
      </div>
      <div class="row g-3">
        <div class="col-lg-4">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <span class="fw-semibold">Senarai Program</span>
              <select id="programSort" class="form-select form-select-sm" style="width:auto">
                <option value="date_desc">Tarikh ↓</option>
                <option value="date_asc">Tarikh ↑</option>
                <option value="title_asc">Tajuk A→Z</option>
                <option value="title_desc">Tajuk Z→A</option>
              </select>
            </div>
            <div class="card-body p-0">
              <div class="p-2"><input id="programFilter" class="form-control form-control-sm" placeholder="Tapis tajuk/tarikh"></div>
              <div id="programList" class="list-group small">
                <div class="p-3 text-center text-muted">Memuat program…</div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-lg-8">
          <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
              <div><span id="sejarahTitle" class="fw-semibold">Maklumat Program</span> <span class="badge text-bg-light" id="programDateLabel"></span></div>
              <div class="small"><span class="badge rounded-pill text-bg-secondary" id="sumTotal">0</span> <span class="badge rounded-pill text-bg-success" id="sumLayak">0</span> <span class="badge rounded-pill text-bg-danger" id="sumTakLayak">0</span></div>
            </div>
            <div class="card-body">
              <div class="table-responsive sejarah-table-wrap">
                <table class="table table-hover align-middle">
                  <thead class="table-light">
                    <tr>
                      <th style="width:56px">#</th><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th><th>Status</th>
                      <th>BP</th><th>PR</th><th>DXT</th><th>BMI</th><th>TCA</th><th>Staff</th><th>Remark</th>
                    </tr>
                  </thead>
                  <tbody id="sejarahTable"><tr><td colspan="13" class="text-center text-muted">Pilih program di sebelah kiri.</td></tr></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

  </main>

  <footer class="footer mt-4 py-3 bg-light">
    <div class="container d-flex justify-content-between">
      <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
      <div>Versi 3.2</div>
    </div>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /* =======================
       KONFIG — EDIT 2 NILAI INI
       ======================= */
    const SCRIPT_URL = 'PASTE_YOUR_EXEC_URL_HERE'; // contohnya: https://script.google.com/macros/s/AKfycb.../exec
    const GOOGLE_CLIENT_ID = '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com';

    /* =======================
       UTIL & STATE
       ======================= */
    const $ = (s, r=document) => r.querySelector(s);
    const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));
    const esc = v => String(v ?? '').replace(/[&<>"']/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
    const show = (id) => $(`#${id}`)?.classList.remove('d-none');
    const hide = (id) => $(`#${id}`)?.classList.add('d-none');
    const loader = { show(msg){ $('#loaderMsg').textContent = msg||'Memproses…'; $('#appLoader').style.display='block'; }, hide(){ $('#appLoader').style.display='none'; } };
    function toast(title, body, variant='primary'){
      const host = $('#toastHost .toast-container');
      const el = document.createElement('div');
      el.className = `toast align-items-center text-bg-${variant}`; el.role = 'status'; el.ariaLive='polite';
      el.innerHTML = `<div class="d-flex"><div class="toast-body"><strong>${esc(title)}:</strong> ${esc(body||'')}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
      host.appendChild(el);
      const t = new bootstrap.Toast(el, { delay: 3500 }); t.show();
      el.addEventListener('hidden.bs.toast', ()=> el.remove());
    }
    function todayStr(){ const d=new Date(),mm=('0'+(d.getMonth()+1)).slice(-2),dd=('0'+d.getDate()).slice(-2); return `${d.getFullYear()}-${mm}-${dd}`; }
    function metaEndpoint(){ return (document.querySelector('meta[name="gas-endpoint"]')?.content||'').trim(); }
    function baseUrl(){ return metaEndpoint() || SCRIPT_URL; }
    function getIdToken(){ try{ return (localStorage.getItem('id_token')||'').trim(); }catch(e){ return ''; } }
    function setIdToken(tok){ try{ localStorage.setItem('id_token', tok||''); }catch(e){} }

    /* =======================
       RUMUS: API WRAPPER
       ======================= */
    const RUMUS = {
      async get(action, params={}) {
        const p = new URLSearchParams(Object.assign({}, params, { action, id_token: getIdToken() }));
        const r = await fetch(baseUrl() + '?' + p.toString(), { method:'GET', credentials:'omit' });
        const j = await r.json(); if (!j || j.status!=='success') throw new Error((j && (j.message||j.code))||'Ralat');
        return j;
      },
      async post(action, params={}) {
        const p = new URLSearchParams(Object.assign({}, params, { action, id_token: getIdToken() }));
        const r = await fetch(baseUrl(), { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:String(p) });
        const j = await r.json(); if (!j || j.status!=='success') throw new Error((j && (j.message||j.code))||'Ralat');
        return j;
      }
    };

    /* =======================
       AUTH (Google Identity)
       ======================= */
    let WHOAMI = null;
    function renderGsiButtons(){
      const targetIds = ['signinArea','signinAreaDesktop'];
      targetIds.forEach(id=>{
        const el = document.getElementById(id); if (!el) return;
        el.innerHTML = '';
        google.accounts.id.initialize({
          client_id: GOOGLE_CLIENT_ID,
          callback: credentialResponse => {
            const tok = credentialResponse.credential || '';
            if (tok){ setIdToken(tok); onSignedIn(); }
          }
        });
        google.accounts.id.renderButton(el, { theme:"outline", size:"medium" });
      });
    }
    async function onSignedIn(){
      try{
        const w = await RUMUS.get('whoami');
        WHOAMI = w;
        $('#staffBadge').classList.remove('d-none');
        $('#staffEmail').textContent = WHOAMI.email || '';
        // Auto muat dashboard
        await loadDashboard();
        // Jika hash sedang buka sesuatu, muatkan
        handleHash();
      }catch(e){
        toast('Akses ditolak', 'Sila pastikan akaun anda dalam allowlist.', 'danger');
        setIdToken('');
      }
    }

    /* =======================
       NAVIGASI (hash)
       ======================= */
    function setActiveLink(hash){
      $$('.nav-link').forEach(a => a.classList.toggle('active', a.getAttribute('href')===hash));
    }
    async function handleHash(){
      const hash = location.hash || '#dashboard';
      ['dashboard','nadi','sejarah','daftar-peka','kelayakan','tca-call','first-visit','lab-followup','second-visit','selesai','arkib']
        .forEach(id => (hash === '#'+id) ? show(id) : hide(id));
      setActiveLink(hash);

      if (!getIdToken()) return; // belum login

      if (hash==='#dashboard'){ await loadDashboard(); }
      if (hash==='#nadi'){ initNadiOnce(); }
      if (hash==='#sejarah'){ await sejarahLoadPrograms(); }
      if (hash==='#tca-call'){ await loadTcaCall(); }
      if (hash==='#first-visit'){ await loadFirstVisit(); }
      if (hash==='#lab-followup'){ await loadLabFollowup(); }
      if (hash==='#second-visit'){ await loadSecondVisit(); }
      if (hash==='#selesai'){ await loadCompleted(); }
      if (hash==='#arkib'){ await loadArchived(); }
    }
    window.addEventListener('hashchange', handleHash);

    /* =======================
       DASHBOARD
       ======================= */
    async function loadDashboard(){
      try{
        const dash = await RUMUS.get('getDashboardData');
        $('#totalDaftar').textContent = dash.data.totalDaftar;
        $('#totalFirstVisit').textContent = dash.data.totalFirstVisit;
        $('#totalSecondVisit').textContent = dash.data.totalSecondVisit;
        $('#totalSelesai').textContent = dash.data.totalSelesai;
        $('#labFollowUpDue').textContent = dash.data.labFollowUpDue;
        $('#labFollowUpPending').textContent = dash.data.labFollowUpPending;

        const tca = await RUMUS.get('getTCACall');
        const rows = tca.data||[];
        const body = $('#tcaCallTable');
        if (!rows.length){ body.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Tiada data.</td></tr>'; return; }
        body.innerHTML = rows.map(r=>`
          <tr><td>${esc(r.nama)}</td><td>${esc(r.noIC)}</td><td>${esc(r.noTelefon)}</td><td>${esc(r.alamat)}</td><td>${esc(r.tarikhTCAView||r.tarikhTCA||'')}</td><td>${esc(r.status||'')}</td></tr>
        `).join('');
      }catch(e){
        console.error(e); toast('Ralat', 'Gagal memuat dashboard', 'danger');
      }
    }

    /* =======================
       NADI: jadual input + Simpan
       ======================= */
    function makeNadiRow(i=0){
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td class="text-center">${i+1}</td>
        <td><input class="form-control form-control-sm in-nama"></td>
        <td><input class="form-control form-control-sm in-ic"></td>
        <td><input class="form-control form-control-sm in-umur" type="number" min="0"></td>
        <td><input class="form-control form-control-sm in-tel"></td>
        <td><input class="form-control form-control-sm in-alamat"></td>
        <td><input class="form-control form-control-sm in-bp" placeholder="cth 120/80"></td>
        <td><input class="form-control form-control-sm in-pr"></td>
        <td><input class="form-control form-control-sm in-dxt" placeholder="cth 6.1 (FASTING/RANDOM)"></td>
        <td><input class="form-control form-control-sm in-tinggi" type="number" step="0.1"></td>
        <td><input class="form-control form-control-sm in-berat" type="number" step="0.1"></td>
        <td><input class="form-control form-control-sm in-bmi" type="number" step="0.1"></td>
        <td class="text-center"><input type="checkbox" class="form-check-input in-layak"></td>
        <td class="text-center"><input type="checkbox" class="form-check-input in-taklayak"></td>
        <td class="text-center"><input type="checkbox" class="form-check-input in-voucher"></td>
        <td><input class="form-control form-control-sm in-tca-voucher" type="date"></td>
        <td><input class="form-control form-control-sm in-remark"></td>
        <td>
          <div class="row g-1">
            <div class="col-5"><input class="form-control form-control-sm in-tca-date" type="date" placeholder="Tarikh (Layak)"></div>
            <div class="col-3"><input class="form-control form-control-sm in-tca-time" type="time" placeholder="Masa"></div>
            <div class="col-4"><input class="form-control form-control-sm in-tca-staff" placeholder="Staff"></div>
          </div>
        </td>
        <td><button class="btn btn-sm btn-outline-danger btn-del">Buang</button></td>
      `;
      tr.querySelector('.btn-del').addEventListener('click', ()=> tr.remove());
      return tr;
    }
    function renumberNadi(){
      $$('#nadiContainer tr').forEach((tr,idx)=> tr.querySelector('td:first-child').textContent = idx+1);
    }
    function initNadiOnce(){
      if (initNadiOnce.done) return; initNadiOnce.done = true;
      $('#btnNadiAddRow').addEventListener('click', ()=>{
        const cont = $('#nadiContainer');
        if (cont.children.length && cont.children[0].querySelector('.text-center.text-muted')) cont.innerHTML='';
        cont.appendChild(makeNadiRow(cont.children.length));
        renumberNadi();
      });
      $('#btnNadiSaveActivity').addEventListener('click', saveNadiAll);
    }
    function truthy(x){ return x===true || String(x).toLowerCase()==='true' || x===1 || String(x)==='1' || String(x).toLowerCase()==='ya' || String(x).toLowerCase()==='yes'; }
    async function saveNadiAll(){
      const title = $('#nadiProgramTitle')?.value?.trim();
      const date  = $('#nadiProgramDate')?.value?.trim();
      const rows  = $$('#nadiContainer tr');
      if (!title){ toast('Peringatan','Isi Tajuk Program','warning'); return; }
      if (!date){ toast('Peringatan','Isi Tarikh Program','warning'); return; }
      if (!rows.length || rows[0].querySelector('.text-muted')){ toast('Peringatan','Tiada baris untuk disimpan','warning'); return; }

      const items = rows.map(tr=>{
        const get = (sel) => tr.querySelector(sel)?.value?.trim() || '';
        const getC= (sel) => tr.querySelector(sel)?.checked || false;
        const layak   = getC('.in-layak');
        const tak     = getC('.in-taklayak');
        const voucher = getC('.in-voucher');
        const obj = {
          nama:get('.in-nama'), noIC:get('.in-ic'), umur:get('.in-umur'),
          noTelefon:get('.in-tel'), alamat:get('.in-alamat'),
          bp:get('.in-bp'), pr:get('.in-pr'), dxt:get('.in-dxt'),
          tinggi:get('.in-tinggi'), berat:get('.in-berat'), bmi:get('.in-bmi'),
          layak, takLayak:tak, tcaVoucher:voucher,
          remark:get('.in-remark'),
          // TCA untuk LAYAK PEKA
          tcaDate:get('.in-tca-date'), tcaTime:get('.in-tca-time'), tcaStaff:get('.in-tca-staff'),
          // TCA Voucher (tarikh sahaja – backend akan salin ke TCADate juga)
          'Tarikh TCA (Voucher)': get('.in-tca-voucher')
        };
        return obj;
      });

      try{
        loader.show('Menyimpan aktiviti…');
        const res = await RUMUS.post('saveNadiActivity', { title, date, items: JSON.stringify(items) });
        loader.hide();
        toast('Berjaya', `Disimpan. ID: ${res.activityId} — Layak:${res.layakCount}, Tidak:${res.takLayakCount}`, 'success');
      }catch(e){
        loader.hide(); console.error(e);
        toast('Ralat Simpan', e.message||e, 'danger');
      }
    }

    /* =======================
       SEJARAH: senarai + butiran
       ======================= */
    async function sejarahLoadPrograms(){
      const list = $('#programList');
      if (!list) return;
      list.innerHTML = '<div class="p-3 text-center text-muted">Memuat program…</div>';
      try{
        const j = await RUMUS.get('getNadiActivities');
        const data = Array.isArray(j.data)? j.data : [];
        if (!data.length){ list.innerHTML = '<div class="p-3 text-center text-muted">Tiada rekod.</div>'; $('#sejarahTable').innerHTML='<tr><td colspan="13" class="text-center text-muted">Pilih program di sebelah kiri.</td></tr>'; return; }

        // Susun ikut dropdown
        const sort = $('#programSort')?.value || 'date_desc';
        const arr = data.slice();
        const toDate = s => { const m=/^(\d{2})\/(\d{2})\/(\d{4})$/.exec(String(s||'')); if(!m) return 0; return new Date(+m[3],+m[2]-1,+m[1]).getTime(); };
        if (sort==='date_desc') arr.sort((a,b)=> toDate(b.programDate)-toDate(a.programDate));
        if (sort==='date_asc')  arr.sort((a,b)=> toDate(a.programDate)-toDate(b.programDate));
        if (sort==='title_asc') arr.sort((a,b)=> (a.title||'').localeCompare(b.title||''));
        if (sort==='title_desc')arr.sort((a,b)=> (b.title||'').localeCompare(a.title||''));

        list.innerHTML = arr.map(r=>{
          const id = esc(r.activityId||''); const ttl=esc(r.title||'-'); const dt=esc(r.programDate||''); const tot=esc(r.total||'0');
          const meta = (ttl + ' ' + dt).toLowerCase();
          return `<button type="button" class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" data-activity-id="${id}" data-meta="${esc(meta)}">
            <span class="fw-semibold">${ttl}</span> <span class="small ms-2">${dt}</span>
            <span class="badge bg-primary rounded-pill">${tot}</span>
          </button>`;
        }).join('');

        // Klik item
        list.addEventListener('click', e=>{
          const btn = e.target.closest('[data-activity-id]'); if (!btn) return;
          $$('#programList .list-group-item').forEach(b=>b.classList.remove('active'));
          btn.classList.add('active');
          sejarahLoadDetail(btn.getAttribute('data-activity-id'), btn.innerText);
        }, { once:true });

        // Auto pilih pertama
        const first = list.querySelector('[data-activity-id]');
        if (first){ first.classList.add('active'); sejarahLoadDetail(first.getAttribute('data-activity-id'), first.innerText); }

        // Tapis
        $('#programFilter')?.addEventListener('input', e=>{
          const q = (e.target.value||'').toLowerCase();
          $$('#programList .list-group-item').forEach(b=>{
            const meta = (b.getAttribute('data-meta')||'').toLowerCase();
            b.style.display = !q || meta.includes(q) ? '' : 'none';
          });
        });

      }catch(e){
        list.innerHTML = `<div class="p-3 text-danger">Gagal memuat program: ${esc(e.message||e)}</div>`;
      }
    }
    async function sejarahLoadDetail(activityId, label){
      const tbody = $('#sejarahTable');
      tbody.innerHTML = `<tr><td colspan="13" class="text-center text-muted">Memuat perincian…</td></tr>`;
      try{
        const j = await RUMUS.get('getNadiActivityDetail', { id: activityId });
        const rows = Array.isArray(j.data)? j.data : [];
        if (!rows.length){ tbody.innerHTML = '<tr><td colspan="13" class="text-center text-muted">Tiada data.</td></tr>'; return; }

        // Kiraan ringkas
        let layak=0, tak=0;
        rows.forEach(r => {
          const s = String(r.status||'').toUpperCase();
          if (s==='LAYAK') layak++; else if (/TAK|TIDAK/.test(s)) tak++;
        });
        $('#sumTotal').textContent = rows.length; $('#sumLayak').textContent = layak; $('#sumTakLayak').textContent = tak;
        $('#sejarahTitle').textContent = 'Maklumat Program ('+activityId+')';
        $('#programDateLabel').textContent = '';

        // Papar jadual
        tbody.innerHTML = rows.map((r,i)=>{
          const tca = [r.tcaDate||'', r.tcaTime||''].filter(Boolean).join(' ');
          // Fallback: jika TCADate kosong tetapi ada Tarikh TCA (Voucher)
          const tcaDisplay = tca || r['Tarikh TCA (Voucher)'] || '';
          return `<tr>
            <td>${i+1}</td>
            <td>${esc(r.nama||r['Nama']||'')}</td>
            <td>${esc(r.noIC||r['NoIC']||r['No IC']||'')}</td>
            <td>${esc(r.noTelefon||r['NoTelefon']||r['Telefon']||'')}</td>
            <td>${esc(r.alamat||r['Alamat']||'')}</td>
            <td>${esc(r.status||'')}</td>
            <td>${esc(r.bp||r['BP']||'')}</td>
            <td>${esc(r.pr||r['PR']||'')}</td>
            <td>${esc(r.dxt||r['DXT']||'')}</td>
            <td>${esc(r.bmi||r['BMI']||'')}</td>
            <td>${esc(tcaDisplay)}</td>
            <td>${esc(r.tcaStaff||r['TCAStaff']||'')}</td>
            <td>${esc(r.remark||r['Remark']||'')}</td>
          </tr>`;
        }).join('');

        // Carian dalam jadual
        const search = $('#sejarahSearch');
        if (search && !search.__wired){
          search.__wired = true;
          search.addEventListener('input', ()=>{
            const q = (search.value||'').toLowerCase();
            $$('#sejarahTable tr').forEach(tr=>{
              const txt = tr.innerText.toLowerCase();
              tr.style.display = txt.includes(q)? '' : 'none';
            });
          });
        }
      }catch(e){
        tbody.innerHTML = `<tr><td colspan="13" class="text-center text-danger">Gagal: ${esc(e.message||e)}</td></tr>`;
      }
    }

    /* =======================
       LAMAN LAIN (ringkas)
       ======================= */
    async function loadTcaCall(){
      try{
        const j = await RUMUS.get('getTCACall', { all:'1' });
        const body = $('#tcaCallList'); const rows = j.data||[];
        if (!rows.length){ body.innerHTML='<tr><td colspan="6" class="text-center text-muted">Tiada data.</td></tr>'; return; }
        body.innerHTML = rows.map(r=> `<tr>
          <td>${esc(r.nama)}</td><td>${esc(r.noIC)}</td><td>${esc(r.noTelefon)}</td><td>${esc(r.alamat)}</td><td>${esc(r.tarikhTCAView||'')}</td><td>${esc(r.status||'')}</td>
        </tr>`).join('');
      }catch(e){ $('#tcaCallList').innerHTML='<tr><td colspan="6" class="text-danger">Ralat memuat.</td></tr>'; }
    }
    async function loadFirstVisit(){
      try{
        const j = await RUMUS.get('getFirstVisit'); const body = $('#firstVisitList'); const rows=j.data||[];
        if (!rows.length){ body.innerHTML='<tr><td colspan="6" class="text-center text-muted">Tiada data.</td></tr>'; return; }
        body.innerHTML = rows.map(r=> `<tr>
          <td>${esc(r.nama)}</td><td>${esc(r.noIC)}</td><td>${esc(r.alamat)}</td><td>${esc(r.tarikhTCAView||'')}</td><td>${esc(r.pdpaFileId? 'Ada':'-')}</td><td>${esc(r.status||'')}</td>
        </tr>`).join('');
      }catch(e){ $('#firstVisitList').innerHTML='<tr><td colspan="6" class="text-danger">Ralat memuat.</td></tr>'; }
    }
    async function loadLabFollowup(){
      try{
        const j = await RUMUS.get('getLabFollowUp'); const body = $('#labFollowupTable'); const rows=j.data||[];
        if (!rows.length){ body.innerHTML='<tr><td colspan="7" class="text-center text-muted">Tiada data.</td></tr>'; return; }
        body.innerHTML = rows.map(r=> `<tr>
          <td>${esc(r.nama)}</td><td>${esc(r.noIC)}</td><td>${esc(r.noTelefon)}</td><td>${esc(r.alamat)}</td><td>${esc(r.firstVisitDate||'')}</td><td>${esc(r.daysSince||'')}</td><td>${esc(r.labStatus||'')}</td>
        </tr>`).join('');
      }catch(e){ $('#labFollowupTable').innerHTML='<tr><td colspan="7" class="text-danger">Ralat memuat.</td></tr>'; }
    }
    async function loadSecondVisit(){
      try{
        const j = await RUMUS.get('getSecondVisit'); const body = $('#secondVisitList'); const rows=j.data||[];
        if (!rows.length){ body.innerHTML='<tr><td colspan="6" class="text-center text-muted">Tiada data.</td></tr>'; return; }
        body.innerHTML = rows.map(r=> `<tr>
          <td>${esc(r.nama)}</td><td>${esc(r.noIC)}</td><td>${esc(r.alamat)}</td><td>${esc(r.tarikhTCAView||'')}</td><td>${esc(r.pdpaFileId? 'Ada':'-')}</td><td>${esc(r.status||'')}</td>
        </tr>`).join('');
      }catch(e){ $('#secondVisitList').innerHTML='<tr><td colspan="6" class="text-danger">Ralat memuat.</td></tr>'; }
    }
    async function loadCompleted(){
      try{
        const j = await RUMUS.get('getCompleted'); const body = $('#completedTable'); const rows=j.data||[];
        if (!rows.length){ body.innerHTML='<tr><td colspan="10" class="text-center text-muted">Tiada data.</td></tr>'; return; }
        body.innerHTML = rows.map(r=> `<tr>
          <td>${esc(r.nama)}</td><td>${esc(r.noIC)}</td><td>${esc(r.noTelefon)}</td><td>${esc(r.alamat)}</td><td>${esc(r.pdpaFileId? 'Ada':'-')}</td>
          <td>${esc(r.tarikhDaftar||'')}</td><td>${esc(r.firstVisitDate||'')}</td><td>${esc(r.labCompletedAt||'')}</td><td>${esc(r.secondVisitDate||'')}</td><td>${esc(r.tarikhSelesai||'')}</td>
        </tr>`).join('');
      }catch(e){ $('#completedTable').innerHTML='<tr><td colspan="10" class="text-danger">Ralat memuat.</td></tr>'; }
    }
    async function loadArchived(){
      try{
        const j = await RUMUS.get('getArchived'); const body = $('#archiveTable'); const rows=j.data||[];
        if (!rows.length){ body.innerHTML='<tr><td colspan="7" class="text-center text-muted">Tiada data.</td></tr>'; return; }
        body.innerHTML = rows.map(r=> `<tr>
          <td>${esc(r.nama)}</td><td>${esc(r.noIC)}</td><td>${esc(r.noTelefon)}</td><td>${esc(r.alamat)}</td><td>${esc(r.tarikhDaftar||'')}</td><td>${esc(r.tarikhSelesai||'')}</td><td>${esc(r.archivedAt||'')}</td>
        </tr>`).join('');
      }catch(e){ $('#archiveTable').innerHTML='<tr><td colspan="7" class="text-danger">Ralat memuat.</td></tr>'; }
    }

    /* =======================
       KELAYAKAN (import CSV/XLSX)
       ======================= */
    (function(){
      const fileInput = $('#excelFile'); const tableBody = $('#kelayakanTable');
      if (!fileInput || !tableBody) return;

      const canon = s => String(s||'').toLowerCase().replace(/[\s\.\-_/()]+/g,'').trim();
      const keysets = {
        nama:['nama','namapenuh','name','namapesakit'],
        ic:['ic','noic','nokp','k/p','kadpengenalan','nric','mykad'],
        telefon:['telefon','notelefon','notel','hp','h/p','whatsapp','mobile','phone'],
        alamat:['alamat','address','addr','alamatrumah','alamatkediaman']
      };
      const norm = v => String(v??'').trim();
      const mapRow = raw => {
        const entries = Object.entries(raw);
        const pick = groups => {
          for (const [k,v] of entries){ const t=canon(k); if (groups.some(w=>t.includes(canon(w)))) return norm(v); }
          for (const [k,v] of entries){ const t=canon(k); if (groups.some(w=>canon(w).includes(t))) return norm(v); }
          return '';
        };
        return { nama:pick(keysets.nama), ic:pick(keysets.ic), telefon:pick(keysets.telefon), alamat:pick(keysets.alamat) };
      };

      async function handleFile(file){
        tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Memproses…</td></tr>';
        const ext = (file.name.split('.').pop()||'').toLowerCase();
        try{
          let items=[];
          if (ext==='csv'){
            const text = await file.text();
            const rows = text.split(/\r?\n/).map(line=>line.split(','));
            const header = rows[0]||[];
            const objs = rows.slice(1).filter(r=>r.some(v=>String(v||'').trim()!=='')).map(r=> Object.fromEntries(header.map((h,i)=>[h,r[i]||''])));
            items = objs.map(mapRow).filter(r=>r.nama||r.ic||r.telefon||r.alamat);
          } else {
            try{ await ensureXLSXReady(); }catch(e){}
            if (!window.XLSX) throw new Error('SheetJS tidak tersedia. Sila simpan sebagai CSV.');
            const wb = XLSX.read(await file.arrayBuffer(), { type:'array' });
            const ws = wb.Sheets[wb.SheetNames[0]];
            const raw = XLSX.utils.sheet_to_json(ws, { defval:'', raw:true });
            items = raw.map(mapRow).filter(r=>r.nama||r.ic||r.telefon||r.alamat);
          }
          if (!items.length){ tableBody.innerHTML = '<tr><td colspan="8" class="text-center text-danger">Tiada lajur sepadan (Nama/IC/Telefon/Alamat).</td></tr>'; return; }

          tableBody.innerHTML = items.map((o,idx)=>`
            <tr data-idx="${idx}">
              <td>${esc(o.nama)}</td>
              <td>${esc(o.ic)}</td>
              <td>${esc(o.telefon)}</td>
              <td>${esc(o.alamat)}</td>
              <td class="text-center"><input type="checkbox" class="form-check-input imp-layak"></td>
              <td class="text-center"><input type="checkbox" class="form-check-input imp-tak"></td>
              <td>
                <div class="row g-1">
                  <div class="col-5"><input type="date" class="form-control form-control-sm imp-date"></div>
                  <div class="col-3"><input type="time" class="form-control form-control-sm imp-time"></div>
                  <div class="col-4"><input class="form-control form-control-sm imp-staff" placeholder="Staff"></div>
                </div>
              </td>
              <td><button class="btn btn-sm btn-outline-primary daftar-row">Isi Borang Daftar</button></td>
            </tr>
          `).join('');

          // klik "Isi Borang Daftar"
          tableBody.addEventListener('click', e=>{
            const btn = e.target.closest('.daftar-row'); if (!btn) return;
            const tr = btn.closest('tr'); const idx = +tr.dataset.idx;
            const i = items[idx]; if (!i) return;
            const fNama=$('#namaPesakit'), fIC=$('#noIC'), fTel=$('#noTelefon'), fAlamat=$('#alamatPesakit'), fTCA=$('#tarikhTCA'), fMasa=$('#masaTCA'), fStaff=$('#namaStaff');
            if (fNama) fNama.value = i.nama||''; if (fIC) fIC.value=i.ic||''; if (fTel) fTel.value=i.telefon||''; if (fAlamat) fAlamat.value=i.alamat||'';
            const d = tr.querySelector('.imp-date')?.value||''; const t=tr.querySelector('.imp-time')?.value||''; const s=tr.querySelector('.imp-staff')?.value||'';
            if (fTCA && d) fTCA.value = d; if (fMasa && t) fMasa.value = t; if (fStaff && s) fStaff.value = s;
            location.hash = '#daftar-peka';
            btn.innerHTML = '<i class="bi bi-check2 me-1"></i>Diisi'; btn.classList.remove('btn-outline-primary'); btn.classList.add('btn-success'); btn.disabled = true;
          }, { once:true });

        }catch(err){
          tableBody.innerHTML = `<tr><td colspan="8" class="text-center text-danger">${esc(err.message||err)}</td></tr>`;
        }
      }

      fileInput.addEventListener('change', e => { const f=e.target.files?.[0]; if (f) handleFile(f); });
    })();

    /* =======================
       DAFTAR PEKA (butang)
       ======================= */
    $('#btnDaftarPesakit')?.addEventListener('click', async ()=>{
      const nama=$('#namaPesakit').value.trim(), noIC=$('#noIC').value.trim(), noTelefon=$('#noTelefon').value.trim(), alamat=$('#alamatPesakit').value.trim();
      const tarikhTCA=$('#tarikhTCA').value.trim(), masaTCA=$('#masaTCA').value.trim(), namaStaff=$('#namaStaff').value.trim();
      if (!nama||!noIC||!noTelefon||!tarikhTCA||!masaTCA){ toast('Peringatan','Maklumat tidak lengkap','warning'); return; }
      try{
        loader.show('Mendaftar pesakit…');
        await RUMUS.post('daftarPesakit', { namaPesakit:nama, noIC, noTelefon, alamat, tarikhTCA, masaTCA, namaStaff });
        loader.hide(); toast('Berjaya','Pesakit didaftar','success');
      }catch(e){ loader.hide(); toast('Ralat', e.message||e, 'danger'); }
    });

    /* =======================
       INIT
       ======================= */
    document.addEventListener('DOMContentLoaded', ()=>{
      $('#current-date').textContent = new Date().toLocaleDateString('ms-MY', { weekday:'long', day:'2-digit', month:'long', year:'numeric' });
      const tok = getIdToken();
      if (tok){ onSignedIn(); }
      if (window.google && google.accounts && google.accounts.id){ renderGsiButtons(); }
      else {
        window.addEventListener('load', ()=> { if (window.google && google.accounts && google.accounts.id) renderGsiButtons(); });
      }
      handleHash();
    });
  </script>
</body>
</html>
