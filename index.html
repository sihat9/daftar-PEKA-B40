<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<!-- COOP/COEP supaya Google Sign-In tidak trigger amaran postMessage -->
<meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
<meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">

<title>Sistem Tracker PEKA B40 - Klinik SihatSokmo</title>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- Chart.js + Datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js" defer></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2" defer></script>

<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js" defer></script>

<!-- Google Identity Services (Sign-In) -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
:root{
  --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12;
  --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6;
}
html{ font-size:15px; }
@media (max-width:1200px){ html{ font-size:14px; } }
@media (max-width:576px){ html{ font-size:13px; } }

html,body{height:100%}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;color:#333}

/* Navbar */
.navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
.navbar-brand{font-weight:700;color:var(--primary);font-size:1.05rem;display:flex;align-items:center;gap:10px}
.nav-link{color:var(--dark);font-weight:500;margin:0 4px;padding:7px 10px!important;border-radius:8px;transition:.2s;position:relative}
.nav-link:hover,.nav-link.active{background:rgba(52,152,219,.12);color:var(--secondary)}
.nav-badge{
  position:absolute; top:-4px; right:-2px; transform:translate(30%,-30%);
  background:#dc3545; color:#fff; border-radius:999px; font-size:.65rem; padding:2px 6px; display:none;
}
/* pastikan toggler kelihatan walau bukan navbar-light/dark */
.navbar-toggler-icon{
  background-image:url("data:image/svg+xml,%3csvg viewBox='0 0 30 30' xmlns='http://www.w3.org/2000/svg'%3e%3cpath stroke='rgba(0,0,0,0.6)' stroke-width='2' stroke-linecap='round' stroke-miterlimit='10' d='M4 7h22M4 15h22M4 23h22'/%3e%3c/svg%3e");
}

/* Header */
.page-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:14px 0;margin-bottom:12px;border-radius:0 0 12px 12px}

/* Cards */
.card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:16px}
.card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;padding:12px 16px;border-radius:14px 14px 0 0!important}
.stat-card{padding:14px;border-radius:14px;color:#fff;text-align:center;position:relative;overflow:hidden;cursor:pointer}
.stat-card .number{font-size:1.45rem;font-weight:800}
.table td,.table th{vertical-align:middle}
.table{font-size:.95rem}
.searchbar{max-width:340px}
.mini-actions .btn{margin-right:6px;margin-bottom:6px}

/* Global App Loader (maks 2s) */
#appLoader{
  position:fixed; inset:0; z-index:2000; display:none;
  background: radial-gradient(1200px 600px at 10% -10%, rgba(52,152,219,.18), transparent),
              radial-gradient(1200px 600px at 110% 110%, rgba(46,204,113,.18), transparent),
              rgba(255,255,255,.35);
  backdrop-filter: blur(10px);
}
#appLoader .loader-card{
  position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
  background:rgba(255,255,255,.75); border:1px solid rgba(255,255,255,.6);
  box-shadow: 0 20px 40px rgba(0,0,0,.12);
  border-radius:18px; padding:16px 18px; min-width:220px; text-align:center;
}
.spinner-premium{
  width:36px;height:36px;border-radius:50%;
  border:4px solid rgba(52,152,219,.25);
  border-top-color:#3498db; animation:spin .9s linear infinite; margin:6px auto 8px;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* Log Calls Drawer */
#logDrawer{
  position:fixed; top:0; right:-420px; width:400px; max-width:90vw; height:100%;
  background:#f8f9fb; box-shadow:-12px 0 35px rgba(0,0,0,.18); z-index:3000;
  transition:right .25s ease; border-left:1px solid rgba(0,0,0,.05);
  display:flex; flex-direction:column;
}
#logDrawer.open{ right:0; }
.log-header{
  padding:10px 12px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06);
  display:flex; gap:8px; align-items:center;
}
.log-header .title{font-weight:700; color:#222; flex:1}
.log-search{ padding:8px; background:#fff; border-bottom:1px solid rgba(0,0,0,.06); }
.log-body{ padding:10px; overflow:auto; flex:1; display:flex; flex-direction:column; gap:8px; }
.bubble{
  max-width:80%; padding:8px 10px; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,.06);
  position:relative; font-size:.9rem; line-height:1.2rem;
}
.bubble.me{ margin-left:auto; background:#007aff; color:#fff; border-bottom-right-radius:6px; }
.bubble.other{ margin-right:auto; background:#e9ecef; color:#222; border-bottom-left-radius:6px; }
.bubble .meta{ font-size:.72rem; opacity:.8; margin-top:5px }
.log-loading{ display:none; text-align:center; padding:8px }
.log-loading.active{ display:block }

/* FAB Log Calls */
#fabLog{
  position:fixed; right:18px; bottom:18px; z-index:3500;
  width:56px; height:56px; border-radius:50%;
  display:flex; align-items:center; justify-content:center;
  box-shadow:0 10px 24px rgba(0,0,0,.18);
}

/* Toast host */
#toastHost{ position:fixed; top:12px; right:12px; z-index:4000; pointer-events:none; }
#toastHost .toast{ pointer-events:auto; }

/* -----------------------------
   NADI (layout profesional)
   ----------------------------- */

/* Input auto-grow */
.input-grow-wrapper{ position:relative; display:inline-block; max-width:none; }
.input-mirror{
  position:absolute; left:0; top:0; visibility:hidden; white-space:pre;
  font: inherit; padding: .25rem .5rem;
}
.nadi-input{
  min-width: 100px;
  width: auto;
  max-width:none;
  border: none;
  outline: none;
  padding: 0.25rem 0.5rem;
  background: transparent;
  font-size: 0.875rem;
  white-space: nowrap;
}
.nadi-input:focus { background: rgba(52, 152, 219, 0.1); border-radius: 4px; }

/* Bekas jadual NADI */
.nadi-table-container {
  overflow-x: auto; overflow-y: auto; margin-bottom: 1rem; border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.1); background: white;
  max-height: calc(100vh - 250px);
  box-shadow: inset 0 1px 0 rgba(0,0,0,.03);
}

/* Jadual NADI */
.nadi-table {
  width: auto;
  min-width: 100%;
  border-collapse: separate; border-spacing: 0;
  table-layout: auto;
}
.nadi-table th {
  background-color: #f8f9fa; position: sticky; top: 0; z-index: 12;
  font-weight: 600; font-size: 0.85rem; padding: 8px 12px; border-bottom: 2px solid #dee2e6;
  white-space: nowrap; text-align: center;
}
.nadi-table td {
  padding: 8px;
  border-bottom: 1px solid #eef1f4;
  vertical-align: top;
  position: relative;
  overflow: visible;
  white-space: nowrap;  /* scroll mendatar, bukan pecah baris */
}

/* Sticky kolum pertama (Nama Pesakit) */
.nadi-table th:first-child,
.nadi-table td:first-child{
  position: sticky; left: 0; z-index: 13;
  background: #fff; box-shadow: 2px 0 0 rgba(0,0,0,.05);
}

/* Lebar kolum utiliti */
.nadi-table th:nth-child(7),  .nadi-table td:nth-child(7)  { min-width: 220px; }  /* DXT */
.nadi-table th:nth-child(11), .nadi-table td:nth-child(11),
.nadi-table th:nth-child(12), .nadi-table td:nth-child(12){ min-width: 90px; text-align:center; } /* Layak / Tidak Layak */
.nadi-table th:nth-child(13), .nadi-table td:nth-child(13){ min-width: 200px; }  /* TCA & Staff */
.nadi-table th:nth-child(14), .nadi-table td:nth-child(14){ min-width: 200px; }  /* Tindakan */

/* Komponen dalam sel */
.nadi-table .form-control-sm { height: calc(1.5em + 0.5rem + 2px); padding: 0.25rem 0.5rem; font-size: 0.875rem; }
.nadi-table .btn-sm { padding: 0.25rem 0.5rem; font-size: 0.875rem; }

.nadi-table .action-buttons { display: flex; gap: 6px; flex-wrap: wrap; align-items: center; justify-content: center; }
.nadi-table .status-check{ display:flex; justify-content:center; align-items:center; }
.nadi-table .tca-fields{ display:flex; gap:6px; flex-direction:column; }
.nadi-table .tca-fields .form-control { min-width: 160px; }
.nadi-table .bmi-field { min-width: 80px; text-align: center; }
.nadi-dxt-wrap{ flex-wrap: nowrap; }

/* Tooltip ringkas */
.nadi-table td:hover::after{
  content: attr(data-title);
  position:absolute; left:0; top:100%; z-index:20; background:#333; color:#fff; padding:4px 8px; border-radius:4px; font-size:.8rem;
  white-space:normal; width:max-content; max-width:300px;
}

/* Responsive */
@media (max-width:992px){
  .stat-card .number{font-size:1.3rem}
}
</style>
</head>
<body>

<!-- Global Loader -->
<div id="appLoader" aria-hidden="true">
  <div class="loader-card">
    <div class="spinner-premium"></div>
    <div class="fw-bold">Sila tunggu…</div>
    <div class="text-muted small" id="loaderMsg">Memproses permintaan anda</div>
  </div>
</div>

<!-- Log Calls Drawer -->
<div id="logDrawer" aria-hidden="true">
  <div class="log-header">
    <button class="btn btn-sm btn-outline-secondary" id="btnCloseLog" type="button"><i class="bi bi-x-lg"></i></button>
    <div class="title"><i class="bi bi-chat-dots me-1"></i> Log Calls</div>
    <div id="logBadge" class="badge text-bg-primary">0</div>
  </div>
  <div class="log-search">
    <input id="logSearch" class="form-control form-control-sm" placeholder="Cari: nama / IC / telefon / staff…" />
  </div>
  <div id="logLoading" class="log-loading">
    <div class="spinner-border spinner-border-sm" role="status"></div>
    <div class="small text-muted mt-1">Memuat Log Calls…</div>
  </div>
  <div id="logBody" class="log-body"></div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-main">
  <div class="container">
    <a class="navbar-brand" href="#dashboard">
      <img id="brandLogo" alt="Logo" style="width:32px;height:32px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,.08)">
      <span>Klinik SihatSokmo</span>
    </a>

    <!-- Google Sign-in button placeholder -->
    <div id="signinArea" class="d-lg-none me-2"></div>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMain">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item position-relative">
          <a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#nadi"><i class="bi bi-clipboard2-pulse"></i> Program PEKA B40 bersama NADI</a>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a>
          <span id="badgeTCA" class="nav-badge">0</span>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a>
          <span id="badgeFirst" class="nav-badge">0</span>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab Report</a>
          <span id="badgeLab" class="nav-badge">0</span>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a>
          <span id="badgeSecond" class="nav-badge">0</span>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a>
        </li>
        <li class="nav-item position-relative">
          <a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a>
        </li>
      </ul>

      <div class="d-none d-lg-flex align-items-center gap-2">
        <div id="signinAreaDesktop"></div>
        <span id="staffBadge" class="badge bg-secondary d-none"><i class="bi bi-person-check me-1"></i><span id="staffEmail"></span></span>
      </div>
    </div>
  </div>
</nav>

<!-- Header -->
<header class="page-header">
  <div class="container">
    <div class="row align-items-center g-2">
      <div class="col-md-6">
        <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
        <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
      </div>
      <div class="col-md-6 text-md-end">
        <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
      </div>
    </div>
  </div>
</header>

<main class="container">

  <!-- Dashboard -->
  <section id="dashboard" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h6 m-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-success" id="btnExportCSV" type="button"><i class="fa-solid fa-file-csv me-1"></i>Export (CSV)</button>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-6 col-md-2">
        <div class="stat-card" data-goto="#tca-call" style="background:linear-gradient(135deg,var(--secondary),#2980b9)">
          <div class="number" id="totalDaftar">0</div><div class="small">Aktif</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="stat-card" data-goto="#first-visit" style="background:linear-gradient(135deg,var(--warning),#e67e22)">
          <div class="number" id="totalFirstVisit">0</div><div class="small">First Visit (Pending)</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="stat-card" data-goto="#second-visit" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">
          <div class="number" id="totalSecondVisit">0</div><div class="small">Second Visit (Pending)</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="stat-card" data-goto="#selesai" style="background:linear-gradient(135deg,var(--success),#16a085)">
          <div class="number" id="totalSelesai">0</div><div class="small">Selesai</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#8e44ad,#6c5ce7)">
          <div class="number" id="labFollowUpDue">0</div><div class="small">Result > 3 Hari</div>
        </div>
      </div>
      <div class="col-6 col-md-2">
        <div class="stat-card" data-goto="#lab-followup" style="background:linear-gradient(135deg,#d35400,#c0392b)">
          <div class="number" id="labFollowUpPending">0</div><div class="small">Perlu Follow-up</div>
        </div>
      </div>
    </div>

    <!-- Pesakit perlu dihubungi (ringkas hari ini) -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi Hari Ini</span>
        <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefon…" />
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
            <tbody id="tcaCallTable"><tr><td colspan="5" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Statistik -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
        <select id="statPeriod" class="form-select form-select-sm" style="max-width:200px">
          <option value="3months">3 Bulan Terakhir</option>
          <option value="6months">6 Bulan Terakhir</option>
          <option value="12months">12 Bulan Terakhir</option>
        </select>
      </div>
      <div class="card-body"><div style="height:320px;"><canvas id="stats3dChart"></canvas></div></div>
    </div>
  </section>

  <!-- Program NADI -->
  <section id="nadi" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="bi bi-clipboard2-pulse me-2"></i>Program PEKA B40 bersama NADI</h2>
      <div class="d-flex gap-2">
        <button id="btnAddNadiRow" class="btn btn-sm btn-primary" type="button"><i class="bi bi-plus-lg me-1"></i>Tambah Baris</button>
        <button id="btnNadiExportCsv" class="btn btn-sm btn-outline-success" type="button"><i class="bi bi-filetype-csv me-1"></i>Transfer kepada fail Excel (CSV)</button>
      </div>
    </div>
    <div class="card"><div class="card-body">
      <div class="nadi-table-container">
        <table class="nadi-table">
          <thead>
            <tr>
              <th>Nama Pesakit</th>
              <th>No IC</th>
              <th>No Telefon</th>
              <th>Alamat</th>
              <th>BP</th>
              <th>PR</th>
              <th>DXT (mmol/L)</th>
              <th>Tinggi (cm)</th>
              <th>Berat (kg)</th>
              <th>BMI</th>
              <th>Layak</th>
              <th>Tidak Layak</th>
              <th>TCA & Staff</th>
              <th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="nadiTableBody">
            <!-- Baris kosong akan ditambah melalui JavaScript -->
          </tbody>
        </table>
      </div>
      <div class="text-muted small mt-2">
        Nota: Baris "Layak" boleh terus <b>Daftar</b> (simpan ke sheet). Baris "Tidak Layak" <u>tidak</u> disimpan ke sheet tetapi <b>tetap dieksport CSV</b> bersama-sama.
      </div>
    </div></div>
  </section>

  <!-- Kelayakan (Excel) -->
  <section id="kelayakan" class="mb-4 d-none">
    <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel)</h2>
    <div class="card"><div class="card-body">
      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-6">
          <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls" />
          <div class="form-text">Fail perlu ada lajur: <b>Nama</b>, <b>IC</b>, <b>Telefon</b>. (Sistem tapis umur ≥40 ikut IC)</div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama</th><th>IC</th><th>Telefon</th>
              <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
              <th style="width:360px">Jika Layak → TCA & Masa & Staff</th><th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="kelayakanTable"><tr><td colspan="7" class="text-center text-muted">Muat naik Excel untuk mula.</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Pendaftaran -->
  <section id="pendaftaran" class="mb-4 d-none">
    <h2 class="h6 mb-3"><i class="fas fa-user-plus me-2"></i>Pendaftaran Pesakit Baru</h2>
    <div class="card"><div class="card-body">
      <form id="formPendaftaran">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Nama Penuh Pesakit</label><input id="namaPesakit" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nombor IC</label><input id="noIC" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nombor Telefon</label><input id="noTelefon" class="form-control" type="tel" required placeholder="cth: 0123456789 atau 60123456789"></div>
          <div class="col-md-6"><label class="form-label">Nama Staff</label><input id="namaStaff" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Tarikh TCA</label><input id="tarikhTCA" class="form-control" type="date" required></div>
          <div class="col-md-6"><label class="form-label">Masa TCA</label><input id="masaTCA" class="form-control" type="time" required></div>
          <div class="col-12"><button class="btn btn-primary"><i class="fas fa-save me-1"></i>Daftar Pesakit</button></div>
        </div>
      </form>
    </div></div>
  </section>

  <!-- TCA Call -->
  <section id="tca-call" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-phone me-2"></i>Senarai Rekod TCA Call</h2>
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group btn-group-sm" role="group" id="tcaFilter">
          <button class="btn btn-outline-primary active" data-filter="today" type="button">Hari ini</button>
          <button class="btn btn-outline-primary" data-filter="upcoming" type="button">Akan datang</button>
          <button class="btn btn-outline-primary" data-filter="past" type="button">Lepas</button>
          <button class="btn btn-outline-secondary" data-filter="all" type="button">Semua</button>
        </div>
        <input class="form-control form-control-sm searchbar" id="searchTCAPage" placeholder="Cari nama/IC/telefon…"/>
      </div>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
          <tbody id="tcaCallList"><tr><td colspan="5" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- First Visit -->
  <section id="first-visit" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
      <input class="form-control form-control-sm searchbar" id="searchFirst" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
          <tbody id="firstVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Follow-up Lab Report -->
  <section id="lab-followup" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
      <input class="form-control form-control-sm searchbar" id="searchLab" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th><th>Tindakan</th></tr>
          </thead>
          <tbody id="labFollowupTable"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Second Visit -->
  <section id="second-visit" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
      <input class="form-control form-control-sm searchbar" id="searchSecond" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
          <tbody id="secondVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Selesai -->
  <section id="selesai" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
      <input class="form-control form-control-sm searchbar" id="searchCompleted" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card mb-3"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>PDPA</th>
              <th>Tarikh Daftar</th><th>First Visit</th><th>Lab Report Completed</th><th>Second Visit</th><th>Tarikh Selesai</th><th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="completedTable"><tr><td colspan="10" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
        <select id="statPeriodCompleted" class="form-select form-select-sm" style="max-width:200px">
          <option value="3months">3 Bulan Terakhir</option>
          <option value="6months">6 Bulan Terakhir</option>
          <option value="12months">12 Bulan Terakhir</option>
        </select>
      </div>
      <div class="card-body"><div style="height:300px;"><canvas id="completed3dChart"></canvas></div></div>
    </div>
  </section>

  <!-- Arkib -->
  <section id="arkib" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
      <input class="form-control form-control-sm searchbar" id="searchArchive" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th><th>Tindakan</th></tr></thead>
          <tbody id="archiveTable"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

</main>

<!-- Modal Re-TCA -->
<div class="modal fade" id="retcaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Daftar TCA Semula</h5>
      <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="retcaIC">
      <div class="mb-3"><label class="form-label">Tarikh TCA Baharu</label><input type="date" id="retcaDate" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Masa TCA Baharu</label><input type="time" id="retcaTime" class="form-control" required></div>
      <small class="text-muted">Status pesakit akan ditukar kepada <b>TCA CALL</b>.</small>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Batal</button>
      <button class="btn btn-primary" id="btnSubmitRetca" type="button"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
    </div>
  </div></div>
</div>

<!-- Modal Set Second Visit TCA -->
<div class="modal fade" id="secondTcaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fa-solid fa-calendar-check me-2"></i>Tetapkan TCA Second Visit</h5>
      <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="secondTcaIC">
      <div class="mb-2"><label class="form-label">Tarikh TCA Second Visit</label><input type="date" id="secondTcaDate" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Masa TCA</label><input type="time" id="secondTcaTime" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Nama Staff (wajib isi)</label><input type="text" id="secondTcaStaff" class="form-control" required placeholder="cth: Dayah"></div>
      <small class="text-muted">Maklumat ini akan direkod ke Log Calls & ruangan "Lab Report Completed".</small>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Batal</button>
      <button class="btn btn-primary" id="btnSubmitSecondTca" type="button"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
    </div>
  </div></div>
</div>

<!-- Modal Upload PDPA -->
<div class="modal fade" id="pdpaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i>Muat Naik Borang PDPA</h5>
      <button class="btn-close" data-bs-dismiss="modal" type="button"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pdpaIC">
      <input type="file" id="pdpaFile" class="form-control" accept="application/pdf,image/*" />
      <div class="form-text">Muat naik PDF / imej borang PDPA pesakit.</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal" type="button">Tutup</button>
      <button class="btn btn-primary" id="btnUploadPDPA" type="button"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload</button>
    </div>
  </div></div>
</div>

<!-- Toast Host -->
<div id="toastHost"><div id="toastContainer" class="toast-container"></div></div>

<!-- FAB Log Calls -->
<button id="fabLog" class="btn btn-primary" type="button">
  <i class="bi bi-chat-dots fs-5"></i>
</button>

<footer class="footer mt-4 py-3 bg-light">
  <div class="container"><div class="d-flex justify-content-between">
    <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
    <div>Versi 3.1 (Secure)</div>
  </div></div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" defer></script>

<script>
/* =======================
   KONFIG (EDIT INI SAHAJA)
   ======================= */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6TKE0vDDPO3-36cY7xjacAbGL0HIRKCrORNm-sED9y5NpIeIUk9gyrpiWy-S7vbc/exec';
const GOOGLE_CLIENT_ID = '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com';
const LOGO_URL = 'https://github.com/sihat9/mari-jalan-dengan-doktor/blob/main/img/logo-kss.png?raw=true';

/* =======================
   AUTH (Google Identity)
   ======================= */
let ID_TOKEN = '';
let STAFF_EMAIL = '';

function initGoogleSignIn(){
  const start = Date.now();
  (function poll(){
    if (window.google && google.accounts && google.accounts.id){
      google.accounts.id.initialize({
        client_id: GOOGLE_CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false,
        cancel_on_tap_outside: true
      });
      google.accounts.id.renderButton(
        document.getElementById('signinArea'),
        { theme: 'outline', size: 'medium', text:'signin_with' }
      );
      google.accounts.id.renderButton(
        document.getElementById('signinAreaDesktop'),
        { theme: 'outline', size: 'medium', text:'signin_with' }
      );
    } else if (Date.now() - start < 10000){
      setTimeout(poll, 150);
    }
  })();
}

async function handleCredentialResponse(resp){
  try{
    ID_TOKEN = resp.credential;
    const r = await fetch(SCRIPT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ action:'whoami', id_token: ID_TOKEN })
    });
    const j = await r.json();
    if (j.status === 'success'){
      STAFF_EMAIL = j.email || '';
      document.getElementById('staffBadge').classList.remove('d-none');
      document.getElementById('staffEmail').textContent = STAFF_EMAIL;
      document.getElementById('signinArea').innerHTML = '';
      document.getElementById('signinAreaDesktop').innerHTML = '';
      bootstrapApp();
    } else {
      toast('Akses Ditolak', j.message || 'Sila hubungi admin untuk allowlist.', 'danger');
      ID_TOKEN = ''; STAFF_EMAIL = '';
    }
  }catch(e){
    toast('Ralat', 'Gagal sahkan log masuk', 'danger');
  }
}

/* =======================
   LOADER (maks 2s)
   ======================= */
let loaderTimer=null;
function showLoader(msg='Memproses…'){
  document.getElementById('loaderMsg').textContent = msg;
  document.getElementById('appLoader').style.display = 'block';
  clearTimeout(loaderTimer);
  loaderTimer = setTimeout(hideLoader, 2000);
}
function hideLoader(){ document.getElementById('appLoader').style.display = 'none'; }

/* =======================
   NETWORK HELPERS
   ======================= */
async function getJSON(params={}, {silent=false, msg='Memuat data…'}={}){
  if (!ID_TOKEN) throw new Error('Belum login');
  const qs = new URLSearchParams({ ...params, id_token: ID_TOKEN }).toString();
  const url = `${SCRIPT_URL}?${qs}`;
  if (!silent) showLoader(msg);
  try{
    const r = await Promise.race([
      fetch(url, { method:'GET' }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

async function postForm(params={}, {silent=false, msg='Menyimpan data…'}={}){
  if (!ID_TOKEN) throw new Error('Belum login');
  if (!silent) showLoader(msg);
  try{
    const r = await Promise.race([
      fetch(SCRIPT_URL, {
        method:'POST',
        headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
        body: new URLSearchParams({ ...params, id_token: ID_TOKEN })
      }),
      new Promise((_,rej)=> setTimeout(()=>rej(new Error('Timeout')), 12000))
    ]);
    return await r.json();
  } finally { if (!silent) hideLoader(); }
}

/* =======================
   UTIL
   ======================= */
const normalizeMsisdnMY = (raw) => {
  if (!raw) return '';
  let s = String(raw).replace(/\D/g,'');
  if (s.startsWith('00')) s = s.slice(2);
  if (s.startsWith('60')) return s;
  if (s.startsWith('0')) return '60' + s.slice(1);
  return '60' + s;
};
const telHref = (msisdn) => `tel:+${msisdn}`;
const waHref  = (msisdn, txt='Assalamualaikum, ini dari Klinik SihatSokmo.') => `https://wa.me/${msisdn}?text=${encodeURIComponent(txt)}`;
const parseDDMMYYYY = (s) => {
  if (!s) return null;
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D); }
  const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
  if (!m) return null; const D=+m[1], M=+m[2], Y=+m[3]; return new Date(Y,M-1,D);
};
function isSameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }
function toast(title, message, variant='primary'){
  const container = document.getElementById('toastContainer');
  const id = 't'+Date.now();
  const html = `
    <div class="toast align-items-center text-bg-${variant} border-0 mb-2" id="${id}" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"><strong>${title}:</strong> ${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`;
  container.insertAdjacentHTML('beforeend', html);
  const el = document.getElementById(id);
  const t = new bootstrap.Toast(el, { delay: 3000 });
  t.show();
  el.addEventListener('hidden.bs.toast', ()=>el.remove());
}

/* =======================
   GLOBALS
   ======================= */
let stats3dChart, completed3dChart;
let retcaModal, secondTcaModal, pdpaModal;

/* =======================
   BOOTSTRAP APP
   ======================= */
function bootstrapApp(){
  const logoEl = document.getElementById('brandLogo');
  logoEl.src = LOGO_URL;
  logoEl.onerror = () => (logoEl.src='https://via.placeholder.com/64x64.png?text=KS');

  document.getElementById('current-date').textContent =
    new Date().toLocaleDateString('ms-MY', { weekday:'long', year:'numeric', month:'long', day:'numeric' });

  setupNavigation();
  setupModals();
  setupSearchBars();
  setupExports();
  setupExcel();
  setupNADI();        // Halaman NADI (kemas)
  setupLogDrawer();
  setupFab();

  loadDashboardData();
  loadStatistics('3months');
  loadCompletedStatistics('3months');
  loadTCACallData();
}

/* =======================
   NAV & UI
   ======================= */
function setupNavigation(){
  document.querySelectorAll('.nav-link').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault();
      document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
      const target = a.getAttribute('href');
      const tgtEl = document.querySelector(target);
      if (tgtEl) tgtEl.classList.remove('d-none');
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
      a.classList.add('active');

      if (target==='#dashboard'){ loadDashboardData(); loadStatistics(document.getElementById('statPeriod').value); }
      else if (target==='#tca-call'){ loadTCACallPage(); }
      else if (target==='#first-visit'){ loadFirstVisitData(); }
      else if (target==='#lab-followup'){ loadLabFollowUp(); }
      else if (target==='#second-visit'){ loadSecondVisitData(); }
      else if (target==='#selesai'){ loadCompletedData(); loadCompletedStatistics(document.getElementById('statPeriodCompleted').value); }
      else if (target==='#arkib'){ loadArchivedData(); }
    });
  });

  document.querySelectorAll('.stat-card[data-goto]').forEach(card=>{
    card.addEventListener('click', ()=>{
      const href = card.getAttribute('data-goto');
      const link = document.querySelector(`.nav-link[href="${href}"]`);
      if (link){ link.click(); }
    });
  });

  document.getElementById('formPendaftaran').addEventListener('submit', async (e)=>{
    e.preventDefault();
    await daftarPesakit();
  });

  document.getElementById('statPeriod').addEventListener('change', function(){ loadStatistics(this.value); });
  document.getElementById('statPeriodCompleted').addEventListener('change', function(){ loadCompletedStatistics(this.value); });
}

function setupModals(){
  retcaModal = new bootstrap.Modal(document.getElementById('retcaModal'));
  document.getElementById('btnSubmitRetca').addEventListener('click', submitRetca);

  secondTcaModal = new bootstrap.Modal(document.getElementById('secondTcaModal'));
  document.getElementById('btnSubmitSecondTca').addEventListener('click', submitSecondTca);

  pdpaModal = new bootstrap.Modal(document.getElementById('pdpaModal'));
  document.getElementById('btnUploadPDPA').addEventListener('click', uploadPDPA);
}

function setupFab(){
  const btn = document.getElementById('fabLog');
  const drawer  = document.getElementById('logDrawer');
  const btnClose= document.getElementById('btnCloseLog');
  btn.addEventListener('click', ()=>{ drawer.classList.add('open'); refreshLogs(); autoRefreshLogs(); });
  btnClose.addEventListener('click', ()=>{ drawer.classList.remove('open'); stopAutoRefreshLogs(); });
}

function setupSearchBars(){
  const pairs = [
    ['searchTCA','tcaCallTable'], ['searchTCAPage','tcaCallList'],
    ['searchFirst','firstVisitList'], ['searchSecond','secondVisitList'],
    ['searchCompleted','completedTable'], ['searchLab','labFollowupTable'],
    ['searchArchive','archiveTable']
  ];
  pairs.forEach(([inpId,tbodyId])=>{
    const inp = document.getElementById(inpId);
    const tb = document.getElementById(tbodyId);
    if (!inp || !tb) return;
    inp.addEventListener('input', ()=>{
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const text = tr.innerText || '';
        tr.style.display = (text.toLowerCase().includes((inp.value||'').trim().toLowerCase())) ? '' : 'none';
      });
    });
  });
}

function setupExports(){
  document.getElementById('btnExportCSV').addEventListener('click', exportCompletedCSV);
}

/* =======================
   CHART HELPERS
   ======================= */
function buildBarChart(elId, dataArr, titleText){
  const el = document.getElementById(elId);
  if (!el || !window.Chart) return null;
  if (window.ChartDataLabels) { Chart.register(window.ChartDataLabels); }
  const ctx = el.getContext('2d');
  const labels = dataArr.map(i=>i.label);
  const counts = dataArr.map(i=>i.count);
  const backgroundColors = counts.map((_,i)=>`hsla(${(i*30)%360},70%,50%,0.7)`);
  const config = {
    type:'bar',
    data:{ labels, datasets:[{ label:'Jumlah Pesakit Selesai', data:counts, backgroundColor:backgroundColors, borderColor:'rgba(0,0,0,.1)', borderWidth:1 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{ display:true, text:titleText, font:{ size:14 } }, legend:{ display:false }, datalabels:{ display:false } },
      scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Jumlah Pesakit'} }, x:{ title:{ display:true, text:'Bulan/Tahun'} } },
      animation:{ duration:500 }
    }
  };
  return new Chart(ctx, config);
}

/* =======================
   LOG CALLS DRAWER
   ======================= */
let logDrawerTimer=null;
function setupLogDrawer(){
  document.getElementById('logSearch').addEventListener('input', ()=> refreshLogs());
}
function autoRefreshLogs(){ stopAutoRefreshLogs(); logDrawerTimer = setInterval(()=> refreshLogs({silent:true}), 10000); }
function stopAutoRefreshLogs(){ if (logDrawerTimer){ clearInterval(logDrawerTimer); logDrawerTimer=null; } }
async function refreshLogs(opts={}){
  const q = (document.getElementById('logSearch').value||'').trim();
  const loader = document.getElementById('logLoading');
  const body   = document.getElementById('logBody');
  if (!opts.silent) loader.classList.add('active');
  try{
    const res = await getJSON({ action:'getCallLogs', q }, { silent:true });
    if (res.status==='success'){
      const arr = res.data||[];
      document.getElementById('logBadge').textContent = arr.length;
      body.innerHTML = '';
      arr.forEach(item=>{
        const me = (item.staff||'').toLowerCase() === (STAFF_EMAIL||'').toLowerCase();
        const who = item.staff || 'STAFF';
        const text = `${item.event || 'CALL'} • ${item.nama||'-'} (${item.noIC||'-'}) • ${item.noTelefon||'-'}`;
        const when = item.time || '';
        const bubble = document.createElement('div');
        bubble.className = 'bubble ' + (me?'me':'other');
        bubble.innerHTML = `<div><i class="fa-solid fa-phone-volume me-1"></i>${text}</div><div class="meta">${who} • ${when}</div>`;
        body.appendChild(bubble);
      });
      body.scrollTop = body.scrollHeight;
    }
  }catch(e){ /* senyap */ }
  finally{ if (!opts.silent) loader.classList.remove('active'); }
}

/* =======================
   EXCEL (Kelayakan)
   ======================= */
function setupExcel(){
  const input = document.getElementById('excelFile');
  const tbody = document.getElementById('kelayakanTable');
  input.addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    showLoader('Memproses Excel…');
    try{
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
      tbody.innerHTML = '';
      if (!json.length) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data.</td></tr>`;
        return;
      }
      json.forEach((row, idx)=>{
        const nama = row.Nama || row.NAMA || row.name || '';
        const ic = row.IC || row.Ic || row.ic || '';
        const tel = row.Telefon || row.TELEFON || row.Phone || row.phone || '';
        const msisdn = normalizeMsisdnMY(tel);
        const id = 'x'+Date.now()+idx;

        // Kelayakan ikut umur ≥40 dari IC
        const lahirYY = ic.slice(0,2), lahirMM = ic.slice(2,4), lahirDD = ic.slice(4,6);
        let ageOk = false;
        if (/^\d{6}/.test(ic)){
          const y = Number(lahirYY); const fullY = (y>=0 && y<=29) ? (2000+y) : (1900+y);
          const dob = new Date(fullY, Number(lahirMM)-1, Number(lahirDD));
          const now = new Date();
          let age = now.getFullYear()-dob.getFullYear();
          const m = now.getMonth()-dob.getMonth();
          if (m<0 || (m===0 && now.getDate()<dob.getDate())) age--;
          ageOk = age>=40;
        }

        const tr = `
          <tr id="${id}">
            <td>${nama}</td>
            <td>${ic}</td>
            <td>${msisdn}</td>
            <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'checked':''} onchange="toggleLayak('${id}', true)"></td>
            <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'':'checked'} onchange="toggleLayak('${id}', false)"></td>
            <td>
              <div class="row g-1 align-items-center">
                <div class="col"><input type="date" class="form-control form-control-sm tca-date" disabled></div>
                <div class="col"><input type="time" class="form-control form-control-sm tca-time" disabled></div>
                <div class="col"><input type="text" class="form-control form-control-sm tca-staff" placeholder="Nama staff" disabled></div>
              </div>
            </td>
            <td>
              <button class="btn btn-sm btn-primary" type="button" onclick="daftarFromExcel('${id}', '${encodeURIComponent(nama)}', '${encodeURIComponent(ic)}', '${msisdn}')" disabled>Daftar</button>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', tr);
      });
    } finally { hideLoader(); }
  });
}
function toggleLayak(rowId, isLayak){
  const tr = document.getElementById(rowId);
  if (!tr) return;
  const checks = tr.querySelectorAll('input[type=checkbox]');
  if (isLayak) { checks[1].checked = false; } else { checks[0].checked = false; }
  const date  = tr.querySelector('.tca-date');
  const time  = tr.querySelector('.tca-time');
  const staff = tr.querySelector('.tca-staff');
  const btn   = tr.querySelector('button');
  if (isLayak && checks[0].checked) {
    date.disabled = false; time.disabled = false; staff.disabled=false; btn.disabled = false;
  } else {
    date.disabled = true;  time.disabled = true; staff.disabled=true;  btn.disabled = true;
  }
}
async function daftarFromExcel(rowId, encNama, encIC, msisdn){
  const tr = document.getElementById(rowId);
  const nama = decodeURIComponent(encNama);
  const ic = decodeURIComponent(encIC);
  const date  = tr.querySelector('.tca-date').value;
  const time  = tr.querySelector('.tca-time').value;
  const staff = tr.querySelector('.tca-staff').value.trim();
  if (!date || !time || !staff) { toast('Ralat','Sila isi tarikh, masa & nama staff','danger'); return; }
  try{
    const res = await postForm({
      action:'daftarPesakit', namaPesakit:nama, noIC: ic, noTelefon: msisdn,
      namaStaff: staff, tarikhTCA: date, masaTCA: time
    }, { msg:'Mendaftar pesakit…' });
    if (res.status==='success'){
      toast('Berjaya',`Pesakit ${nama} didaftarkan ke TCA`, 'success');
      tr.remove();
      loadDashboardData(); loadTCACallData();
    } else throw new Error(res.message||'Gagal daftar');
  }catch(e){ toast('Ralat',e.message,'danger'); }
}

/* =======================
   NADI PAGE
   ======================= */
function setupNADI(){
  const container = document.getElementById('nadiTableBody');
  container.innerHTML = '';
  for (let i = 0; i < 5; i++) addNadiRow();

  document.getElementById('btnNadiExportCsv').addEventListener('click', exportNadiCSV);
  document.getElementById('btnAddNadiRow').addEventListener('click', addNadiRow);

  document.getElementById('nadi').addEventListener('keydown', (e)=>{
    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') addNadiRow();
  });
}

function createAutoGrowInput(placeholder = '', initialWidth = 120) {
  const wrapper = document.createElement('div');
  wrapper.className = 'input-grow-wrapper';
  const mirror = document.createElement('span');
  mirror.className = 'input-mirror';
  mirror.textContent = placeholder || ' ';
  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'form-control form-control-sm nadi-input';
  input.placeholder = placeholder;
  input.style.minWidth = initialWidth + 'px';
  function updateSize() {
    mirror.textContent = input.value || placeholder || ' ';
    const w = mirror.scrollWidth + 18;
    input.style.width = w + 'px';
  }
  input.addEventListener('input', updateSize);
  input.addEventListener('focus', updateSize);
  wrapper.appendChild(mirror);
  wrapper.appendChild(input);
  updateSize();
  return { wrapper, input, updateSize };
}

function addNadiRow(){
  const tbody = document.getElementById('nadiTableBody');
  const id = 'n'+Date.now()+Math.random().toString(36).slice(2,6);
  const row = document.createElement('tr'); row.id = id;

  // Kolom 1: Nama Pesakit
  const namaCell = document.createElement('td');
  const { wrapper: namaWrapper, input: namaInput } = createAutoGrowInput('Nama pesakit', 160);
  namaCell.appendChild(namaWrapper); row.appendChild(namaCell);

  // Kolom 2: No IC
  const icCell = document.createElement('td');
  const { wrapper: icWrapper, input: icInput } = createAutoGrowInput('No IC', 120);
  icCell.appendChild(icWrapper); row.appendChild(icCell);

  // Kolom 3: No Telefon
  const telCell = document.createElement('td');
  const { wrapper: telWrapper, input: telInput } = createAutoGrowInput('No Telefon', 130);
  telCell.appendChild(telWrapper); row.appendChild(telCell);

  // Kolom 4: Alamat
  const alamatCell = document.createElement('td');
  const { wrapper: alamatWrapper, input: alamatInput } = createAutoGrowInput('Alamat', 220);
  alamatCell.appendChild(alamatWrapper); row.appendChild(alamatCell);

  // Kolom 5: BP
  const bpCell = document.createElement('td');
  const { wrapper: bpWrapper, input: bpInput } = createAutoGrowInput('BP (cth: 120/80)', 120);
  bpCell.appendChild(bpWrapper); row.appendChild(bpCell);

  // Kolom 6: PR
  const prCell = document.createElement('td');
  const { wrapper: prWrapper, input: prInput } = createAutoGrowInput('PR (degupan/min)', 130);
  prCell.appendChild(prWrapper); row.appendChild(prCell);

  // Kolom 7: DXT
  const dxtCell = document.createElement('td');
  const dxtGroup = document.createElement('div');
  dxtGroup.className = 'input-group input-group-sm nadi-dxt-wrap';

  const dxtTypeBtn = document.createElement('button');
  dxtTypeBtn.className = 'btn btn-outline-secondary dropdown-toggle';
  dxtTypeBtn.setAttribute('data-bs-toggle', 'dropdown');
  dxtTypeBtn.type = 'button';
  dxtTypeBtn.textContent = 'Fasting';

  const dxtTypeMenu = document.createElement('ul');
  dxtTypeMenu.className = 'dropdown-menu';
  ['Fasting','Random'].forEach(val=>{
    const li=document.createElement('li');
    const a=document.createElement('a');
    a.className='dropdown-item'; a.href='#'; a.setAttribute('data-value',val); a.textContent=val;
    li.appendChild(a); dxtTypeMenu.appendChild(li);
  });

  const { wrapper: dxtWrapper, input: dxtInput } = createAutoGrowInput('DXT (mmol/L)', 120);
  dxtInput.classList.add('nadi-dxt-input');

  const dxtTypeHidden = document.createElement('input');
  dxtTypeHidden.type = 'hidden';
  dxtTypeHidden.className = 'nadi-dxt-type';
  dxtTypeHidden.value = 'Fasting';

  dxtGroup.appendChild(dxtTypeBtn);
  dxtGroup.appendChild(dxtTypeMenu);
  dxtGroup.appendChild(dxtWrapper);
  dxtGroup.appendChild(dxtTypeHidden);
  dxtCell.appendChild(dxtGroup);
  row.appendChild(dxtCell);

  // Kolom 8: Tinggi
  const tinggiCell = document.createElement('td');
  const { wrapper: tinggiWrapper, input: tinggiInput } = createAutoGrowInput('Tinggi (cm)', 110);
  tinggiCell.appendChild(tinggiWrapper); row.appendChild(tinggiCell);

  // Kolom 9: Berat
  const beratCell = document.createElement('td');
  const { wrapper: beratWrapper, input: beratInput } = createAutoGrowInput('Berat (kg)', 110);
  beratCell.appendChild(beratWrapper); row.appendChild(beratCell);

  // Kolom 10: BMI
  const bmiCell = document.createElement('td');
  const bmiInput = document.createElement('input');
  bmiInput.className = 'form-control form-control-sm bmi-field';
  bmiInput.placeholder = 'BMI'; bmiInput.disabled = true;
  bmiCell.appendChild(bmiInput); row.appendChild(bmiCell);

  // Kolom 11: Layak
  const layakCell = document.createElement('td');
  layakCell.className = 'status-check';
  const layakDiv = document.createElement('div'); layakDiv.className = 'form-check';
  const layakInput = document.createElement('input'); 
  layakInput.className = 'form-check-input nadi-layak'; 
  layakInput.type = 'checkbox';
  layakDiv.appendChild(layakInput); 
  layakCell.appendChild(layakDiv); 
  row.appendChild(layakCell);

  // Kolom 12: Tidak Layak
  const takLayakCell = document.createElement('td');
  takLayakCell.className = 'status-check';
  const takLayakDiv = document.createElement('div'); 
  takLayakDiv.className = 'form-check';
  const takLayakInput = document.createElement('input'); 
  takLayakInput.className = 'form-check-input nadi-taklayak'; 
  takLayakInput.type = 'checkbox';
  takLayakDiv.appendChild(takLayakInput); 
  takLayakCell.appendChild(takLayakDiv); 
  row.appendChild(takLayakCell);

  // Kolom 13: TCA & Staff (untuk Layak)
  const tcaLayakCell = document.createElement('td');
  tcaLayakCell.className = 'tca-fields';
  const tcaLayakDate = document.createElement('input'); 
  tcaLayakDate.type='date'; 
  tcaLayakDate.className='form-control form-control-sm tca-layak-date'; 
  tcaLayakDate.disabled=true;
  const tcaLayakTime = document.createElement('input'); 
  tcaLayakTime.type='time'; 
  tcaLayakTime.className='form-control form-control-sm tca-layak-time'; 
  tcaLayakTime.disabled=true;
  const staffLayakInput = document.createElement('input'); 
  staffLayakInput.type='text'; 
  staffLayakInput.className='form-control form-control-sm tca-layak-staff'; 
  staffLayakInput.placeholder='Nama staff'; 
  staffLayakInput.disabled=true;
  tcaLayakCell.appendChild(tcaLayakDate); 
  tcaLayakCell.appendChild(tcaLayakTime); 
  tcaLayakCell.appendChild(staffLayakInput); 
  row.appendChild(tcaLayakCell);

  // Kolom 14: Tindakan
  const actionCell = document.createElement('td');
  actionCell.className = 'action-buttons';
  
  // Button Daftar (untuk Layak)
  const daftarBtn = document.createElement('button'); 
  daftarBtn.className='btn btn-sm btn-outline-primary nadi-daftar'; 
  daftarBtn.disabled=true; 
  daftarBtn.type='button'; 
  daftarBtn.innerHTML='<i class="bi bi-save"></i> Daftar';
  
  // Button Buang
  const buangBtn = document.createElement('button'); 
  buangBtn.className='btn btn-sm btn-outline-danger nadi-buang'; 
  buangBtn.type='button'; 
  buangBtn.innerHTML='<i class="bi bi-trash"></i> Buang';
  
  actionCell.appendChild(daftarBtn);
  actionCell.appendChild(buangBtn);
  row.appendChild(actionCell);

  tbody.appendChild(row);

  // Setup dropdown DXT type
  dxtTypeMenu.querySelectorAll('.dropdown-item').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const val = a.getAttribute('data-value') || 'Fasting';
      dxtTypeHidden.value = val;
      dxtTypeBtn.textContent = val;
    });
  });

  // Fungsi kira BMI
  function calcBMI() {
    const tinggi = parseFloat(tinggiInput.value || '0') / 100;
    const berat = parseFloat(beratInput.value || '0');
    if (tinggi && berat) bmiInput.value = (berat / (tinggi * tinggi)).toFixed(1);
    else bmiInput.value = '';
  }
  tinggiInput.addEventListener('input', calcBMI);
  beratInput.addEventListener('input', calcBMI);

  // Event listeners untuk checkbox Layak/Tidak Layak
  layakInput.addEventListener('change', () => {
    if (layakInput.checked) {
      takLayakInput.checked = false;
      tcaLayakDate.disabled = false; 
      tcaLayakTime.disabled = false; 
      staffLayakInput.disabled = false; 
      daftarBtn.disabled = false;
    } else {
      tcaLayakDate.disabled = true;  
      tcaLayakTime.disabled = true;  
      staffLayakInput.disabled = true;  
      daftarBtn.disabled = true;
    }
  });
  
  takLayakInput.addEventListener('change', () => {
    if (takLayakInput.checked) {
      layakInput.checked = false;
      tcaLayakDate.disabled = true;  
      tcaLayakTime.disabled = true;  
      staffLayakInput.disabled = true;  
      daftarBtn.disabled = true;
    }
  });

  // Button Daftar
  daftarBtn.addEventListener('click', async () => {
    const nama = namaInput.value.trim();
    const ic = icInput.value.trim();
    const tel = telInput.value.trim();
    const date = tcaLayakDate.value;
    const time = tcaLayakTime.value;
    const staff = staffLayakInput.value.trim();
    if (!nama || !ic || !tel || !date || !time || !staff) return toast('Ralat', 'Sila isi semua maklumat untuk pendaftaran', 'danger');
    try {
      const res = await postForm({ 
        action:'daftarPesakit', 
        namaPesakit:nama, 
        noIC:ic, 
        noTelefon:tel, 
        namaStaff:staff, 
        tarikhTCA:date, 
        masaTCA:time 
      }, { msg:'Mendaftar pesakit...' });
      if (res.status === 'success') {
        toast('Berjaya', `Pesakit ${nama} didaftarkan`, 'success');
        [namaInput, icInput, telInput, alamatInput, bpInput, prInput, dxtInput, tinggiInput, beratInput].forEach(i=> i.value='');
        bmiInput.value=''; 
        tcaLayakDate.value=''; 
        tcaLayakTime.value=''; 
        staffLayakInput.value='';
        layakInput.checked=false; 
        takLayakInput.checked=false;
      } else { 
        throw new Error(res.message || 'Gagal mendaftar'); 
      }
    } catch (e) { 
      toast('Ralat', e.message, 'danger'); 
    }
  });

  // Button Buang
  buangBtn.addEventListener('click', () => {
    if (confirm('Adakah anda pasti ingin membuang baris ini?')) row.remove();
  });
}

async function exportNadiCSV() {
  const tbody = document.getElementById('nadiTableBody');
  const rows = Array.from(tbody.querySelectorAll('tr'));
  if (!rows.length) return toast('Makluman', 'Tiada data untuk diexport', 'warning');

  const header = ['Nama','No IC','No Telefon','Alamat','BP','PR','DXT_Tipe','DXT','Tinggi(cm)','Berat(kg)','BMI','Layak','Tidak Layak','TarikhTCA','MasaTCA','Staff'];

  const data = rows.map(row => {
    const v = sel => (row.querySelector(sel) ? row.querySelector(sel).value.trim() : '');
    const yes = sel => (row.querySelector(sel) && row.querySelector(sel).checked) ? 'Ya' : 'Tidak';
    return [
      v('td:nth-child(1) input'),
      v('td:nth-child(2) input'),
      v('td:nth-child(3) input'),
      v('td:nth-child(4) input'),
      v('td:nth-child(5) input'),
      v('td:nth-child(6) input'),
      (row.querySelector('.nadi-dxt-type')?.value || ''),
      v('.nadi-dxt-input'),
      v('td:nth-child(8) input'),
      v('td:nth-child(9) input'),
      v('td:nth-child(10) input'),
      yes('.nadi-layak'),
      yes('.nadi-taklayak'),
      v('.tca-layak-date'),
      v('.tca-layak-time'),
      v('.tca-layak-staff')
    ];
  });

  const csv = [header, ...data].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); 
  a.href = url; 
  a.download = `program_nadi_${new Date().toISOString().slice(0,10)}.csv`; 
  document.body.appendChild(a); 
  a.click(); 
  a.remove();
  URL.revokeObjectURL(url);
  toast('Export', 'Fail CSV telah dimuat turun', 'success');
}

/* =======================
   DATA LOADERS
   ======================= */
async function loadDashboardData(){
  try{
    const data = await getJSON({ action:'getDashboardData' }, { msg:'Memuat Dashboard…' });
    if (data.status==='success'){
      const d = data.data || {};
      document.getElementById('totalDaftar').textContent = d.totalDaftar || 0;
      document.getElementById('totalFirstVisit').textContent = d.totalFirstVisit || 0;
      document.getElementById('totalSecondVisit').textContent = d.totalSecondVisit || 0;
      document.getElementById('totalSelesai').textContent = d.totalSelesai || 0;
      document.getElementById('labFollowUpDue').textContent = d.labFollowUpDue || 0;
      document.getElementById('labFollowUpPending').textContent = d.labFollowUpPending || 0;

      setBadge('badgeTCA', d.totalDaftar);
      setBadge('badgeFirst', d.totalFirstVisit);
      setBadge('badgeSecond', d.totalSecondVisit);
      setBadge('badgeLab', (d.labFollowUpDue||0) + (d.labFollowUpPending||0));
    }
  }catch(e){ toast('Ralat','Gagal memuat data dashboard','danger'); }
}
function setBadge(id,val){
  const el = document.getElementById(id);
  if (!el) return;
  if (val>0){ el.textContent = val; el.style.display='inline-block'; }
  else { el.style.display='none'; }
}

async function loadStatistics(period){
  try{
    const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…' });
    if (data.status==='success'){
      if (stats3dChart) stats3dChart.destroy();
      stats3dChart = buildBarChart('stats3dChart', data.data, `Statistik Pesakit Selesai (${getPeriodLabel(period)})`);
    }
  }catch(e){}
}
async function loadCompletedStatistics(period){
  try{
    const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…' });
    if (data.status==='success'){
      if (completed3dChart) completed3dChart.destroy();
      completed3dChart = buildBarChart('completed3dChart', data.data, `Statistik Pesakit Selesai (${getPeriodLabel(period)})`);
    }
  }catch(e){}
}
function getPeriodLabel(p){ if(p==='3months')return'3 Bulan Terakhir'; if(p==='6months')return'6 Bulan Terakhir'; if(p==='12months')return'12 Bulan Terakhir'; return p; }

async function loadTCACallData(){
  try{
    const data = await getJSON({ action:'getTCACall' }, { msg:'Memuat TCA Hari Ini…' });
    const tb1 = document.getElementById('tcaCallTable');
    if (tb1) tb1.innerHTML = '';
    const renderRow = (p) => {
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      return `
      <tr data-ic="${p.noIC}">
        <td>${p.nama}</td>
        <td>${p.noIC}</td>
        <td class="mini-actions">
          <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          <div class="small text-muted mt-1">${msisdn}</div>
        </td>
        <td>${p.tarikhTCA}</td>
        <td><span class="badge ${p.status==='CALLED'?'bg-success':'bg-warning'}">${p.status || 'PENDING'}</span></td>
      </tr>`;
    };
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{ if (tb1) tb1.insertAdjacentHTML('beforeend', renderRow(p)); });
    } else {
      if (tb1) tb1.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tiada pesakit perlu dihubungi hari ini</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

/* === TCA PAGE === */
let TCA_ALL = [];
async function loadTCACallPage(){
  try{
    const res = await getJSON({ action:'getTCACall', all:1 }, { msg:'Memuat rekod TCA…' });
    TCA_ALL = (res.status==='success') ? (res.data||[]) : [];
    renderTcaList('today');
  }catch(e){ renderTcaList('all'); }
  document.querySelectorAll('#tcaFilter [data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#tcaFilter [data-filter]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderTcaList(btn.getAttribute('data-filter'));
    });
  });
}
function renderTcaList(mode){
  const tbody = document.getElementById('tcaCallList');
  if (!tbody) return;
  tbody.innerHTML = '';
  const today = new Date(); today.setHours(0,0,0,0);

  const filtered = TCA_ALL.filter(p=>{
    const d = parseDDMMYYYY(p.tarikhTCA);
    if (!d) return mode==='all';
    d.setHours(0,0,0,0);
    if (mode==='today') return isSameDay(d, today);
    if (mode==='upcoming') return d.getTime() > today.getTime();
    if (mode==='past') return d.getTime() < today.getTime();
    return true;
  });

  if (!filtered.length){
    tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tiada rekod untuk paparan ini.</td></tr>`;
    return;
  }

  filtered.forEach(p=>{
    const msisdn = normalizeMsisdnMY(p.noTelefon||'');
    const d = parseDDMMYYYY(p.tarikhTCA);
    const badgeCls = p.status==='CALLED' ? 'bg-success' : ((d && d.getTime()<today.getTime()) ? 'bg-secondary' : 'bg-warning');
    const label = p.status==='CALLED' ? 'CALLED' : ((d && d.getTime()<today.getTime()) ? 'LEPAS' : (d && isSameDay(d, today) ? 'HARI INI' : 'AKAN DATANG'));
    const row = `
      <tr data-ic="${p.noIC}">
        <td>${p.nama}</td>
        <td>${p.noIC}</td>
        <td class="mini-actions">
          <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          <div class="small text-muted mt-1">${msisdn}</div>
        </td>
        <td>${p.tarikhTCA||'-'}</td>
        <td><span class="badge ${badgeCls}">${label}</span></td>
      </tr>`;
    tbody.insertAdjacentHTML('beforeend', row);
  });
}

async function loadFirstVisitData(){
  try{
    const data = await getJSON({ action:'getFirstVisit' }, { msg:'Memuat First Visit…' });
    const tbody = document.getElementById('firstVisitList');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const hadir = p.status==='HADIR';
        const within = isWithin24hOfDate(p.tarikhTCA);
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        let pdpaHTML = '';
        if (p.pdpaFileId){
          pdpaHTML = `
            <div class="d-flex flex-wrap gap-1">
              <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
              <button class="btn btn-sm btn-outline-danger" type="button" onclick="deletePDPA('${p.noIC}')"><i class="fa-solid fa-trash"></i> Padam</button>
            </div>`;
        } else {
          pdpaHTML = hadir ? `<button class="btn btn-sm btn-outline-primary" type="button" onclick="openPDPA('${p.noIC}')"><i class="fa-solid fa-file-arrow-up"></i> Upload</button>` : `<span class="text-muted">-</span>`;
        }

        const row = `
        <tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td>${p.tarikhTCA||'-'}</td>
          <td>${pdpaHTML}</td>
          <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
          <td class="mini-actions">
            ${within && !hadir ? `<button class="btn btn-sm btn-success" type="button" onclick="markFirstVisit('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
            ${!hadir ? `<button class="btn btn-sm btn-primary" type="button" onclick="openRetcaModal('${p.noIC}')"><i class="fa-solid fa-calendar-plus"></i> Re-TCA</button>` : ''}
            ${msisdn ? `
              <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
              <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
          </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada data First Visit</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}
function isWithin24hOfDate(dateStr){
  const d = parseDDMMYYYY(dateStr);
  if (!d) return false;
  const start = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
  const end = new Date(start.getTime() + 24*60*60*1000);
  const now = new Date();
  return now >= start && now < end;
}

async function loadLabFollowUp(){
  try{
    const data = await getJSON({ action:'getLabFollowUp' }, { msg:'Memuat Follow-up Lab…' });
    const tbody = document.getElementById('labFollowupTable');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        const badge = p.labStatus==='DONE' ? 'bg-success' : (p.labStatus==='REPEAT' ? 'bg-danger' : (p.labStatus==='IN_PROCESS' ? 'bg-warning' : 'bg-secondary'));
        const label = p.labStatus || 'PENDING';
        const row = `
        <tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td class="mini-actions">
            <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
            <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn,'Keputusan makmal anda telah siap.')}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
            <div class="small text-muted mt-1">${msisdn}</div>
          </td>
          <td>${p.firstVisitDate}</td>
          <td>${p.daysSince}</td>
          <td><span class="badge ${badge}">${label}</span></td>
          <td class="mini-actions">
            <button class="btn btn-sm btn-success" type="button" onclick="openSecondTca('${p.noIC}')"><i class="fa-solid fa-square-check"></i> Result complete & berjaya call</button>
            <button class="btn btn-sm btn-warning" type="button" onclick="markLabStatus('${p.noIC}','IN_PROCESS')"><i class="fa-solid fa-hourglass-half"></i> In process</button>
            <button class="btn btn-sm btn-danger" type="button" onclick="markLabStatus('${p.noIC}','REPEAT')"><i class="fa-solid fa-rotate-left"></i> Repeat sample</button>
          </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada pesakit untuk follow-up.</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

async function loadSecondVisitData(){
  try{
    const data = await getJSON({ action:'getSecondVisit' }, { msg:'Memuat Second Visit…' });
    const tbody = document.getElementById('secondVisitList');
    tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const hadir = p.status==='HADIR';
        const within = isWithin24hOfDate(p.tarikhTCA);
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        const pdpaHTML = p.pdpaFileId
          ? `<div class="d-flex flex-wrap gap-1">
              <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
            </div>`
          : `<span class="text-danger">PDPA tiada</span>`;

        const row = `
        <tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td>${p.tarikhTCA||'-'}</td>
          <td>${pdpaHTML}</td>
          <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
          <td class="mini-actions">
            ${within && !hadir ? `<button class="btn btn-sm btn-success" type="button" onclick="markSecondVisitHadir('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
            ${msisdn ? `
              <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
              <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
          </td>
        </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada data Second Visit</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

async function loadCompletedData(){
  try{
    const data = await getJSON({ action:'getCompleted' }, { msg:'Memuat Selesai…' });
    const tbody = document.getElementById('completedTable');
    if (tbody) tbody.innerHTML = '';

    if (data.status === 'success' && Array.isArray(data.data) && data.data.length > 0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon || '');
        const hasPDPA = !!p.pdpaFileId;
        const pdpaHTML = hasPDPA
          ? `<div class="d-flex flex-wrap gap-1">
               <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
               <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
             </div>`
          : `<span class="badge bg-secondary">Tiada</span>`;

        const row = `
          <tr data-ic="${p.noIC}">
            <td>${p.nama || '-'}</td>
            <td>${p.noIC || '-'}</td>
            <td>${msisdn || '-'}</td>
            <td data-has-pdpa="${hasPDPA?1:0}">${pdpaHTML}</td>
            <td>${p.tarikhDaftar || '-'}</td>
            <td>${p.firstVisitDate || '-'}</td>
            <td>${p.labCompletedDate || '-'}</td>
            <td>${p.secondVisitDate || '-'}</td>
            <td>${p.tarikhSelesai || '-'}</td>
            <td class="mini-actions">
              ${msisdn ? `
                <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
                <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
              <button class="btn btn-sm btn-outline-warning" type="button" onclick="archivePatient('${p.noIC}')">
                <i class="fa-solid fa-box-archive"></i> Arkib
              </button>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    } else {
      if (tbody) tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">Tiada data selesai.</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

async function loadArchivedData(){
  try{
    const data = await getJSON({ action:'getArchived' }, { msg:'Memuat Arkib…' });
    const tbody = document.getElementById('archiveTable');
    if (tbody) tbody.innerHTML = '';
    if (data.status === 'success' && Array.isArray(data.data) && data.data.length){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon || '');
        const row = `
          <tr data-ic="${p.noIC}">
            <td>${p.nama || '-'}</td>
            <td>${p.noIC || '-'}</td>
            <td>${msisdn || '-'}</td>
            <td>${p.tarikhDaftar || '-'}</td>
            <td>${p.tarikhSelesai || '-'}</td>
            <td>${p.tarikhArkib || '-'}</td>
            <td class="mini-actions">
              <button class="btn btn-sm btn-outline-secondary" type="button" onclick="unarchivePatient('${p.noIC}')">
                <i class="fa-solid fa-rotate-left"></i> Pulihkan
              </button>
            </td>
          </tr>`;
        tbody.insertAdjacentHTML('beforeend', row);
      });
    }else{
      if (tbody) tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data arkib.</td></tr>`;
    }
  }catch(e){ /* senyap */ }
}

/* =======================
   TINDAKAN / SIMPANAN
   ======================= */
async function daftarPesakit(){
  const nama = document.getElementById('namaPesakit').value.trim();
  const ic   = document.getElementById('noIC').value.trim();
  const tel  = normalizeMsisdnMY(document.getElementById('noTelefon').value.trim());
  const staff= document.getElementById('namaStaff').value.trim();
  const tcaD = document.getElementById('tarikhTCA').value;
  const tcaT = document.getElementById('masaTCA').value;

  if (!nama || !ic || !tel || !staff || !tcaD || !tcaT){
    toast('Ralat','Sila isi semua ruangan pendaftaran.','danger'); return;
  }
  try{
    const res = await postForm({
      action:'daftarPesakit',
      namaPesakit:nama, noIC:ic, noTelefon:tel,
      namaStaff:staff, tarikhTCA:tcaD, masaTCA:tcaT
    }, { msg:'Mendaftar pesakit…' });
    if (res.status === 'success'){
      toast('Berjaya', `Pesakit ${nama} didaftarkan ke TCA`, 'success');
      document.getElementById('formPendaftaran').reset();
      loadDashboardData(); loadTCACallData(); loadTCACallPage();
    } else throw new Error(res.message || 'Gagal daftar');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

function openRetcaModal(ic){
  document.getElementById('retcaIC').value = ic;
  document.getElementById('retcaDate').value = '';
  document.getElementById('retcaTime').value = '';
  retcaModal.show();
}
async function submitRetca(){
  const ic = document.getElementById('retcaIC').value;
  const d  = document.getElementById('retcaDate').value;
  const t  = document.getElementById('retcaTime').value;
  if (!ic || !d || !t){ toast('Ralat','Sila isi tarikh & masa TCA baharu.','danger'); return; }
  try{
    const res = await postForm({ action:'retca', noIC:ic, tarikhTCA:d, masaTCA:t }, { msg:'Menyimpan Re-TCA…' });
    if (res.status === 'success'){
      toast('Berjaya','Re-TCA disimpan. Status ditukar kepada TCA CALL.','success');
      retcaModal.hide();
      loadFirstVisitData(); loadTCACallData(); loadTCACallPage(); refreshLogs();
    }else throw new Error(res.message || 'Gagal simpan');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

function openSecondTca(ic){
  document.getElementById('secondTcaIC').value = ic;
  document.getElementById('secondTcaDate').value = '';
  document.getElementById('secondTcaTime').value = '';
  document.getElementById('secondTcaStaff').value = '';
  secondTcaModal.show();
}
async function submitSecondTca(){
  const ic    = document.getElementById('secondTcaIC').value;
  const d     = document.getElementById('secondTcaDate').value;
  const t     = document.getElementById('secondTcaTime').value;
  const staff = document.getElementById('secondTcaStaff').value.trim();
  if (!ic || !d || !t || !staff){ toast('Ralat','Isi tarikh, masa & nama staff.','danger'); return; }
  try{
    const res = await postForm({
      action:'setSecondTca', noIC:ic, tarikhTCA:d, masaTCA:t, namaStaff:staff
    }, { msg:'Menyimpan Second Visit…' });
    if (res.status === 'success'){
      toast('Berjaya','TCA Second Visit ditetapkan.','success');
      secondTcaModal.hide();
      loadLabFollowUp(); loadSecondVisitData(); refreshLogs();
    }else throw new Error(res.message || 'Gagal simpan');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

async function markLabStatus(ic, status){
  try{
    const res = await postForm({ action:'markLabStatus', noIC:ic, status }, { msg:'Mengemaskini status lab…' });
    if (res.status === 'success'){
      toast('Berjaya','Status lab dikemaskini.','success');
      loadLabFollowUp(); loadDashboardData();
    }else throw new Error(res.message || 'Gagal kemaskini');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

async function markFirstVisit(ic){
  try{
    const res = await postForm({ action:'markFirstVisit', noIC:ic }, { msg:'Menandakan First Visit hadir…' });
    if (res.status === 'success'){
      toast('Berjaya','First Visit ditandakan hadir.','success');
      loadFirstVisitData(); loadLabFollowUp(); loadDashboardData();
    }else throw new Error(res.message || 'Gagal kemaskini');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

async function markSecondVisitHadir(ic){
  try{
    const res = await postForm({ action:'markSecondVisitHadir', noIC:ic }, { msg:'Menandakan Second Visit hadir…' });
    if (res.status === 'success'){
      toast('Berjaya','Second Visit ditandakan hadir.','success');
      loadSecondVisitData(); loadCompletedData(); loadDashboardData();
    }else throw new Error(res.message || 'Gagal kemaskini');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

function openPDPA(ic){
  document.getElementById('pdpaIC').value = ic;
  document.getElementById('pdpaFile').value = '';
  pdpaModal.show();
}
async function uploadPDPA(){
  const ic   = document.getElementById('pdpaIC').value;
  const file = document.getElementById('pdpaFile').files[0];
  if (!ic || !file){ toast('Ralat','Pilih fail PDPA dahulu.','danger'); return; }

  // Tukar ke base64 (tanpa header data:)
  const toBase64 = (f)=> new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = ()=> resolve(String(reader.result).split(',')[1] || '');
    reader.onerror = reject;
    reader.readAsDataURL(f);
  });

  try{
    const base64 = await toBase64(file);
    const res = await postForm({
      action:'uploadPDPA', noIC:ic, fileName:file.name, mimeType:file.type, data:base64
    }, { msg:'Memuat naik PDPA…' });
    if (res.status === 'success'){
      toast('Berjaya','Fail PDPA dimuat naik.','success');
      pdpaModal.hide();
      loadFirstVisitData(); loadSecondVisitData(); loadCompletedData();
    }else throw new Error(res.message || 'Gagal muat naik');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
async function deletePDPA(ic){
  if (!confirm('Padam fail PDPA untuk pesakit ini?')) return;
  try{
    const res = await postForm({ action:'deletePDPA', noIC:ic }, { msg:'Memadam PDPA…' });
    if (res.status === 'success'){
      toast('Berjaya','Fail PDPA dipadam.','success');
      loadFirstVisitData(); loadSecondVisitData(); loadCompletedData();
    }else throw new Error(res.message || 'Gagal padam');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

async function archivePatient(ic){
  if (!confirm('Arkibkan rekod pesakit ini?')) return;
  try{
    const res = await postForm({ action:'archivePatient', noIC:ic }, { msg:'Mengarkibkan rekod…' });
    if (res.status === 'success'){
      toast('Berjaya','Rekod dipindahkan ke Arkib.','success');
      loadCompletedData(); loadArchivedData(); loadDashboardData();
    }else throw new Error(res.message || 'Gagal arkib');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
async function unarchivePatient(ic){
  try{
    const res = await postForm({ action:'unarchivePatient', noIC:ic }, { msg:'Memulihkan rekod…' });
    if (res.status === 'success'){
      toast('Berjaya','Rekod dipulihkan ke aktif.','success');
      loadArchivedData(); loadDashboardData();
    }else throw new Error(res.message || 'Gagal pulih');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

/* =======================
   EXPORTS (CSV)
   ======================= */
function exportCompletedCSV(){
  const tbody = document.getElementById('completedTable');
  if (!tbody){ toast('Makluman','Tiada data untuk dieksport.','warning'); return; }
  const rows = Array.from(tbody.querySelectorAll('tr'));
  if (!rows.length || rows[0].querySelectorAll('td').length === 1){
    toast('Makluman','Tiada data selesai untuk dieksport.','warning'); return;
  }

  const header = [
    'Nama Pesakit','No IC','No Telefon','PDPA',
    'Tarikh Daftar','First Visit','Lab Report Completed','Second Visit','Tarikh Selesai'
  ];
  const toRow = (tr)=>{
    const tds = Array.from(tr.querySelectorAll('td'));
    const pdpa = (tds[3]?.getAttribute('data-has-pdpa') === '1') ? 'Ada' : 'Tiada';
    return [
      tds[0]?.innerText?.trim() || '',
      tds[1]?.innerText?.trim() || '',
      tds[2]?.innerText?.trim() || '',
      pdpa,
      tds[4]?.innerText?.trim() || '',
      tds[5]?.innerText?.trim() || '',
      tds[6]?.innerText?.trim() || '',
      tds[7]?.innerText?.trim() || '',
      tds[8]?.innerText?.trim() || ''
    ];
  };
  const data = rows.map(toRow);
  const csv = [header, ...data].map(r=>r.map(c=>`"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `completed_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
  toast('Export','Fail CSV (Selesai) telah dimuat turun.','success');
}

/* =======================
   MULA (LOGIN)
   ======================= */
document.addEventListener('DOMContentLoaded', initGoogleSignIn);
</script>
</body>
</html>
