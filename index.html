<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

<meta http-equiv="Cross-Origin-Opener-Policy" content="same-origin-allow-popups">
<meta http-equiv="Cross-Origin-Embedder-Policy" content="unsafe-none">

<title>Sistem Tracker PEKA B40 - Klinik SihatSokmo</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.19.3/dist/xlsx.full.min.js"></script>
<script src="https://accounts.google.com/gsi/client" async defer></script>

<style>
:root{
  --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12;
  --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6;
}
html{ font-size:15px; }
@media (max-width:1200px){ html{ font-size:14px; } }
@media (max-width:576px){ html{ font-size:13px; } }

body{background:#f5f7fa;color:#333;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif}

/* Navbar */
.navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
.navbar-brand{font-weight:700;color:var(--primary);font-size:1.05rem;display:flex;align-items:center;gap:10px}
.nav-link{color:var(--dark);font-weight:500;margin:0 4px;padding:7px 10px!important;border-radius:8px}
.nav-link:hover,.nav-link.active{background:rgba(52,152,219,.12);color:var(--secondary)}
.nav-badge{position:absolute;top:-4px;right:-2px;background:#dc3545;color:#fff;border-radius:999px;font-size:.65rem;padding:2px 6px;display:none}

/* Header */
.page-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:14px 0;margin-bottom:12px;border-radius:0 0 12px 12px}

/* Cards */
.card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:16px}
.card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;padding:12px 16px;border-radius:14px 14px 0 0!important}
.table td,.table th{vertical-align:middle}

/* Loader */
#appLoader{position:fixed;inset:0;z-index:2000;display:none;background:rgba(255,255,255,.5);backdrop-filter:blur(5px)}
#appLoader .loader-card{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:#fff;border-radius:14px;padding:16px 18px;min-width:220px;box-shadow:0 20px 40px rgba(0,0,0,.12);text-align:center}
.spinner-premium{width:36px;height:36px;border-radius:50%;border:4px solid rgba(52,152,219,.25);border-top-color:#3498db;animation:spin .9s linear infinite;margin:6px auto 8px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Log Calls Drawer */
#logDrawer{position:fixed;top:0;right:-420px;width:400px;max-width:90vw;height:100%;background:#f8f9fb;box-shadow:-12px 0 35px rgba(0,0,0,.18);z-index:3000;transition:right .25s ease;border-left:1px solid rgba(0,0,0,.05);display:flex;flex-direction:column}
#logDrawer.open{right:0}
.log-header{padding:10px 12px;background:#fff;border-bottom:1px solid rgba(0,0,0,.06);display:flex;gap:8px;align-items:center}
.log-body{padding:10px;overflow:auto;flex:1;display:flex;flex-direction:column;gap:8px}
.bubble{max-width:80%;padding:8px 10px;border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.06);font-size:.9rem}
.bubble.me{margin-left:auto;background:#007aff;color:#fff;border-bottom-right-radius:6px}
.bubble.other{margin-right:auto;background:#e9ecef;color:#222;border-bottom-left-radius:6px}
.bubble .meta{font-size:.72rem;opacity:.8;margin-top:5px}

/* FAB Log Calls */
#fabLog{position:fixed;right:18px;bottom:18px;z-index:3500;width:56px;height:56px;border-radius:50%;display:flex;align-items:center;justify-content:center;box-shadow:0 10px 24px rgba(0,0,0,.18)}

/* Toast (kanan atas) */
#toastHost{position:fixed;top:12px;right:12px;z-index:4000;pointer-events:none}
#toastHost .toast{pointer-events:auto}

/* ————— NADI (gaya v2.5.0) ————— */
.nadi-toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.nadi-toolbar .spacer{flex:1}
.nadi-wrap .table-responsive{border:1px solid rgba(0,0,0,.06);border-radius:10px}
table.nadi-table{min-width:1400px}
table.nadi-table thead th{white-space:nowrap}
table.nadi-table td input, table.nadi-table td .form-select, table.nadi-table td .btn{width:100%}
table.nadi-table td .btn-icon{width:auto}
table.nadi-table td .small-note{font-size:.75rem;color:#6c757d}
.nadi-min{min-width:140px}
.nadi-min-lg{min-width:200px}
.nadi-alamat{min-width:260px}
.nadi-center{text-align:center}

/* DXT dropdown */
.nadi-dxt-wrap .dropdown-toggle{width:100%}

/* Search bar */
.searchbar{max-width:340px}
</style>
</head>
<body>
<div id="appLoader" aria-hidden="true">
  <div class="loader-card">
    <div class="spinner-premium"></div>
    <div class="fw-bold">Sila tunggu…</div>
    <div class="text-muted small" id="loaderMsg">Memproses permintaan anda</div>
  </div>
</div>

<!-- Log Drawer -->
<div id="logDrawer" aria-hidden="true">
  <div class="log-header">
    <button class="btn btn-sm btn-outline-secondary" id="btnCloseLog"><i class="bi bi-x-lg"></i></button>
    <div class="fw-bold">Log Calls</div>
    <div id="logBadge" class="badge text-bg-primary">0</div>
  </div>
  <div class="p-2 border-bottom bg-white">
    <input id="logSearch" class="form-control form-control-sm" placeholder="Cari: nama / IC / telefon / staff…">
  </div>
  <div id="logBody" class="log-body"></div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-main sticky-top">
  <div class="container">
    <a class="navbar-brand" href="#dashboard">
      <img id="brandLogo" alt="Logo" style="width:32px;height:32px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,.08)">
      <span>Klinik SihatSokmo</span>
    </a>
    <div id="signinArea" class="d-lg-none me-2"></div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain"><span class="navbar-toggler-icon"></span></button>
    <div class="collapse navbar-collapse" id="navbarMain">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <li class="nav-item position-relative"><a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#nadi"><i class="bi bi-clipboard2-pulse"></i> Program PEKA B40 bersama NADI</a></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a><span id="badgeTCA" class="nav-badge">0</span></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a><span id="badgeFirst" class="nav-badge">0</span></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab Report</a><span id="badgeLab" class="nav-badge">0</span></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a><span id="badgeSecond" class="nav-badge">0</span></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a></li>
        <li class="nav-item position-relative"><a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a></li>
      </ul>
      <div class="d-none d-lg-flex align-items-center gap-2">
        <div id="signinAreaDesktop"></div>
        <span id="staffBadge" class="badge bg-secondary d-none"><i class="bi bi-person-check me-1"></i><span id="staffEmail"></span></span>
      </div>
    </div>
  </div>
</nav>

<header class="page-header">
  <div class="container">
    <div class="row align-items-center g-2">
      <div class="col-md-6">
        <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
        <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
      </div>
      <div class="col-md-6 text-md-end">
        <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
      </div>
    </div>
  </div>
</header>

<main class="container">

  <!-- Dashboard (ringkas – kekal) -->
  <section id="dashboard" class="mb-4">
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi Hari Ini</span>
        <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefon…">
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
            <tbody id="tcaCallTable"><tr><td colspan="5" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-6 col-md-2"><div class="card text-center p-3"><div class="fw-bold" id="totalDaftar">0</div><div class="text-muted small">Aktif</div></div></div>
      <div class="col-6 col-md-2"><div class="card text-center p-3"><div class="fw-bold" id="totalFirstVisit">0</div><div class="text-muted small">First Visit (Pending)</div></div></div>
      <div class="col-6 col-md-2"><div class="card text-center p-3"><div class="fw-bold" id="totalSecondVisit">0</div><div class="text-muted small">Second Visit (Pending)</div></div></div>
      <div class="col-6 col-md-2"><div class="card text-center p-3"><div class="fw-bold" id="totalSelesai">0</div><div class="text-muted small">Selesai</div></div></div>
      <div class="col-6 col-md-2"><div class="card text-center p-3"><div class="fw-bold" id="labFollowUpDue">0</div><div class="text-muted small">Result > 3 Hari</div></div></div>
      <div class="col-6 col-md-2"><div class="card text-center p-3"><div class="fw-bold" id="labFollowUpPending">0</div><div class="text-muted small">Perlu Follow-up</div></div></div>
    </div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
        <select id="statPeriod" class="form-select form-select-sm" style="max-width:200px">
          <option value="3months">3 Bulan Terakhir</option>
          <option value="6months">6 Bulan Terakhir</option>
          <option value="12months">12 Bulan Terakhir</option>
        </select>
      </div>
      <div class="card-body"><div style="height:320px;"><canvas id="stats3dChart"></canvas></div></div>
    </div>
  </section>

  <!-- =============== NADI (gaya v2.5.0) =============== -->
  <section id="nadi" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="bi bi-clipboard2-pulse me-2"></i>Program PEKA B40 bersama NADI</h2>
      <div class="nadi-toolbar">
        <button id="btnNadiAddRow" class="btn btn-sm btn-primary"><i class="fa-solid fa-plus me-1"></i>Tambah Baris</button>
        <button id="btnNadiExportCsv" class="btn btn-sm btn-outline-success"><i class="bi bi-filetype-csv me-1"></i>Transfer kepada Excel (CSV)</button>
      </div>
    </div>

    <div class="card nadi-wrap">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle nadi-table">
            <thead class="table-light">
              <tr>
                <th class="nadi-min-lg">Nama</th>
                <th class="nadi-min">IC</th>
                <th class="nadi-min">Telefon</th>
                <th class="nadi-alamat">Alamat</th>
                <th class="nadi-min">BP</th>
                <th class="nadi-min">PR</th>
                <th class="nadi-min">DXT (Jenis)</th>
                <th class="nadi-min">DXT (mmol/L)</th>
                <th class="nadi-min">Tinggi (cm)</th>
                <th class="nadi-min">Berat (kg)</th>
                <th class="nadi-min">BMI</th>
                <th class="nadi-center">Layak?</th>
                <th class="nadi-min">Tarikh TCA</th>
                <th class="nadi-min">Masa TCA</th>
                <th class="nadi-min">Staff</th>
                <th style="min-width:220px">Tindakan</th>
              </tr>
            </thead>
            <tbody id="nadiTbody">
              <!-- baris dinamik -->
            </tbody>
          </table>
        </div>
        <div class="text-muted small mt-2">Nota: Baris “Tidak Layak” tidak disimpan ke sheet tetapi tetap akan dieksport ke CSV. Hanya baris “Layak” yang didaftarkan ke sheet apabila ditekan butang <b>Daftar</b>.</div>
      </div>
    </div>
  </section>

  <!-- Kelayakan (Excel) -->
  <section id="kelayakan" class="mb-4 d-none">
    <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel)</h2>
    <div class="card"><div class="card-body">
      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-6">
          <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls">
          <div class="form-text">Fail perlu ada lajur: <b>Nama</b>, <b>IC</b>, <b>Telefon</b>. (Sistem tapis umur ≥40 ikut IC)</div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama</th><th>IC</th><th>Telefon</th>
              <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
              <th style="width:360px">Jika Layak → TCA & Masa & Staff</th><th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="kelayakanTable"><tr><td colspan="7" class="text-center text-muted">Muat naik Excel untuk mula.</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- TCA Call (rekod senarai) -->
  <section id="tca-call" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-phone me-2"></i>Senarai Rekod TCA Call</h2>
      <div class="d-flex align-items-center gap-2">
        <div class="btn-group btn-group-sm" role="group" id="tcaFilter">
          <button class="btn btn-outline-primary active" data-filter="today">Hari ini</button>
          <button class="btn btn-outline-primary" data-filter="upcoming">Akan datang</button>
          <button class="btn btn-outline-primary" data-filter="past">Lepas</button>
          <button class="btn btn-outline-secondary" data-filter="all">Semua</button>
        </div>
        <input class="form-control form-control-sm searchbar" id="searchTCAPage" placeholder="Cari nama/IC/telefon…">
      </div>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh TCA</th><th>Status</th></tr></thead>
          <tbody id="tcaCallList"><tr><td colspan="5" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- First Visit -->
  <section id="first-visit" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
      <input class="form-control form-control-sm searchbar" id="searchFirst" placeholder="Cari nama/IC/telefon…">
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
          <tbody id="firstVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Follow-up Lab Report -->
  <section id="lab-followup" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
      <input class="form-control form-control-sm searchbar" id="searchLab" placeholder="Cari nama/IC/telefon…">
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th><th>Tindakan</th></tr>
          </thead>
          <tbody id="labFollowupTable"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Second Visit -->
  <section id="second-visit" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
      <input class="form-control form-control-sm searchbar" id="searchSecond" placeholder="Cari nama/IC/telefon…">
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
          <tbody id="secondVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Selesai -->
  <section id="selesai" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
      <input class="form-control form-control-sm searchbar" id="searchCompleted" placeholder="Cari nama/IC/telefon…">
    </div>
    <div class="card mb-3"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>PDPA</th>
              <th>Tarikh Daftar</th><th>First Visit</th><th>Lab Report Completed</th><th>Second Visit</th><th>Tarikh Selesai</th><th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="completedTable"><tr><td colspan="10" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
        <select id="statPeriodCompleted" class="form-select form-select-sm" style="max-width:200px">
          <option value="3months">3 Bulan Terakhir</option>
          <option value="6months">6 Bulan Terakhir</option>
          <option value="12months">12 Bulan Terakhir</option>
        </select>
      </div>
      <div class="card-body"><div style="height:300px;"><canvas id="completed3dChart"></canvas></div></div>
    </div>
  </section>

  <!-- Arkib -->
  <section id="arkib" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
      <input class="form-control form-control-sm searchbar" id="searchArchive" placeholder="Cari nama/IC/telefon…">
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th><th>Tindakan</th></tr></thead>
          <tbody id="archiveTable"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

</main>

<!-- Modals (Re-TCA / Second-TCA / PDPA) -->
<div class="modal fade" id="retcaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Daftar TCA Semula</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="hidden" id="retcaIC">
      <div class="mb-3"><label class="form-label">Tarikh TCA Baharu</label><input type="date" id="retcaDate" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Masa TCA Baharu</label><input type="time" id="retcaTime" class="form-control" required></div>
      <small class="text-muted">Status pesakit akan ditukar kepada <b>TCA CALL</b>.</small>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary" id="btnSubmitRetca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button></div>
  </div></div>
</div>

<div class="modal fade" id="secondTcaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-calendar-check me-2"></i>Tetapkan TCA Second Visit</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="hidden" id="secondTcaIC">
      <div class="mb-2"><label class="form-label">Tarikh TCA Second Visit</label><input type="date" id="secondTcaDate" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Masa TCA</label><input type="time" id="secondTcaTime" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Nama Staff (wajib isi)</label><input type="text" id="secondTcaStaff" class="form-control" required placeholder="cth: Dayah"></div>
      <small class="text-muted">Maklumat ini akan direkod ke Log Calls & ruangan “Lab Report Completed”.</small>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button><button class="btn btn-primary" id="btnSubmitSecondTca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button></div>
  </div></div>
</div>

<div class="modal fade" id="pdpaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header"><h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i>Muat Naik Borang PDPA</h5><button class="btn-close" data-bs-dismiss="modal"></button></div>
    <div class="modal-body">
      <input type="hidden" id="pdpaIC">
      <input type="file" id="pdpaFile" class="form-control" accept="application/pdf,image/*">
      <div class="form-text">Muat naik PDF / imej borang PDPA pesakit.</div>
    </div>
    <div class="modal-footer"><button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button><button class="btn btn-primary" id="btnUploadPDPA"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload</button></div>
  </div></div>
</div>

<!-- Toast Host -->
<div id="toastHost"><div id="toastContainer" class="toast-container"></div></div>

<!-- FAB Log Calls -->
<button id="fabLog" class="btn btn-primary"><i class="bi bi-chat-dots fs-5"></i></button>

<footer class="footer mt-4 py-3 bg-light">
  <div class="container"><div class="d-flex justify-content-between">
    <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
    <div>Versi 3.2 (UI NADI v2.5.0)</div>
  </div></div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* =======================
   KONFIG (EDIT INI SAHAJA)
======================= */
const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6TKE0vDDPO3-36cY7xjacAbGL0HIRKCrORNm-sED9y5NpIeIUk9gyrpiWy-S7vbc/exec';
const GOOGLE_CLIENT_ID = '863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com';
const LOGO_URL = 'https://github.com/sihat9/mari-jalan-dengan-doktor/blob/main/img/logo-kss.png?raw=true';

/* =======================
   AUTH (Google Identity)
======================= */
let ID_TOKEN = '';
let STAFF_EMAIL = '';

function initGoogleSignIn(){
  google.accounts.id.initialize({
    client_id: GOOGLE_CLIENT_ID,
    callback: handleCredentialResponse,
    auto_select: false, cancel_on_tap_outside: true
  });
  google.accounts.id.renderButton(document.getElementById('signinArea'), { theme:'outline', size:'medium', text:'signin_with' });
  google.accounts.id.renderButton(document.getElementById('signinAreaDesktop'), { theme:'outline', size:'medium', text:'signin_with' });
}
async function handleCredentialResponse(resp){
  ID_TOKEN = resp.credential;
  const r = await fetch(SCRIPT_URL, {
    method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
    body: new URLSearchParams({ action:'whoami', id_token: ID_TOKEN })
  });
  const j = await r.json();
  if (j.status === 'success'){
    STAFF_EMAIL = j.email || '';
    document.getElementById('staffBadge').classList.remove('d-none');
    document.getElementById('staffEmail').textContent = STAFF_EMAIL;
    document.getElementById('signinArea').innerHTML = '';
    document.getElementById('signinAreaDesktop').innerHTML = '';
    bootstrapApp();
  } else {
    toast('Akses Ditolak', j.message || 'Sila hubungi admin untuk allowlist.', 'danger');
    ID_TOKEN = ''; STAFF_EMAIL = '';
  }
}

/* Loader */
let loaderTimer=null;
function showLoader(msg='Memproses…'){ document.getElementById('loaderMsg').textContent=msg; document.getElementById('appLoader').style.display='block'; clearTimeout(loaderTimer); loaderTimer=setTimeout(hideLoader, 2000); }
function hideLoader(){ document.getElementById('appLoader').style.display='none'; }

/* HTTP helpers */
async function getJSON(params={}, {silent=false, msg='Memuat data…'}={}){
  if(!ID_TOKEN) throw new Error('Belum login');
  const qs = new URLSearchParams({ ...params, id_token: ID_TOKEN }).toString();
  const url = `${SCRIPT_URL}?${qs}`;
  if(!silent) showLoader(msg);
  try{
    const r = await Promise.race([ fetch(url), new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),12000)) ]);
    return await r.json();
  } finally { if(!silent) hideLoader(); }
}
async function postForm(params={}, {silent=false, msg='Menyimpan data…'}={}){
  if(!ID_TOKEN) throw new Error('Belum login');
  if(!silent) showLoader(msg);
  try{
    const r = await Promise.race([
      fetch(SCRIPT_URL,{ method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body:new URLSearchParams({ ...params, id_token: ID_TOKEN }) }),
      new Promise((_,rej)=>setTimeout(()=>rej(new Error('Timeout')),12000))
    ]);
    return await r.json();
  } finally { if(!silent) hideLoader(); }
}

/* Util */
const normalizeMsisdnMY = (raw) => {
  if (!raw) return '';
  let s = String(raw).replace(/\D/g,'');
  if (s.startsWith('00')) s = s.slice(2);
  if (s.startsWith('60')) return s;
  if (s.startsWith('0')) return '60' + s.slice(1);
  return '60' + s;
};
const telHref = (msisdn) => `tel:+${msisdn}`;
const waHrefWeb = (msisdn, txt='Assalamualaikum, ini dari Klinik SihatSokmo.') => `https://wa.me/${msisdn}?text=${encodeURIComponent(txt)}`;
const parseDDMMYYYY = (s) => {
  if (!s) return null;
  if (/^\d{4}-\d{2}-\d{2}$/.test(s)) { const [Y,M,D]=s.split('-').map(Number); return new Date(Y,M-1,D); }
  const m = /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/.exec(s);
  if (!m) return null; const D=+m[1], M=+m[2], Y=+m[3]; return new Date(Y,M-1,D);
};
function isSameDay(a,b){ return a.getFullYear()==b.getFullYear() && a.getMonth()==b.getMonth() && a.getDate()==b.getDate(); }
function toast(title, message, variant='primary'){
  const container = document.getElementById('toastContainer');
  const id = 't'+Date.now();
  container.insertAdjacentHTML('beforeend', `
    <div class="toast align-items-center text-bg-${variant} border-0 mb-2" id="${id}" role="alert" aria-live="assertive" aria-atomic="true">
      <div class="d-flex">
        <div class="toast-body"><strong>${title}:</strong> ${message}</div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>
    </div>`);
  const el = document.getElementById(id);
  const t = new bootstrap.Toast(el, { delay: 3000 }); t.show();
  el.addEventListener('hidden.bs.toast', ()=>el.remove());
}

/* Globals */
let stats3dChart, completed3dChart;
let retcaModal, secondTcaModal, pdpaModal;

/* Boot */
function bootstrapApp(){
  const logoEl = document.getElementById('brandLogo');
  logoEl.src = LOGO_URL; logoEl.onerror = () => (logoEl.src='https://via.placeholder.com/64x64.png?text=KS');
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('ms-MY',{weekday:'long',year:'numeric',month:'long',day:'numeric'});

  setupNavigation();
  setupModals();
  setupSearchBars();
  setupExcel();
  setupNADI_v25();   // << gaya baharu
  setupLogDrawer();
  setupFab();

  loadDashboardData();
  loadStatistics('3months');
  loadCompletedStatistics('3months');
  loadTCACallData();
}

/* Navigation */
function setupNavigation(){
  document.querySelectorAll('.nav-link').forEach(a=>{
    a.addEventListener('click',(e)=>{
      e.preventDefault();
      document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
      const target = a.getAttribute('href');
      document.querySelector(target).classList.remove('d-none');
      document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
      a.classList.add('active');

      if (target==='#dashboard'){ loadDashboardData(); loadStatistics(document.getElementById('statPeriod').value); }
      else if (target==='#nadi'){ /* no-op */ }
      else if (target==='#kelayakan'){ /* no-op */ }
      else if (target==='#tca-call'){ loadTCACallPage(); }
      else if (target==='#first-visit'){ loadFirstVisitData(); }
      else if (target==='#lab-followup'){ loadLabFollowUp(); }
      else if (target==='#second-visit'){ loadSecondVisitData(); }
      else if (target==='#selesai'){ loadCompletedData(); loadCompletedStatistics(document.getElementById('statPeriodCompleted').value); }
      else if (target==='#arkib'){ loadArchivedData(); }
    });
  });

  document.getElementById('statPeriod').addEventListener('change', function(){ loadStatistics(this.value); });
  document.getElementById('statPeriodCompleted').addEventListener('change', function(){ loadCompletedStatistics(this.value); });
}

function setupModals(){
  retcaModal = new bootstrap.Modal(document.getElementById('retcaModal'));
  document.getElementById('btnSubmitRetca').addEventListener('click', submitRetca);

  secondTcaModal = new bootstrap.Modal(document.getElementById('secondTcaModal'));
  document.getElementById('btnSubmitSecondTca').addEventListener('click', submitSecondTca);

  pdpaModal = new bootstrap.Modal(document.getElementById('pdpaModal'));
  document.getElementById('btnUploadPDPA').addEventListener('click', uploadPDPA);
}

function setupFab(){
  const btn = document.getElementById('fabLog');
  const drawer  = document.getElementById('logDrawer');
  document.getElementById('btnCloseLog').addEventListener('click', ()=>{ drawer.classList.remove('open'); stopAutoRefreshLogs(); });
  btn.addEventListener('click', ()=>{ drawer.classList.add('open'); refreshLogs(); autoRefreshLogs(); });
}

function setupSearchBars(){
  const pairs = [
    ['searchTCA','tcaCallTable'], ['searchTCAPage','tcaCallList'],
    ['searchFirst','firstVisitList'], ['searchSecond','secondVisitList'],
    ['searchCompleted','completedTable'], ['searchLab','labFollowupTable'],
    ['searchArchive','archiveTable']
  ];
  pairs.forEach(([inpId,tbodyId])=>{
    const inp = document.getElementById(inpId);
    const tb = document.getElementById(tbodyId);
    if (!inp || !tb) return;
    inp.addEventListener('input', ()=>{
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const text = tr.innerText || '';
        tr.style.display = text.toLowerCase().includes((inp.value||'').trim().toLowerCase()) ? '' : 'none';
      });
    });
  });
}

/* Charts */
function buildBarChart(elId, dataArr, titleText){
  const ctx = document.getElementById(elId).getContext('2d');
  const labels = dataArr.map(i=>i.label);
  const counts = dataArr.map(i=>i.count);
  const backgroundColors = counts.map((_,i)=>`hsla(${(i*30)%360},70%,50%,0.7)`);
  return new Chart(ctx, {
    type:'bar',
    data:{ labels, datasets:[{ label:'Jumlah Pesakit Selesai', data:counts, backgroundColor:backgroundColors, borderColor:'rgba(0,0,0,.1)', borderWidth:1 }] },
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{ title:{ display:true, text:titleText, font:{ size:14 } }, legend:{ display:false }, datalabels:{ display:false } },
      scales:{ y:{ beginAtZero:true, title:{ display:true, text:'Jumlah Pesakit'} }, x:{ title:{ display:true, text:'Bulan/Tahun'} } },
      animation:{ duration:500 }
    }
  });
}

/* Log drawer */
let logDrawerTimer=null;
function autoRefreshLogs(){ stopAutoRefreshLogs(); logDrawerTimer = setInterval(()=> refreshLogs({silent:true}), 10000); }
function stopAutoRefreshLogs(){ if (logDrawerTimer){ clearInterval(logDrawerTimer); logDrawerTimer=null; } }
function setupLogDrawer(){ document.getElementById('logSearch').addEventListener('input', ()=> refreshLogs()); }
async function refreshLogs(opts={}){
  const q = (document.getElementById('logSearch').value||'').trim();
  const body = document.getElementById('logBody');
  try{
    const res = await getJSON({ action:'getCallLogs', q }, { silent:true });
    if (res.status==='success'){
      const arr = res.data||[];
      document.getElementById('logBadge').textContent = arr.length;
      body.innerHTML='';
      arr.forEach(item=>{
        const me = (item.staff||'').toLowerCase() === (STAFF_EMAIL||'').toLowerCase();
        const who = item.staff || 'STAFF';
        const text = `${item.event || 'CALL'} • ${item.nama||'-'} (${item.noIC||'-'}) • ${item.noTelefon||'-'}`;
        const when = item.time || '';
        const div = document.createElement('div');
        div.className = 'bubble ' + (me?'me':'other');
        div.innerHTML = `<div><i class="fa-solid fa-phone-volume me-1"></i>${text}</div><div class="meta">${who} • ${when}</div>`;
        body.appendChild(div);
      });
      body.scrollTop = body.scrollHeight;
    }
  }catch(e){}
}

/* Excel (Kelayakan) */
function setupExcel(){
  const input = document.getElementById('excelFile');
  const tbody = document.getElementById('kelayakanTable');
  input.addEventListener('change', async (e)=>{
    const file = e.target.files[0]; if (!file) return;
    showLoader('Memproses Excel…');
    try{
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
      tbody.innerHTML = '';
      if (!json.length) { tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data.</td></tr>`; return; }
      json.forEach((row, idx)=>{
        const nama = row.Nama || row.NAMA || row.name || '';
        const ic = row.IC || row.Ic || row.ic || '';
        const tel = row.Telefon || row.TELEFON || row.Phone || row.phone || '';
        const msisdn = normalizeMsisdnMY(tel);
        const id = 'x'+Date.now()+idx;

        // umur ≥40 (anggaran dari IC)
        const lahirYY = ic.slice(0,2), lahirMM = ic.slice(2,4), lahirDD = ic.slice(4,6);
        let ageOk=false;
        if (/^\d{6}/.test(ic)){
          const y = Number(lahirYY); const fullY = (y<=29)?(2000+y):(1900+y);
          const dob = new Date(fullY, Number(lahirMM)-1, Number(lahirDD));
          const now = new Date(); let age = now.getFullYear()-dob.getFullYear();
          const m = now.getMonth()-dob.getMonth(); if (m<0 || (m===0 && now.getDate()<dob.getDate())) age--;
          ageOk = age>=40;
        }

        tbody.insertAdjacentHTML('beforeend', `
          <tr id="${id}">
            <td>${nama}</td>
            <td>${ic}</td>
            <td>${msisdn}</td>
            <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'checked':''} onchange="toggleLayak('${id}', true)"></td>
            <td class="text-center"><input type="checkbox" class="form-check-input" ${ageOk?'':'checked'} onchange="toggleLayak('${id}', false)"></td>
            <td>
              <div class="row g-1 align-items-center">
                <div class="col"><input type="date" class="form-control form-control-sm tca-date" disabled></div>
                <div class="col"><input type="time" class="form-control form-control-sm tca-time" disabled></div>
                <div class="col"><input type="text" class="form-control form-control-sm tca-staff" placeholder="Nama staff" disabled></div>
              </div>
            </td>
            <td><button class="btn btn-sm btn-primary" onclick="daftarFromExcel('${id}', '${encodeURIComponent(nama)}', '${encodeURIComponent(ic)}', '${msisdn}')" disabled>Daftar</button></td>
          </tr>`);
      });
    } finally { hideLoader(); }
  });
}
function toggleLayak(rowId, isLayak){
  const tr = document.getElementById(rowId);
  const checks = tr.querySelectorAll('input[type=checkbox]');
  if (isLayak) { checks[1].checked = false; } else { checks[0].checked = false; }
  const date  = tr.querySelector('.tca-date');
  const time  = tr.querySelector('.tca-time');
  const staff = tr.querySelector('.tca-staff');
  const btn   = tr.querySelector('button');
  if (isLayak && checks[0].checked) { date.disabled = false; time.disabled = false; staff.disabled=false; btn.disabled=false; }
  else { date.disabled = true; time.disabled = true; staff.disabled=true; btn.disabled=true; }
}
async function daftarFromExcel(rowId, encNama, encIC, msisdn){
  const tr = document.getElementById(rowId);
  const nama = decodeURIComponent(encNama);
  const ic = decodeURIComponent(encIC);
  const date  = tr.querySelector('.tca-date').value;
  const time  = tr.querySelector('.tca-time').value;
  const staff = tr.querySelector('.tca-staff').value.trim();
  if (!date || !time || !staff) { toast('Ralat','Sila isi tarikh, masa & nama staff','danger'); return; }
  try{
    const res = await postForm({ action:'daftarPesakit', namaPesakit:nama, noIC: ic, noTelefon: msisdn, namaStaff: staff, tarikhTCA: date, masaTCA: time }, { msg:'Mendaftar pesakit…' });
    if (res.status==='success'){ toast('Berjaya',`Pesakit ${nama} didaftarkan ke TCA`, 'success'); tr.remove(); loadDashboardData(); loadTCACallData(); }
    else throw new Error(res.message||'Gagal daftar');
  }catch(e){ toast('Ralat',e.message,'danger'); }
}

/* =======================
   NADI (v2.5.0-style table)
======================= */
function setupNADI_v25(){
  document.getElementById('btnNadiAddRow').addEventListener('click', addNadiRow_v25);
  document.getElementById('btnNadiExportCsv').addEventListener('click', exportNadiCSV_v25);
  // mula dengan 1 baris
  addNadiRow_v25();
}

function addNadiRow_v25(){
  const tb = document.getElementById('nadiTbody');
  const id = 'n'+Date.now()+Math.random().toString(36).slice(2,6);

  const tr = document.createElement('tr'); tr.id=id;
  tr.innerHTML = `
    <td><input class="form-control form-control-sm nadi-nama nadi-min-lg" placeholder="Nama pesakit"></td>
    <td><input class="form-control form-control-sm nadi-ic nadi-min" placeholder="IC"></td>
    <td><input class="form-control form-control-sm nadi-tel nadi-min" placeholder="Telefon (012.. atau 60..)"></td>
    <td><input class="form-control form-control-sm nadi-alamat" placeholder="Alamat"></td>
    <td><input class="form-control form-control-sm nadi-bp nadi-min" placeholder="cth: 120/80"></td>
    <td><input class="form-control form-control-sm nadi-pr nadi-min" placeholder="degupan/min"></td>
    <td>
      <div class="dropdown nadi-dxt-wrap">
        <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" type="button">Fasting</button>
        <ul class="dropdown-menu">
          <li><a class="dropdown-item" href="#" data-value="Fasting">Fasting</a></li>
          <li><a class="dropdown-item" href="#" data-value="Random">Random</a></li>
        </ul>
        <input type="hidden" class="nadi-dxt-type" value="Fasting">
      </div>
    </td>
    <td><input class="form-control form-control-sm nadi-dxt nadi-min" placeholder="mmol/L"></td>
    <td><input class="form-control form-control-sm nadi-tinggi nadi-min" placeholder="cm"></td>
    <td><input class="form-control form-control-sm nadi-berat nadi-min" placeholder="kg"></td>
    <td><input class="form-control form-control-sm nadi-bmi nadi-min" placeholder="auto" disabled></td>
    <td class="nadi-center">
      <div class="form-check form-check-inline">
        <input class="form-check-input nadi-layak" type="checkbox" id="${id}_layak">
        <label class="form-check-label" for="${id}_layak">Layak</label>
      </div>
      <div class="form-check form-check-inline">
        <input class="form-check-input nadi-taklayak" type="checkbox" id="${id}_tak">
        <label class="form-check-label" for="${id}_tak">Tidak</label>
      </div>
    </td>
    <td><input type="date" class="form-control form-control-sm nadi-tca-date nadi-min" disabled></td>
    <td><input type="time" class="form-control form-control-sm nadi-tca-time nadi-min" disabled></td>
    <td><input type="text" class="form-control form-control-sm nadi-staff nadi-min" placeholder="Nama staff" disabled></td>
    <td>
      <div class="d-flex flex-wrap gap-1">
        <button class="btn btn-sm btn-outline-primary nadi-daftar" disabled><i class="fa-solid fa-floppy-disk"></i> Daftar</button>
        <button class="btn btn-sm btn-outline-success nadi-wa"><i class="fa-brands fa-whatsapp"></i> WhatsApp Report</button>
        <button class="btn btn-sm btn-outline-danger nadi-buang"><i class="fa-solid fa-trash"></i> Buang</button>
      </div>
      <div class="small-note mt-1">* WhatsApp Web akan dibuka, imej laporan akan dimuat turun untuk dilampirkan.</div>
    </td>
  `;
  tb.appendChild(tr);

  // BMI auto-kira
  const tinggi = tr.querySelector('.nadi-tinggi');
  const berat  = tr.querySelector('.nadi-berat');
  const bmi    = tr.querySelector('.nadi-bmi');
  function calcBMI(){
    const h = parseFloat(tinggi.value||'0')/100;
    const w = parseFloat(berat.value||'0');
    bmi.value = (!h||!w) ? '' : (w/(h*h)).toFixed(1);
  }
  tinggi.addEventListener('input', calcBMI);
  berat.addEventListener('input', calcBMI);

  // Dropdown DXT
  tr.querySelectorAll('.nadi-dxt-wrap .dropdown-item').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const val = a.getAttribute('data-value') || 'Fasting';
      tr.querySelector('.nadi-dxt-type').value = val;
      tr.querySelector('.nadi-dxt-wrap .dropdown-toggle').textContent = val;
    });
  });

  // Layak/Tidak Layak
  const layak = tr.querySelector('.nadi-layak');
  const tak   = tr.querySelector('.nadi-taklayak');
  const tcaD  = tr.querySelector('.nadi-tca-date');
  const tcaT  = tr.querySelector('.nadi-tca-time');
  const staff = tr.querySelector('.nadi-staff');
  const btnReg= tr.querySelector('.nadi-daftar');

  layak.addEventListener('change', ()=>{
    if (layak.checked){ tak.checked=false; tcaD.disabled=false; tcaT.disabled=false; staff.disabled=false; btnReg.disabled=false; }
    else { tcaD.disabled=true; tcaT.disabled=true; staff.disabled=true; btnReg.disabled=true; }
  });
  tak.addEventListener('change', ()=>{ if (tak.checked){ layak.checked=false; tcaD.disabled=true; tcaT.disabled=true; staff.disabled=true; btnReg.disabled=true; } });

  // Daftar (yang layak sahaja)
  btnReg.addEventListener('click', async ()=>{
    const nama   = tr.querySelector('.nadi-nama').value.trim();
    const ic     = tr.querySelector('.nadi-ic').value.trim();
    const telRaw = tr.querySelector('.nadi-tel').value.trim();
    const tel    = normalizeMsisdnMY(telRaw);
    const date   = tcaD.value; const time = tcaT.value; const st = staff.value.trim();
    if (!nama||!ic||!tel||!date||!time||!st){ toast('Ralat','Sila isi penuh untuk pendaftaran layak','danger'); return; }
    try{
      const res = await postForm({ action:'daftarPesakit', namaPesakit:nama, noIC:ic, noTelefon:tel, namaStaff:st, tarikhTCA:date, masaTCA:time }, { msg:'Mendaftar (NADI)…' });
      if (res.status==='success'){ toast('Berjaya', `Daftar ${nama}`, 'success'); }
      else throw new Error(res.message||'Gagal daftar');
    }catch(e){ toast('Ralat', e.message, 'danger'); }
  });

  // WhatsApp Report (WA Web)
  tr.querySelector('.nadi-wa').addEventListener('click', async ()=>{
    try{
      const data = {
        nama: tr.querySelector('.nadi-nama').value.trim(),
        ic: tr.querySelector('.nadi-ic').value.trim(),
        tel: normalizeMsisdnMY(tr.querySelector('.nadi-tel').value.trim()),
        alamat: tr.querySelector('.nadi-alamat').value.trim(),
        bp: tr.querySelector('.nadi-bp').value.trim(),
        pr: tr.querySelector('.nadi-pr').value.trim(),
        dxtType: tr.querySelector('.nadi-dxt-type').value,
        dxt: tr.querySelector('.nadi-dxt').value.trim(),
        tinggi: tr.querySelector('.nadi-tinggi').value.trim(),
        berat: tr.querySelector('.nadi-berat').value.trim(),
        bmi: tr.querySelector('.nadi-bmi').value.trim(),
        layak: tr.querySelector('.nadi-layak').checked
      };
      const file = await buildNadiReportImage(data);
      if (file){
        // 1) auto muat turun imej (untuk dilampirkan di WhatsApp Web)
        const a = document.createElement('a');
        a.href = URL.createObjectURL(file);
        a.download = `Laporan_NADI_${(data.nama||'pesakit').replace(/\s+/g,'_')}.png`;
        document.body.appendChild(a); a.click(); a.remove();

        // 2) buka WhatsApp Web dengan teks ringkasan
        const txt = `Laporan Saringan NADI\nNama: ${data.nama}\nIC: ${data.ic}\nBP: ${data.bp}\nPR: ${data.pr}\nDXT (${data.dxtType}): ${data.dxt}\nTinggi: ${data.tinggi} cm\nBerat: ${data.berat} kg\nBMI: ${data.bmi}\nStatus: ${data.layak?'Layak PEKA B40':'Tidak Layak PEKA B40'}\n\n*Nota:* Gambar laporan telah dimuat turun. Sila lampirkan di WhatsApp.`;
        if (data.tel){ window.open(waHrefWeb(data.tel, txt), '_blank'); }
        else { toast('Makluman','Nombor telefon kosong. Imej telah dimuat turun.','warning'); }
      }
    }catch(e){ toast('Ralat','Gagal jana laporan: '+e.message,'danger'); }
  });

  // Buang
  tr.querySelector('.nadi-buang').addEventListener('click', ()=> tr.remove());
}

function exportNadiCSV_v25(){
  const rows = Array.from(document.querySelectorAll('#nadiTbody tr'));
  if (!rows.length){ toast('Makluman','Tiada data untuk diexport','warning'); return; }
  const header = ['Nama','IC','Telefon','Alamat','BP','PR','DXT_Tipe','DXT','Tinggi(cm)','Berat(kg)','BMI','Layak','TarikhTCA','MasaTCA','Staff'];
  const data = rows.map(r=>{
    const v = (sel) => (r.querySelector(sel)?.value || '').trim();
    const b = (sel) => (r.querySelector(sel)?.checked ? 'Ya' : 'Tidak');
    return [
      v('.nadi-nama'), v('.nadi-ic'), v('.nadi-tel'), v('.nadi-alamat'),
      v('.nadi-bp'), v('.nadi-pr'), (r.querySelector('.nadi-dxt-type')?.value||''), v('.nadi-dxt'),
      v('.nadi-tinggi'), v('.nadi-berat'), v('.nadi-bmi'),
      b('.nadi-layak'),
      v('.nadi-tca-date'), v('.nadi-tca-time'), v('.nadi-staff')
    ];
  });
  const csv = [header, ...data].map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `program_nadi_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  toast('Export','Fail CSV telah dimuat turun','success');
}

/* Laporan NADI → imej (canvas) */
async function buildNadiReportImage(data){
  const w=900, h=1100, pad=28, line=36;
  const canvas = document.createElement('canvas'); canvas.width=w; canvas.height=h;
  const ctx = canvas.getContext('2d');
  ctx.fillStyle='#ffffff'; ctx.fillRect(0,0,w,h);
  ctx.fillStyle='#2c3e50'; ctx.fillRect(0,0,w,118);
  try{
    const img = new Image(); img.crossOrigin='anonymous'; img.src=LOGO_URL;
    await new Promise((res)=>{ img.onload=res; img.onerror=()=>res(); });
    if (img.width) ctx.drawImage(img, pad, 18, 86, 86);
  }catch(_){}
  ctx.fillStyle='#ffffff'; ctx.font='700 28px Segoe UI, Arial'; ctx.fillText('Klinik SihatSokmo', 118, 54);
  ctx.font='600 20px Segoe UI, Arial'; ctx.fillText('Laporan Saringan Program NADI', 118, 86);

  const tarikh = new Date().toLocaleString('ms-MY', {year:'numeric',month:'long',day:'numeric', hour:'2-digit', minute:'2-digit'});
  ctx.fillStyle='#333'; ctx.font='600 20px Segoe UI, Arial'; ctx.fillText('Butiran Pesakit', pad, 160);
  ctx.font='400 18px Segoe UI, Arial';
  let y=196;
  const write = (label, val)=>{ ctx.fillStyle='#666'; ctx.fillText(label, pad, y); ctx.fillStyle='#111'; ctx.fillText(': '+(val||'-'), pad+180, y); y+=line; };
  write('Nama', data.nama);
  write('No. IC', data.ic);
  write('Tarikh Cetakan', tarikh);
  ctx.strokeStyle='#e5e7eb'; ctx.lineWidth=2; ctx.beginPath(); ctx.moveTo(pad, y+8); ctx.lineTo(w-pad, y+8); ctx.stroke(); y+=30;
  ctx.fillStyle='#333'; ctx.font='600 20px Segoe UI, Arial'; ctx.fillText('Keputusan Saringan', pad, y); y+=line;
  ctx.font='400 18px Segoe UI, Arial';
  write('Tekanan Darah (BP)', data.bp);
  write('Degupan Jantung (PR)', data.pr);
  write(`Bacaan Gula (DXT - ${data.dxtType})`, data.dxt);
  write('Tinggi', data.tinggi ? (data.tinggi+' cm') : '');
  write('Berat', data.berat ? (data.berat+' kg') : '');
  write('BMI', data.bmi);
  y+=14;
  const statusTxt = data.layak ? 'LAYAK Saringan PEKA B40' : 'TIDAK LAYAK Saringan PEKA B40';
  ctx.fillStyle = data.layak ? '#16a085' : '#c0392b';
  ctx.fillRect(pad, y, w-pad*2, 70);
  ctx.fillStyle='#fff'; ctx.font='700 22px Segoe UI, Arial'; ctx.fillText(statusTxt, pad+16, y+44);
  ctx.fillStyle='#94a3b8'; ctx.font='400 14px Segoe UI, Arial';
  ctx.fillText('Untuk rujukan pesakit. Sila hubungi klinik jika ada pertanyaan.', pad, h-24);
  const blob = await new Promise(res=> canvas.toBlob(res, 'image/png', 0.92));
  if (!blob) throw new Error('Gagal menukar imej');
  return new File([blob], 'laporan_nadi.png', { type:'image/png' });
}

/* Data loaders — (kekalkan seperti versi sebelum ini) */
async function loadDashboardData(){
  try{
    const data = await getJSON({ action:'getDashboardData' }, { msg:'Memuat Dashboard…' });
    if (data.status==='success'){
      const d = data.data || {};
      totalDaftar.textContent = d.totalDaftar || 0;
      totalFirstVisit.textContent = d.totalFirstVisit || 0;
      totalSecondVisit.textContent = d.totalSecondVisit || 0;
      totalSelesai.textContent = d.totalSelesai || 0;
      labFollowUpDue.textContent = d.labFollowUpDue || 0;
      labFollowUpPending.textContent = d.labFollowUpPending || 0;
      setBadge('badgeTCA', d.totalDaftar);
      setBadge('badgeFirst', d.totalFirstVisit);
      setBadge('badgeSecond', d.totalSecondVisit);
      setBadge('badgeLab', d.labFollowUpDue + d.labFollowUpPending);
    }
  }catch(e){ toast('Ralat','Gagal memuat data dashboard','danger'); }
}
function setBadge(id,val){
  const el = document.getElementById(id);
  if (!el) return;
  if (val>0){ el.textContent = val; el.style.display='inline-block'; }
  else { el.style.display='none'; }
}
async function loadStatistics(period){
  try{
    const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…' });
    if (data.status==='success'){
      if (stats3dChart) stats3dChart.destroy();
      stats3dChart = buildBarChart('stats3dChart', data.data, `Statistik Pesakit Selesai (${getPeriodLabel(period)})`);
    }
  }catch(e){}
}
async function loadCompletedStatistics(period){
  try{
    const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…' });
    if (data.status==='success'){
      if (completed3dChart) completed3dChart.destroy();
      completed3dChart = buildBarChart('completed3dChart', data.data, `Statistik Pesakit Selesai (${getPeriodLabel(period)})`);
    }
  }catch(e){}
}
function getPeriodLabel(p){ if(p==='3months')return'3 Bulan Terakhir'; if(p==='6months')return'6 Bulan Terakhir'; if(p==='12months')return'12 Bulan Terakhir'; return p; }

async function loadTCACallData(){
  try{
    const data = await getJSON({ action:'getTCACall' }, { msg:'Memuat TCA Hari Ini…' });
    const tb1 = document.getElementById('tcaCallTable'); if (tb1) tb1.innerHTML = '';
    const renderRow = (p) => {
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      return `<tr data-ic="${p.noIC}">
        <td>${p.nama}</td>
        <td>${p.noIC}</td>
        <td class="mini-actions">
          <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHrefWeb(msisdn)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          <div class="small text-muted mt-1">${msisdn}</div>
        </td>
        <td>${p.tarikhTCA}</td>
        <td><span class="badge ${p.status==='CALLED'?'bg-success':'bg-warning'}">${p.status || 'PENDING'}</span></td>
      </tr>`;
    };
    if (data.status==='success' && data.data.length>0){ data.data.forEach(p=>{ if (tb1) tb1.insertAdjacentHTML('beforeend', renderRow(p)); }); }
    else { if (tb1) tb1.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tiada pesakit perlu dihubungi hari ini</td></tr>`; }
  }catch(e){}
}

/* TCA page */
let TCA_ALL = [];
async function loadTCACallPage(){
  try{
    const res = await getJSON({ action:'getTCACall', all:1 }, { msg:'Memuat rekod TCA…' });
    TCA_ALL = (res.status==='success') ? (res.data||[]) : [];
    renderTcaList('today');
  }catch(e){ renderTcaList('all'); }
  document.querySelectorAll('#tcaFilter [data-filter]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      document.querySelectorAll('#tcaFilter [data-filter]').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active'); renderTcaList(btn.getAttribute('data-filter'));
    });
  });
}
function renderTcaList(mode){
  const tbody = document.getElementById('tcaCallList'); if (!tbody) return;
  tbody.innerHTML = '';
  const today = new Date(); today.setHours(0,0,0,0);
  const filtered = TCA_ALL.filter(p=>{
    const d = parseDDMMYYYY(p.tarikhTCA); if (!d) return mode==='all';
    d.setHours(0,0,0,0);
    if (mode==='today') return isSameDay(d, today);
    if (mode==='upcoming') return d.getTime() > today.getTime();
    if (mode==='past') return d.getTime() < today.getTime();
    return true;
  });
  if (!filtered.length){ tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted">Tiada rekod untuk paparan ini.</td></tr>`; return; }
  filtered.forEach(p=>{
    const msisdn = normalizeMsisdnMY(p.noTelefon||'');
    const badgeCls = p.status==='CALLED' ? 'bg-success' : (parseDDMMYYYY(p.tarikhTCA)?.getTime()<today.getTime() ? 'bg-secondary' : 'bg-warning');
    const label = p.status==='CALLED' ? 'CALLED' : (parseDDMMYYYY(p.tarikhTCA)?.getTime()<today.getTime() ? 'LEPAS' : (isSameDay(parseDDMMYYYY(p.tarikhTCA), today) ? 'HARI INI' : 'AKAN DATANG'));
    tbody.insertAdjacentHTML('beforeend', `<tr data-ic="${p.noIC}">
      <td>${p.nama}</td>
      <td>${p.noIC}</td>
      <td class="mini-actions">
        <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
        <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHrefWeb(msisdn)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
        <div class="small text-muted mt-1">${msisdn}</div>
      </td>
      <td>${p.tarikhTCA||'-'}</td>
      <td><span class="badge ${badgeCls}">${label}</span></td>
    </tr>`);
  });
}

/* First/Second/Lab/Completed/Archive — kekal */
async function loadFirstVisitData(){
  try{
    const data = await getJSON({ action:'getFirstVisit' }, { msg:'Memuat First Visit…' });
    const tbody = document.getElementById('firstVisitList'); tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const hadir = p.status==='HADIR';
        const within = isWithin24hOfDate(p.tarikhTCA);
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        let pdpaHTML = '';
        if (p.pdpaFileId){
          pdpaHTML = `<div class="d-flex flex-wrap gap-1">
              <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
              <button class="btn btn-sm btn-outline-danger" onclick="deletePDPA('${p.noIC}')"><i class="fa-solid fa-trash"></i> Padam</button>
            </div>`;
        } else { pdpaHTML = hadir ? `<button class="btn btn-sm btn-outline-primary" onclick="openPDPA('${p.noIC}')"><i class="fa-solid fa-file-arrow-up"></i> Upload</button>` : `<span class="text-muted">-</span>`; }
        tbody.insertAdjacentHTML('beforeend', `<tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td>${p.tarikhTCA||'-'}</td>
          <td>${pdpaHTML}</td>
          <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
          <td class="mini-actions">
            ${within && !hadir ? `<button class="btn btn-sm btn-success" onclick="markFirstVisit('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
            ${!hadir ? `<button class="btn btn-sm btn-primary" onclick="openRetcaModal('${p.noIC}')"><i class="fa-solid fa-calendar-plus"></i> Re-TCA</button>` : ''}
            ${msisdn ? `<a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
                        <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHrefWeb(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>`:''}
          </td>
        </tr>`);
      });
    } else { tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada data First Visit</td></tr>`; }
  }catch(e){}
}
function isWithin24hOfDate(dateStr){
  const d = parseDDMMYYYY(dateStr); if (!d) return false;
  const start = new Date(d.getFullYear(), d.getMonth(), d.getDate(), 0,0,0,0);
  const end = new Date(start.getTime() + 24*60*60*1000);
  const now = new Date(); return now >= start && now < end;
}
async function loadLabFollowUp(){
  try{
    const data = await getJSON({ action:'getLabFollowUp' }, { msg:'Memuat Follow-up Lab…' });
    const tbody = document.getElementById('labFollowupTable'); tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        const badge = p.labStatus==='DONE' ? 'bg-success' : (p.labStatus==='REPEAT' ? 'bg-danger' : (p.labStatus==='IN_PROCESS' ? 'bg-warning' : 'bg-secondary'));
        const label = p.labStatus || 'PENDING';
        tbody.insertAdjacentHTML('beforeend', `<tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td class="mini-actions">
            <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
            <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHrefWeb(msisdn,'Keputusan makmal anda telah siap.')}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
            <div class="small text-muted mt-1">${msisdn}</div>
          </td>
          <td>${p.firstVisitDate}</td>
          <td>${p.daysSince}</td>
          <td><span class="badge ${badge}">${label}</span></td>
          <td class="mini-actions">
            <button class="btn btn-sm btn-success" onclick="openSecondTca('${p.noIC}')"><i class="fa-solid fa-square-check"></i> Result complete & berjaya call</button>
            <button class="btn btn-sm btn-warning" onclick="markLabStatus('${p.noIC}','IN_PROCESS')"><i class="fa-solid fa-hourglass-half"></i> In process</button>
            <button class="btn btn-sm btn-danger"  onclick="markLabStatus('${p.noIC}','REPEAT')"><i class="fa-solid fa-rotate-left"></i> Repeat sample</button>
          </td>
        </tr>`);
      });
    } else { tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada pesakit untuk follow-up.</td></tr>`; }
  }catch(e){}
}
async function loadSecondVisitData(){
  try{
    const data = await getJSON({ action:'getSecondVisit' }, { msg:'Memuat Second Visit…' });
    const tbody = document.getElementById('secondVisitList'); tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const hadir = p.status==='HADIR';
        const within = isWithin24hOfDate(p.tarikhTCA);
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        let pdpaHTML = p.pdpaFileId
          ? `<div class="d-flex flex-wrap gap-1"><a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a></div>`
          : `<span class="text-danger">PDPA tiada</span>`;
        tbody.insertAdjacentHTML('beforeend', `<tr data-ic="${p.noIC}">
          <td>${p.nama}</td>
          <td>${p.noIC}</td>
          <td>${p.tarikhTCA||'-'}</td>
          <td>${pdpaHTML}</td>
          <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
          <td class="mini-actions">
            ${within && !hadir ? `<button class="btn btn-sm btn-success" onclick="markSecondVisitHadir('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
            ${msisdn ? `<a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
                        <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHrefWeb(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>`:''}
          </td>
        </tr>`);
      });
    } else { tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada data Second Visit</td></tr>`; }
  }catch(e){}
}
async function loadCompletedData(){
  try{
    const data = await getJSON({ action:'getCompleted' }, { msg:'Memuat Selesai…' });
    const tbody = document.getElementById('completedTable'); tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        const pdpaHTML = p.pdpaFileId
          ? `<div class="d-flex flex-wrap gap-1"><a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a></div>`
          : `<span class="text-muted">-</span>`;
        const labCompleted = p.labCompletedAt ? `${p.labCompletedAt}` : '-';
        tbody.insertAdjacentHTML('beforeend', `<tr data-ic="${p.noIC}">
          <td>${p.nama}</td><td>${p.noIC}</td><td>${msisdn}</td><td>${pdpaHTML}</td>
          <td>${p.tarikhDaftar||'-'}</td><td>${p.firstVisitDate||'-'}</td><td>${labCompleted}</td><td>${p.secondVisitDate||'-'}</td><td>${p.tarikhSelesai||'-'}</td>
          <td><button class="btn btn-sm btn-outline-secondary" onclick="archivePatient('${p.noIC}')"><i class="fa-solid fa-box-archive"></i> Arkib</button></td>
        </tr>`);
      });
    } else { tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">Tiada data pesakit selesai</td></tr>`; }
  }catch(e){}
}
async function loadArchivedData(){
  try{
    const data = await getJSON({ action:'getArchived' }, { msg:'Memuat Arkib…' });
    const tbody = document.getElementById('archiveTable'); tbody.innerHTML = '';
    if (data.status==='success' && data.data.length>0){
      data.data.forEach(p=>{
        const msisdn = normalizeMsisdnMY(p.noTelefon||'');
        tbody.insertAdjacentHTML('beforeend', `<tr data-ic="${p.noIC}">
          <td>${p.nama}</td><td>${p.noIC}</td><td>${msisdn}</td><td>${p.tarikhDaftar}</td><td>${p.tarikhSelesai}</td><td>${p.archivedAt||'-'}</td>
          <td><button class="btn btn-sm btn-outline-primary" onclick="restorePatient('${p.noIC}')"><i class="fa-solid fa-rotate-left"></i> Pulihkan</button></td>
        </tr>`);
      });
    } else { tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada rekod arkib</td></tr>`; }
  }catch(e){}
}

/* Actions */
async function markFirstVisit(noIC){
  try{
    const res = await postForm({ action:'updateStatus', op:'firstVisit', noIC, staff: STAFF_EMAIL }, { msg:'Merekod Hadir (First Visit)…' });
    if (res.status==='success'){ toast('Berjaya','Hadir (First Visit) direkodkan. Sila muat naik PDPA.', 'success'); openPDPA(noIC); loadFirstVisitData(); loadLabFollowUp(); loadSecondVisitData(); loadDashboardData(); }
    else throw new Error(res.message||'Gagal rekod hadir');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
async function markSecondVisitHadir(noIC){
  try{
    const res = await postForm({ action:'updateStatus', op:'secondVisitHadir', noIC, staff: STAFF_EMAIL }, { msg:'Menandakan Hadir (Second Visit)…' });
    if (res.status==='success'){ toast('Berjaya','Second Visit selesai → Selesai','success'); loadSecondVisitData(); loadCompletedData(); loadDashboardData(); }
    else throw new Error(res.message||'Gagal menandakan hadir');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
function openRetcaModal(noIC){ document.getElementById('retcaIC').value=noIC; document.getElementById('retcaDate').value=''; document.getElementById('retcaTime').value=''; retcaModal.show(); }
async function submitRetca(){
  const noIC = document.getElementById('retcaIC').value;
  const tarikhTCA = document.getElementById('retcaDate').value;
  const masaTCA = document.getElementById('retcaTime').value;
  if (!noIC || !tarikhTCA || !masaTCA) return toast('Ralat','Sila lengkapkan tarikh & masa','danger');
  try{
    const res = await postForm({ action:'updateStatus', op:'retca', noIC, tarikhTCA, masaTCA, staff: STAFF_EMAIL }, { msg:'Mendaftar TCA semula…' });
    if (res.status==='success'){ retcaModal.hide(); toast('Berjaya','TCA baharu disimpan','success'); loadTCACallData(); loadFirstVisitData(); loadSecondVisitData(); loadDashboardData(); }
    else throw new Error(res.message||'Gagal kemaskini TCA');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
function openSecondTca(noIC){ document.getElementById('secondTcaIC').value=noIC; document.getElementById('secondTcaDate').value=''; document.getElementById('secondTcaTime').value=''; document.getElementById('secondTcaStaff').value=''; secondTcaModal.show(); }
async function submitSecondTca(){
  const noIC = document.getElementById('secondTcaIC').value;
  const date = document.getElementById('secondTcaDate').value;
  const time = document.getElementById('secondTcaTime').value;
  const staff= document.getElementById('secondTcaStaff').value.trim();
  if (!date || !time || !staff) { toast('Ralat','Sila isi tarikh, masa & nama staff','danger'); return; }
  try{
    const a = await postForm({ action:'updatePatient', noIC, tarikhTCA:date, masaTCA:time, staff }, { msg:'Menetapkan TCA Second Visit…' });
    if (a.status!=='success') throw new Error(a.message||'Gagal tetapkan TCA');
    const b = await postForm({ action:'logCall', noIC, staff, event:'LAB_COMPLETE_CALL' }, { msg:'Merekod log panggilan…' });
    if (b.status!=='success') throw new Error(b.message||'Gagal rekod log');
    const c = await postForm({ action:'updateLabStatus', noIC, status:'DONE', staff }, { msg:'Mengemas kini status follow-up…' });
    if (c.status!=='success') throw new Error(c.message||'Gagal set follow-up DONE');
    secondTcaModal.hide(); toast('Berjaya','TCA Second Visit ditetapkan, log disimpan & lab ditanda Selesai','success');
    loadLabFollowUp(); loadSecondVisitData(); loadCompletedData(); loadDashboardData(); refreshLogs({silent:true});
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
function openPDPA(noIC){ document.getElementById('pdpaIC').value=noIC; document.getElementById('pdpaFile').value=''; pdpaModal.show(); }
async function uploadPDPA(){
  const noIC = document.getElementById('pdpaIC').value;
  const file = document.getElementById('pdpaFile').files[0];
  if (!file) { toast('Ralat','Sila pilih fail PDPA','danger'); return; }
  showLoader('Memuat naik PDPA…');
  try{
    const base64 = await new Promise((resolve, reject)=>{ const fr=new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file); });
    const pure64 = String(base64).split(',').pop();
    const res = await fetch(SCRIPT_URL, { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'},
      body:new URLSearchParams({ action:'uploadPDPA', id_token:ID_TOKEN, noIC, staff:STAFF_EMAIL, fileBase64:pure64, fileName:file.name, fileType:file.type||'application/octet-stream' })});
    const json = await res.json();
    if (json.status === 'success'){ pdpaModal.hide(); toast('Berjaya','PDPA dimuat naik','success'); loadFirstVisitData(); loadSecondVisitData(); loadCompletedData(); }
    else { throw new Error(json.message || 'Gagal muat naik PDPA'); }
  } catch(e){ toast('Ralat', e.message, 'danger'); } finally { hideLoader(); }
}
async function deletePDPA(noIC){
  if (!confirm('Padam PDPA untuk pesakit ini?')) return;
  try{
    const res = await postForm({ action:'deletePDPA', noIC, staff: STAFF_EMAIL }, { msg:'Memadam PDPA…' });
    if (res.status==='success'){ toast('Berjaya','PDPA dipadam.','success'); loadFirstVisitData(); loadSecondVisitData(); loadCompletedData(); }
    else throw new Error(res.message||'Gagal padam PDPA');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
async function archivePatient(noIC){
  if (!confirm('Arkibkan rekod pesakit ini?')) return;
  try{
    const res = await postForm({ action:'archivePatient', noIC, staff: STAFF_EMAIL }, { msg:'Mengarkib rekod…' });
    if (res.status==='success'){ toast('Arkib','Rekod telah diarkibkan','success'); loadCompletedData(); }
    else throw new Error(res.message||'Gagal arkib');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}
async function restorePatient(noIC){
  if (!confirm('Pulihkan rekod ini ke senarai utama?')) return;
  try{
    const res = await postForm({ action:'restorePatient', noIC, staff: STAFF_EMAIL }, { msg:'Memulihkan rekod…' });
    if (res.status==='success'){ toast('Pulih','Rekod telah dipulihkan','success'); loadArchivedData(); loadCompletedData(); loadDashboardData(); }
    else throw new Error(res.message||'Gagal pulih');
  }catch(e){ toast('Ralat', e.message, 'danger'); }
}

/* Statistik helpers */
function getCompleted(){ /* placeholder */ }

/* Start */
document.addEventListener('DOMContentLoaded', ()=>{ initGoogleSignIn(); });
</script>
</body>
</html>
