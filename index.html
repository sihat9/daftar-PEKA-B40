<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Sistem Tracker PEKA B40 - Klinik SihatSokmo</title>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

<!-- Chart.js (v4) + 3D plugin + Datalabels -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-3d@4"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

<!-- SheetJS (Excel) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --primary:#2c3e50; --secondary:#3498db; --success:#27ae60; --warning:#f39c12;
  --danger:#e74c3c; --light:#ecf0f1; --dark:#34495e; --muted:#95a5a6;
}
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:#f5f7fa;color:#333}
.navbar-main{background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.08);padding:10px 0}
.navbar-brand{font-weight:700;color:var(--primary);font-size:1.1rem;display:flex;align-items:center;gap:10px}
.brand-logo{width:34px;height:34px;border-radius:8px;object-fit:cover;border:1px solid rgba(0,0,0,.08)}
.nav-link{color:var(--dark);font-weight:500;margin:0 5px;padding:8px 12px!important;border-radius:8px;transition:.2s}
.nav-link:hover,.nav-link.active{background:rgba(52,152,219,.12);color:var(--secondary)}
.page-header{background:linear-gradient(135deg,var(--primary),var(--secondary));color:#fff;padding:20px 0;margin-bottom:16px;border-radius:0 0 12px 12px}
.card{border:none;border-radius:14px;box-shadow:0 8px 24px rgba(0,0,0,.06);margin-bottom:18px}
.card-header{background:#fff;border-bottom:1px solid rgba(0,0,0,.06);font-weight:600;padding:14px 18px;border-radius:14px 14px 0 0!important}
.stat-card{padding:18px;border-radius:14px;color:#fff;text-align:center;position:relative;overflow:hidden;cursor:pointer}
.stat-card .number{font-size:1.9rem;font-weight:800}
.table td,.table th{vertical-align:middle}
.searchbar{max-width:360px}
.mini-actions .btn{margin-right:6px;margin-bottom:6px}
.toasts{position:fixed;top:16px;right:16px;z-index:1080}

/* Loader global — auto-hide ≤2s */
#appLoader{position:fixed;inset:0;z-index:2000;display:none;background:radial-gradient(1200px 600px at 10% -10%, rgba(52,152,219,.18), transparent),radial-gradient(1200px 600px at 110% 110%, rgba(46,204,113,.18), transparent),rgba(255,255,255,.35);backdrop-filter: blur(10px)}
#appLoader .loader-card{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(255,255,255,.78);border:1px solid rgba(255,255,255,.6);box-shadow:0 20px 40px rgba(0,0,0,.12);border-radius:18px;padding:22px 26px;min-width:260px;text-align:center}
.spinner-premium{width:44px;height:44px;border-radius:50%;border:4px solid rgba(52,152,219,.25);border-top-color:#3498db;animation:spin .9s linear infinite;margin:8px auto 10px}
@keyframes spin{to{transform:rotate(360deg)}}

/* Offcanvas Log Calls (iPhone-like) */
.offcanvas-end{width:min(460px,33vw)}
.log-header{display:flex;align-items:center;gap:8px}
.log-list{list-style:none;margin:0;padding:0}
.log-item{display:flex;align-items:center;gap:12px;padding:10px 4px;border-bottom:1px solid rgba(0,0,0,.06);background:#fff}
.log-avatar{width:34px;height:34px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-weight:700;background:#eef6ff;color:#2c6bed}
.log-name{font-weight:600}
.log-meta{font-size:.86rem;color:#6b7280}
.log-type.badge{font-weight:600}
#logLoading{display:none}
#logLoading .spinner-border{width:1.6rem;height:1.6rem}

/* Floating button Log Calls */
.log-floating-btn{position:fixed;right:16px;bottom:16px;z-index:1040;background:#1f2937;color:#fff;border:none;border-radius:999px;padding:10px 14px;box-shadow:0 10px 24px rgba(0,0,0,.18);display:flex;align-items:center;gap:8px}
.log-floating-btn:hover{opacity:.9}

/* NADI table */
.nadi-table th,.nadi-table td{white-space:nowrap}
.nadi-mini{font-size:.88rem;opacity:.75}

/* Auto-grow inputs (melebar ikut kandungan) */
.auto-grow{min-width:140px;max-width:520px;width:140px;transition:width .12s ease}
.table-responsive{overflow-x:auto}

@media (max-width:768px){
  .navbar-brand{font-size:1rem}
  .stat-card .number{font-size:1.6rem}
}
</style>
</head>
<body>
<!-- Loader -->
<div id="appLoader" aria-hidden="true">
  <div class="loader-card">
    <div class="spinner-premium"></div>
    <div class="fw-bold">Sila tunggu…</div>
    <div id="loaderMsg" class="text-muted">Memproses permintaan anda</div>
  </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-main sticky-top">
  <div class="container">
    <a class="navbar-brand" href="#dashboard">
      <img id="brandLogo" class="brand-logo" alt="Logo Klinik">
      <span>Klinik SihatSokmo</span>
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarMain">
      <ul class="navbar-nav me-auto mb-2 mb-lg-0">
        <!-- 1) Dashboard -->
        <li class="nav-item"><a class="nav-link active" href="#dashboard"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
        <!-- 2) NADI (selepas Dashboard) -->
        <li class="nav-item"><a class="nav-link" href="#nadi-program"><i class="fa-solid fa-hands-holding-heart"></i> Program PEKA B40 bersama NADI</a></li>
        <!-- Lain-lain -->
        <li class="nav-item"><a class="nav-link" href="#kelayakan"><i class="fa-solid fa-file-excel"></i> Kelayakan (Excel)</a></li>
        <li class="nav-item"><a class="nav-link" href="#pendaftaran"><i class="fas fa-user-plus"></i> Pendaftaran</a></li>
        <li class="nav-item"><a class="nav-link" href="#tca-call"><i class="fas fa-phone"></i> TCA Call</a></li>
        <li class="nav-item"><a class="nav-link" href="#first-visit"><i class="fas fa-calendar-check"></i> First Visit</a></li>
        <li class="nav-item"><a class="nav-link" href="#lab-followup"><i class="fa-solid fa-flask-vial"></i> Follow-up Lab Report</a></li>
        <li class="nav-item"><a class="nav-link" href="#second-visit"><i class="fas fa-calendar-check"></i> Second Visit</a></li>
        <li class="nav-item"><a class="nav-link" href="#selesai"><i class="fas fa-check-circle"></i> Selesai</a></li>
        <li class="nav-item"><a class="nav-link" href="#arkib"><i class="fa-solid fa-box-archive"></i> Arkib</a></li>
      </ul>
      <button class="log-floating-btn" type="button" data-bs-toggle="offcanvas" data-bs-target="#offcanvasLog">
        <i class="fa-solid fa-list-ul"></i> Log Calls
      </button>
    </div>
  </div>
</nav>

<!-- Header -->
<header class="page-header">
  <div class="container">
    <div class="row align-items-center g-2">
      <div class="col-md-6">
        <h1 class="h5 m-0"><i class="fas fa-heartbeat me-2"></i> Sistem TRacKer PEKA B40</h1>
        <div class="small opacity-75">Sistem pengurusan pesakit untuk program saringan kesihatan PEKA B40</div>
      </div>
      <div class="col-md-6 text-md-end">
        <span class="badge bg-light text-dark fs-6 p-2"><i class="fas fa-calendar-day me-1"></i> <span id="current-date"></span></span>
      </div>
    </div>
  </div>
</header>

<main class="container">

  <!-- Dashboard -->
  <section id="dashboard" class="mb-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="h6 m-0"><i class="fas fa-tachometer-alt me-2"></i>Dashboard</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-success" id="btnExportCSV"><i class="fa-solid fa-file-csv me-1"></i>Export (CSV)</button>
      </div>
    </div>

    <div class="row g-3 mb-3">
      <div class="col-md-2">
        <div class="stat-card" data-target="#pendaftaran" style="background:linear-gradient(135deg,var(--secondary),#2980b9)">
          <div class="number" id="totalDaftar">0</div><div class="small">Aktif</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="stat-card" data-target="#first-visit" style="background:linear-gradient(135deg,var(--warning),#e67e22)">
          <div class="number" id="totalFirstVisit">0</div><div class="small">First Visit (Pending)</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="stat-card" data-target="#second-visit" style="background:linear-gradient(135deg,#9b59b6,#8e44ad)">
          <div class="number" id="totalSecondVisit">0</div><div class="small">Second Visit (Pending)</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="stat-card" data-target="#selesai" style="background:linear-gradient(135deg,var(--success),#16a085)">
          <div class="number" id="totalSelesai">0</div><div class="small">Selesai</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="stat-card" data-target="#lab-followup" style="background:linear-gradient(135deg,#8e44ad,#6c5ce7)">
          <div class="number" id="labFollowUpDue">0</div><div class="small">Result > 3 Hari</div>
        </div>
      </div>
      <div class="col-md-2">
        <div class="stat-card" data-target="#lab-followup" style="background:linear-gradient(135deg,#d35400,#c0392b)">
          <div class="number" id="labFollowUpPending">0</div><div class="small">Perlu Follow-up</div>
        </div>
      </div>
    </div>

    <!-- TCA Hari Ini -->
    <div class="card mb-3">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-phone me-2"></i>Pesakit Perlu Dihubungi Hari Ini</span>
        <input class="form-control form-control-sm searchbar" id="searchTCA" placeholder="Cari nama/IC/telefon…" />
      </div>
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
              <tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh TCA</th><th>Status</th><th>Tindakan</th></tr>
            </thead>
            <tbody id="tcaCallTable"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Statistik (3D) -->
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
        <select id="statPeriod" class="form-select form-select-sm" style="max-width:200px">
          <option value="3months">3 Bulan Terakhir</option>
          <option value="6months">6 Bulan Terakhir</option>
          <option value="12months">12 Bulan Terakhir</option>
        </select>
      </div>
      <div class="card-body" style="height:340px">
        <canvas id="stats3dChart" height="300"></canvas>
      </div>
    </div>
  </section>

  <!-- Kelayakan (Excel) -->
  <section id="kelayakan" class="mb-4 d-none">
    <h2 class="h6 mb-3"><i class="fa-solid fa-file-excel me-2"></i>Semak Kelayakan (Import Excel)</h2>
    <div class="card"><div class="card-body">
      <div class="row g-2 align-items-center mb-3">
        <div class="col-md-6">
          <input type="file" id="excelFile" class="form-control" accept=".xlsx,.xls" />
          <div class="form-text">Fail perlu ada lajur: <b>Nama</b>, <b>IC</b>, <b>Telefon</b>.</div>
        </div>
      </div>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama</th><th>IC</th><th>Telefon</th>
              <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
              <th style="min-width:360px">Jika Layak → TCA/Masa/Nama Staf</th><th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="kelayakanTable"><tr><td colspan="7" class="text-center text-muted">Muat naik Excel untuk mula.</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Pendaftaran -->
  <section id="pendaftaran" class="mb-4 d-none">
    <h2 class="h6 mb-3"><i class="fas fa-user-plus me-2"></i>Pendaftaran Pesakit Baru</h2>
    <div class="card"><div class="card-body">
      <form id="formPendaftaran">
        <div class="row g-3">
          <div class="col-md-6"><label class="form-label">Nama Penuh Pesakit</label><input id="namaPesakit" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nombor IC</label><input id="noIC" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Nombor Telefon</label><input id="noTelefon" class="form-control" type="tel" required placeholder="cth: 0123456789 atau 60123456789"></div>
          <div class="col-md-6"><label class="form-label">Nama Staff</label><input id="namaStaff" class="form-control" required></div>
          <div class="col-md-6"><label class="form-label">Tarikh TCA</label><input id="tarikhTCA" class="form-control" type="date" required></div>
          <div class="col-md-6"><label class="form-label">Masa TCA</label><input id="masaTCA" class="form-control" type="time" required></div>
          <div class="col-12"><button class="btn btn-primary"><i class="fas fa-save me-1"></i>Daftar Pesakit</button></div>
        </div>
      </form>
    </div></div>
  </section>

  <!-- TCA Call -->
  <section id="tca-call" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-phone me-2"></i>Senarai TCA Call</h2>
      <input class="form-control form-control-sm searchbar" id="searchTCAPage" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh TCA</th><th>Status</th><th>Tindakan</th></tr></thead>
        <tbody id="tcaCallList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- First Visit -->
  <section id="first-visit" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>First Visit</h2>
      <input class="form-control form-control-sm searchbar" id="searchFirst" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
          <tbody id="firstVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Follow-up Lab Report -->
  <section id="lab-followup" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-flask-vial me-2"></i>Follow-up Lab Report</h2>
      <input class="form-control form-control-sm searchbar" id="searchLab" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr><th>Nama</th><th>IC</th><th>Telefon</th><th>Tarikh First Visit</th><th>Hari Ke-</th><th>Status</th><th>Tindakan</th></tr>
          </thead>
          <tbody id="labFollowupTable"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Second Visit -->
  <section id="second-visit" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-calendar-check me-2"></i>Second Visit</h2>
      <input class="form-control form-control-sm searchbar" id="searchSecond" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>Tarikh TCA</th><th>PDPA</th><th>Status</th><th>Tindakan</th></tr></thead>
          <tbody id="secondVisitList"><tr><td colspan="6" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Selesai -->
  <section id="selesai" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fas fa-check-circle me-2"></i>Pesakit Selesai</h2>
      <input class="form-control form-control-sm searchbar" id="searchCompleted" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card mb-3"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
            <tr>
              <th>Nama</th><th>No IC</th><th>Telefon</th><th>PDPA</th>
              <th>Tarikh Daftar</th><th>Tarikh First Visit</th>
              <th>Lab Completed</th><th>Tarikh Second Visit</th><th>Tarikh Selesai</th>
              <th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="completedTable"><tr><td colspan="10" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>

    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <span><i class="fas fa-chart-bar me-2"></i>Statistik Pesakit Selesai</span>
        <select id="statPeriodCompleted" class="form-select form-select-sm" style="max-width:200px">
          <option value="3months">3 Bulan Terakhir</option>
          <option value="6months">6 Bulan Terakhir</option>
          <option value="12months">12 Bulan Terakhir</option>
        </select>
      </div>
      <div class="card-body" style="height:340px">
        <canvas id="completed3dChart" height="300"></canvas>
      </div>
    </div>
  </section>

  <!-- Arkib -->
  <section id="arkib" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-box-archive me-2"></i>Arkib</h2>
      <input class="form-control form-control-sm searchbar" id="searchArchive" placeholder="Cari nama/IC/telefon…"/>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light"><tr><th>Nama Pesakit</th><th>No IC</th><th>No Telefon</th><th>Tarikh Daftar</th><th>Tarikh Selesai</th><th>Diarkib</th><th>Tindakan</th></tr></thead>
          <tbody id="archiveTable"><tr><td colspan="7" class="text-center text-muted">Memuat data...</td></tr></tbody>
        </table>
      </div>
    </div></div>
  </section>

  <!-- Program NADI -->
  <section id="nadi-program" class="mb-4 d-none">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <h2 class="h6 m-0"><i class="fa-solid fa-hands-holding-heart me-2"></i>Program PEKA B40 bersama NADI</h2>
      <div class="d-flex gap-2">
        <button class="btn btn-sm btn-outline-primary" id="btnAddNadiRow"><i class="fa-solid fa-plus"></i> Tambah Baris</button>
        <button class="btn btn-sm btn-success" id="btnExportNadiCSV"><i class="fa-solid fa-file-arrow-down"></i> Transfer kepada fail Excel (CSV)</button>
      </div>
    </div>
    <div class="card"><div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle nadi-table">
          <thead class="table-light">
            <tr>
              <th>#</th><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th>
              <th>BP</th>
              <th>DXT</th>
              <th>Tinggi (cm)</th><th>Berat (kg)</th><th>BMI</th>
              <th class="text-center">Layak</th><th class="text-center">Tidak Layak</th>
              <th>TCA</th><th>Masa</th><th>Nama Staf</th><th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="nadiBody"></tbody>
        </table>
        <div class="nadi-mini">* BMI dikira automatik bila “Tinggi” & “Berat” diisi. Jika <b>Layak</b>, isikan TCA/Masa/Nama Staf dan klik <b>Daftar</b> untuk simpan ke Sheet. Peserta <b>Tidak Layak</b> tidak disimpan ke Sheet tetapi akan dieksport dalam CSV.</div>
      </div>
    </div></div>
  </section>

</main>

<!-- Offcanvas Log Calls -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="offcanvasLog" aria-labelledby="offcanvasLogLabel">
  <div class="offcanvas-header">
    <div class="log-header">
      <i class="fa-solid fa-list-ul"></i>
      <h5 class="offcanvas-title" id="offcanvasLogLabel">Log Calls</h5>
      <span class="badge text-bg-light ms-1" id="logCount">0</span>
    </div>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body p-0">
    <div id="logLoading" class="d-flex align-items-center justify-content-center py-2">
      <div class="spinner-border" role="status" aria-hidden="true"></div>
      <span class="ms-2">Memuat log…</span>
    </div>
    <ul class="log-list" id="logList"></ul>
  </div>
</div>

<!-- Modal Re-TCA -->
<div class="modal fade" id="retcaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fa-solid fa-calendar-plus me-2"></i>Daftar TCA Semula</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="retcaIC">
      <div class="mb-3"><label class="form-label">Tarikh TCA Baharu</label><input type="date" id="retcaDate" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Masa TCA Baharu</label><input type="time" id="retcaTime" class="form-control" required></div>
      <small class="text-muted">Status pesakit akan ditukar kepada <b>TCA CALL</b>.</small>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      <button class="btn btn-primary" id="btnSubmitRetca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
    </div>
  </div></div>
</div>

<!-- Modal Set Second Visit TCA (+ Nama Staf wajib) -->
<div class="modal fade" id="secondTcaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fa-solid fa-calendar-check me-2"></i>Tetapkan TCA Second Visit</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="secondTcaIC">
      <div class="mb-3"><label class="form-label">Tarikh TCA Second Visit</label><input type="date" id="secondTcaDate" class="form-control" required></div>
      <div class="mb-3"><label class="form-label">Masa TCA</label><input type="time" id="secondTcaTime" class="form-control" required></div>
      <div class="mb-2"><label class="form-label">Nama Staf</label><input type="text" id="secondTcaStaff" class="form-control" required placeholder="cth: Dayah"></div>
      <small class="text-muted">Pesakit akan muncul dalam senarai <b>Second Visit</b> dengan TCA yang ditetapkan. Nama staf Wajib diisi.</small>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
      <button class="btn btn-primary" id="btnSubmitSecondTca"><i class="fa-solid fa-floppy-disk me-1"></i>Simpan</button>
    </div>
  </div></div>
</div>

<!-- Modal Upload PDPA -->
<div class="modal fade" id="pdpaModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered"><div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title"><i class="fa-solid fa-file-arrow-up me-2"></i>Muat Naik Borang PDPA</h5>
      <button class="btn-close" data-bs-dismiss="modal"></button>
    </div>
    <div class="modal-body">
      <input type="hidden" id="pdpaIC">
      <input type="file" id="pdpaFile" class="form-control" accept="application/pdf,image/*" />
      <div class="form-text">Muat naik PDF / imej borang PDPA pesakit.</div>
    </div>
    <div class="modal-footer">
      <button class="btn btn-secondary" data-bs-dismiss="modal">Tutup</button>
      <button class="btn btn-primary" id="btnUploadPDPA"><i class="fa-solid fa-cloud-arrow-up me-1"></i>Upload</button>
    </div>
  </div></div>
</div>

<!-- Toasts -->
<div class="toasts" id="toastContainer"></div>

<footer class="footer mt-4 py-3 bg-light">
  <div class="container"><div class="d-flex justify-content-between">
    <div>&copy; 2025 Klinik SihatSokmo. Untuk kegunaan Klinik sahaja.</div>
    <div>Versi 2.5.0</div>
  </div></div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* =======================
   KONFIG
======================= */
const CONFIG = {
  SCRIPT_URL: 'https://script.google.com/macros/s/AKfycbx6TKE0vDDPO3-36cY7xjacAbGL0HIRKCrORNm-sED9y5NpIeIUk9gyrpiWy-S7vbc/exec',
  LOGO_URL: 'https://github.com/sihat9/mari-jalan-dengan-doktor/blob/main/img/logo-kss.png?raw=true',
  LOG_REFRESH_MS: 10000
};

/* =======================
   LOADER
======================= */
function showLoader(msg='Memproses permintaan anda…'){
  document.getElementById('loaderMsg').textContent = msg;
  const el = document.getElementById('appLoader');
  el.style.display = 'block';
  clearTimeout(showLoader._t); showLoader._t = setTimeout(()=>{ el.style.display='none'; }, 2000);
}
function hideLoader(){ document.getElementById('appLoader').style.display = 'none'; }

/* =======================
   NETWORK HELPERS
======================= */
const getJSON = async (params={}, opts={}) => {
  const { silent=false, msg='Memuat data…', timeout=6000 } = opts;
  const qs = new URLSearchParams(params).toString();
  const url = qs ? `${CONFIG.SCRIPT_URL}?${qs}` : CONFIG.SCRIPT_URL;
  if (!silent) showLoader(msg);
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const res = await fetch(url, { method:'GET', signal: ctrl.signal });
    return await res.json();
  } catch(e){
    console.warn('GET fail', e);
    return { status:'error', message: String(e) };
  } finally { clearTimeout(id); if (!silent) hideLoader(); }
};
const postForm = async (params={}, opts={}) => {
  const { silent=false, msg='Menyimpan data…', timeout=8000 } = opts;
  if (!silent) showLoader(msg);
  const ctrl = new AbortController();
  const id = setTimeout(()=>ctrl.abort(), timeout);
  try{
    const body = new URLSearchParams(params);
    const res = await fetch(CONFIG.SCRIPT_URL, {
      method:'POST',
      headers:{ 'Content-Type':'application/x-www-form-urlencoded' },
      body, signal: ctrl.signal
    });
    return await res.json();
  } catch(e){
    console.warn('POST fail', e);
    return { status:'error', message: String(e) };
  } finally { clearTimeout(id); if (!silent) hideLoader(); }
};

/* =======================
   UTIL
======================= */
const normalizeMsisdnMY = (raw) => {
  if (!raw) return '';
  let s = String(raw).replace(/\D/g,'');
  if (s.startsWith('00')) s = s.slice(2);
  if (s.startsWith('60')) return s;
  if (s.startsWith('0')) return '60' + s.slice(1);
  return '60' + s;
};
const telHref = (msisdn) => `tel:+${msisdn}`;
const waHref  = (msisdn, txt='Assalamualaikum, ini dari Klinik SihatSokmo.') => `https://wa.me/${msisdn}?text=${encodeURIComponent(txt)}`;
function showToast(title, message, variant='primary'){
  const container = document.getElementById('toastContainer');
  const id = 't'+Date.now();
  const html = `<div class="toast align-items-center text-bg-${variant} border-0 mb-2" id="${id}" role="alert" aria-live="assertive" aria-atomic="true"><div class="d-flex"><div class="toast-body"><strong>${title}:</strong> ${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div></div>`;
  container.insertAdjacentHTML('beforeend', html);
  const el = document.getElementById(id);
  const t = new bootstrap.Toast(el, { delay: 2600 });
  t.show(); el.addEventListener('hidden.bs.toast', ()=>el.remove());
}
const ddmmyyyy = (iso) => {
  if (!iso) return '';
  const m=/^(\d{4})-(\d{2})-(\d{2})$/.exec(iso); if(!m) return iso;
  const [_,Y,MM,DD]=m; return `${DD}/${MM}/${Y}`;
}

/* Auto-grow input width */
function autoGrow(el){
  const s = document.createElement('span');
  s.style.visibility='hidden'; s.style.whiteSpace='pre';
  s.style.font = getComputedStyle(el).font;
  s.textContent = el.value || el.placeholder || '';
  document.body.appendChild(s);
  const w = Math.min(Math.max(s.offsetWidth + 28, 140), 520);
  el.style.width = w + 'px';
  document.body.removeChild(s);
}

/* =======================
   GLOBALS
======================= */
let stats3dChart, completed3dChart;
let retcaModal, secondTcaModal, pdpaModal;
let offcanvasLog; let logTimer = null;

/* =======================
   INIT
======================= */
document.addEventListener('DOMContentLoaded', () => {
  // Logo + fallback
  const logoEl = document.getElementById('brandLogo');
  logoEl.src = CONFIG.LOGO_URL;
  logoEl.onerror = () => (logoEl.src = 'https://via.placeholder.com/64x64.png?text=KS');

  // Tarikh semasa
  const opt = { weekday:'long', year:'numeric', month:'long', day:'numeric' };
  document.getElementById('current-date').textContent = new Date().toLocaleDateString('ms-MY', opt);

  setupNavigation();
  setupModals();
  setupSearchBars();
  setupExports();
  setupExcel();   // (Kelayakan)
  setupNadi();    // (Program NADI)

  // Bootstrap: cepat ≤2s
  bootstrapLoad();

  // Auto refresh Log bila panel dibuka
  offcanvasLog = document.getElementById('offcanvasLog');
  offcanvasLog.addEventListener('shown.bs.offcanvas', ()=>{ startLogAuto(); refreshLogCalls(true); });
  offcanvasLog.addEventListener('hidden.bs.offcanvas', stopLogAuto);
});

async function bootstrapLoad(){
  showLoader('Memuat Dashboard…');
  const boot = await getJSON({ action:'bootstrap' }, { msg:'Memuat Dashboard…' });
  hideLoader();
  if (boot.status==='success'){
    const d = boot.dashboard || {};
    totalDaftar.textContent = d.totalDaftar || 0;
    totalFirstVisit.textContent = d.totalFirstVisit || 0;
    totalSecondVisit.textContent = d.totalSecondVisit || 0;
    totalSelesai.textContent = d.totalSelesai || 0;
    labFollowUpDue.textContent = d.labFollowUpDue || 0;
    labFollowUpPending.textContent = d.labFollowUpPending || 0;
    if (Array.isArray(boot.tcaToday)){
      const tb = document.getElementById('tcaCallTable'); tb.innerHTML='';
      boot.tcaToday.forEach(p=> tb.insertAdjacentHTML('beforeend', renderTCARow(p, true)));
      if (!boot.tcaToday.length) tb.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada pesakit perlu dihubungi hari ini</td></tr>`;
    }
  }
  // Prefetch tanpa loader global
  loadStatistics('3months', true);
  loadCompletedStatistics('3months', true);
}

/* =======================
   NAV + CLICKABLE STAT
======================= */
function setupNavigation(){
  document.querySelectorAll('.nav-link').forEach(a=>{
    a.addEventListener('click',(e)=>{ e.preventDefault(); navigateTo(a.getAttribute('href')); });
  });
  document.querySelectorAll('.stat-card[data-target]').forEach(card=>{
    card.addEventListener('click', ()=> navigateTo(card.getAttribute('data-target')));
  });
  document.getElementById('formPendaftaran').addEventListener('submit', async (e)=>{ e.preventDefault(); await daftarPesakit(); });
  document.getElementById('statPeriod').addEventListener('change', function(){ loadStatistics(this.value); });
  document.getElementById('statPeriodCompleted').addEventListener('change', function(){ loadCompletedStatistics(this.value); });
}
function navigateTo(target){
  document.querySelectorAll('main section').forEach(s=>s.classList.add('d-none'));
  document.querySelectorAll('.nav-link').forEach(n=>n.classList.remove('active'));
  const link = document.querySelector(`.nav-link[href="${target}"]`); if (link) link.classList.add('active');
  const sec = document.querySelector(target); if (sec) sec.classList.remove('d-none');

  if (target==='#dashboard'){ loadDashboardData(); loadStatistics(document.getElementById('statPeriod').value, true); }
  else if (target==='#kelayakan'){ /* no-op */ }
  else if (target==='#pendaftaran'){ /* no-op */ }
  else if (target==='#tca-call'){ loadTCACallData(); }
  else if (target==='#first-visit'){ loadFirstVisitData(); }
  else if (target==='#lab-followup'){ loadLabFollowUp(); }
  else if (target==='#second-visit'){ loadSecondVisitData(); }
  else if (target==='#selesai'){ loadCompletedData(); loadCompletedStatistics(document.getElementById('statPeriodCompleted').value, true); }
  else if (target==='#arkib'){ loadArchivedData(); }
  else if (target==='#nadi-program'){ /* no-op */ }
}

/* =======================
   MODALS
======================= */
function setupModals(){
  retcaModal = new bootstrap.Modal(document.getElementById('retcaModal'));
  document.getElementById('btnSubmitRetca').addEventListener('click', submitRetca);

  secondTcaModal = new bootstrap.Modal(document.getElementById('secondTcaModal'));
  document.getElementById('btnSubmitSecondTca').addEventListener('click', submitSecondTca);

  pdpaModal = new bootstrap.Modal(document.getElementById('pdpaModal'));
  document.getElementById('btnUploadPDPA').addEventListener('click', uploadPDPA);
}

/* =======================
   CARIAN
======================= */
function setupSearchBars(){
  const pairs = [
    ['searchTCA','tcaCallTable'], ['searchTCAPage','tcaCallList'],
    ['searchFirst','firstVisitList'], ['searchSecond','secondVisitList'],
    ['searchCompleted','completedTable'], ['searchLab','labFollowupTable'],
    ['searchArchive','archiveTable']
  ];
  pairs.forEach(([inpId,tbodyId])=>{
    const inp = document.getElementById(inpId);
    const tb = document.getElementById(tbodyId);
    if (!inp || !tb) return;
    inp.addEventListener('input', ()=>{
      Array.from(tb.querySelectorAll('tr')).forEach(tr=>{
        const text = tr.innerText || '';
        tr.style.display = (text.toLowerCase().includes((inp.value||'').trim().toLowerCase())) ? '' : 'none';
      });
    });
  });
}

/* =======================
   EXPORT CSV (Selesai)
======================= */
function setupExports(){
  document.getElementById('btnExportCSV').addEventListener('click', exportCompletedCSV);
}

/* =======================
   DASHBOARD & STAT (3D)
======================= */
async function loadDashboardData(){
  const data = await getJSON({ action:'getDashboardData' }, { msg:'Memuat Dashboard…' });
  if (data.status==='success'){
    totalDaftar.textContent = data.data.totalDaftar || 0;
    totalFirstVisit.textContent = data.data.totalFirstVisit || 0;
    totalSecondVisit.textContent = data.data.totalSecondVisit || 0;
    totalSelesai.textContent = data.data.totalSelesai || 0;
    labFollowUpDue.textContent = data.data.labFollowUpDue || 0;
    labFollowUpPending.textContent = data.data.labFollowUpPending || 0;
  }
}
async function loadStatistics(period, silent=false){
  const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…', silent });
  if (data.status==='success') update3DBarChart('stats3dChart', data.data, `Statistik (${getPeriodLabel(period)})`);
}
async function loadCompletedStatistics(period, silent=false){
  const data = await getJSON({ action:'getStatistics', period }, { msg:'Memuat statistik…', silent });
  if (data.status==='success') update3DBarChart('completed3dChart', data.data, `Selesai (${getPeriodLabel(period)})`);
}
function update3DBarChart(canvasId, rows, title){
  const labels = rows.map(i=>i.label);
  const values = rows.map(i=>i.count);
  const colors = values.map((_,i)=>`hsla(${(i*37)%360},70%,50%,0.85)`);

  const ctx = document.getElementById(canvasId).getContext('2d');
  const isStats = canvasId==='stats3dChart';
  if (isStats && stats3dChart) stats3dChart.destroy();
  if (!isStats && completed3dChart) completed3dChart.destroy();

  let chart;
  try{
    chart = new Chart(ctx, {
      type: 'bar3d',
      data: { labels, datasets: [{ label:'Jumlah Pesakit', data: values, backgroundColor: colors }] },
      options: {
        plugins: {
          datalabels: { display:false },
          legend: { display:false },
          title: { display:true, text:title, font:{ weight:600, size:16 } },
          tooltip: { callbacks: { label:(c)=>`Jumlah: ${c.raw}` } }
        },
        scales: { x:{ grid:{ display:false } }, y:{ beginAtZero:true, title:{ display:true, text:'Jumlah' } }, z:{ display:false } },
        aspectRatio: 2.2,
      }
    });
  } catch(e){
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels, datasets: [{ label:'Jumlah Pesakit', data: values, backgroundColor: colors }] },
      options: { plugins:{ legend:{ display:false }, title:{ display:true, text:title, font:{ weight:600, size:16 } } }, scales:{ y:{ beginAtZero:true } } }
    });
  }
  if (isStats) stats3dChart = chart; else completed3dChart = chart;
}
function getPeriodLabel(p){ return p==='3months'?'3 Bulan Terakhir':(p==='6months'?'6 Bulan Terakhir':'12 Bulan Terakhir'); }

/* =======================
   RENDER HELPERS
======================= */
function renderTCARow(p){
  const msisdn = normalizeMsisdnMY(p.noTelefon||'');
  return `
  <tr data-ic="${p.noIC}">
    <td>${p.nama||'-'}</td>
    <td>${p.noIC||'-'}</td>
    <td class="mini-actions">
      <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
      <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
      <div class="small text-muted mt-1">${msisdn}</div>
    </td>
    <td>${p.tarikhTCA||'-'} ${p.masaTCA||''}</td>
    <td><span class="badge bg-warning">${p.status||'TCA CALL'}</span></td>
    <td class="mini-actions"><button class="btn btn-sm btn-primary" onclick="openRetcaModal('${p.noIC}')"><i class="fa-solid fa-calendar-plus"></i> Re-TCA</button></td>
  </tr>`;
}

/* =======================
   SENARAI (GET)
======================= */
async function loadTCACallData(){
  const data = await getJSON({ action:'getTCACall' }, { msg:'Memuat TCA Hari Ini…' });
  const tb1 = document.getElementById('tcaCallTable');
  const tb2 = document.getElementById('tcaCallList');
  [tb1,tb2].forEach(tb=> tb && (tb.innerHTML=''));
  if (data.status==='success' && data.data.length){
    data.data.forEach(p=>{
      const row = renderTCARow(p);
      if (tb1) tb1.insertAdjacentHTML('beforeend', row);
      if (tb2) tb2.insertAdjacentHTML('beforeend', row);
    });
  } else {
    const empty = `<tr><td colspan="6" class="text-center text-muted">Tiada pesakit perlu dihubungi hari ini</td></tr>`;
    if (tb1) tb1.innerHTML = empty; if (tb2) tb2.innerHTML = empty;
  }
}

async function loadFirstVisitData(){
  const data = await getJSON({ action:'getFirstVisit' }, { msg:'Memuat First Visit…' });
  const tbody = document.getElementById('firstVisitList');
  tbody.innerHTML = '';
  if (data.status==='success' && data.data.length){
    data.data.forEach(p=>{
      const hadir = p.status==='HADIR';
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      let pdpaHTML = '';
      if (p.pdpaFileId){
        pdpaHTML = `
          <div class="d-flex flex-wrap gap-1">
            <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
            <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
            <button class="btn btn-sm btn-outline-danger" onclick="deletePDPA('${p.noIC}')"><i class="fa-solid fa-trash"></i> Padam</button>
          </div>`;
      } else {
        pdpaHTML = hadir ? `<button class="btn btn-sm btn-outline-primary" onclick="openPDPA('${p.noIC}')"><i class="fa-solid fa-file-arrow-up"></i> Upload</button>` : `<span class="text-muted">-</span>`;
      }
      const row = `
      <tr data-ic="${p.noIC}">
        <td>${p.nama}</td>
        <td>${p.noIC}</td>
        <td>${p.tarikhTCA||'-'} ${p.masaTCA||''}</td>
        <td>${pdpaHTML}</td>
        <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
        <td class="mini-actions">
          ${!hadir ? `<button class="btn btn-sm btn-success" onclick="markFirstVisit('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
          ${!hadir ? `<button class="btn btn-sm btn-primary" onclick="openRetcaModal('${p.noIC}')"><i class="fa-solid fa-calendar-plus"></i> Re-TCA</button>` : ''}
          ${msisdn ? `<a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
        </td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  } else {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada data First Visit</td></tr>`;
  }
}

async function loadLabFollowUp(){
  const data = await getJSON({ action:'getLabFollowUp' }, { msg:'Memuat Follow-up Lab…' });
  const tbody = document.getElementById('labFollowupTable');
  tbody.innerHTML = '';
  if (data.status==='success' && data.data.length){
    data.data.forEach(p=>{
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      const badge = p.labStatus==='DONE' ? 'bg-success' : (p.labStatus==='REPEAT' ? 'bg-danger' : (p.labStatus==='IN_PROCESS' ? 'bg-warning' : 'bg-secondary'));
      const label = p.labStatus || 'PENDING';
      const row = `
      <tr data-ic="${p.noIC}">
        <td>${p.nama}</td>
        <td>${p.noIC}</td>
        <td class="mini-actions">
          <a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i> Call</a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn,'Keputusan makmal anda telah siap.')}"><i class="fa-brands fa-whatsapp"></i> WhatsApp</a>
          <div class="small text-muted mt-1">${msisdn}</div>
        </td>
        <td>${p.firstVisitDate||'-'}</td>
        <td>${p.daysSince}</td>
        <td><span class="badge ${badge}">${label}</span></td>
        <td class="mini-actions">
          <button class="btn btn-sm btn-success" onclick="openSecondTca('${p.noIC}')"><i class="fa-solid fa-square-check"></i> Result selesai & berjaya call</button>
          <button class="btn btn-sm btn-warning" onclick="markLabStatus('${p.noIC}','IN_PROCESS')"><i class="fa-solid fa-hourglass-half"></i> Result in process</button>
          <button class="btn btn-sm btn-danger" onclick="markLabStatus('${p.noIC}','REPEAT')"><i class="fa-solid fa-rotate-left"></i> Repeat sample</button>
        </td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  } else {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada pesakit untuk follow-up.</td></tr>`;
  }
}

async function loadSecondVisitData(){
  const data = await getJSON({ action:'getSecondVisit' }, { msg:'Memuat Second Visit…' });
  const tbody = document.getElementById('secondVisitList');
  tbody.innerHTML = '';
  if (data.status==='success' && data.data.length){
    data.data.forEach(p=>{
      const hadir = p.status==='HADIR';
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      let pdpaHTML = p.pdpaFileId
        ? `<div class="d-flex flex-wrap gap-1">
            <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
            <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
          </div>`
        : `<span class="text-danger">PDPA tiada</span>`;
      const row = `
      <tr data-ic="${p.noIC}">
        <td>${p.nama}</td>
        <td>${p.noIC}</td>
        <td>${p.tarikhTCA||'-'} ${p.masaTCA||''}</td>
        <td>${pdpaHTML}</td>
        <td><span class="badge ${hadir?'bg-success':'bg-warning'}">${hadir?'Hadir':'Belum Hadir'}</span></td>
        <td class="mini-actions">
          ${!hadir ? `<button class="btn btn-sm btn-success" onclick="markSecondVisitHadir('${p.noIC}')"><i class="fa-solid fa-circle-check"></i> Hadir</button>` : ''}
          ${msisdn ? `<a class="btn btn-sm btn-outline-secondary" href="${telHref(msisdn)}"><i class="fa-solid fa-phone"></i></a>
          <a class="btn btn-sm btn-outline-success" target="_blank" href="${waHref(msisdn)}"><i class="fa-brands fa-whatsapp"></i></a>` : ''}
        </td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  } else {
    tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Tiada data Second Visit</td></tr>`;
  }
}

async function loadCompletedData(){
  const data = await getJSON({ action:'getCompleted' }, { msg:'Memuat Selesai…' });
  const tbody = document.getElementById('completedTable');
  tbody.innerHTML = '';
  if (data.status==='success' && data.data.length){
    data.data.forEach(p=>{
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      const pdpaHTML = p.pdpaFileId
        ? `<div class="d-flex flex-wrap gap-1">
            <a class="btn btn-sm btn-outline-success" target="_blank" href="https://drive.google.com/file/d/${p.pdpaFileId}/preview"><i class="fa-solid fa-eye"></i> Lihat</a>
            <a class="btn btn-sm btn-outline-primary" target="_blank" href="https://drive.google.com/uc?export=download&id=${p.pdpaFileId}"><i class="fa-solid fa-download"></i> Muat Turun</a>
          </div>`
        : `<span class="text-muted">-</span>`;
      const labBy = p.labCompletedAt ? `${p.labCompletedAt}${p.labCompletedBy?(' by '+p.labCompletedBy):''}` : '-';
      const row = `<tr data-ic="${p.noIC}">
        <td>${p.nama||'-'}</td><td>${p.noIC||'-'}</td><td>${msisdn||'-'}</td><td>${pdpaHTML}</td>
        <td>${p.tarikhDaftar||'-'}</td>
        <td>${p.firstVisitDate||'-'}</td>
        <td>${labBy}</td>
        <td>${p.secondVisitDate||'-'}</td>
        <td>${p.tarikhSelesai||'-'}</td>
        <td><button class="btn btn-sm btn-outline-secondary" onclick="archivePatient('${p.noIC}')"><i class="fa-solid fa-box-archive"></i> Arkib</button></td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  } else {
    tbody.innerHTML = `<tr><td colspan="10" class="text-center text-muted">Tiada data pesakit selesai</td></tr>`;
  }
}

async function loadArchivedData(){
  const data = await getJSON({ action:'getArchived' }, { msg:'Memuat Arkib…' });
  const tbody = document.getElementById('archiveTable');
  tbody.innerHTML = '';
  if (data.status==='success' && data.data.length){
    data.data.forEach(p=>{
      const msisdn = normalizeMsisdnMY(p.noTelefon||'');
      const row = `<tr data-ic="${p.noIC}">
        <td>${p.nama}</td><td>${p.noIC}</td><td>${msisdn}</td><td>${p.tarikhDaftar}</td><td>${p.tarikhSelesai}</td><td>${p.archivedAt||'-'}</td>
        <td><button class="btn btn-sm btn-outline-primary" onclick="restorePatient('${p.noIC}')"><i class="fa-solid fa-rotate-left"></i> Pulihkan</button></td>
      </tr>`;
      tbody.insertAdjacentHTML('beforeend', row);
    });
  } else {
    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada rekod arkib</td></tr>`;
  }
}

/* =======================
   ACTIONS
======================= */
async function markFirstVisit(noIC){
  const res = await postForm({ action:'updateStatus', op:'firstVisit', noIC, staff:'SYSTEM' }, { msg:'Merekod Hadir (First Visit)…' });
  if (res.status==='success'){
    showToast('Berjaya','Hadir (First Visit) direkodkan. Sila muat naik PDPA sekarang.', 'success');
    openPDPA(noIC);
    loadFirstVisitData(); loadLabFollowUp(); loadSecondVisitData(); loadDashboardData();
  } else showToast('Ralat', res.message||'Gagal rekod hadir', 'danger');
}

async function markSecondVisitHadir(noIC){
  const res = await postForm({ action:'updateStatus', op:'secondVisitHadir', noIC, staff:'SYSTEM' }, { msg:'Menandakan Hadir (Second Visit)…' });
  if (res.status==='success'){
    showToast('Berjaya','Second Visit selesai → dipindahkan ke Selesai','success');
    loadSecondVisitData(); loadCompletedData(); loadDashboardData();
  } else showToast('Ralat', res.message||'Gagal menandakan hadir', 'danger');
}

function openRetcaModal(noIC){
  retcaIC.value = noIC;
  retcaDate.value = ''; retcaTime.value = '';
  retcaModal.show();
}
async function submitRetca(){
  const noIC = retcaIC.value;
  const tarikhTCA = retcaDate.value;
  const masaTCA = retcaTime.value;
  if (!noIC || !tarikhTCA || !masaTCA) return showToast('Ralat','Sila lengkapkan tarikh & masa','danger');
  const res = await postForm({ action:'updateStatus', op:'retca', noIC, tarikhTCA, masaTCA, staff:'SYSTEM' }, { msg:'Mendaftar TCA semula…' });
  if (res.status==='success'){
    retcaModal.hide();
    showToast('Berjaya','TCA baharu disimpan','success');
    loadTCACallData(); loadFirstVisitData(); loadSecondVisitData(); loadDashboardData();
  } else showToast('Ralat', res.message||'Gagal kemaskini TCA', 'danger');
}

/* Follow-up → set TCA second + log staff */
function openSecondTca(noIC){
  secondTcaIC.value = noIC;
  secondTcaDate.value = ''; secondTcaTime.value = ''; secondTcaStaff.value = '';
  secondTcaModal.show();
}
async function submitSecondTca(){
  const noIC = secondTcaIC.value;
  const date = secondTcaDate.value;
  const time = secondTcaTime.value;
  const staff = secondTcaStaff.value.trim();
  if (!date || !time || !staff) { showToast('Ralat','Tarikh, Masa & Nama Staf wajib diisi','danger'); return; }
  const a = await postForm({ action:'updatePatient', noIC, tarikhTCA:date, masaTCA:time, staff }, { msg:'Menetapkan TCA Second Visit…' });
  if (a.status!=='success') return showToast('Ralat', a.message||'Gagal tetapkan TCA', 'danger');
  const b = await postForm({ action:'updateLabStatus', noIC, status:'DONE', staff }, { msg:'Mengemas kini status follow-up…' });
  if (b.status!=='success') return showToast('Ralat', b.message||'Gagal set follow-up DONE', 'danger');
  postForm({ action:'appendLogCall', noIC, staff, note:'LAB_DONE' }, { silent:true });
  secondTcaModal.hide();
  showToast('Berjaya','TCA Second Visit ditetapkan & follow-up ditanda selesai','success');
  loadLabFollowUp(); loadSecondVisitData(); loadDashboardData(); loadCompletedData();
}

/* Lab status selain DONE */
async function markLabStatus(noIC, status){
  const res = await postForm({ action:'updateLabStatus', noIC, status, staff:'SYSTEM' }, { msg:'Mengemas kini status follow-up…' });
  if (res.status==='success'){
    showToast('Follow-up', `Status ditetapkan: ${status==='IN_PROCESS'?'In Process':'Repeat Sample'}`, 'warning');
    loadLabFollowUp(); loadDashboardData();
  } else showToast('Ralat', res.message||'Gagal set status follow-up', 'danger');
}

/* PDPA */
function openPDPA(noIC){
  pdpaIC.value = noIC;
  pdpaFile.value = '';
  pdpaModal.show();
}
async function uploadPDPA(){
  const noIC = pdpaIC.value;
  const file = pdpaFile.files[0];
  if (!file) { showToast('Ralat','Sila pilih fail PDPA','danger'); return; }
  const fd = new FormData();
  fd.append('action','uploadPDPA'); fd.append('noIC', noIC); fd.append('staff','SYSTEM'); fd.append('pdpa', file, file.name);
  showLoader('Memuat naik PDPA…');
  try{
    let res = await fetch(CONFIG.SCRIPT_URL, { method:'POST', body: fd });
    let json = await res.json();
    if (json.status === 'success'){ pdpaModal.hide(); showToast('Berjaya','PDPA dimuat naik (multipart)','success'); loadFirstVisitData(); return; }
    const base64 = await fileToBase64(file); const pure64 = base64.split(',').pop();
    res = await fetch(CONFIG.SCRIPT_URL, { method:'POST', headers:{ 'Content-Type':'application/x-www-form-urlencoded' }, body: new URLSearchParams({ action:'uploadPDPA', noIC, staff:'SYSTEM', fileBase64:pure64, fileName:file.name, fileType:file.type||'application/octet-stream' }) });
    json = await res.json();
    if (json.status === 'success'){ pdpaModal.hide(); showToast('Berjaya','PDPA dimuat naik (fallback)','success'); loadFirstVisitData(); }
    else throw new Error(json.message || 'Gagal muat naik PDPA (fallback)');
  } catch(e){ showToast('Ralat', e.message, 'danger'); }
  finally{ hideLoader(); }
}
function fileToBase64(file){ return new Promise((resolve, reject)=>{ const fr = new FileReader(); fr.onload=()=>resolve(fr.result); fr.onerror=reject; fr.readAsDataURL(file); }); }
async function deletePDPA(noIC){
  if (!confirm('Padam PDPA untuk pesakit ini?')) return;
  const res = await postForm({ action:'deletePDPA', noIC, staff:'SYSTEM' }, { msg:'Memadam PDPA…' });
  if (res.status==='success'){ showToast('Berjaya','PDPA dipadam. Anda boleh upload semula jika perlu.','success'); loadFirstVisitData(); loadSecondVisitData(); loadCompletedData(); }
  else showToast('Ralat', res.message||'Gagal padam PDPA', 'danger');
}

/* Arkib */
async function archivePatient(noIC){
  if (!confirm('Arkibkan rekod pesakit ini?')) return;
  const res = await postForm({ action:'archivePatient', noIC, staff:'SYSTEM' }, { msg:'Mengarkib rekod…' });
  if (res.status==='success'){ showToast('Arkib','Rekod telah diarkibkan','success'); loadCompletedData(); }
  else showToast('Ralat', res.message||'Gagal arkib', 'danger');
}
async function restorePatient(noIC){
  if (!confirm('Pulihkan rekod ini ke senarai utama?')) return;
  const res = await postForm({ action:'restorePatient', noIC, staff:'SYSTEM' }, { msg:'Memulihkan rekod…' });
  if (res.status==='success'){ showToast('Pulih','Rekod telah dipulihkan','success'); loadArchivedData(); loadCompletedData(); loadDashboardData(); }
  else showToast('Ralat', res.message||'Gagal pulih', 'danger');
}

/* =======================
   PENDAFTARAN & EXPORT (Selesai)
======================= */
async function daftarPesakit(){
  const formData = {
    action:'daftarPesakit',
    namaPesakit: document.getElementById('namaPesakit').value.trim(),
    noIC:        document.getElementById('noIC').value.trim(),
    noTelefon:   normalizeMsisdnMY(document.getElementById('noTelefon').value.trim()),
    namaStaff:   document.getElementById('namaStaff').value.trim() || 'SYSTEM',
    tarikhTCA:   document.getElementById('tarikhTCA').value,
    masaTCA:     document.getElementById('masaTCA').value
  };
  if (!formData.namaPesakit || !formData.noIC || !formData.noTelefon || !formData.namaStaff || !formData.tarikhTCA || !formData.masaTCA){
    showToast('Ralat','Sila isi semua maklumat yang diperlukan','danger'); return;
  }
  const result = await postForm(formData, { msg:'Mendaftar pesakit…' });
  if (result.status==='success'){
    showToast('Berjaya','Pendaftaran pesakit berjaya (IC sebagai kunci, tiada duplikasi)','success');
    document.getElementById('formPendaftaran').reset();
    loadDashboardData(); loadTCACallData();
  } else showToast('Ralat', result.message||'Gagal mendaftar pesakit', 'danger');
}

async function exportCompletedCSV(){
  const data = await getJSON({ action:'getCompleted' }, { msg:'Menjana CSV…' });
  if (data.status!=='success' || !data.data.length) return showToast('Makluman','Tiada data untuk diexport','warning');
  const header = ['Nama','NoIC','Telefon','TarikhDaftar','TarikhFirstVisit','LabCompleted','TarikhSecondVisit','TarikhSelesai'];
  const rows = data.data.map(x=>[
    x.nama||'', x.noIC||'', normalizeMsisdnMY(x.noTelefon||''), x.tarikhDaftar||'',
    x.firstVisitDate||'', (x.labCompletedAt?(x.labCompletedAt+(x.labCompletedBy?(' by '+x.labCompletedBy):'')):''),
    x.secondVisitDate||'', x.tarikhSelesai||''
  ]);
  const csv = [header, ...rows].map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = `pesakit_selesai_${new Date().toISOString().slice(0,10)}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showToast('Export','Fail CSV telah dimuat turun','success');
}

/* =======================
   LOG CALLS (offcanvas)
======================= */
function startLogAuto(){ if (logTimer) return; logTimer = setInterval(()=>refreshLogCalls(), CONFIG.LOG_REFRESH_MS); }
function stopLogAuto(){ clearInterval(logTimer); logTimer=null; }
let _logBusy = false;
async function refreshLogCalls(first=false){
  if (_logBusy) return; _logBusy = true;
  const logLoading = document.getElementById('logLoading');
  const list = document.getElementById('logList');
  if (first){ logLoading.style.display='flex'; }
  const res = await getJSON({ action:'getLogCalls', limit:100 }, { silent:true });
  if (res.status==='success'){
    const arr = res.data||[];
    document.getElementById('logCount').textContent = arr.length;
    list.innerHTML = '';
    arr.forEach((x)=>{
      const init = (x.nama||x.noIC||'?').trim().slice(0,1).toUpperCase();
      const label = (x.note==='LAB_DONE') ? `<span class="badge text-bg-success log-type">Lab Done</span>` :
                    (x.note==='RE_TCA') ? `<span class="badge text-bg-primary log-type">Re-TCA</span>` :
                    `<span class="badge text-bg-secondary log-type">${x.note||'Info'}</span>`;
      const meta = `${x.ts||'-'} • by ${x.staff||'-'}`;
      const item = `<li class="log-item"><div class="log-avatar">${init}</div><div class="flex-grow-1"><div class="d-flex justify-content-between"><div class="log-name">${x.nama||'-'} <span class="text-muted">(${x.noIC||''})</span></div><div>${label}</div></div><div class="log-meta">${meta}</div></div></li>`;
      list.insertAdjacentHTML('beforeend', item);
    });
  }
  if (first){ logLoading.style.display='none'; }
  _logBusy = false;
}

/* =======================
   KELAYAKAN (Excel) – Layak: TCA/Masa/Nama Staf + Daftar
======================= */
function setupExcel(){
  const input = document.getElementById('excelFile');
  const tbody = document.getElementById('kelayakanTable');
  input.addEventListener('change', async (e)=>{
    const file = e.target.files[0];
    if (!file) return;
    showLoader('Memproses Excel…');
    try{
      const data = await file.arrayBuffer();
      const wb = XLSX.read(data, { type:'array' });
      const ws = wb.Sheets[wb.SheetNames[0]];
      const json = XLSX.utils.sheet_to_json(ws, { defval:'' });
      tbody.innerHTML = '';
      if (!json.length) { tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">Tiada data.</td></tr>`; return; }
      json.forEach((row, idx)=>{
        const nama = row.Nama || row.NAMA || row.name || '';
        const ic = row.IC || row.Ic || row.ic || '';
        const tel = row.Telefon || row.TELEFON || row.Phone || row.phone || '';
        const msisdn = normalizeMsisdnMY(tel);
        const id = 'x'+Date.now()+idx;
        const tr = document.createElement('tr'); tr.id = id;
        tr.innerHTML = `
          <td><input class="form-control form-control-sm auto-grow x-nama" value="${nama}" oninput="autoGrow(this)" title="${nama}"></td>
          <td><input class="form-control form-control-sm auto-grow x-ic" value="${ic}" oninput="autoGrow(this)" title="${ic}"></td>
          <td><input class="form-control form-control-sm auto-grow x-tel" value="${msisdn}" oninput="autoGrow(this)" title="${msisdn}"></td>
          <td class="text-center"><input type="checkbox" class="form-check-input x-layak"></td>
          <td class="text-center"><input type="checkbox" class="form-check-input x-tak"></td>
          <td>
            <div class="row g-1 align-items-center">
              <div class="col"><input type="date" class="form-control form-control-sm x-tca" disabled></div>
              <div class="col"><input type="time" class="form-control form-control-sm x-masa" disabled></div>
              <div class="col"><input class="form-control form-control-sm auto-grow x-staf" placeholder="Nama Staf" disabled oninput="autoGrow(this)"></div>
            </div>
          </td>
          <td>
            <button class="btn btn-sm btn-primary x-daftar" disabled><i class="fa-solid fa-user-plus"></i> Daftar</button>
          </td>`;
        tbody.appendChild(tr);

        const layak = tr.querySelector('.x-layak');
        const tak   = tr.querySelector('.x-tak');
        const tca   = tr.querySelector('.x-tca');
        const masa  = tr.querySelector('.x-masa');
        const staf  = tr.querySelector('.x-staf');
        const btn   = tr.querySelector('.x-daftar');

        const toggle = ()=>{
          if (layak.checked){ tak.checked=false; tca.disabled=false; masa.disabled=false; staf.disabled=false; checkEnable(); }
          else if (tak.checked){ layak.checked=false; tca.disabled=true; masa.disabled=true; staf.disabled=true; tca.value=''; masa.value=''; staf.value=''; btn.disabled=true; }
          else { tca.disabled=true; masa.disabled=true; staf.disabled=true; tca.value=''; masa.value=''; staf.value=''; btn.disabled=true; }
        };
        const checkEnable = ()=>{
          btn.disabled = !(layak.checked && tca.value && masa.value && staf.value.trim());
        };
        [layak,tak,tca,masa,staf].forEach(el=> el.addEventListener('change', ()=>{ toggle(); checkEnable(); }));
        [tca,masa,staf].forEach(el=> el.addEventListener('input', checkEnable));

        btn.addEventListener('click', async ()=>{
          const namaV = tr.querySelector('.x-nama').value.trim();
          const icV   = tr.querySelector('.x-ic').value.trim();
          const telV  = normalizeMsisdnMY(tr.querySelector('.x-tel').value.trim());
          if (!namaV || !icV || !telV || !tca.value || !masa.value || !staf.value.trim()){
            showToast('Ralat','Lengkapkan nama, IC, telefon, TCA, masa & staf','danger'); return;
          }
          const res = await postForm({
            action:'daftarPesakit', namaPesakit:namaV, noIC:icV, noTelefon:telV,
            namaStaff:staf.value.trim(), tarikhTCA:tca.value, masaTCA:masa.value
          }, { msg:'Mendaftar (Excel)…' });
          if (res.status==='success'){
            showToast('Berjaya',`Pesakit ${namaV} didaftarkan`, 'success');
            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-check"></i> Telah daftar';
          } else showToast('Ralat', res.message||'Gagal daftar', 'danger');
        });

        toggle();
      });
    } finally { hideLoader(); }
  });
}

/* =======================
   NADI PAGE (daftar Layak ke Sheet + CSV semua)
======================= */
function setupNadi(){
  document.getElementById('btnAddNadiRow').addEventListener('click', addNadiRow);
  document.getElementById('btnExportNadiCSV').addEventListener('click', exportNadiCSV);
  for (let i=0;i<5;i++) addNadiRow();
}
let nadiIdx=0;
function addNadiRow(){
  const tb = document.getElementById('nadiBody');
  const id = 'n'+(++nadiIdx);
  const tr = document.createElement('tr'); tr.dataset.row = id;
  tr.innerHTML = `
    <td>${nadiIdx}</td>
    <td><input class="form-control form-control-sm auto-grow nadi-nama" oninput="autoGrow(this)" title=""></td>
    <td><input class="form-control form-control-sm auto-grow nadi-ic" oninput="autoGrow(this)" title=""></td>
    <td><input class="form-control form-control-sm auto-grow nadi-tel" placeholder="01xxxxxxxx / 60xxxxxxxxx" oninput="autoGrow(this)" title=""></td>
    <td><input class="form-control form-control-sm auto-grow nadi-alamat" oninput="autoGrow(this)" title=""></td>
    <td><input class="form-control form-control-sm auto-grow nadi-bp" placeholder="120/80" oninput="autoGrow(this)"></td>
    <td>
      <div class="d-flex align-items-center gap-1">
        <select class="form-select form-select-sm nadi-dxt-type" style="width:auto">
          <option value="Fasting">Fasting</option>
          <option value="Random">Random</option>
        </select>
        <input type="number" step="0.1" class="form-control form-control-sm auto-grow nadi-dxt-val" placeholder="mmol/L" oninput="autoGrow(this)">
      </div>
    </td>
    <td><input type="number" class="form-control form-control-sm nadi-tinggi" placeholder="cm"></td>
    <td><input type="number" class="form-control form-control-sm nadi-berat" placeholder="kg"></td>
    <td><span class="badge text-bg-light nadi-bmi">-</span></td>
    <td class="text-center"><input type="checkbox" class="form-check-input nadi-layak"></td>
    <td class="text-center"><input type="checkbox" class="form-check-input nadi-taklayak"></td>
    <td><input type="date" class="form-control form-control-sm nadi-tca" disabled></td>
    <td><input type="time" class="form-control form-control-sm nadi-masa" disabled></td>
    <td><input class="form-control form-control-sm auto-grow nadi-staf" disabled oninput="autoGrow(this)"></td>
    <td><button class="btn btn-sm btn-primary nadi-daftar" disabled><i class="fa-solid fa-user-plus"></i> Daftar</button></td>
  `;
  tb.appendChild(tr);

  const tinggi = tr.querySelector('.nadi-tinggi');
  const berat  = tr.querySelector('.nadi-berat');
  const bmiEl  = tr.querySelector('.nadi-bmi');
  const layak  = tr.querySelector('.nadi-layak');
  const tak    = tr.querySelector('.nadi-taklayak');
  const tca    = tr.querySelector('.nadi-tca');
  const masa   = tr.querySelector('.nadi-masa');
  const staf   = tr.querySelector('.nadi-staf');
  const btn    = tr.querySelector('.nadi-daftar');

  const calcBMI = ()=>{
    const h = parseFloat(tinggi.value||'0')/100;
    const w = parseFloat(berat.value||'0');
    if (h>0 && w>0){ const bmi=(w/(h*h)); bmiEl.textContent = bmi.toFixed(1); }
    else bmiEl.textContent='-';
  };
  tinggi.addEventListener('input', calcBMI);
  berat .addEventListener('input', calcBMI);

  const checkEnable = ()=>{
    btn.disabled = !(layak.checked && tca.value && masa.value && (staf.value||'').trim());
  };
  const toggle = ()=>{
    if (layak.checked){ tak.checked=false; tca.disabled=false; masa.disabled=false; staf.disabled=false; checkEnable(); }
    else if (tak.checked){ layak.checked=false; tca.disabled=true; masa.disabled=true; staf.disabled=true; tca.value=''; masa.value=''; staf.value=''; btn.disabled=true; }
    else { tca.disabled=true; masa.disabled=true; staf.disabled=true; tca.value=''; masa.value=''; staf.value=''; btn.disabled=true; }
  };
  [layak,tak,tca,masa,staf].forEach(el=> el.addEventListener('change', ()=>{ toggle(); checkEnable(); }));
  [tca,masa,staf].forEach(el=> el.addEventListener('input', checkEnable));

  btn.addEventListener('click', async ()=>{
    const nama = tr.querySelector('.nadi-nama')?.value.trim();
    const ic   = tr.querySelector('.nadi-ic')?.value.trim();
    const tel  = normalizeMsisdnMY(tr.querySelector('.nadi-tel')?.value.trim());
    if (!nama || !ic || !tel || !tca.value || !masa.value || !staf.value.trim()){
      showToast('Ralat','Lengkapkan nama, IC, telefon, TCA, masa & staf','danger'); return;
    }
    const res = await postForm({
      action:'daftarPesakit',
      namaPesakit:nama, noIC:ic, noTelefon:tel,
      namaStaff:staf.value.trim(), tarikhTCA:tca.value, masaTCA:masa.value
    }, { msg:'Mendaftar (NADI)…' });
    if (res.status==='success'){
      showToast('Berjaya',`Pesakit ${nama} didaftarkan`, 'success');
      btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-check"></i> Telah daftar';
    } else showToast('Ralat', res.message||'Gagal daftar', 'danger');
  });
  toggle();
}
function exportNadiCSV(){
  const rows = [['Nama','IC','Telefon','Alamat','BP','DXT','Tinggi(cm)','Berat(kg)','BMI','Status','TCA','Masa','Nama Staf']];
  document.querySelectorAll('#nadiBody tr').forEach(tr=>{
    const nama = tr.querySelector('.nadi-nama')?.value||'';
    const ic   = tr.querySelector('.nadi-ic')?.value||'';
    const tel  = normalizeMsisdnMY(tr.querySelector('.nadi-tel')?.value||'');
    const alamat = tr.querySelector('.nadi-alamat')?.value||'';
    const bp   = tr.querySelector('.nadi-bp')?.value||'';
    const dxtType = tr.querySelector('.nadi-dxt-type')?.value||'';
    const dxtVal  = tr.querySelector('.nadi-dxt-val')?.value||'';
    const dxt  = (dxtType||'') + (dxtVal?(' '+dxtVal):'');
    const ting = tr.querySelector('.nadi-tinggi')?.value||'';
    const ber  = tr.querySelector('.nadi-berat')?.value||'';
    const bmi  = tr.querySelector('.nadi-bmi')?.textContent||'';
    const layak= tr.querySelector('.nadi-layak')?.checked;
    const tak  = tr.querySelector('.nadi-taklayak')?.checked;
    const tca  = tr.querySelector('.nadi-tca')?.value||'';
    const masa = tr.querySelector('.nadi-masa')?.value||'';
    const staf = tr.querySelector('.nadi-staf')?.value||'';
    const status = layak ? 'Layak' : (tak ? 'Tidak Layak' : '');
    rows.push([nama, ic, tel, alamat, bp, dxt, ting, ber, bmi, status, ddmmyyyy(tca), masa, staf]);
  });
  const csv = rows.map(r=>r.map(v=>`"${String(v||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob([csv], { type:'text/csv;charset=utf-8;' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  const today = new Date().toISOString().slice(0,10);
  a.href = url; a.download = `program_nadi_${today}.csv`;
  document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
  showToast('Export NADI','CSV berjaya dijana','success');
}

/* =======================
   END
======================= */
</script>
</body>
</html>
