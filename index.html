<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- 🔧 Update these if needed -->
  <meta name="gas-endpoint" content="https://broken-dew-0eb2.amiruladlije.workers.dev/exec" />
  <meta name="google-signin-client_id" content="863564124015-838ksbuk27f0kkomm16hnc3bu608pbrr.apps.googleusercontent.com" />

  <title>daftar-PEKA-B40</title>
  <!-- Keep your original CSS includes here if you have them -->
  <style>
    /* Minimal styles so we don't disturb your original layout */
    #gsi-area { display:flex; gap:8px; align-items:center; }
    #auth-info { font: 12px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial; opacity:.8; }
    #debug-log {
      position: fixed; right: 8px; bottom: 8px; width: 360px; max-height: 45vh; overflow:auto;
      font: 11px/1.35 ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      background: #0b1020; color: #cfe6ff; border:1px solid #213; border-radius:8px; padding:8px;
      box-shadow: 0 8px 24px rgba(0,0,0,.24); z-index: 9999;
    }
    #debug-log .line { white-space: pre-wrap; margin: 0 0 .35rem 0; }
    #debug-log .ts { opacity:.65; }
    #debug-log .ok { color:#8ff19f; }
    #debug-log .err { color:#ff9ca4; }
    #debug-log .muted { color:#97a4b1; }
    .hidden { display:none !important;}
  </style>

  <!-- Google Identity Services -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>

  <!-- ✅ Sign-In area (keeps layout minimal) -->
  <div id="gsi-area" style="padding:10px;">
    <div id="gsi-btn"></div>
    <div id="auth-info" class="hidden"></div>
    <button id="btn-signout" class="hidden" type="button">Sign out</button>
  </div>

  <!-- Your existing app markup stays as-is below this line.
       If you already have #gsi-btn/#auth-info/#btn-signout, this will reuse them. -->

  <!-- 🧪 Tiny debug overlay you can close if you want -->
  <div id="debug-log" class="hidden"></div>

  <script>
  (function(){
    // ===== Config =====
    const GAS_ENDPOINT = (document.querySelector('meta[name="gas-endpoint"]')?.content || '').replace(/\/+$/, '') || '';
    const CLIENT_ID    = document.querySelector('meta[name="google-signin-client_id"]')?.content || '';
    const STATE_KEY    = 'pkb40_id_token';
    const LOG_ON       = true; // set false to hide log widget

    const $log = document.getElementById('debug-log');
    function ts(){ return new Date().toLocaleTimeString(); }
    function log(msg, cls){
      if (!LOG_ON) return;
      if ($log.classList.contains('hidden')) $log.classList.remove('hidden');
      const div = document.createElement('div');
      div.className = 'line ' + (cls||'');
      div.innerHTML = '<span class="ts">['+ts()+']</span> ' + msg;
      $log.appendChild(div);
      $log.scrollTop = $log.scrollHeight;
    }

    function statusBadge(ok){ return ok ? '<span class="ok">OK</span>' : '<span class="err">GAGAL</span>'; }

    // ===== Auth State =====
    let idToken = localStorage.getItem(STATE_KEY) || '';
    let profile = null;
    const $gsiBtn    = document.getElementById('gsi-btn');
    const $authInfo  = document.getElementById('auth-info');
    const $btnOut    = document.getElementById('btn-signout');

    function setSignedInUI(ok){
      if (ok){
        $authInfo.classList.remove('hidden');
        $btnOut.classList.remove('hidden');
      } else {
        $authInfo.classList.add('hidden');
        $btnOut.classList.add('hidden');
      }
    }

    // ===== Google Sign-In =====
    function initGSI(){
      if (!window.google || !google.accounts || !CLIENT_ID){
        log('Client ID kosong.', 'err');
        return;
      }
      google.accounts.id.initialize({
        client_id: CLIENT_ID,
        callback: handleCredentialResponse,
        auto_select: false
      });
      try {
        google.accounts.id.renderButton($gsiBtn, { theme: 'outline', size: 'medium', text: 'signin_with' });
        log('GSI sedia.', 'muted');
      } catch(e){ log('GSI gagal render: '+e, 'err'); }
    }

    async function handleCredentialResponse(resp){
      try{
        idToken = String(resp?.credential || '').trim();
        if (!idToken){ log('[auth] tiada credential diterima', 'err'); return; }
        localStorage.setItem(STATE_KEY, idToken);
        log('[auth] id_token disimpan', 'muted');
        await afterLogin();
      }catch(e){
        log('[auth] ralat: '+e, 'err');
      }
    }

    function signOut(){
      idToken='';
      localStorage.removeItem(STATE_KEY);
      if (google?.accounts?.id) { try { google.accounts.id.disableAutoSelect(); }catch(e){} }
      setSignedInUI(false);
      $authInfo.textContent = '';
      log('Token dibuang.', 'muted');
    }
    $btnOut.addEventListener('click', signOut);

    // ===== Fetch Shim (inject id_token + route via Worker) =====
    const ORIG_FETCH = window.fetch.bind(window);

    function isAppsScriptLike(url){
      return /script\.google\.com\/macros\/s\/.+\/exec/i.test(url);
    }
    function isWorkerLike(url){
      return /workers\.dev\/exec/i.test(url);
    }
    function hasJson(contentType){
      return /application\/json/i.test(String(contentType||''));
    }

    function normalizeItems(items){
      // Accept array of rows; coerce to keys our Apps Script expects.
      // This is defensive — it won't change your layout; only the outgoing payload.
      const toBool = v => v===true || String(v).toLowerCase()==='true' || String(v).trim()==='1' || /ya/i.test(String(v));
      const norm = (r) => {
        const o = r || {};
        const pick = (...keys) => {
          for (const k of keys){
            if (o.hasOwnProperty(k) && o[k] !== undefined && o[k] !== null && String(o[k])!=='') return o[k];
          }
          return '';
        };
        const dxtTypeRaw = String(pick('dxtType','dxt_type','DXTType','gulaType','randomFasting')).toUpperCase();
        let dxtType = '';
        if (/FAST|FBG|PUASA/.test(dxtTypeRaw)) dxtType='FASTING';
        else if (/RAND|RBG|RANDOM/.test(dxtTypeRaw)) dxtType='RANDOM';

        let status = String(pick('status','kelayakan','kel','layakTak','Layak?')).toUpperCase();
        const layak     = toBool(pick('layak','eligible'));
        const takLayak  = toBool(pick('takLayak','tidakLayak','notEligible'));
        if (!status) status = layak ? 'LAYAK' : (takLayak ? 'TAK LAYAK' : '');

        // Appointment type decision (client-side hint only; server still decides safely).
        let appointmentType = String(pick('appointmentType','appointment_type','jenis')).toUpperCase();
        const voucherFlag = toBool(pick('voucher','isVoucher','tcaVoucher'));
        if (!appointmentType){
          if (status==='LAYAK') appointmentType='PKB40';
          else if (voucherFlag) appointmentType='VOUCHER';
          else appointmentType='NONE';
        }

        const tcaDate = pick('tcaDate','tca_date','tca','TarikhTCA','TCADate');
        const tcaTime = pick('tcaTime','tca_time','masaTCA','TCATime');

        return {
          nama:       pick('nama','name','fullname','Nama'),
          noIC:       pick('noIC','ic','no_kp','icNumber','nokp','NoIC'),
          umur:       pick('umur','age','Umur'),
          noTelefon:  pick('noTelefon','telefon','noTel','phone','msisdn','tel','NoTelefon'),
          alamat:     pick('alamat','address','addr','Alamat'),
          bp:         pick('bp','bloodPressure','BP'),
          pr:         pick('pr','nadi','pulse','HR','PR'),
          dxt:        pick('dxt','gula','dxtValue','bs','sugar','DXT'),
          dxtType,
          tinggi:     pick('tinggi','height','Tinggi'),
          berat:      pick('berat','weight','Berat'),
          bmi:        pick('bmi','BMI'),
          status,
          appointmentType,
          remark:     pick('remark','catatan','notes','note','Remark'),
          tcaDate,
          tcaTime,
          tcaStaff:   pick('tcaStaff','staffTCA','TCAStaff'),
          voucher:    voucherFlag,
          layak,
          takLayak
        };
      };
      try { return (items||[]).map(norm); } catch(e){ return items||[]; }
    }

    async function smartFetch(input, init={}){
      let url = typeof input === 'string' ? input : (input?.url || '');
      if (!url) return ORIG_FETCH(input, init);

      // If caller hits Apps Script or our Worker but without token,
      // re-route to Worker and append id_token
      const u = new URL(url, location.href);
      const isAS  = isAppsScriptLike(u.href);
      const isW   = isWorkerLike(u.href);
      const isOur = u.href.startsWith(GAS_ENDPOINT);

      if (isAS || isW || isOur){
        if (!GAS_ENDPOINT){
          log('GAS_ENDPOINT kosong – tetapkan meta[name="gas-endpoint"]', 'err');
        }
        // Normalize to Worker
        const base = GAS_ENDPOINT || u.origin + (u.pathname.endsWith('/exec') ? '/exec' : u.pathname);
        const out = new URL(base);
        // Preserve action & params
        u.searchParams.forEach((v,k)=> out.searchParams.set(k,v));
        // Inject id_token
        if (idToken) out.searchParams.set('id_token', idToken);
        // Force CORS-friendly options
        const opt = Object.assign({}, init||{});
        opt.mode = 'cors';
        opt.credentials = 'omit';
        opt.headers = Object.assign({}, opt.headers||{});

        // If posting form/json, also ensure id_token exists there (compat with legacy servers)
        let ctype = '';
        if (opt.body && typeof opt.body === 'string'){
          ctype = String(opt.headers['Content-Type'] || opt.headers['content-type'] || '');
          if (/application\/x-www-form-urlencoded/i.test(ctype)){
            const params = new URLSearchParams(opt.body);
            if (!params.get('id_token') && idToken) params.set('id_token', idToken);

            // 🔧 Normalize NADI items if present
            const action = params.get('action') || '';
            if ((action==='saveNadiActivity' || action==='saveNadiProgramActivity') && params.get('items')){
              try{
                const arr = JSON.parse(params.get('items'));
                params.set('items', JSON.stringify(normalizeItems(arr)));
              }catch(e){ /* ignore */ }
            }
            opt.body = params.toString();
          } else if (/application\/json/i.test(ctype)){
            try{
              const obj = JSON.parse(opt.body || '{}');
              if (idToken && !obj.id_token) obj.id_token = idToken;
              const action = obj.action || '';
              if ((action==='saveNadiActivity' || action==='saveNadiProgramActivity') && Array.isArray(obj.items)){
                obj.items = normalizeItems(obj.items);
              }
              opt.body = JSON.stringify(obj);
            }catch(e){ /* ignore */ }
          }
        }

        const res = await ORIG_FETCH(out.href, opt);
        // Try to detect accidental HTML
        const ctypeRes = res.headers.get('content-type') || '';
        if (!hasJson(ctypeRes)){
          const text = await res.text();
          log('⚠️ Respons bukan JSON ('+res.status+') – mungkin token/endpoint salah. Pratonton 200 aksara:\n' + text.slice(0,200), 'err');
          throw new Error('Respons bukan JSON');
        }
        return res;
      }
      // Not our GAS/Worker → pass-through
      return ORIG_FETCH(input, init);
    }
    window.fetch = smartFetch;

    // ===== API helpers =====
    async function apiGet(action, params={}){
      const url = new URL(GAS_ENDPOINT);
      url.searchParams.set('action', action);
      if (idToken) url.searchParams.set('id_token', idToken);
      Object.entries(params||{}).forEach(([k,v])=> url.searchParams.set(k,String(v)));
      const r = await smartFetch(url.href, { method: 'GET' });
      return r.json();
    }
    async function apiPost(action, bodyObj){
      const body = new URLSearchParams();
      body.set('action', action);
      if (idToken) body.set('id_token', idToken);
      Object.entries(bodyObj||{}).forEach(([k,v])=>{
        if (v===undefined || v===null) return;
        if (typeof v === 'object') body.set(k, JSON.stringify(v));
        else body.set(k, String(v));
      });
      const r = await smartFetch(GAS_ENDPOINT, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: body.toString()
      });
      return r.json();
    }

    // ===== After Login =====
    async function afterLogin(){
      try{
        const me = await apiPost('whoami', {});
        log('WHOAMI → '+JSON.stringify(me), me?.status==='success'?'ok':'err');
        if (me?.status==='success'){
          profile = me;
          $authInfo.textContent = me.email || '';
          setSignedInUI(true);
          // Preload voucher ICs (used by some UIs)
          try{
            const vo = await apiGet('getVoucherICSet');
            log('Voucher IC set → '+JSON.stringify(vo), vo?.status==='success'?'ok':'err');
            window.__VOUCHER_IC_SET__ = (vo?.ics || []);
          }catch(e){ log('Voucher IC set gagal: '+e, 'err'); }
          // (Optional) Load history list to unblock your "Lihat Sejarah Saringan"
          try{
            const acts = await apiGet('getNadiActivities');
            log('Aktiviti dimuat: '+(acts?.data?.length||0), 'muted');
            // If you already have your own renderer, it will pick this up.
            window.__NADI_ACTIVITIES__ = acts?.data || [];
            document.dispatchEvent(new CustomEvent('nadi:activitiesLoaded', { detail: window.__NADI_ACTIVITIES__ }));
          }catch(e){ log('Gagal muat aktiviti: '+e, 'err'); }
        } else {
          setSignedInUI(false);
        }
      }catch(e){
        log('WHOAMI gagal: '+e, 'err');
      }
    }

    // ===== Public helpers (optional for your existing code) =====
    window.PKB40 = {
      apiGet, apiPost,
      get token(){ return idToken; },
      get endpoint(){ return GAS_ENDPOINT; },
      normalizeItems,
      log
    };

    // ===== Init =====
    window.addEventListener('load', function(){
      if (CLIENT_ID){
        initGSI();
      } else {
        log('Client ID kosong.', 'err');
      }
      if (idToken){
        afterLogin();
      }
    });
  })();
  </script>
</body>
</html>
