<!DOCTYPE html>
<html lang="ms">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Saringan — Hotfix/Diagnostik</title>
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">
<style>
  body { max-width: 1100px; margin: 24px auto; }
  .row { display: grid; gap: 12px; grid-template-columns: 1fr 1fr; }
  .row-3 { display: grid; gap: 12px; grid-template-columns: repeat(3, 1fr); }
  #logs { height: 200px; overflow:auto; background:#0b0f16; color:#bfe2ff; padding:10px; font: 12px/1.4 ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; border-radius: 8px; }
  .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background:#eee; padding:0 6px; border-radius:4px; }
  textarea { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; }
  small.mono { font: 12px/1.2 ui-monospace, monospace; color:#6d7784 }
  .muted { color:#6d7784 }
</style>
<script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <header>
    <h2>Saringan — <span class="muted">Hotfix/Diagnostik</span></h2>
    <p class="muted">Tujuan: uji sambungan Cloudflare Worker → Google Apps Script dengan selamat. <br>
      <small class="mono">Jika respons bukan JSON (contoh: berisi <code>&lt;!DOCTYPE html&gt;</code>), panel log akan memaparkan <code>UPSTREAM_NOT_JSON</code> berserta petikan HTML supaya kita boleh kenal pasti punca.</small>
    </p>
  </header>

  <article>
    <h4>1) Konfigurasi</h4>
    <div class="grid">
      <div>
        <label>API BASE (Cloudflare Worker URL)
          <input id="apiBase" type="url" placeholder="https://example.workers.dev/exec">
        </label>
        <small class="mono">Contoh: <code>https://broken-dew-0eb2.amiruladlije.workers.dev/exec</code></small>
      </div>
      <div>
        <label>Google Client ID (GSI)
          <input id="clientId" type="text" placeholder="863564124015-....apps.googleusercontent.com">
        </label>
        <small class="mono">Biarkan jika tidak berubah.</small>
      </div>
    </div>
    <div class="grid">
      <div>
        <div id="gsiButton"></div>
        <button id="btnLogout" class="secondary">Log keluar</button>
        <small class="mono" id="authState">Belum log masuk</small>
      </div>
      <div class="grid">
        <button id="btnPing" class="secondary">Uji WhoAmI</button>
        <button id="btnVoucher" class="secondary">Bina Voucher Set</button>
      </div>
    </div>
  </article>

  <article>
    <h4>2) Lihat Sejarah Saringan (AKTIVITI_PROGRAM)</h4>
    <div class="grid">
      <button id="btnLoadActivities">Muatkan Aktiviti</button>
      <small class="mono">Jika berjaya, senarai ringkas dipaparkan di bawah.</small>
    </div>
    <details>
      <summary>Hasil Aktiviti</summary>
      <pre id="activitiesOut" class="mono"></pre>
    </details>
  </article>

  <article>
    <h4>3) Simpan Jadual NADI (Demo Minimum)</h4>
    <div class="grid">
      <label>Tajuk Program
        <input id="title" type="text" value="Program NADI Komuniti">
      </label>
      <label>Tarikh Program (YYYY-MM-DD atau DD/MM/YYYY)
        <input id="date" type="text" value="2025-09-12">
      </label>
    </div>
    <label>Items (JSON Array)
      <textarea id="items" rows="5">[{"nama":"Ali","noIC":"900101-10-1234","noTelefon":"0123456789","status":"LAYAK","appointmentType":"PKB40"}]</textarea>
    </label>
    <div class="grid">
      <button id="btnSave">Simpan</button>
      <small class="mono">Server akan mengisi <span class="kbd">staff</span> menggunakan email akaun yang log masuk.</small>
    </div>
  </article>

  <article>
    <h4>Log</h4>
    <div id="logs"></div>
  </article>

<script>
(function(){
  const qs = (sel) => document.querySelector(sel);
  const apiBaseEl = qs('#apiBase');
  const clientIdEl = qs('#clientId');
  const logsEl = qs('#logs');
  const authStateEl = qs('#authState');
  const activitiesOut = qs('#activitiesOut');
  const LS = {
    apiBase: 'saringan.apiBase',
    clientId: 'saringan.clientId',
    token: 'saringan.id_token'
  };

  function log(...args){
    const t = new Date().toISOString();
    const line = args.map(a => (typeof a === 'string' ? a : JSON.stringify(a, null, 2))).join(' ');
    logsEl.textContent += '['+t+'] ' + line + '\\n';
    logsEl.scrollTop = logsEl.scrollHeight;
    // Mirror to console for convenience
    console.log('[hotfix]', ...args);
  }

  // ---------- LocalStorage helpers ----------
  function loadConfig(){
    apiBaseEl.value = localStorage.getItem(LS.apiBase) || '';
    clientIdEl.value = localStorage.getItem(LS.clientId) || '';
    updateAuthState();
  }
  function saveConfig(){
    localStorage.setItem(LS.apiBase, apiBaseEl.value.trim());
    localStorage.setItem(LS.clientId, clientIdEl.value.trim());
  }
  function setToken(tok){
    if (tok) localStorage.setItem(LS.token, tok);
    else localStorage.removeItem(LS.token);
    updateAuthState();
  }
  function getToken(){ return localStorage.getItem(LS.token) || ''; }

  function updateAuthState(){
    const tok = getToken();
    authStateEl.textContent = tok ? 'Token tersedia' : 'Belum log masuk';
  }

  // ---------- Google Sign-In ----------
  window.onGoogleLibraryLoad = function(){
    try {
      const clientId = clientIdEl.value.trim() || localStorage.getItem(LS.clientId) || '';
      if (!clientId) {
        log('⚠️ Tiada Google Client ID. Masukkan dahulu.');
        return;
      }
      google.accounts.id.initialize({
        client_id: clientId,
        callback: (resp) => {
          if (resp && resp.credential){
            setToken(resp.credential);
            log('✅ [auth] id_token received & stored (panjang='+resp.credential.length+')');
          } else {
            log('❌ [auth] callback tanpa credential:', resp);
          }
        }
      });
      google.accounts.id.renderButton(document.getElementById('gsiButton'), { theme: 'outline', size: 'medium' });
      google.accounts.id.prompt(); // optional
    } catch(err){
      log('❌ GSI init error:', err);
    }
  };

  // Script loader to re-init when clientId changes
  function ensureGsiLoaded(){
    if (window.google && window.google.accounts && window.google.accounts.id) {
      window.onGoogleLibraryLoad();
      return;
    }
    // If script not ready yet, we will rely on onload
  }

  window.addEventListener('load', () => {
    loadConfig();
    ensureGsiLoaded();
  });

  clientIdEl.addEventListener('change', () => {
    saveConfig();
    // re-render button
    document.getElementById('gsiButton').innerHTML = '';
    ensureGsiLoaded();
  });
  apiBaseEl.addEventListener('change', saveConfig);

  document.getElementById('btnLogout').addEventListener('click', () => {
    setToken('');
    log('ℹ️ Token dibersihkan.');
  });

  // ---------- API helper ----------
  function normalizeBase(u){
    u = String(u||'').trim();
    if (!u) return '';
    // drop trailing slashes (but keep /exec if present)
    // if user pasted the GAS URL directly (script.google.com/.../exec), still okay
    return u.replace(/\\/?$/,''); // remove single trailing slash
  }

  async function callApi(action, method, params){
    const base = normalizeBase(apiBaseEl.value);
    if (!base) throw new Error('API BASE kosong.');

    const idToken = getToken();
    if (!idToken) throw new Error('Belum log masuk. Sila Sign in terlebih dahulu.');

    // Build URL
    let url = base;
    const headers = { };
    let fetchInit = { method: method || 'GET' };

    if (fetchInit.method.toUpperCase() === 'GET'){
      const u = new URL(url);
      u.searchParams.set('action', action);
      u.searchParams.set('id_token', idToken);
      // include other query params if provided
      if (params && typeof params === 'object'){
        Object.entries(params).forEach(([k,v]) => {
          if (v !== undefined && v !== null) u.searchParams.set(k, String(v));
        });
      }
      url = u.toString();
    } else {
      const body = new URLSearchParams();
      body.set('action', action);
      body.set('id_token', idToken);
      if (params && typeof params === 'object'){
        Object.entries(params).forEach(([k,v]) => {
          if (v !== undefined && v !== null){
            body.set(k, typeof v === 'string' ? v : JSON.stringify(v));
          }
        });
      }
      headers['Content-Type'] = 'application/x-www-form-urlencoded;charset=UTF-8';
      fetchInit.body = body.toString();
    }
    fetchInit.headers = headers;

    log('→', fetchInit.method, action, 'URL:', url);
    const res = await fetch(url, fetchInit);
    const ct = (res.headers.get('content-type')||'').toLowerCase();

    if (ct.includes('application/json')){
      const j = await res.json();
      log('← JSON', j);
      return j;
    } else {
      const txt = await res.text();
      // Try to sniff JSON
      try {
        const j2 = JSON.parse(txt);
        log('← JSON(text)', j2);
        return j2;
      } catch(_){
        // Not JSON — show helpful diagnostics
        const diag = {
          status: 'error',
          code: 'UPSTREAM_NOT_JSON',
          hint: 'Semak Web App GAS: akses "Anyone" dan URL berakhir dengan /exec, serta URL di Worker betul.',
          upstreamStatus: res.status,
          body: txt.slice(0, 500)
        };
        log('←', diag);
        return diag;
      }
    }
  }

  // ---------- Feature buttons ----------
  async function testWhoAmI(){
    try {
      const out = await callApi('whoami', 'GET');
      if (out && out.status === 'success'){
        log('✅ whoami:', out.email || out);
      } else {
        log('❌ whoami gagal:', out);
      }
    } catch(err){
      log('❌ ralat whoami:', err);
    }
  }
  async function ensureVoucherICs(){
    try {
      const out = await callApi('getVoucherICSet', 'GET');
      if (out && out.status === 'success'){
        log('✅ Voucher IC set ada', (out.ics||[]).length, 'IC');
      } else {
        log('❌ getVoucherICSet gagal:', out);
      }
    } catch(err){
      log('❌ ralat getVoucherICSet:', err);
    }
  }
  async function loadActivities(){
    try {
      const out = await callApi('getNadiActivities', 'GET');
      if (out && out.status === 'success'){
        const list = (out.data||[]).slice(0, 10);
        activitiesOut.textContent = JSON.stringify(list, null, 2);
        log('✅ Aktiviti diterima:', list.length, 'rekod (papar maksimum 10).');
      } else {
        log('❌ getNadiActivities gagal:', out);
      }
    } catch(err){
      log('❌ ralat getNadiActivities:', err);
    }
  }
  async function saveNadiProgramActivity(){
    const title = qs('#title').value.trim();
    const date  = qs('#date').value.trim();
    let itemsTxt = qs('#items').value.trim();
    let items;
    try {
      items = JSON.parse(itemsTxt);
      if (!Array.isArray(items) || items.length === 0) throw new Error('Items kosong');
    } catch(e){
      log('❌ JSON items tidak sah:', String(e));
      return;
    }
    try {
      const out = await callApi('saveNadiProgramActivity', 'POST', {
        programTitle: title,
        programDate: date,
        items: JSON.stringify(items)
      });
      if (out && out.status === 'success'){
        log('✅ Simpan berjaya:', out);
      } else {
        log('❌ Simpan gagal:', out);
      }
    } catch(err){
      log('❌ ralat simpan:', err);
    }
  }

  // Bind buttons
  document.getElementById('btnPing').addEventListener('click', testWhoAmI);
  document.getElementById('btnVoucher').addEventListener('click', ensureVoucherICs);
  document.getElementById('btnLoadActivities').addEventListener('click', loadActivities);
  document.getElementById('btnSave').addEventListener('click', saveNadiProgramActivity);

  // Re-init GSI after script loads
  window.addEventListener('load', () => {
    if (window.google && window.google.accounts && window.google.accounts.id){
      window.onGoogleLibraryLoad();
    } else {
      // fallback: attach when script fires
      window.addEventListener('load', window.onGoogleLibraryLoad);
    }
  });
})();
</script>
</body>
</html>
