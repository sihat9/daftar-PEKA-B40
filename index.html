<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>TRacKer PEKA B40 ‚Äî Login Fix</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0b1324;--card:#ffffff;--ink:#222;--muted:#667085;--brand:#0ea5e9;--ok:#16a34a;--warn:#ca8a04;--err:#dc2626;--chip:#f1f5f9;}
    *{box-sizing:border-box} body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    background:#f6f8fb;color:var(--ink)}
    .wrap{max-width:1160px;margin:28px auto;padding:0 16px}
    header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
    header h1{font-size:18px;margin:0;font-weight:700}
    .right{margin-left:auto;display:flex;align-items:center;gap:8px}
    .btn{border:1px solid #cbd5e1;background:#fff;border-radius:8px;padding:8px 12px;cursor:pointer}
    .btn.primary{background:var(--brand);color:#fff;border-color:var(--brand)}
    .badge{font-size:12px;color:#0f172a;background:#e2e8f0;border-radius:999px;padding:4px 8px}
    .card{background:var(--card);box-shadow:0 8px 20px rgba(2,6,23,.06);border-radius:14px;padding:16px;margin:12px 0}
    .title{display:flex;align-items:center;gap:8px;font-weight:700}
    .grid{display:grid;grid-template-columns:1fr 2fr;gap:14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    input[type=text],input[type=date]{width:100%;padding:10px;border:1px solid #cbd5e1;border-radius:8px}
    .table{width:100%;border-collapse:collapse}
    .table th,.table td{padding:10px;border-bottom:1px solid #e2e8f0;text-align:left;font-size:14px}
    .log{background:#0f172a;color:#e5e7eb;border-radius:12px;padding:10px;height:160px;overflow:auto;font-family:ui-monospace,Menlo,Consolas}
    .pill{background:var(--chip);padding:3px 8px;border-radius:999px;font-size:12px}
    .hint{background:#e0f2fe;border:1px solid #bae6fd;color:#0c4a6e;border-radius:10px;padding:10px;margin-bottom:12px}
    .hidden{display:none !important}
  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>TRacKer PEKA B40</h1>
      <div id="status" class="badge">Memuat‚Ä¶</div>
      <div class="right">
        <div id="gsiArea"></div>
        <button id="btnSignOut" class="btn hidden">Sign out</button>
        <button id="btnConfig" class="btn">‚öôÔ∏è Konfigurasi</button>
      </div>
    </header>

    <div id="banner" class="hint">
      Pastikan <b>API BASE</b> (Cloudflare Worker <code>/exec</code>) dan <b>Google Client ID</b> telah ditetapkan.
      Klik <b>Konfigurasi</b> ‚Üí isi & simpan. Kemudian <b>Sign in with Google</b>.
    </div>

    <!-- Lihat Sejarah Saringan -->
    <section class="card">
      <div class="title">‚è±Ô∏è Lihat Sejarah Saringan</div>
      <div class="grid">
        <div>
          <div class="row" style="margin:8px 0">
            <input id="filterTitle" type="text" placeholder="Tapis tajuk‚Ä¶">
            <button id="btnLoad" class="btn primary">Muatkan Aktiviti</button>
          </div>
          <div id="list" class="card" style="max-height:260px;overflow:auto"></div>
        </div>
        <div>
          <table class="table">
            <thead>
              <tr>
                <th>#</th><th>Nama</th><th>IC</th><th>Telefon</th><th>Alamat</th><th>Status</th>
                <th>BP</th><th>PR</th><th>DXT</th><th>DXT Type</th><th>Tinggi</th><th>Berat</th>
                <th>BMI</th><th>TCA</th><th>Staff</th><th>Remark</th>
              </tr>
            </thead>
            <tbody id="detailBody"><tr><td colspan="16" style="text-align:center;color:#64748b">Pilih program di sebelah kiri.</td></tr></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Program NADI -->
    <section class="card">
      <div class="title">üóÇÔ∏è Program PEKA B40 bersama NADI</div>
      <div class="row" style="margin:10px 0">
        <input id="pTitle" type="text" placeholder="cth: Saringan Komuniti Tmn Mawar" style="flex:2">
        <input id="pDate" type="date" style="flex:1">
        <input id="pStaff" type="text" placeholder="Nama Staff" style="flex:1">
        <button id="btnAddRow" class="btn">üë• Tambah Peserta</button>
        <button id="btnSave" class="btn primary">üíæ Simpan Aktiviti (Semua)</button>
      </div>
      <table class="table" id="nadiTable">
        <thead>
          <tr>
            <th>#</th><th>Nama</th><th>IC</th><th>Umur</th><th>Telefon</th><th>Alamat</th>
            <th>BP</th><th>PR</th><th>DXT</th><th>DXT Type</th><th>Tinggi</th><th>Berat</th><th>BMI</th>
            <th>Layak</th><th>Tidak Layak</th><th>TCA Tarikh</th><th>TCA Masa</th><th>TCA Staff</th><th>Remark</th><th></th>
          </tr>
        </thead>
        <tbody id="nadiBody"></tbody>
      </table>
    </section>

    <section class="card">
      <div class="title">‚å®Ô∏è Log</div>
      <div class="row"><button id="btnClearLog" class="btn">Kosongkan</button></div>
      <pre id="log" class="log"></pre>
    </section>
  </div>

  <!-- Konfigurasi Modal -->
  <dialog id="cfg" style="border:none;border-radius:16px;max-width:720px;width:92%;padding:0">
    <form method="dialog">
      <div class="card" style="margin:0;border-radius:16px 16px 0 0">
        <div class="title">‚öôÔ∏è Konfigurasi</div>
        <div class="row" style="margin-top:10px">
          <label style="flex:1">
            <div>API BASE (Worker /exec)</div>
            <input id="cfgApi" type="text" placeholder="https://xxx.workers.dev/exec">
          </label>
          <label style="flex:1">
            <div>Google Client ID (GSI)</div>
            <input id="cfgGsi" type="text" placeholder="xxxxxxxx.apps.googleusercontent.com">
          </label>
        </div>
        <div class="row" style="justify-content:flex-end;margin-top:10px">
          <button class="btn" value="cancel">Batal</button>
          <button id="saveCfg" class="btn primary" value="default">Simpan</button>
        </div>
      </div>
    </form>
  </dialog>

<script>
(() => {
  const LS = {
    api: 'PKB40_API_BASE',
    client: 'PKB40_GSI_CLIENT_ID',
    token: 'PKB40_ID_TOKEN'
  };
  const els = (id) => document.getElementById(id);
  const logEl = els('log');
  function log(msg){ const ts = new Date().toLocaleTimeString('ms-MY',{hour12:false}); logEl.textContent += '['+ts+'] '+msg+'\\n'; logEl.scrollTop = logEl.scrollHeight; }

  const state = { apiBase: localStorage.getItem(LS.api)||'', gsiClient: localStorage.getItem(LS.client)||'', idToken: localStorage.getItem(LS.token)||'' };

  // UI helpers
  function setStatus(){
    const s = els('status');
    if(state.idToken) { s.textContent = 'Log masuk'; s.style.background = '#dcfce7'; }
    else { s.textContent = 'Belum log masuk'; s.style.background = '#fee2e2'; }
    els('banner').classList.toggle('hidden', !!(state.apiBase && state.gsiClient));
  }
  function saveCfg(){
    state.apiBase = els('cfgApi').value.trim();
    state.gsiClient = els('cfgGsi').value.trim();
    localStorage.setItem(LS.api, state.apiBase);
    localStorage.setItem(LS.client, state.gsiClient);
    log('Konfigurasi disimpan.');
    setStatus();
    renderGsi();
  }

  // Google Sign-In
  function renderGsi(){
    const area = els('gsiArea'); area.innerHTML='';
    els('btnSignOut').classList.toggle('hidden', !state.idToken);
    if(!state.gsiClient){ area.innerHTML = '<span class="pill">Isi Google Client ID dahulu</span>'; return; }
    if(typeof google === 'undefined' || !google.accounts || !google.accounts.id){
      // Will render when GSI script completes
      return;
    }
    google.accounts.id.initialize({
      client_id: state.gsiClient,
      callback: (resp) => {
        state.idToken = resp.credential || '';
        localStorage.setItem(LS.token, state.idToken);
        log('[auth] id_token disimpan');
        setStatus();
      }
    });
    google.accounts.id.renderButton(area, { theme:'outline', size:'medium' });
  }
  function signOut(){
    try{ google.accounts.id.disableAutoSelect(); }catch(e){}
    localStorage.removeItem(LS.token);
    state.idToken='';
    setStatus();
    renderGsi();
    log('Sign out.');
  }

  // API helper (Cloudflare Worker ‚Üí GAS)
  async function apiFetch(path, {method='GET', body=null, asJson=true}={}){
    if(!state.apiBase) throw new Error('API BASE kosong');
    const url = new URL(state.apiBase);
    if(path) url.searchParams.set('action', path);
    if(state.idToken) url.searchParams.set('id_token', state.idToken);

    const opt = { method, headers: {} };
    if(method === 'POST'){
      const form = new URLSearchParams();
      form.set('action', path);
      if(state.idToken) form.set('id_token', state.idToken);
      if(body && typeof body === 'object'){
        for(const k in body){ form.set(k, body[k]); }
      }
      opt.body = form.toString();
      opt.headers['Content-Type'] = 'application/x-www-form-urlencoded;charset=UTF-8';
    }

    const res = await fetch(url.toString(), opt);
    const txt = await res.text();
    try{
      const json = JSON.parse(txt);
      return json;
    }catch(e){
      // Worker returned HTML (UPSTREAM_NOT_JSON); show short preview
      log('UPSTREAM_NOT_JSON: '+ txt.slice(0,120).replace(/\\n/g,' ') + '‚Ä¶');
      throw new Error('Respon bukan JSON');
    }
  }

  // Lihat Sejarah Saringan
  async function loadActivities(){
    try{
      const json = await apiFetch('getNadiActivities');
      const data = json && json.data || [];
      log('Aktiviti dimuat: '+data.length);
      const list = els('list');
      list.innerHTML = '';
      if(!data.length){ list.innerHTML = '<div class="pill">Tiada rekod</div>'; return; }
      data.forEach((it,idx)=>{
        const a = document.createElement('button');
        a.className='btn'; a.style.width='100%'; a.style.margin='4px 0'; a.style.justifyContent='space-between'; a.style.display='flex';
        a.innerHTML = `<span>${it.title||'(tanpa tajuk)'} <span class="pill">${it.programDate||''}</span></span><span class="pill">${it.total||0}</span>`;
        a.addEventListener('click', ()=> showActivity(it.activityId, it.title||''));
        list.appendChild(a);
      });
    }catch(err){ log('Gagal muat aktiviti: '+err.message); }
  }
  async function showActivity(activityId, title){
    try{
      const json = await apiFetch('getNadiActivityDetail', { method:'GET', body:{ activityId } });
      const rows = json && json.data || [];
      const tbody = els('detailBody');
      tbody.innerHTML='';
      rows.forEach((r,i)=>{
        const tr = document.createElement('tr');
        const tca = [r.tcaDate||'', r.tcaTime||''].filter(Boolean).join(' ');
        tr.innerHTML = `<td>${i+1}</td><td>${r.nama||''}</td><td>${r.noIC||''}</td><td>${r.noTelefon||''}</td><td>${r.alamat||''}</td>
        <td>${r.status||''}</td><td>${r.bp||''}</td><td>${r.pr||''}</td><td>${r.dxt||''}</td><td>${r.dxtType||''}</td>
        <td>${r.tinggi||''}</td><td>${r.berat||''}</td><td>${r.bmi||''}</td><td>${tca}</td><td>${r.tcaStaff||''}</td><td>${r.remark||''}</td>`;
        tbody.appendChild(tr);
      });
      log(`Butiran "${title}" ‚Üí ${rows.length} baris`);
    }catch(err){ log('Gagal muat butiran: '+err.message); }
  }

  // NADI table row helper
  function addRow(){
    const i = els('nadiBody').children.length + 1;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i}</td>
      <td><input type="text" placeholder="Nama"></td>
      <td><input type="text" placeholder="IC"></td>
      <td><input type="text" placeholder="Umur"></td>
      <td><input type="text" placeholder="Telefon"></td>
      <td><input type="text" placeholder="Alamat"></td>
      <td><input type="text" placeholder="120/80"></td>
      <td><input type="text" placeholder="72"></td>
      <td><input type="text" placeholder="5.6"></td>
      <td><select><option value="">-</option><option>FASTING</option><option>RANDOM</option></select></td>
      <td><input type="text" placeholder="170"></td>
      <td><input type="text" placeholder="70"></td>
      <td><input type="text" placeholder="24.2"></td>
      <td style="text-align:center"><input type="checkbox"></td>
      <td style="text-align:center"><input type="checkbox"></td>
      <td><input type="date"></td>
      <td><input type="text" placeholder="09:00"></td>
      <td><input type="text" placeholder="Nama Staff"></td>
      <td><input type="text" placeholder="Remark"></td>
      <td><button class="btn">Buang</button></td>`;
    tr.querySelector('button').addEventListener('click', ()=> tr.remove());
    els('nadiBody').appendChild(tr);
  }
  function serializeRows(){
    const rows = [];
    [...els('nadiBody').children].forEach(tr=>{
      const q = (i)=> tr.children[i].querySelector('input,select')?.value || '';
      rows.push({
        nama: q(1), noIC: q(2), umur: q(3), noTelefon:q(4), alamat:q(5),
        bp:q(6), pr:q(7), dxt:q(8), dxtType:q(9), tinggi:q(10), berat:q(11), bmi:q(12),
        layak: tr.children[13].querySelector('input').checked,
        takLayak: tr.children[14].querySelector('input').checked,
        tcaDate: q(15), tcaTime:q(16), tcaStaff:q(17), remark:q(18),
        appointmentType: '' // biar server tentukan bila kosong
      });
    });
    return rows;
  }
  async function saveProgram(){
    const title = els('pTitle').value.trim();
    const date = els('pDate').value;
    const staff = els('pStaff').value.trim();
    const items = serializeRows();
    if(!title || !date || !items.length){ log('Sila isi tajuk, tarikh, dan sekurang-kurangnya 1 peserta.'); return; }
    try{
      const json = await apiFetch('saveNadiProgramActivity', { method:'POST', body: {
        programTitle: title, programDate: date, staff, items: JSON.stringify(items)
      }});
      log('Simpan OK ‚Üí '+JSON.stringify(json));
    }catch(err){ log('Simpan gagal: '+err.message); }
  }

  // Events
  window.addEventListener('load', () => {
    setStatus();
    els('cfgApi').value = state.apiBase; els('cfgGsi').value = state.gsiClient;
    renderGsi();
    // if GSI loaded later, re-render
    const iv = setInterval(()=>{
      if(typeof google !== 'undefined' && google.accounts && google.accounts.id){
        clearInterval(iv); renderGsi();
      }
    }, 200);

    els('btnConfig').addEventListener('click', ()=> els('cfg').showModal());
    els('saveCfg').addEventListener('click', (e)=>{ e.preventDefault(); saveCfg(); els('cfg').close(); });
    els('btnClearLog').addEventListener('click', ()=> logEl.textContent='');
    els('btnSignOut').addEventListener('click', signOut);

    els('btnLoad').addEventListener('click', loadActivities);
    els('btnAddRow').addEventListener('click', addRow);
    els('btnSave').addEventListener('click', saveProgram);
  });
})();
</script>
</body>
</html>
